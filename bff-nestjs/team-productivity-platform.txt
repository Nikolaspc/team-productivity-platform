
================================================================================
File: .github/workflows/ci.yml
Size: 2.56 kB
================================================================================

name: Enterprise CI Pipeline
on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres_password
          POSTGRES_DB: productivity_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Setup Node.js Environment
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'bff-nestjs/package-lock.json'

      - name: Install Project Dependencies
        working-directory: ./bff-nestjs
        run: npm ci

      - name: Initialize Prisma Client
        working-directory: ./bff-nestjs
        run: npx prisma generate

      - name: Code Quality Audit (Lint)
        working-directory: ./bff-nestjs
        continue-on-error: true
        run: npm run lint

      - name: Execute Unit Tests
        working-directory: ./bff-nestjs
        env:
          NODE_ENV: test
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASS: ${{ secrets.MAIL_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
        run: npm run test -- --passWithNoTests

      - name: Setup Test Database
        working-directory: ./bff-nestjs
        env:
          DATABASE_URL: postgresql://postgres:postgres_password@localhost:5432/productivity_test?schema=public
        run: npx prisma migrate deploy

      - name: Execute End-to-End Tests
        working-directory: ./bff-nestjs
        env:
          DATABASE_URL: postgresql://postgres:postgres_password@localhost:5432/productivity_test?schema=public
          AT_SECRET: ${{ secrets.JWT_ACCESS_SECRET }}
          RT_SECRET: ${{ secrets.JWT_REFRESH_SECRET }}
          NODE_ENV: test
          MAIL_HOST: ${{ secrets.MAIL_HOST }}
          MAIL_PORT: ${{ secrets.MAIL_PORT }}
          MAIL_USER: ${{ secrets.MAIL_USER }}
          MAIL_PASS: ${{ secrets.MAIL_PASS }}
          MAIL_FROM: ${{ secrets.MAIL_FROM }}
        run: npm run test:e2e -- --passWithNoTests
        continue-on-error: true

      - name: Build Production Artifact
        working-directory: ./bff-nestjs
        run: npm run build

================================================================================
File: .github/workflows/quality-gate.yml
Size: 3.36 kB
================================================================================

# .github/workflows/quality-gate.yml
name: Quality Gate (CI)

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ------------------------------------------------------------------
  # JOB 1: Static Analysis & Security
  # German Enterprise Standard: Fail fast on style or security issues
  # ------------------------------------------------------------------
  static-checks:
    name: üõ°Ô∏è Static Analysis & Security
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Linting & Formatting
        run: npm run lint
        # Fails if code doesn't adhere to Prettier/ESLint rules

      - name: Type Checking (Build Dry Run)
        run: npm run build
        # Fails if strict Typescript errors exist

      - name: Security Audit
        run: npm audit --audit-level=high
        # Fails only on high/critical vulnerabilities (Enterprise requirement)

  # ------------------------------------------------------------------
  # JOB 2: Testing Strategy
  # Includes isolated PostgreSQL service for reliable integration tests
  # ------------------------------------------------------------------
  tests:
    name: üß™ Unit & E2E Tests
    needs: static-checks
    runs-on: ubuntu-latest

    # Service Containers: This solves your "No Local Docker" constraint.
    # We spin up a real Postgres 14 just for the duration of this job.
    services:
      postgres:
        image: postgres:14-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        ports:
          - 5432:5432
        # Health check to ensure DB is ready before tests start
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Generate Prisma Client
        run: npx prisma generate
        env:
          DATABASE_URL: 'postgresql://test_user:test_password@localhost:5432/test_db?schema=public'

      - name: Run Database Migrations
        run: npx prisma migrate deploy
        env:
          DATABASE_URL: 'postgresql://test_user:test_password@localhost:5432/test_db?schema=public'

      - name: Run Unit Tests
        run: npm run test
        env:
          # Mocking Supabase/External services via ENV if needed in unit tests
          JWT_SECRET: 'super-secret-testing-key'

      - name: Run E2E Tests
        run: npm run test:e2e
        env:
          DATABASE_URL: 'postgresql://test_user:test_password@localhost:5432/test_db?schema=public'
          JWT_SECRET: 'super-secret-testing-key'
          JWT_REFRESH_SECRET: 'super-secret-refresh-key'
          # Mock Supabase credentials ensures we don't hit live production during CI
          SUPABASE_URL: 'https://mock.supabase.co'
          SUPABASE_KEY: 'mock-key'
cd bff-nestjs

================================================================================
File: .gitignore
Size: 705 B
================================================================================

# compiled output
/dist
/node_modules
/build

# Logs
logs
*.log
npm-debug.log*
pnpm-debug.log*
yarn-debug.log*
yarn-error.log*
lerna-debug.log*

# OS
.DS_Store

# Tests
/coverage
/.nyc_output

# IDEs and editors
/.idea
.project
.classpath
.c9/
*.launch
.settings/
*.sublime-workspace

# IDE - VSCode
.vscode/*
!.vscode/settings.json
!.vscode/tasks.json
!.vscode/launch.json
!.vscode/extensions.json

# dotenv environment variable files
.env
.env.development.local
.env.test.local
.env.production.local
.env.local

# temp directory
.temp
.tmp

# Runtime data
pids
*.pid
*.seed
*.pid.lock

# Diagnostic reports (https://nodejs.org/api/report.html)
report.[0-9]*.[0-9]*.[0-9]*.[0-9]*.json

/generated/prisma


================================================================================
File: .prettierrc
Size: 52 B
================================================================================

{
  "singleQuote": true,
  "trailingComma": "all"
}


================================================================================
File: .vscode/settings.json
Size: 47 B
================================================================================

{
  "prisma.showPrisma7UpgradePrompt": false
}


================================================================================
File: LICENSE
Size: 1.07 kB
================================================================================

MIT License

Copyright (c) 2026 Nikolaspc

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


================================================================================
File: README.md
Size: 5.03 kB
================================================================================

<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil My≈õliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).


================================================================================
File: bff-nestjs/.env.example
Size: 1.19 kB
================================================================================

# --- APP CONFIGURATION ---
NODE_ENV=development
PORT=3001
FRONTEND_URL="http://localhost:3000"

# --- DATABASE (Postgres 14) ---
DATABASE_URL="postgresql://postgres:postgres@localhost:5432/productivity_db?schema=public"
DATABASE_POOL_SIZE=10

# --- JWT & COOKIE SECURITY ---
# Generate secrets using: openssl rand -base64 32
AT_SECRET="change-me-at-least-32-chars-long-!!!"
RT_SECRET="change-me-at-least-32-chars-long-!!!"
COOKIE_SECRET="change-me-at-least-32-chars-long-!!!"
AT_EXPIRES_IN="15m"
RT_EXPIRES_IN="7d"

# --- INFRASTRUCTURE (Redis for BullMQ) ---
REDIS_HOST="127.0.0.1"
REDIS_PORT=6379
REDIS_PASSWORD=""

# --- MAIL SERVICE ---
MAIL_HOST="smtp.ethereal.email"
MAIL_PORT=587
MAIL_USER="placeholder@ethereal.email"
MAIL_PASS="password_placeholder"
MAIL_FROM='"Team Productivity" <no-reply@teamplatform.local>'

# --- STORAGE (Supabase S3 Interoperability) ---
STORAGE_ENDPOINT="https://xxxx.storage.supabase.co/storage/v1/s3"
STORAGE_REGION="eu-central-1"
STORAGE_ACCESS_KEY="your-supabase-key"
STORAGE_SECRET_KEY="your-supabase-secret"
STORAGE_BUCKET="attachments"
STORAGE_FORCE_PATH_STYLE=true

# --- PERFORMANCE & LOGS ---
THROTTLE_TTL=60000
THROTTLE_LIMIT=20
LOG_LEVEL="debug"

================================================================================
File: bff-nestjs/.env.save
Size: 1.24 kB
================================================================================

# Environment variables declared in this file are NOT automatically loaded by Prisma.
# Please add `import "dotenv/config";` to your `prisma.config.ts` file, or use the Prisma CLI with Bun
# to load environment variables from .env files: https://pris.ly/prisma-config-env-vars.

# Prisma supports the native connection string format for PostgreSQL, MySQL, SQLite, SQL Server, MongoDB and CockroachDB.
# See the documentation for all the connection string options: https://pris.ly/d/connection-strings

# The following `prisma+postgres` URL is similar to the URL produced by running a local Prisma Postgres
# server with the `prisma dev` CLI command, when not choosing any non-default ports or settings. The API key, unlike the
# one found in a remote Prisma Postgres URL, does not contain any sensitive informativbm5lY3Rpb25fbGlmZXRpbWU9MCZwb29sX3RpbWVvdXQ9MCZzaW5nbGVfdXNlX2Nvbm5lY3Rpb25zPXRydWUmc29ja2V0X3RpbWVvdXQ9MCIsIm5hbWUiOiJkZWZhdWx0Iiwic2hhZG93RGF0YWJhc2VVcmwiOiJwb3N0Z3JlczovL3Bvc3RncmVzOnBvc3RncmVzQGxvY2FsaG9zdDo1MTIxNS90ZW1wbGF0ZTE_c3NsbW9kZT1kaXNhYmxlJmNvbm5lY3Rpb25fbGltaXQ9MSZjb25uZWN0X3RpbWVvdXQ9MCZtYXhfaWRsZV9jb25uZWN0aW9uX2xpZmV0aW1lPTAmcG9vbF90aW1lb3V0PTAmc2luZ2xlX3VzZV9jb25uZWN0aW9ucz10cnVlJnNvY2tldF90aW1lb3V0PTAifQ"


================================================================================
File: bff-nestjs/.env.test
Size: 160 B
================================================================================

DATABASE_URL="postgresql://postgres:postgres@localhost:5432/productivity_test?schema=public"
NODE_ENV=test
AT_SECRET="test-secret-at"
RT_SECRET="test-secret-rt"

================================================================================
File: bff-nestjs/README.md
Size: 5.03 kB
================================================================================

<p align="center">
  <a href="http://nestjs.com/" target="blank"><img src="https://nestjs.com/img/logo-small.svg" width="120" alt="Nest Logo" /></a>
</p>

[circleci-image]: https://img.shields.io/circleci/build/github/nestjs/nest/master?token=abc123def456
[circleci-url]: https://circleci.com/gh/nestjs/nest

  <p align="center">A progressive <a href="http://nodejs.org" target="_blank">Node.js</a> framework for building efficient and scalable server-side applications.</p>
    <p align="center">
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/v/@nestjs/core.svg" alt="NPM Version" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/l/@nestjs/core.svg" alt="Package License" /></a>
<a href="https://www.npmjs.com/~nestjscore" target="_blank"><img src="https://img.shields.io/npm/dm/@nestjs/common.svg" alt="NPM Downloads" /></a>
<a href="https://circleci.com/gh/nestjs/nest" target="_blank"><img src="https://img.shields.io/circleci/build/github/nestjs/nest/master" alt="CircleCI" /></a>
<a href="https://discord.gg/G7Qnnhy" target="_blank"><img src="https://img.shields.io/badge/discord-online-brightgreen.svg" alt="Discord"/></a>
<a href="https://opencollective.com/nest#backer" target="_blank"><img src="https://opencollective.com/nest/backers/badge.svg" alt="Backers on Open Collective" /></a>
<a href="https://opencollective.com/nest#sponsor" target="_blank"><img src="https://opencollective.com/nest/sponsors/badge.svg" alt="Sponsors on Open Collective" /></a>
  <a href="https://paypal.me/kamilmysliwiec" target="_blank"><img src="https://img.shields.io/badge/Donate-PayPal-ff3f59.svg" alt="Donate us"/></a>
    <a href="https://opencollective.com/nest#sponsor"  target="_blank"><img src="https://img.shields.io/badge/Support%20us-Open%20Collective-41B883.svg" alt="Support us"></a>
  <a href="https://twitter.com/nestframework" target="_blank"><img src="https://img.shields.io/twitter/follow/nestframework.svg?style=social&label=Follow" alt="Follow us on Twitter"></a>
</p>
  <!--[![Backers on Open Collective](https://opencollective.com/nest/backers/badge.svg)](https://opencollective.com/nest#backer)
  [![Sponsors on Open Collective](https://opencollective.com/nest/sponsors/badge.svg)](https://opencollective.com/nest#sponsor)-->

## Description

[Nest](https://github.com/nestjs/nest) framework TypeScript starter repository.

## Project setup

```bash
$ npm install
```

## Compile and run the project

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev

# production mode
$ npm run start:prod
```

## Run tests

```bash
# unit tests
$ npm run test

# e2e tests
$ npm run test:e2e

# test coverage
$ npm run test:cov
```

## Deployment

When you're ready to deploy your NestJS application to production, there are some key steps you can take to ensure it runs as efficiently as possible. Check out the [deployment documentation](https://docs.nestjs.com/deployment) for more information.

If you are looking for a cloud-based platform to deploy your NestJS application, check out [Mau](https://mau.nestjs.com), our official platform for deploying NestJS applications on AWS. Mau makes deployment straightforward and fast, requiring just a few simple steps:

```bash
$ npm install -g @nestjs/mau
$ mau deploy
```

With Mau, you can deploy your application in just a few clicks, allowing you to focus on building features rather than managing infrastructure.

## Resources

Check out a few resources that may come in handy when working with NestJS:

- Visit the [NestJS Documentation](https://docs.nestjs.com) to learn more about the framework.
- For questions and support, please visit our [Discord channel](https://discord.gg/G7Qnnhy).
- To dive deeper and get more hands-on experience, check out our official video [courses](https://courses.nestjs.com/).
- Deploy your application to AWS with the help of [NestJS Mau](https://mau.nestjs.com) in just a few clicks.
- Visualize your application graph and interact with the NestJS application in real-time using [NestJS Devtools](https://devtools.nestjs.com).
- Need help with your project (part-time to full-time)? Check out our official [enterprise support](https://enterprise.nestjs.com).
- To stay in the loop and get updates, follow us on [X](https://x.com/nestframework) and [LinkedIn](https://linkedin.com/company/nestjs).
- Looking for a job, or have a job to offer? Check out our official [Jobs board](https://jobs.nestjs.com).

## Support

Nest is an MIT-licensed open source project. It can grow thanks to the sponsors and support by the amazing backers. If you'd like to join them, please [read more here](https://docs.nestjs.com/support).

## Stay in touch

- Author - [Kamil My≈õliwiec](https://twitter.com/kammysliwiec)
- Website - [https://nestjs.com](https://nestjs.com/)
- Twitter - [@nestframework](https://twitter.com/nestframework)

## License

Nest is [MIT licensed](https://github.com/nestjs/nest/blob/master/LICENSE).


================================================================================
File: bff-nestjs/analyze-duplicates.sh
Size: 39 B
================================================================================

[pega aqu√≠ el contenido del artifact]


================================================================================
File: bff-nestjs/dist/prisma/seed.d.ts
Size: 11 B
================================================================================

export {};


================================================================================
File: bff-nestjs/dist/prisma/seed.js
Size: 3.34 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
const client_1 = require("@prisma/client");
const argon2 = __importStar(require("argon2"));
const prisma = new client_1.PrismaClient();
async function main() {
    console.log('--- Starting Seeding Process ---');
    const password = await argon2.hash('password123');
    const admin = await prisma.user.upsert({
        where: { email: 'admin@test.com' },
        update: { password },
        create: {
            email: 'admin@test.com',
            name: 'Admin User',
            password,
            role: client_1.Role.ADMIN,
        },
    });
    const team = await prisma.team.create({
        data: {
            name: 'Development Team',
            members: {
                create: {
                    userId: admin.id,
                    role: client_1.TeamRole.OWNER,
                },
            },
        },
    });
    await prisma.project.create({
        data: {
            name: 'Platform Rebuild',
            teamId: team.id,
            tasks: {
                create: [
                    {
                        title: 'Database Schema',
                        status: client_1.TaskStatus.DONE,
                    },
                    {
                        title: 'API Implementation',
                        status: client_1.TaskStatus.IN_PROGRESS,
                    },
                    {
                        title: 'Legacy Migration',
                        status: client_1.TaskStatus.TODO,
                        dueDate: new Date('2025-01-01'),
                    },
                ],
            },
        },
    });
    console.log('--- Seed Success ---');
    console.log({
        admin: admin.email,
        teamId: team.id,
    });
}
main()
    .catch((e) => {
    console.error('Error during seeding:', e);
    process.exit(1);
})
    .finally(async () => {
    await prisma.$disconnect();
});
//# sourceMappingURL=seed.js.map

================================================================================
File: bff-nestjs/dist/prisma/seed.js.map
Size: 1.63 kB
================================================================================

{"version":3,"file":"seed.js","sourceRoot":"","sources":["../../prisma/seed.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,2CAA0E;AAC1E,+CAAiC;AAEjC,MAAM,MAAM,GAAG,IAAI,qBAAY,EAAE,CAAC;AAElC,KAAK,UAAU,IAAI;IACjB,OAAO,CAAC,GAAG,CAAC,kCAAkC,CAAC,CAAC;IAChD,MAAM,QAAQ,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;IAGlD,MAAM,KAAK,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;QACrC,KAAK,EAAE,EAAE,KAAK,EAAE,gBAAgB,EAAE;QAClC,MAAM,EAAE,EAAE,QAAQ,EAAE;QACpB,MAAM,EAAE;YACN,KAAK,EAAE,gBAAgB;YACvB,IAAI,EAAE,YAAY;YAClB,QAAQ;YACR,IAAI,EAAE,aAAI,CAAC,KAAK;SACjB;KACF,CAAC,CAAC;IAIH,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;QACpC,IAAI,EAAE;YACJ,IAAI,EAAE,kBAAkB;YACxB,OAAO,EAAE;gBACP,MAAM,EAAE;oBACN,MAAM,EAAE,KAAK,CAAC,EAAE;oBAChB,IAAI,EAAE,iBAAQ,CAAC,KAAK;iBACrB;aACF;SACF;KACF,CAAC,CAAC;IAGH,MAAM,MAAM,CAAC,OAAO,CAAC,MAAM,CAAC;QAC1B,IAAI,EAAE;YACJ,IAAI,EAAE,kBAAkB;YACxB,MAAM,EAAE,IAAI,CAAC,EAAE;YACf,KAAK,EAAE;gBACL,MAAM,EAAE;oBACN;wBACE,KAAK,EAAE,iBAAiB;wBACxB,MAAM,EAAE,mBAAU,CAAC,IAAI;qBACxB;oBACD;wBACE,KAAK,EAAE,oBAAoB;wBAC3B,MAAM,EAAE,mBAAU,CAAC,WAAW;qBAC/B;oBACD;wBACE,KAAK,EAAE,kBAAkB;wBACzB,MAAM,EAAE,mBAAU,CAAC,IAAI;wBACvB,OAAO,EAAE,IAAI,IAAI,CAAC,YAAY,CAAC;qBAChC;iBACF;aACF;SACF;KACF,CAAC,CAAC;IAEH,OAAO,CAAC,GAAG,CAAC,sBAAsB,CAAC,CAAC;IACpC,OAAO,CAAC,GAAG,CAAC;QACV,KAAK,EAAE,KAAK,CAAC,KAAK;QAClB,MAAM,EAAE,IAAI,CAAC,EAAE;KAChB,CAAC,CAAC;AACL,CAAC;AAED,IAAI,EAAE;KACH,KAAK,CAAC,CAAC,CAAC,EAAE,EAAE;IACX,OAAO,CAAC,KAAK,CAAC,uBAAuB,EAAE,CAAC,CAAC,CAAC;IAC1C,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;AAClB,CAAC,CAAC;KACD,OAAO,CAAC,KAAK,IAAI,EAAE;IAClB,MAAM,MAAM,CAAC,WAAW,EAAE,CAAC;AAC7B,CAAC,CAAC,CAAC"}

================================================================================
File: bff-nestjs/dist/src/app.controller.d.ts
Size: 190 B
================================================================================

import { AppService } from './app.service';
export declare class AppController {
    private readonly appService;
    constructor(appService: AppService);
    getHello(): Promise<string>;
}


================================================================================
File: bff-nestjs/dist/src/app.controller.js
Size: 1.62 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppController = void 0;
const common_1 = require("@nestjs/common");
const app_service_1 = require("./app.service");
let AppController = class AppController {
    appService;
    constructor(appService) {
        this.appService = appService;
    }
    async getHello() {
        return await this.appService.getHello();
    }
};
exports.AppController = AppController;
__decorate([
    (0, common_1.Get)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", Promise)
], AppController.prototype, "getHello", null);
exports.AppController = AppController = __decorate([
    (0, common_1.Controller)(),
    __metadata("design:paramtypes", [app_service_1.AppService])
], AppController);
//# sourceMappingURL=app.controller.js.map

================================================================================
File: bff-nestjs/dist/src/app.controller.js.map
Size: 456 B
================================================================================

{"version":3,"file":"app.controller.js","sourceRoot":"","sources":["../../src/app.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAAiD;AACjD,+CAA2C;AAGpC,IAAM,aAAa,GAAnB,MAAM,aAAa;IACK;IAA7B,YAA6B,UAAsB;QAAtB,eAAU,GAAV,UAAU,CAAY;IAAG,CAAC;IAGjD,AAAN,KAAK,CAAC,QAAQ;QAEZ,OAAO,MAAM,IAAI,CAAC,UAAU,CAAC,QAAQ,EAAE,CAAC;IAC1C,CAAC;CACF,CAAA;AARY,sCAAa;AAIlB;IADL,IAAA,YAAG,GAAE;;;;6CAIL;wBAPU,aAAa;IADzB,IAAA,mBAAU,GAAE;qCAE8B,wBAAU;GADxC,aAAa,CAQzB"}

================================================================================
File: bff-nestjs/dist/src/app.module.d.ts
Size: 35 B
================================================================================

export declare class AppModule {
}


================================================================================
File: bff-nestjs/dist/src/app.module.js
Size: 4.13 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppModule = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const core_1 = require("@nestjs/core");
const throttler_1 = require("@nestjs/throttler");
const nestjs_pino_1 = require("nestjs-pino");
const nestjs_prometheus_1 = require("@willsoto/nestjs-prometheus");
const terminus_1 = require("@nestjs/terminus");
const auth_module_1 = require("./auth/auth.module");
const prisma_module_1 = require("./prisma/prisma.module");
const storage_module_1 = require("./storage/storage.module");
const notifications_module_1 = require("./modules/notifications/notifications.module");
const teams_module_1 = require("./modules/teams/teams.module");
const projects_module_1 = require("./modules/projects/projects.module");
const tasks_module_1 = require("./modules/tasks/tasks.module");
const dashboard_module_1 = require("./modules/dashboard/dashboard.module");
const invitations_module_1 = require("./modules/invitations/invitations.module");
const mail_module_1 = require("./modules/mail/mail.module");
const health_module_1 = require("./modules/health/health.module");
const at_guard_1 = require("./auth/guards/at.guard");
const roles_guard_1 = require("./common/guards/roles.guard");
const env_validation_1 = require("./common/config/env.validation");
let AppModule = class AppModule {
};
exports.AppModule = AppModule;
exports.AppModule = AppModule = __decorate([
    (0, common_1.Module)({
        imports: [
            config_1.ConfigModule.forRoot({
                isGlobal: true,
                validationSchema: env_validation_1.envValidationSchema,
                cache: true,
            }),
            nestjs_pino_1.LoggerModule.forRootAsync({
                inject: [config_1.ConfigService],
                useFactory: (config) => ({
                    pinoHttp: {
                        level: config.get('NODE_ENV') !== 'production' ? 'debug' : 'info',
                        transport: config.get('NODE_ENV') !== 'production'
                            ? { target: 'pino-pretty', options: { colorize: true } }
                            : undefined,
                    },
                }),
            }),
            throttler_1.ThrottlerModule.forRootAsync({
                inject: [config_1.ConfigService],
                useFactory: (config) => [
                    {
                        ttl: config.get('THROTTLE_TTL') || 60000,
                        limit: config.get('THROTTLE_LIMIT') || 10,
                    },
                ],
            }),
            nestjs_prometheus_1.PrometheusModule.register({ path: '/metrics' }),
            terminus_1.TerminusModule,
            prisma_module_1.PrismaModule,
            auth_module_1.AuthModule,
            storage_module_1.StorageModule,
            mail_module_1.MailModule,
            health_module_1.HealthModule,
            notifications_module_1.NotificationsModule,
            teams_module_1.TeamsModule,
            projects_module_1.ProjectsModule,
            tasks_module_1.TasksModule,
            dashboard_module_1.DashboardModule,
            invitations_module_1.InvitationsModule,
        ],
        providers: [
            { provide: core_1.APP_GUARD, useClass: throttler_1.ThrottlerGuard },
            { provide: core_1.APP_GUARD, useClass: at_guard_1.AtGuard },
            { provide: core_1.APP_GUARD, useClass: roles_guard_1.RolesGuard },
        ],
    })
], AppModule);
//# sourceMappingURL=app.module.js.map

================================================================================
File: bff-nestjs/dist/src/app.module.js.map
Size: 1.66 kB
================================================================================

{"version":3,"file":"app.module.js","sourceRoot":"","sources":["../../src/app.module.ts"],"names":[],"mappings":";;;;;;;;;AACA,2CAAwC;AACxC,2CAA6D;AAC7D,uCAAyC;AACzC,iDAAoE;AACpE,6CAA2C;AAC3C,mEAA+D;AAC/D,+CAAkD;AAGlD,oDAAgD;AAChD,0DAAsD;AACtD,6DAAyD;AAEzD,uFAAmF;AACnF,+DAA2D;AAC3D,wEAAoE;AACpE,+DAA2D;AAC3D,2EAAuE;AACvE,iFAA6E;AAC7E,4DAAwD;AACxD,kEAA8D;AAE9D,qDAAiD;AACjD,6DAAyD;AACzD,mEAAqE;AAsD9D,IAAM,SAAS,GAAf,MAAM,SAAS;CAAG,CAAA;AAAZ,8BAAS;oBAAT,SAAS;IApDrB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE;YACP,qBAAY,CAAC,OAAO,CAAC;gBACnB,QAAQ,EAAE,IAAI;gBACd,gBAAgB,EAAE,oCAAmB;gBACrC,KAAK,EAAE,IAAI;aACZ,CAAC;YAEF,0BAAY,CAAC,YAAY,CAAC;gBACxB,MAAM,EAAE,CAAC,sBAAa,CAAC;gBACvB,UAAU,EAAE,CAAC,MAAqB,EAAE,EAAE,CAAC,CAAC;oBACtC,QAAQ,EAAE;wBACR,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,KAAK,YAAY,CAAC,CAAC,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM;wBACjE,SAAS,EACP,MAAM,CAAC,GAAG,CAAC,UAAU,CAAC,KAAK,YAAY;4BACrC,CAAC,CAAC,EAAE,MAAM,EAAE,aAAa,EAAE,OAAO,EAAE,EAAE,QAAQ,EAAE,IAAI,EAAE,EAAE;4BACxD,CAAC,CAAC,SAAS;qBAChB;iBACF,CAAC;aACH,CAAC;YAEF,2BAAe,CAAC,YAAY,CAAC;gBAC3B,MAAM,EAAE,CAAC,sBAAa,CAAC;gBACvB,UAAU,EAAE,CAAC,MAAqB,EAAE,EAAE,CAAC;oBACrC;wBACE,GAAG,EAAE,MAAM,CAAC,GAAG,CAAC,cAAc,CAAC,IAAI,KAAK;wBACxC,KAAK,EAAE,MAAM,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAI,EAAE;qBAC1C;iBACF;aACF,CAAC;YAEF,oCAAgB,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,UAAU,EAAE,CAAC;YAC/C,yBAAc;YACd,4BAAY;YACZ,wBAAU;YACV,8BAAa;YACb,wBAAU;YACV,4BAAY;YACZ,0CAAmB;YACnB,0BAAW;YACX,gCAAc;YACd,0BAAW;YACX,kCAAe;YACf,sCAAiB;SAClB;QACD,SAAS,EAAE;YAET,EAAE,OAAO,EAAE,gBAAS,EAAE,QAAQ,EAAE,0BAAc,EAAE;YAChD,EAAE,OAAO,EAAE,gBAAS,EAAE,QAAQ,EAAE,kBAAO,EAAE;YACzC,EAAE,OAAO,EAAE,gBAAS,EAAE,QAAQ,EAAE,wBAAU,EAAE;SAC7C;KACF,CAAC;GACW,SAAS,CAAG"}

================================================================================
File: bff-nestjs/dist/src/app.service.d.ts
Size: 186 B
================================================================================

import { PrismaService } from './prisma/prisma.service';
export declare class AppService {
    private prisma;
    constructor(prisma: PrismaService);
    getHello(): Promise<string>;
}


================================================================================
File: bff-nestjs/dist/src/app.service.js
Size: 1.66 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AppService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("./prisma/prisma.service");
let AppService = class AppService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async getHello() {
        const user = await this.prisma.user.create({
            data: {
                email: `dev_${Date.now()}@example.com`,
                name: 'Nikolas Developer',
                password: 'securePassword123',
            },
        });
        return `User created successfully: ${user.email} with ID: ${user.id}`;
    }
};
exports.AppService = AppService;
exports.AppService = AppService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], AppService);
//# sourceMappingURL=app.service.js.map

================================================================================
File: bff-nestjs/dist/src/app.service.js.map
Size: 620 B
================================================================================

{"version":3,"file":"app.service.js","sourceRoot":"","sources":["../../src/app.service.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAA4C;AAC5C,4DAAwD;AAGjD,IAAM,UAAU,GAAhB,MAAM,UAAU;IAED;IAApB,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,QAAQ;QAEZ,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YACzC,IAAI,EAAE;gBACJ,KAAK,EAAE,OAAO,IAAI,CAAC,GAAG,EAAE,cAAc;gBACtC,IAAI,EAAE,mBAAmB;gBACzB,QAAQ,EAAE,mBAAmB;aAC9B;SACF,CAAC,CAAC;QAEH,OAAO,8BAA8B,IAAI,CAAC,KAAK,aAAa,IAAI,CAAC,EAAE,EAAE,CAAC;IACxE,CAAC;CACF,CAAA;AAhBY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAGiB,8BAAa;GAF9B,UAAU,CAgBtB"}

================================================================================
File: bff-nestjs/dist/src/auth/auth.controller.d.ts
Size: 636 B
================================================================================

import { Response } from 'express';
import { AuthService } from './auth.service';
import { RegisterDto, LoginDto } from './dto/auth.dto';
export declare class AuthController {
    private authService;
    constructor(authService: AuthService);
    signup(dto: RegisterDto, res: Response): Promise<{
        access_token: string;
    }>;
    signin(dto: LoginDto, res: Response): Promise<{
        access_token: string;
    }>;
    logout(userId: number, res: Response): Promise<{
        success: boolean;
    }>;
    refreshTokens(userId: number, refreshToken: string, res: Response): Promise<{
        access_token: string;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/auth/auth.controller.js
Size: 3.86 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthController = void 0;
const common_1 = require("@nestjs/common");
const auth_service_1 = require("./auth.service");
const auth_dto_1 = require("./dto/auth.dto");
const rt_guard_1 = require("./guards/rt.guard");
const decorators_1 = require("../common/decorators");
let AuthController = class AuthController {
    authService;
    constructor(authService) {
        this.authService = authService;
    }
    signup(dto, res) {
        return this.authService.signupLocal(dto, res);
    }
    signin(dto, res) {
        return this.authService.signinLocal(dto, res);
    }
    logout(userId, res) {
        return this.authService.logout(userId, res);
    }
    refreshTokens(userId, refreshToken, res) {
        return this.authService.refreshTokens(userId, refreshToken, res);
    }
};
exports.AuthController = AuthController;
__decorate([
    (0, decorators_1.Public)(),
    (0, common_1.Post)('signup'),
    (0, common_1.HttpCode)(common_1.HttpStatus.CREATED),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Res)({ passthrough: true })),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [auth_dto_1.RegisterDto, Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "signup", null);
__decorate([
    (0, decorators_1.Public)(),
    (0, common_1.Post)('signin'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, common_1.Res)({ passthrough: true })),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [auth_dto_1.LoginDto, Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "signin", null);
__decorate([
    (0, common_1.Post)('logout'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, decorators_1.GetCurrentUserId)()),
    __param(1, (0, common_1.Res)({ passthrough: true })),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "logout", null);
__decorate([
    (0, decorators_1.Public)(),
    (0, common_1.UseGuards)(rt_guard_1.RtGuard),
    (0, common_1.Post)('refresh'),
    (0, common_1.HttpCode)(common_1.HttpStatus.OK),
    __param(0, (0, decorators_1.GetCurrentUserId)()),
    __param(1, (0, decorators_1.GetCurrentUser)('refreshToken')),
    __param(2, (0, common_1.Res)({ passthrough: true })),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, String, Object]),
    __metadata("design:returntype", void 0)
], AuthController.prototype, "refreshTokens", null);
exports.AuthController = AuthController = __decorate([
    (0, common_1.Controller)('auth'),
    __metadata("design:paramtypes", [auth_service_1.AuthService])
], AuthController);
//# sourceMappingURL=auth.controller.js.map

================================================================================
File: bff-nestjs/dist/src/auth/auth.controller.js.map
Size: 1.74 kB
================================================================================

{"version":3,"file":"auth.controller.js","sourceRoot":"","sources":["../../../src/auth/auth.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CAQwB;AAExB,iDAA6C;AAC7C,6CAAuD;AAEvD,gDAA4C;AAC5C,qDAAgF;AAGzE,IAAM,cAAc,GAApB,MAAM,cAAc;IACL;IAApB,YAAoB,WAAwB;QAAxB,gBAAW,GAAX,WAAW,CAAa;IAAG,CAAC;IAKhD,MAAM,CAAS,GAAgB,EAA8B,GAAa;QACxE,OAAO,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;IAChD,CAAC;IAKD,MAAM,CAAS,GAAa,EAA8B,GAAa;QACrE,OAAO,IAAI,CAAC,WAAW,CAAC,WAAW,CAAC,GAAG,EAAE,GAAG,CAAC,CAAC;IAChD,CAAC;IAID,MAAM,CACgB,MAAc,EACN,GAAa;QAEzC,OAAO,IAAI,CAAC,WAAW,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAC9C,CAAC;IAMD,aAAa,CACS,MAAc,EACF,YAAoB,EACxB,GAAa;QAEzC,OAAO,IAAI,CAAC,WAAW,CAAC,aAAa,CAAC,MAAM,EAAE,YAAY,EAAE,GAAG,CAAC,CAAC;IACnE,CAAC;CACF,CAAA;AArCY,wCAAc;AAMzB;IAHC,IAAA,mBAAM,GAAE;IACR,IAAA,aAAI,EAAC,QAAQ,CAAC;IACd,IAAA,iBAAQ,EAAC,mBAAU,CAAC,OAAO,CAAC;IACrB,WAAA,IAAA,aAAI,GAAE,CAAA;IAAoB,WAAA,IAAA,YAAG,EAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAA;;qCAAxC,sBAAW;;4CAE9B;AAKD;IAHC,IAAA,mBAAM,GAAE;IACR,IAAA,aAAI,EAAC,QAAQ,CAAC;IACd,IAAA,iBAAQ,EAAC,mBAAU,CAAC,EAAE,CAAC;IAChB,WAAA,IAAA,aAAI,GAAE,CAAA;IAAiB,WAAA,IAAA,YAAG,EAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAA;;qCAArC,mBAAQ;;4CAE3B;AAID;IAFC,IAAA,aAAI,EAAC,QAAQ,CAAC;IACd,IAAA,iBAAQ,EAAC,mBAAU,CAAC,EAAE,CAAC;IAErB,WAAA,IAAA,6BAAgB,GAAE,CAAA;IAClB,WAAA,IAAA,YAAG,EAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAA;;;;4CAG5B;AAMD;IAJC,IAAA,mBAAM,GAAE;IACR,IAAA,kBAAS,EAAC,kBAAO,CAAC;IAClB,IAAA,aAAI,EAAC,SAAS,CAAC;IACf,IAAA,iBAAQ,EAAC,mBAAU,CAAC,EAAE,CAAC;IAErB,WAAA,IAAA,6BAAgB,GAAE,CAAA;IAClB,WAAA,IAAA,2BAAc,EAAC,cAAc,CAAC,CAAA;IAC9B,WAAA,IAAA,YAAG,EAAC,EAAE,WAAW,EAAE,IAAI,EAAE,CAAC,CAAA;;;;mDAG5B;yBApCU,cAAc;IAD1B,IAAA,mBAAU,EAAC,MAAM,CAAC;qCAEgB,0BAAW;GADjC,cAAc,CAqC1B"}

================================================================================
File: bff-nestjs/dist/src/auth/auth.module.d.ts
Size: 36 B
================================================================================

export declare class AuthModule {
}


================================================================================
File: bff-nestjs/dist/src/auth/auth.module.js
Size: 1.33 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthModule = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const auth_controller_1 = require("./auth.controller");
const auth_service_1 = require("./auth.service");
const strategies_1 = require("./strategies");
let AuthModule = class AuthModule {
};
exports.AuthModule = AuthModule;
exports.AuthModule = AuthModule = __decorate([
    (0, common_1.Module)({
        imports: [jwt_1.JwtModule.register({})],
        controllers: [auth_controller_1.AuthController],
        providers: [auth_service_1.AuthService, strategies_1.AtStrategy, strategies_1.RtStrategy],
    })
], AuthModule);
//# sourceMappingURL=auth.module.js.map

================================================================================
File: bff-nestjs/dist/src/auth/auth.module.js.map
Size: 449 B
================================================================================

{"version":3,"file":"auth.module.js","sourceRoot":"","sources":["../../../src/auth/auth.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,qCAAwC;AACxC,uDAAmD;AACnD,iDAA6C;AAC7C,6CAAsD;AAO/C,IAAM,UAAU,GAAhB,MAAM,UAAU;CAAG,CAAA;AAAb,gCAAU;qBAAV,UAAU;IALtB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,eAAS,CAAC,QAAQ,CAAC,EAAE,CAAC,CAAC;QACjC,WAAW,EAAE,CAAC,gCAAc,CAAC;QAC7B,SAAS,EAAE,CAAC,0BAAW,EAAE,uBAAU,EAAE,uBAAU,CAAC;KACjD,CAAC;GACW,UAAU,CAAG"}

================================================================================
File: bff-nestjs/dist/src/auth/auth.service.d.ts
Size: 1.08 kB
================================================================================

import { ConfigService } from '@nestjs/config';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../prisma/prisma.service';
import { RegisterDto, LoginDto } from './dto/auth.dto';
import { Response } from 'express';
export declare class AuthService {
    private prisma;
    private jwtService;
    private config;
    private readonly logger;
    constructor(prisma: PrismaService, jwtService: JwtService, config: ConfigService);
    signupLocal(dto: RegisterDto, res: Response): Promise<{
        access_token: string;
    }>;
    signinLocal(dto: LoginDto, res: Response): Promise<{
        access_token: string;
    }>;
    logout(userId: number, res: Response): Promise<{
        success: boolean;
    }>;
    refreshTokens(userId: number, rt: string, res: Response): Promise<{
        access_token: string;
    }>;
    updateRtHash(userId: number, rt: string): Promise<void>;
    getTokens(userId: number, email: string, role: string): Promise<{
        access_token: string;
        refresh_token: string;
    }>;
    private finalizeSession;
}


================================================================================
File: bff-nestjs/dist/src/auth/auth.service.js
Size: 7.08 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AuthService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AuthService = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const jwt_1 = require("@nestjs/jwt");
const prisma_service_1 = require("../prisma/prisma.service");
const argon2 = __importStar(require("argon2"));
let AuthService = AuthService_1 = class AuthService {
    prisma;
    jwtService;
    config;
    logger = new common_1.Logger(AuthService_1.name);
    constructor(prisma, jwtService, config) {
        this.prisma = prisma;
        this.jwtService = jwtService;
        this.config = config;
    }
    async signupLocal(dto, res) {
        const existingUser = await this.prisma.extended.user.findUnique({
            where: { email: dto.email },
        });
        if (existingUser) {
            throw new common_1.ConflictException('User with this email already exists');
        }
        const hash = await argon2.hash(dto.password);
        const newUser = await this.prisma.extended.user.create({
            data: {
                email: dto.email,
                password: hash,
                name: dto.name,
            },
        });
        const tokens = await this.getTokens(newUser.id, newUser.email, newUser.role);
        await this.updateRtHash(newUser.id, tokens.refresh_token);
        return this.finalizeSession(res, tokens);
    }
    async signinLocal(dto, res) {
        const user = await this.prisma.extended.user.findUnique({
            where: { email: dto.email },
        });
        if (!user)
            throw new common_1.ForbiddenException('Access Denied: Invalid credentials');
        const passwordMatches = await argon2.verify(user.password, dto.password);
        if (!passwordMatches)
            throw new common_1.ForbiddenException('Access Denied: Invalid credentials');
        const tokens = await this.getTokens(user.id, user.email, user.role);
        await this.updateRtHash(user.id, tokens.refresh_token);
        return this.finalizeSession(res, tokens);
    }
    async logout(userId, res) {
        await this.prisma.extended.user.updateMany({
            where: {
                id: userId,
                refreshTokenHash: { not: null },
            },
            data: { refreshTokenHash: null },
        });
        res.clearCookie('refresh_token', {
            httpOnly: true,
            secure: this.config.get('NODE_ENV') === 'production',
            sameSite: 'strict',
        });
        return { success: true };
    }
    async refreshTokens(userId, rt, res) {
        const user = await this.prisma.extended.user.findUnique({
            where: { id: userId },
        });
        if (!user || !user.refreshTokenHash)
            throw new common_1.ForbiddenException('Access Denied: Session expired');
        const rtMatches = await argon2.verify(user.refreshTokenHash, rt);
        if (!rtMatches)
            throw new common_1.ForbiddenException('Access Denied: Invalid token');
        const tokens = await this.getTokens(user.id, user.email, user.role);
        await this.updateRtHash(user.id, tokens.refresh_token);
        return this.finalizeSession(res, tokens);
    }
    async updateRtHash(userId, rt) {
        const hash = await argon2.hash(rt);
        await this.prisma.extended.user.update({
            where: { id: userId },
            data: { refreshTokenHash: hash },
        });
    }
    async getTokens(userId, email, role) {
        try {
            const [at, rt] = await Promise.all([
                this.jwtService.signAsync({ sub: userId, email, role }, {
                    secret: this.config.get('AT_SECRET'),
                    expiresIn: '15m',
                }),
                this.jwtService.signAsync({ sub: userId, email, role }, {
                    secret: this.config.get('RT_SECRET'),
                    expiresIn: '7d',
                }),
            ]);
            return { access_token: at, refresh_token: rt };
        }
        catch (error) {
            this.logger.error(`Error generating tokens: ${error instanceof Error ? error.message : 'Unknown error'}`);
            throw new common_1.InternalServerErrorException('Error creating session');
        }
    }
    finalizeSession(res, tokens) {
        const isProduction = this.config.get('NODE_ENV') === 'production';
        res.cookie('refresh_token', tokens.refresh_token, {
            httpOnly: true,
            secure: isProduction,
            sameSite: 'strict',
            maxAge: 7 * 24 * 60 * 60 * 1000,
        });
        return { access_token: tokens.access_token };
    }
};
exports.AuthService = AuthService;
exports.AuthService = AuthService = AuthService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService,
        jwt_1.JwtService,
        config_1.ConfigService])
], AuthService);
//# sourceMappingURL=auth.service.js.map

================================================================================
File: bff-nestjs/dist/src/auth/auth.service.js.map
Size: 4.57 kB
================================================================================

{"version":3,"file":"auth.service.js","sourceRoot":"","sources":["../../../src/auth/auth.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,2CAMwB;AACxB,2CAA+C;AAC/C,qCAAyC;AACzC,6DAAyD;AACzD,+CAAiC;AAK1B,IAAM,WAAW,mBAAjB,MAAM,WAAW;IAIZ;IACA;IACA;IALO,MAAM,GAAG,IAAI,eAAM,CAAC,aAAW,CAAC,IAAI,CAAC,CAAC;IAEvD,YACU,MAAqB,EACrB,UAAsB,EACtB,MAAqB;QAFrB,WAAM,GAAN,MAAM,CAAe;QACrB,eAAU,GAAV,UAAU,CAAY;QACtB,WAAM,GAAN,MAAM,CAAe;IAC5B,CAAC;IAEJ,KAAK,CAAC,WAAW,CAAC,GAAgB,EAAE,GAAa;QAC/C,MAAM,YAAY,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YAC9D,KAAK,EAAE,EAAE,KAAK,EAAE,GAAG,CAAC,KAAK,EAAE;SAC5B,CAAC,CAAC;QAEH,IAAI,YAAY,EAAE,CAAC;YACjB,MAAM,IAAI,0BAAiB,CAAC,qCAAqC,CAAC,CAAC;QACrE,CAAC;QAED,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAE7C,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC;YACrD,IAAI,EAAE;gBACJ,KAAK,EAAE,GAAG,CAAC,KAAK;gBAChB,QAAQ,EAAE,IAAI;gBACd,IAAI,EAAE,GAAG,CAAC,IAAI;aACf;SACF,CAAC,CAAC;QAEH,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CACjC,OAAO,CAAC,EAAE,EACV,OAAO,CAAC,KAAK,EACb,OAAO,CAAC,IAAI,CACb,CAAC;QACF,MAAM,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,EAAE,EAAE,MAAM,CAAC,aAAa,CAAC,CAAC;QAE1D,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;IAC3C,CAAC;IAED,KAAK,CAAC,WAAW,CAAC,GAAa,EAAE,GAAa;QAC5C,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACtD,KAAK,EAAE,EAAE,KAAK,EAAE,GAAG,CAAC,KAAK,EAAE;SAC5B,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI;YACP,MAAM,IAAI,2BAAkB,CAAC,oCAAoC,CAAC,CAAC;QAErE,MAAM,eAAe,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,QAAQ,EAAE,GAAG,CAAC,QAAQ,CAAC,CAAC;QACzE,IAAI,CAAC,eAAe;YAClB,MAAM,IAAI,2BAAkB,CAAC,oCAAoC,CAAC,CAAC;QAErE,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;QACpE,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,aAAa,CAAC,CAAC;QAEvD,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;IAC3C,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,MAAc,EAAE,GAAa;QACxC,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACzC,KAAK,EAAE;gBACL,EAAE,EAAE,MAAM;gBACV,gBAAgB,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE;aAChC;YACD,IAAI,EAAE,EAAE,gBAAgB,EAAE,IAAI,EAAE;SACjC,CAAC,CAAC;QAEH,GAAG,CAAC,WAAW,CAAC,eAAe,EAAE;YAC/B,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,UAAU,CAAC,KAAK,YAAY;YAC5D,QAAQ,EAAE,QAAQ;SACnB,CAAC,CAAC;QAEH,OAAO,EAAE,OAAO,EAAE,IAAI,EAAE,CAAC;IAC3B,CAAC;IAED,KAAK,CAAC,aAAa,CAAC,MAAc,EAAE,EAAU,EAAE,GAAa;QAC3D,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACtD,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;SACtB,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,gBAAgB;YACjC,MAAM,IAAI,2BAAkB,CAAC,gCAAgC,CAAC,CAAC;QAEjE,MAAM,SAAS,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,gBAAgB,EAAE,EAAE,CAAC,CAAC;QACjE,IAAI,CAAC,SAAS;YACZ,MAAM,IAAI,2BAAkB,CAAC,8BAA8B,CAAC,CAAC;QAE/D,MAAM,MAAM,GAAG,MAAM,IAAI,CAAC,SAAS,CAAC,IAAI,CAAC,EAAE,EAAE,IAAI,CAAC,KAAK,EAAE,IAAI,CAAC,IAAI,CAAC,CAAC;QACpE,MAAM,IAAI,CAAC,YAAY,CAAC,IAAI,CAAC,EAAE,EAAE,MAAM,CAAC,aAAa,CAAC,CAAC;QAEvD,OAAO,IAAI,CAAC,eAAe,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;IAC3C,CAAC;IAED,KAAK,CAAC,YAAY,CAAC,MAAc,EAAE,EAAU;QAC3C,MAAM,IAAI,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,EAAE,CAAC,CAAC;QACnC,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC;YACrC,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,IAAI,EAAE,EAAE,gBAAgB,EAAE,IAAI,EAAE;SACjC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,SAAS,CAAC,MAAc,EAAE,KAAa,EAAE,IAAY;QACzD,IAAI,CAAC;YACH,MAAM,CAAC,EAAE,EAAE,EAAE,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;gBACjC,IAAI,CAAC,UAAU,CAAC,SAAS,CACvB,EAAE,GAAG,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,EAC5B;oBACE,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;oBAC5C,SAAS,EAAE,KAAK;iBACjB,CACF;gBACD,IAAI,CAAC,UAAU,CAAC,SAAS,CACvB,EAAE,GAAG,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,EAC5B;oBACE,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;oBAC5C,SAAS,EAAE,IAAI;iBAChB,CACF;aACF,CAAC,CAAC;YAEH,OAAO,EAAE,YAAY,EAAE,EAAE,EAAE,aAAa,EAAE,EAAE,EAAE,CAAC;QACjD,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,4BAA4B,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,EAAE,CACvF,CAAC;YACF,MAAM,IAAI,qCAA4B,CAAC,wBAAwB,CAAC,CAAC;QACnE,CAAC;IACH,CAAC;IAEO,eAAe,CACrB,GAAa,EACb,MAAuD;QAEvD,MAAM,YAAY,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,UAAU,CAAC,KAAK,YAAY,CAAC;QAE1E,GAAG,CAAC,MAAM,CAAC,eAAe,EAAE,MAAM,CAAC,aAAa,EAAE;YAChD,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE,YAAY;YACpB,QAAQ,EAAE,QAAQ;YAClB,MAAM,EAAE,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI;SAChC,CAAC,CAAC;QAEH,OAAO,EAAE,YAAY,EAAE,MAAM,CAAC,YAAY,EAAE,CAAC;IAC/C,CAAC;CACF,CAAA;AA/IY,kCAAW;sBAAX,WAAW;IADvB,IAAA,mBAAU,GAAE;qCAKO,8BAAa;QACT,gBAAU;QACd,sBAAa;GANpB,WAAW,CA+IvB"}

================================================================================
File: bff-nestjs/dist/src/auth/dto/auth.dto.d.ts
Size: 171 B
================================================================================

export declare class RegisterDto {
    email: string;
    password: string;
    name: string;
}
export declare class LoginDto {
    email: string;
    password: string;
}


================================================================================
File: bff-nestjs/dist/src/auth/dto/auth.dto.js
Size: 2.9 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.LoginDto = exports.RegisterDto = void 0;
const class_validator_1 = require("class-validator");
const swagger_1 = require("@nestjs/swagger");
class RegisterDto {
    email;
    password;
    name;
}
exports.RegisterDto = RegisterDto;
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'User corporate email',
        example: 'user@example.com',
    }),
    (0, class_validator_1.IsEmail)({}, { message: 'Please provide a valid email address' }),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], RegisterDto.prototype, "email", void 0);
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'Secure password',
        minLength: 8,
        example: 'password123',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    (0, class_validator_1.MinLength)(8, { message: 'Password must be at least 8 characters long' }),
    (0, class_validator_1.MaxLength)(32),
    __metadata("design:type", String)
], RegisterDto.prototype, "password", void 0);
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'Full name for the profile',
        example: 'John Doe',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    (0, class_validator_1.MaxLength)(100),
    __metadata("design:type", String)
], RegisterDto.prototype, "name", void 0);
class LoginDto {
    email;
    password;
}
exports.LoginDto = LoginDto;
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'User email for login',
        example: 'user@example.com',
    }),
    (0, class_validator_1.IsEmail)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], LoginDto.prototype, "email", void 0);
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'User password',
        example: 'password123',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], LoginDto.prototype, "password", void 0);
//# sourceMappingURL=auth.dto.js.map

================================================================================
File: bff-nestjs/dist/src/auth/dto/auth.dto.js.map
Size: 1.15 kB
================================================================================

{"version":3,"file":"auth.dto.js","sourceRoot":"","sources":["../../../../src/auth/dto/auth.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAMyB;AACzB,6CAA8C;AAE9C,MAAa,WAAW;IAOtB,KAAK,CAAU;IAWf,QAAQ,CAAU;IASlB,IAAI,CAAU;CACf;AA5BD,kCA4BC;AArBC;IANC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,sBAAsB;QACnC,OAAO,EAAE,kBAAkB;KAC5B,CAAC;IACD,IAAA,yBAAO,EAAC,EAAE,EAAE,EAAE,OAAO,EAAE,sCAAsC,EAAE,CAAC;IAChE,IAAA,4BAAU,GAAE;;0CACE;AAWf;IATC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,iBAAiB;QAC9B,SAAS,EAAE,CAAC;QACZ,OAAO,EAAE,aAAa;KACvB,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;IACZ,IAAA,2BAAS,EAAC,CAAC,EAAE,EAAE,OAAO,EAAE,6CAA6C,EAAE,CAAC;IACxE,IAAA,2BAAS,EAAC,EAAE,CAAC;;6CACI;AASlB;IAPC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,2BAA2B;QACxC,OAAO,EAAE,UAAU;KACpB,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;IACZ,IAAA,2BAAS,EAAC,GAAG,CAAC;;yCACD;AAGhB,MAAa,QAAQ;IAOnB,KAAK,CAAU;IAQf,QAAQ,CAAU;CACnB;AAhBD,4BAgBC;AATC;IANC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,sBAAsB;QACnC,OAAO,EAAE,kBAAkB;KAC5B,CAAC;IACD,IAAA,yBAAO,GAAE;IACT,IAAA,4BAAU,GAAE;;uCACE;AAQf;IANC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,eAAe;QAC5B,OAAO,EAAE,aAAa;KACvB,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;;0CACK"}

================================================================================
File: bff-nestjs/dist/src/auth/entities/user.entity.d.ts
Size: 275 B
================================================================================

import { Role } from '@prisma/client';
export declare class User {
    id: number;
    email: string;
    name: string | null;
    role: Role;
    password: string;
    refreshTokenHash?: string | null;
    createdAt: Date;
    updatedAt: Date;
    deletedAt: Date | null;
}


================================================================================
File: bff-nestjs/dist/src/auth/entities/user.entity.js
Size: 295 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.User = void 0;
class User {
    id;
    email;
    name;
    role;
    password;
    refreshTokenHash;
    createdAt;
    updatedAt;
    deletedAt;
}
exports.User = User;
//# sourceMappingURL=user.entity.js.map

================================================================================
File: bff-nestjs/dist/src/auth/entities/user.entity.js.map
Size: 315 B
================================================================================

{"version":3,"file":"user.entity.js","sourceRoot":"","sources":["../../../../src/auth/entities/user.entity.ts"],"names":[],"mappings":";;;AAEA,MAAa,IAAI;IACf,EAAE,CAAU;IACZ,KAAK,CAAU;IACf,IAAI,CAAiB;IACrB,IAAI,CAAQ;IACZ,QAAQ,CAAU;IAClB,gBAAgB,CAAiB;IACjC,SAAS,CAAQ;IACjB,SAAS,CAAQ;IACjB,SAAS,CAAe;CACzB;AAVD,oBAUC"}

================================================================================
File: bff-nestjs/dist/src/auth/guards/at.guard.d.ts
Size: 429 B
================================================================================

import { ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
declare const AtGuard_base: import("@nestjs/passport").Type<import("@nestjs/passport").IAuthGuard>;
export declare class AtGuard extends AtGuard_base {
    private reflector;
    constructor(reflector: Reflector);
    canActivate(context: ExecutionContext): boolean | Promise<boolean> | import("rxjs").Observable<boolean>;
}
export {};


================================================================================
File: bff-nestjs/dist/src/auth/guards/at.guard.js
Size: 1.84 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AtGuard = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const passport_1 = require("@nestjs/passport");
const public_decorator_1 = require("../../common/decorators/public.decorator");
let AtGuard = class AtGuard extends (0, passport_1.AuthGuard)('jwt') {
    reflector;
    constructor(reflector) {
        super();
        this.reflector = reflector;
    }
    canActivate(context) {
        const isPublic = this.reflector.getAllAndOverride(public_decorator_1.IS_PUBLIC_KEY, [
            context.getHandler(),
            context.getClass(),
        ]);
        console.log(`--- AtGuard --- Route: ${context.getHandler().name} | Public: ${isPublic}`);
        if (isPublic)
            return true;
        return super.canActivate(context);
    }
};
exports.AtGuard = AtGuard;
exports.AtGuard = AtGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [core_1.Reflector])
], AtGuard);
//# sourceMappingURL=at.guard.js.map

================================================================================
File: bff-nestjs/dist/src/auth/guards/at.guard.js.map
Size: 753 B
================================================================================

{"version":3,"file":"at.guard.js","sourceRoot":"","sources":["../../../../src/auth/guards/at.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;AACA,2CAA8D;AAC9D,uCAAyC;AACzC,+CAA6C;AAC7C,+EAAyE;AAGlE,IAAM,OAAO,GAAb,MAAM,OAAQ,SAAQ,IAAA,oBAAS,EAAC,KAAK,CAAC;IACvB;IAApB,YAAoB,SAAoB;QACtC,KAAK,EAAE,CAAC;QADU,cAAS,GAAT,SAAS,CAAW;IAExC,CAAC;IAED,WAAW,CAAC,OAAyB;QACnC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAU,gCAAa,EAAE;YACxE,OAAO,CAAC,UAAU,EAAE;YACpB,OAAO,CAAC,QAAQ,EAAE;SACnB,CAAC,CAAC;QAGH,OAAO,CAAC,GAAG,CACT,0BAA0B,OAAO,CAAC,UAAU,EAAE,CAAC,IAAI,cAAc,QAAQ,EAAE,CAC5E,CAAC;QAEF,IAAI,QAAQ;YAAE,OAAO,IAAI,CAAC;QAE1B,OAAO,KAAK,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC;IACpC,CAAC;CACF,CAAA;AApBY,0BAAO;kBAAP,OAAO;IADnB,IAAA,mBAAU,GAAE;qCAEoB,gBAAS;GAD7B,OAAO,CAoBnB"}

================================================================================
File: bff-nestjs/dist/src/auth/guards/rt.guard.d.ts
Size: 184 B
================================================================================

declare const RtGuard_base: import("@nestjs/passport").Type<import("@nestjs/passport").IAuthGuard>;
export declare class RtGuard extends RtGuard_base {
    constructor();
}
export {};


================================================================================
File: bff-nestjs/dist/src/auth/guards/rt.guard.js
Size: 1.26 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RtGuard = void 0;
const common_1 = require("@nestjs/common");
const passport_1 = require("@nestjs/passport");
let RtGuard = class RtGuard extends (0, passport_1.AuthGuard)('jwt-refresh') {
    constructor() {
        super();
    }
};
exports.RtGuard = RtGuard;
exports.RtGuard = RtGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [])
], RtGuard);
//# sourceMappingURL=rt.guard.js.map

================================================================================
File: bff-nestjs/dist/src/auth/guards/rt.guard.js.map
Size: 334 B
================================================================================

{"version":3,"file":"rt.guard.js","sourceRoot":"","sources":["../../../../src/auth/guards/rt.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAA4C;AAC5C,+CAA6C;AAGtC,IAAM,OAAO,GAAb,MAAM,OAAQ,SAAQ,IAAA,oBAAS,EAAC,aAAa,CAAC;IACnD;QACE,KAAK,EAAE,CAAC;IACV,CAAC;CACF,CAAA;AAJY,0BAAO;kBAAP,OAAO;IADnB,IAAA,mBAAU,GAAE;;GACA,OAAO,CAInB"}

================================================================================
File: bff-nestjs/dist/src/auth/guards/ws-jwt.guard.d.ts
Size: 412 B
================================================================================

import { CanActivate, ExecutionContext } from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
export declare class WsJwtGuard implements CanActivate {
    private jwtService;
    private config;
    private readonly logger;
    constructor(jwtService: JwtService, config: ConfigService);
    canActivate(context: ExecutionContext): Promise<boolean>;
}


================================================================================
File: bff-nestjs/dist/src/auth/guards/ws-jwt.guard.js
Size: 2.5 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var WsJwtGuard_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.WsJwtGuard = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const config_1 = require("@nestjs/config");
const websockets_1 = require("@nestjs/websockets");
let WsJwtGuard = WsJwtGuard_1 = class WsJwtGuard {
    jwtService;
    config;
    logger = new common_1.Logger(WsJwtGuard_1.name);
    constructor(jwtService, config) {
        this.jwtService = jwtService;
        this.config = config;
    }
    async canActivate(context) {
        try {
            const client = context.switchToWs().getClient();
            const token = client.handshake?.auth?.token ||
                client.handshake?.headers?.authorization?.split(' ')[1];
            if (!token) {
                this.logger.warn('WebSocket connection attempt rejected: No token provided');
                throw new websockets_1.WsException('Unauthorized');
            }
            const payload = await this.jwtService.verifyAsync(token, {
                secret: this.config.get('AT_SECRET'),
            });
            client.user = payload;
            return true;
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            this.logger.error(`WebSocket JWT Verification failed: ${errorMessage}`);
            throw new websockets_1.WsException('Unauthorized');
        }
    }
};
exports.WsJwtGuard = WsJwtGuard;
exports.WsJwtGuard = WsJwtGuard = WsJwtGuard_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [jwt_1.JwtService,
        config_1.ConfigService])
], WsJwtGuard);
//# sourceMappingURL=ws-jwt.guard.js.map

================================================================================
File: bff-nestjs/dist/src/auth/guards/ws-jwt.guard.js.map
Size: 1.32 kB
================================================================================

{"version":3,"file":"ws-jwt.guard.js","sourceRoot":"","sources":["../../../../src/auth/guards/ws-jwt.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAKwB;AACxB,qCAAyC;AACzC,2CAA+C;AAC/C,mDAAiD;AAG1C,IAAM,UAAU,kBAAhB,MAAM,UAAU;IAIX;IACA;IAJO,MAAM,GAAG,IAAI,eAAM,CAAC,YAAU,CAAC,IAAI,CAAC,CAAC;IAEtD,YACU,UAAsB,EACtB,MAAqB;QADrB,eAAU,GAAV,UAAU,CAAY;QACtB,WAAM,GAAN,MAAM,CAAe;IAC5B,CAAC;IAEJ,KAAK,CAAC,WAAW,CAAC,OAAyB;QACzC,IAAI,CAAC;YACH,MAAM,MAAM,GAAG,OAAO,CAAC,UAAU,EAAE,CAAC,SAAS,EAAE,CAAC;YAGhD,MAAM,KAAK,GACT,MAAM,CAAC,SAAS,EAAE,IAAI,EAAE,KAAK;gBAC7B,MAAM,CAAC,SAAS,EAAE,OAAO,EAAE,aAAa,EAAE,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YAE1D,IAAI,CAAC,KAAK,EAAE,CAAC;gBACX,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,0DAA0D,CAC3D,CAAC;gBACF,MAAM,IAAI,wBAAW,CAAC,cAAc,CAAC,CAAC;YACxC,CAAC;YAGD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,KAAK,EAAE;gBACvD,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;aAC7C,CAAC,CAAC;YAGH,MAAM,CAAC,IAAI,GAAG,OAAO,CAAC;YAEtB,OAAO,IAAI,CAAC;QACd,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YAExB,MAAM,YAAY,GAChB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CAAC;YAC3D,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,sCAAsC,YAAY,EAAE,CAAC,CAAC;YAExE,MAAM,IAAI,wBAAW,CAAC,cAAc,CAAC,CAAC;QACxC,CAAC;IACH,CAAC;CACF,CAAA;AA1CY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAKW,gBAAU;QACd,sBAAa;GALpB,UAAU,CA0CtB"}

================================================================================
File: bff-nestjs/dist/src/auth/strategies/at.strategy.d.ts
Size: 584 B
================================================================================

import { ConfigService } from '@nestjs/config';
import { Strategy } from 'passport-jwt';
import { Role } from '@prisma/client';
type JwtPayload = {
    sub: number;
    email: string;
    role: Role;
};
declare const AtStrategy_base: new (...args: [opt: import("passport-jwt").StrategyOptionsWithRequest] | [opt: import("passport-jwt").StrategyOptionsWithoutRequest]) => Strategy & {
    validate(...args: any[]): unknown;
};
export declare class AtStrategy extends AtStrategy_base {
    constructor(config: ConfigService);
    validate(payload: JwtPayload): JwtPayload;
}
export {};


================================================================================
File: bff-nestjs/dist/src/auth/strategies/at.strategy.js
Size: 1.64 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AtStrategy = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const passport_1 = require("@nestjs/passport");
const passport_jwt_1 = require("passport-jwt");
let AtStrategy = class AtStrategy extends (0, passport_1.PassportStrategy)(passport_jwt_1.Strategy, 'jwt') {
    constructor(config) {
        super({
            jwtFromRequest: passport_jwt_1.ExtractJwt.fromAuthHeaderAsBearerToken(),
            secretOrKey: config.getOrThrow('AT_SECRET'),
        });
    }
    validate(payload) {
        return payload;
    }
};
exports.AtStrategy = AtStrategy;
exports.AtStrategy = AtStrategy = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], AtStrategy);
//# sourceMappingURL=at.strategy.js.map

================================================================================
File: bff-nestjs/dist/src/auth/strategies/at.strategy.js.map
Size: 555 B
================================================================================

{"version":3,"file":"at.strategy.js","sourceRoot":"","sources":["../../../../src/auth/strategies/at.strategy.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAA4C;AAC5C,2CAA+C;AAC/C,+CAAoD;AACpD,+CAAoD;AAW7C,IAAM,UAAU,GAAhB,MAAM,UAAW,SAAQ,IAAA,2BAAgB,EAAC,uBAAQ,EAAE,KAAK,CAAC;IAC/D,YAAY,MAAqB;QAC/B,KAAK,CAAC;YACJ,cAAc,EAAE,yBAAU,CAAC,2BAA2B,EAAE;YACxD,WAAW,EAAE,MAAM,CAAC,UAAU,CAAS,WAAW,CAAC;SACpD,CAAC,CAAC;IACL,CAAC;IAED,QAAQ,CAAC,OAAmB;QAE1B,OAAO,OAAO,CAAC;IACjB,CAAC;CACF,CAAA;AAZY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAES,sBAAa;GADtB,UAAU,CAYtB"}

================================================================================
File: bff-nestjs/dist/src/auth/strategies/index.d.ts
Size: 62 B
================================================================================

export * from './at.strategy';
export * from './rt.strategy';


================================================================================
File: bff-nestjs/dist/src/auth/strategies/index.js
Size: 888 B
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
__exportStar(require("./at.strategy"), exports);
__exportStar(require("./rt.strategy"), exports);
//# sourceMappingURL=index.js.map

================================================================================
File: bff-nestjs/dist/src/auth/strategies/index.js.map
Size: 167 B
================================================================================

{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/auth/strategies/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;AACA,gDAA8B;AAC9B,gDAA8B"}

================================================================================
File: bff-nestjs/dist/src/auth/strategies/rt.strategy.d.ts
Size: 505 B
================================================================================

import { Strategy } from 'passport-jwt';
import { Request } from 'express';
import { ConfigService } from '@nestjs/config';
declare const RtStrategy_base: new (...args: [opt: import("passport-jwt").StrategyOptionsWithRequest] | [opt: import("passport-jwt").StrategyOptionsWithoutRequest]) => Strategy & {
    validate(...args: any[]): unknown;
};
export declare class RtStrategy extends RtStrategy_base {
    constructor(config: ConfigService);
    validate(req: Request, payload: any): any;
}
export {};


================================================================================
File: bff-nestjs/dist/src/auth/strategies/rt.strategy.js
Size: 1.96 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RtStrategy = void 0;
const passport_1 = require("@nestjs/passport");
const passport_jwt_1 = require("passport-jwt");
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
let RtStrategy = class RtStrategy extends (0, passport_1.PassportStrategy)(passport_jwt_1.Strategy, 'jwt-refresh') {
    constructor(config) {
        super({
            jwtFromRequest: passport_jwt_1.ExtractJwt.fromAuthHeaderAsBearerToken(),
            secretOrKey: config.getOrThrow('RT_SECRET'),
            passReqToCallback: true,
        });
    }
    validate(req, payload) {
        const authHeader = req.get('authorization');
        if (!authHeader)
            throw new common_1.ForbiddenException('Refresh token missing');
        const refreshToken = authHeader.replace('Bearer', '').trim();
        return {
            ...payload,
            refreshToken,
        };
    }
};
exports.RtStrategy = RtStrategy;
exports.RtStrategy = RtStrategy = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], RtStrategy);
//# sourceMappingURL=rt.strategy.js.map

================================================================================
File: bff-nestjs/dist/src/auth/strategies/rt.strategy.js.map
Size: 815 B
================================================================================

{"version":3,"file":"rt.strategy.js","sourceRoot":"","sources":["../../../../src/auth/strategies/rt.strategy.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,+CAAoD;AACpD,+CAAoD;AAEpD,2CAAgE;AAChE,2CAA+C;AAGxC,IAAM,UAAU,GAAhB,MAAM,UAAW,SAAQ,IAAA,2BAAgB,EAAC,uBAAQ,EAAE,aAAa,CAAC;IACvE,YAAY,MAAqB;QAC/B,KAAK,CAAC;YACJ,cAAc,EAAE,yBAAU,CAAC,2BAA2B,EAAE;YAExD,WAAW,EAAE,MAAM,CAAC,UAAU,CAAS,WAAW,CAAC;YACnD,iBAAiB,EAAE,IAAI;SACxB,CAAC,CAAC;IACL,CAAC;IAGD,QAAQ,CAAC,GAAY,EAAE,OAAY;QACjC,MAAM,UAAU,GAAG,GAAG,CAAC,GAAG,CAAC,eAAe,CAAC,CAAC;QAC5C,IAAI,CAAC,UAAU;YAAE,MAAM,IAAI,2BAAkB,CAAC,uBAAuB,CAAC,CAAC;QAEvE,MAAM,YAAY,GAAG,UAAU,CAAC,OAAO,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC,IAAI,EAAE,CAAC;QAE7D,OAAO;YACL,GAAG,OAAO;YACV,YAAY;SACb,CAAC;IACJ,CAAC;CACF,CAAA;AAtBY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAES,sBAAa;GADtB,UAAU,CAsBtB"}

================================================================================
File: bff-nestjs/dist/src/common/config/env.validation.d.ts
Size: 93 B
================================================================================

import * as Joi from 'joi';
export declare const envValidationSchema: Joi.ObjectSchema<any>;


================================================================================
File: bff-nestjs/dist/src/common/config/env.validation.js
Size: 2.21 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.envValidationSchema = void 0;
const Joi = __importStar(require("joi"));
exports.envValidationSchema = Joi.object({
    NODE_ENV: Joi.string()
        .valid('development', 'production', 'test')
        .default('development'),
    PORT: Joi.number().default(3001),
    DATABASE_URL: Joi.string().required(),
    AT_SECRET: Joi.string().required(),
    RT_SECRET: Joi.string().required(),
    REDIS_HOST: Joi.string().default('localhost'),
    REDIS_PORT: Joi.number().default(6379),
    MAIL_HOST: Joi.string().required(),
    MAIL_PORT: Joi.number().required(),
    MAIL_USER: Joi.string().required(),
    MAIL_PASS: Joi.string().required(),
    MAIL_FROM: Joi.string().default('"Team Platform" <no-reply@test.com>'),
});
//# sourceMappingURL=env.validation.js.map

================================================================================
File: bff-nestjs/dist/src/common/config/env.validation.js.map
Size: 959 B
================================================================================

{"version":3,"file":"env.validation.js","sourceRoot":"","sources":["../../../../src/common/config/env.validation.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AACA,yCAA2B;AAEd,QAAA,mBAAmB,GAAG,GAAG,CAAC,MAAM,CAAC;IAC5C,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE;SACnB,KAAK,CAAC,aAAa,EAAE,YAAY,EAAE,MAAM,CAAC;SAC1C,OAAO,CAAC,aAAa,CAAC;IACzB,IAAI,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IAChC,YAAY,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAErC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAElC,UAAU,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,WAAW,CAAC;IAC7C,UAAU,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IAEtC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,qCAAqC,CAAC;CACvE,CAAC,CAAC"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-id.decorator.d.ts
Size: 227 B
================================================================================

export declare const GetCurrentUserId: (...dataOrPipes: (import("@nestjs/common").PipeTransform<any, any> | import("@nestjs/common").Type<import("@nestjs/common").PipeTransform<any, any>> | undefined)[]) => ParameterDecorator;


================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-id.decorator.js
Size: 423 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetCurrentUserId = void 0;
const common_1 = require("@nestjs/common");
exports.GetCurrentUserId = (0, common_1.createParamDecorator)((data, context) => {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    return user ? user.sub : null;
});
//# sourceMappingURL=get-current-user-id.decorator.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-id.decorator.js.map
Size: 458 B
================================================================================

{"version":3,"file":"get-current-user-id.decorator.js","sourceRoot":"","sources":["../../../../src/common/decorators/get-current-user-id.decorator.ts"],"names":[],"mappings":";;;AAAA,2CAAwE;AAE3D,QAAA,gBAAgB,GAAG,IAAA,6BAAoB,EAClD,CAAC,IAAe,EAAE,OAAyB,EAAiB,EAAE;IAC5D,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;IACpD,MAAM,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;IAC1B,OAAO,IAAI,CAAC,CAAC,CAAE,IAAY,CAAC,GAAG,CAAC,CAAC,CAAC,IAAI,CAAC;AACzC,CAAC,CACF,CAAC"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-role.decorator.d.ts
Size: 92 B
================================================================================

export declare const GetCurrentUserRole: (...dataOrPipes: unknown[]) => ParameterDecorator;


================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-role.decorator.js
Size: 430 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetCurrentUserRole = void 0;
const common_1 = require("@nestjs/common");
exports.GetCurrentUserRole = (0, common_1.createParamDecorator)((data, context) => {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    return user ? user.role : null;
});
//# sourceMappingURL=get-current-user-role.decorator.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user-role.decorator.js.map
Size: 461 B
================================================================================

{"version":3,"file":"get-current-user-role.decorator.js","sourceRoot":"","sources":["../../../../src/common/decorators/get-current-user-role.decorator.ts"],"names":[],"mappings":";;;AAAA,2CAAwE;AAG3D,QAAA,kBAAkB,GAAG,IAAA,6BAAoB,EACpD,CAAC,IAAa,EAAE,OAAyB,EAAe,EAAE;IACxD,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;IACpD,MAAM,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;IAC1B,OAAO,IAAI,CAAC,CAAC,CAAE,IAAY,CAAC,IAAI,CAAC,CAAC,CAAC,IAAI,CAAC;AAC1C,CAAC,CACF,CAAC"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user.decorator.d.ts
Size: 234 B
================================================================================

export declare const GetCurrentUser: (...dataOrPipes: (string | import("@nestjs/common").PipeTransform<any, any> | import("@nestjs/common").Type<import("@nestjs/common").PipeTransform<any, any>> | undefined)[]) => ParameterDecorator;


================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user.decorator.js
Size: 427 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.GetCurrentUser = void 0;
const common_1 = require("@nestjs/common");
exports.GetCurrentUser = (0, common_1.createParamDecorator)((data, context) => {
    const request = context.switchToHttp().getRequest();
    if (!data)
        return request.user;
    return request.user?.[data];
});
//# sourceMappingURL=get-current-user.decorator.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/get-current-user.decorator.js.map
Size: 440 B
================================================================================

{"version":3,"file":"get-current-user.decorator.js","sourceRoot":"","sources":["../../../../src/common/decorators/get-current-user.decorator.ts"],"names":[],"mappings":";;;AAAA,2CAAwE;AAE3D,QAAA,cAAc,GAAG,IAAA,6BAAoB,EAChD,CAAC,IAAwB,EAAE,OAAyB,EAAE,EAAE;IACtD,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;IACpD,IAAI,CAAC,IAAI;QAAE,OAAO,OAAO,CAAC,IAAI,CAAC;IAC/B,OAAO,OAAO,CAAC,IAAI,EAAE,CAAC,IAAI,CAAC,CAAC;AAC9B,CAAC,CACF,CAAC"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/index.d.ts
Size: 217 B
================================================================================

export * from './public.decorator';
export * from './get-current-user-id.decorator';
export * from './get-current-user-role.decorator';
export * from './get-current-user.decorator';
export * from './roles.decorator';


================================================================================
File: bff-nestjs/dist/src/common/decorators/index.js
Size: 1.1 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
__exportStar(require("./public.decorator"), exports);
__exportStar(require("./get-current-user-id.decorator"), exports);
__exportStar(require("./get-current-user-role.decorator"), exports);
__exportStar(require("./get-current-user.decorator"), exports);
__exportStar(require("./roles.decorator"), exports);
//# sourceMappingURL=index.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/index.js.map
Size: 208 B
================================================================================

{"version":3,"file":"index.js","sourceRoot":"","sources":["../../../../src/common/decorators/index.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA,qDAAmC;AACnC,kEAAgD;AAChD,oEAAkD;AAClD,+DAA6C;AAC7C,oDAAkC"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/public.decorator.d.ts
Size: 134 B
================================================================================

export declare const IS_PUBLIC_KEY = "isPublic";
export declare const Public: () => import("@nestjs/common").CustomDecorator<string>;


================================================================================
File: bff-nestjs/dist/src/common/decorators/public.decorator.js
Size: 352 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Public = exports.IS_PUBLIC_KEY = void 0;
const common_1 = require("@nestjs/common");
exports.IS_PUBLIC_KEY = 'isPublic';
const Public = () => (0, common_1.SetMetadata)(exports.IS_PUBLIC_KEY, true);
exports.Public = Public;
//# sourceMappingURL=public.decorator.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/public.decorator.js.map
Size: 296 B
================================================================================

{"version":3,"file":"public.decorator.js","sourceRoot":"","sources":["../../../../src/common/decorators/public.decorator.ts"],"names":[],"mappings":";;;AAAA,2CAA6C;AAEhC,QAAA,aAAa,GAAG,UAAU,CAAC;AACjC,MAAM,MAAM,GAAG,GAAG,EAAE,CAAC,IAAA,oBAAW,EAAC,qBAAa,EAAE,IAAI,CAAC,CAAC;AAAhD,QAAA,MAAM,UAA0C"}

================================================================================
File: bff-nestjs/dist/src/common/decorators/roles.decorator.d.ts
Size: 181 B
================================================================================

import { Role } from '@prisma/client';
export declare const ROLES_KEY = "roles";
export declare const Roles: (...roles: Role[]) => import("@nestjs/common").CustomDecorator<string>;


================================================================================
File: bff-nestjs/dist/src/common/decorators/roles.decorator.js
Size: 341 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Roles = exports.ROLES_KEY = void 0;
const common_1 = require("@nestjs/common");
exports.ROLES_KEY = 'roles';
const Roles = (...roles) => (0, common_1.SetMetadata)(exports.ROLES_KEY, roles);
exports.Roles = Roles;
//# sourceMappingURL=roles.decorator.js.map

================================================================================
File: bff-nestjs/dist/src/common/decorators/roles.decorator.js.map
Size: 309 B
================================================================================

{"version":3,"file":"roles.decorator.js","sourceRoot":"","sources":["../../../../src/common/decorators/roles.decorator.ts"],"names":[],"mappings":";;;AAAA,2CAA6C;AAGhC,QAAA,SAAS,GAAG,OAAO,CAAC;AAC1B,MAAM,KAAK,GAAG,CAAC,GAAG,KAAa,EAAE,EAAE,CAAC,IAAA,oBAAW,EAAC,iBAAS,EAAE,KAAK,CAAC,CAAC;AAA5D,QAAA,KAAK,SAAuD"}

================================================================================
File: bff-nestjs/dist/src/common/filters/http-exception.filter.d.ts
Size: 355 B
================================================================================

import { ExceptionFilter, ArgumentsHost } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
export declare class AllExceptionsFilter implements ExceptionFilter {
    private readonly configService;
    private readonly logger;
    constructor(configService: ConfigService);
    catch(exception: unknown, host: ArgumentsHost): void;
}


================================================================================
File: bff-nestjs/dist/src/common/filters/http-exception.filter.js
Size: 2.79 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AllExceptionsFilter_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AllExceptionsFilter = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
let AllExceptionsFilter = AllExceptionsFilter_1 = class AllExceptionsFilter {
    configService;
    logger = new common_1.Logger(AllExceptionsFilter_1.name);
    constructor(configService) {
        this.configService = configService;
    }
    catch(exception, host) {
        const ctx = host.switchToHttp();
        const response = ctx.getResponse();
        const request = ctx.getRequest();
        const nodeEnv = this.configService.get('NODE_ENV');
        const status = exception instanceof common_1.HttpException
            ? exception.getStatus()
            : common_1.HttpStatus.INTERNAL_SERVER_ERROR;
        let message = 'Internal server error';
        if (exception instanceof common_1.HttpException) {
            const res = exception.getResponse();
            message = typeof res === 'object' ? res.message : res;
        }
        else if (nodeEnv !== 'production') {
            message =
                exception instanceof Error ? exception.message : String(exception);
        }
        const errorResponse = {
            statusCode: status,
            timestamp: new Date().toISOString(),
            path: request.url,
            method: request.method,
            message: message,
        };
        this.logger.error(`[${request.method}] ${request.url} - Status: ${status} - Error: ${exception instanceof Error ? exception.message : 'Unknown'}`, exception instanceof Error ? exception.stack : undefined);
        response.status(status).json(errorResponse);
    }
};
exports.AllExceptionsFilter = AllExceptionsFilter;
exports.AllExceptionsFilter = AllExceptionsFilter = AllExceptionsFilter_1 = __decorate([
    (0, common_1.Catch)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], AllExceptionsFilter);
//# sourceMappingURL=http-exception.filter.js.map

================================================================================
File: bff-nestjs/dist/src/common/filters/http-exception.filter.js.map
Size: 1.66 kB
================================================================================

{"version":3,"file":"http-exception.filter.js","sourceRoot":"","sources":["../../../../src/common/filters/http-exception.filter.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAOwB;AACxB,2CAA+C;AAIxC,IAAM,mBAAmB,2BAAzB,MAAM,mBAAmB;IAGD;IAFZ,MAAM,GAAG,IAAI,eAAM,CAAC,qBAAmB,CAAC,IAAI,CAAC,CAAC;IAE/D,YAA6B,aAA4B;QAA5B,kBAAa,GAAb,aAAa,CAAe;IAAG,CAAC;IAE7D,KAAK,CAAC,SAAkB,EAAE,IAAmB;QAC3C,MAAM,GAAG,GAAG,IAAI,CAAC,YAAY,EAAE,CAAC;QAChC,MAAM,QAAQ,GAAG,GAAG,CAAC,WAAW,EAAY,CAAC;QAC7C,MAAM,OAAO,GAAG,GAAG,CAAC,UAAU,EAAW,CAAC;QAC1C,MAAM,OAAO,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,CAAS,UAAU,CAAC,CAAC;QAE3D,MAAM,MAAM,GACV,SAAS,YAAY,sBAAa;YAChC,CAAC,CAAC,SAAS,CAAC,SAAS,EAAE;YACvB,CAAC,CAAC,mBAAU,CAAC,qBAAqB,CAAC;QAGvC,IAAI,OAAO,GAAG,uBAAuB,CAAC;QACtC,IAAI,SAAS,YAAY,sBAAa,EAAE,CAAC;YACvC,MAAM,GAAG,GAAG,SAAS,CAAC,WAAW,EAAE,CAAC;YACpC,OAAO,GAAG,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAE,GAAW,CAAC,OAAO,CAAC,CAAC,CAAC,GAAG,CAAC;QACjE,CAAC;aAAM,IAAI,OAAO,KAAK,YAAY,EAAE,CAAC;YAEpC,OAAO;gBACL,SAAS,YAAY,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,SAAS,CAAC,CAAC;QACvE,CAAC;QAED,MAAM,aAAa,GAAG;YACpB,UAAU,EAAE,MAAM;YAClB,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;YACnC,IAAI,EAAE,OAAO,CAAC,GAAG;YACjB,MAAM,EAAE,OAAO,CAAC,MAAM;YACtB,OAAO,EAAE,OAAO;SACjB,CAAC;QAGF,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,IAAI,OAAO,CAAC,MAAM,KAAK,OAAO,CAAC,GAAG,cAAc,MAAM,aACpD,SAAS,YAAY,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC,OAAO,CAAC,CAAC,CAAC,SACnD,EAAE,EACF,SAAS,YAAY,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CACzD,CAAC;QAEF,QAAQ,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;IAC9C,CAAC;CACF,CAAA;AA7CY,kDAAmB;8BAAnB,mBAAmB;IAD/B,IAAA,cAAK,GAAE;qCAIsC,sBAAa;GAH9C,mBAAmB,CA6C/B"}

================================================================================
File: bff-nestjs/dist/src/common/guards/roles.guard.d.ts
Size: 393 B
================================================================================

import { CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { PrismaService } from '../../prisma/prisma.service';
export declare class RolesGuard implements CanActivate {
    private reflector;
    private prisma;
    constructor(reflector: Reflector, prisma: PrismaService);
    canActivate(context: ExecutionContext): Promise<boolean>;
}


================================================================================
File: bff-nestjs/dist/src/common/guards/roles.guard.js
Size: 2.9 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.RolesGuard = void 0;
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const client_1 = require("@prisma/client");
const roles_decorator_1 = require("../decorators/roles.decorator");
const public_decorator_1 = require("../decorators/public.decorator");
const prisma_service_1 = require("../../prisma/prisma.service");
let RolesGuard = class RolesGuard {
    reflector;
    prisma;
    constructor(reflector, prisma) {
        this.reflector = reflector;
        this.prisma = prisma;
    }
    async canActivate(context) {
        const isPublic = this.reflector.getAllAndOverride(public_decorator_1.IS_PUBLIC_KEY, [
            context.getHandler(),
            context.getClass(),
        ]);
        if (isPublic)
            return true;
        const requiredRoles = this.reflector.getAllAndOverride(roles_decorator_1.ROLES_KEY, [
            context.getHandler(),
            context.getClass(),
        ]);
        const request = context.switchToHttp().getRequest();
        const user = request.user;
        const teamId = parseInt(request.params.teamId);
        if (user?.role === client_1.Role.ADMIN)
            return true;
        if (requiredRoles && !requiredRoles.some((role) => user.role === role)) {
            throw new common_1.ForbiddenException('Missing required global role');
        }
        if (teamId) {
            const membership = await this.prisma.teamMember.findUnique({
                where: {
                    userId_teamId: { userId: user.sub, teamId: teamId },
                },
            });
            if (!membership) {
                throw new common_1.ForbiddenException('You are not a member of this team');
            }
            request.user.teamRole = membership.role;
        }
        return true;
    }
};
exports.RolesGuard = RolesGuard;
exports.RolesGuard = RolesGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [core_1.Reflector,
        prisma_service_1.PrismaService])
], RolesGuard);
//# sourceMappingURL=roles.guard.js.map

================================================================================
File: bff-nestjs/dist/src/common/guards/roles.guard.js.map
Size: 1.57 kB
================================================================================

{"version":3,"file":"roles.guard.js","sourceRoot":"","sources":["../../../../src/common/guards/roles.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAKwB;AACxB,uCAAyC;AACzC,2CAAgD;AAChD,mEAA0D;AAC1D,qEAA+D;AAC/D,gEAA4D;AAGrD,IAAM,UAAU,GAAhB,MAAM,UAAU;IAEX;IACA;IAFV,YACU,SAAoB,EACpB,MAAqB;QADrB,cAAS,GAAT,SAAS,CAAW;QACpB,WAAM,GAAN,MAAM,CAAe;IAC5B,CAAC;IAEJ,KAAK,CAAC,WAAW,CAAC,OAAyB;QAEzC,MAAM,QAAQ,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAU,gCAAa,EAAE;YACxE,OAAO,CAAC,UAAU,EAAE;YACpB,OAAO,CAAC,QAAQ,EAAE;SACnB,CAAC,CAAC;QACH,IAAI,QAAQ;YAAE,OAAO,IAAI,CAAC;QAG1B,MAAM,aAAa,GAAG,IAAI,CAAC,SAAS,CAAC,iBAAiB,CAAS,2BAAS,EAAE;YACxE,OAAO,CAAC,UAAU,EAAE;YACpB,OAAO,CAAC,QAAQ,EAAE;SACnB,CAAC,CAAC;QAEH,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;QAC1B,MAAM,MAAM,GAAG,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;QAG/C,IAAI,IAAI,EAAE,IAAI,KAAK,aAAI,CAAC,KAAK;YAAE,OAAO,IAAI,CAAC;QAG3C,IAAI,aAAa,IAAI,CAAC,aAAa,CAAC,IAAI,CAAC,CAAC,IAAI,EAAE,EAAE,CAAC,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,EAAE,CAAC;YACvE,MAAM,IAAI,2BAAkB,CAAC,8BAA8B,CAAC,CAAC;QAC/D,CAAC;QAID,IAAI,MAAM,EAAE,CAAC;YACX,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC;gBACzD,KAAK,EAAE;oBACL,aAAa,EAAE,EAAE,MAAM,EAAE,IAAI,CAAC,GAAG,EAAE,MAAM,EAAE,MAAM,EAAE;iBACpD;aACF,CAAC,CAAC;YAEH,IAAI,CAAC,UAAU,EAAE,CAAC;gBAChB,MAAM,IAAI,2BAAkB,CAAC,mCAAmC,CAAC,CAAC;YACpE,CAAC;YAGD,OAAO,CAAC,IAAI,CAAC,QAAQ,GAAG,UAAU,CAAC,IAAI,CAAC;QAC1C,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AAnDY,gCAAU;qBAAV,UAAU;IADtB,IAAA,mBAAU,GAAE;qCAGU,gBAAS;QACZ,8BAAa;GAHpB,UAAU,CAmDtB"}

================================================================================
File: bff-nestjs/dist/src/common/guards/team-member.guard.d.ts
Size: 311 B
================================================================================

import { CanActivate, ExecutionContext } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
export declare class TeamMemberGuard implements CanActivate {
    private prisma;
    constructor(prisma: PrismaService);
    canActivate(context: ExecutionContext): Promise<boolean>;
}


================================================================================
File: bff-nestjs/dist/src/common/guards/team-member.guard.js
Size: 1.96 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeamMemberGuard = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
let TeamMemberGuard = class TeamMemberGuard {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const userId = request.user.sub;
        const teamId = parseInt(request.params.teamId || request.body.teamId);
        if (!teamId)
            return true;
        const membership = await this.prisma.extended.teamMember.findFirst({
            where: {
                userId,
                teamId,
            },
        });
        if (!membership) {
            throw new common_1.ForbiddenException('Access Denied: You do not belong to this team');
        }
        return true;
    }
};
exports.TeamMemberGuard = TeamMemberGuard;
exports.TeamMemberGuard = TeamMemberGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], TeamMemberGuard);
//# sourceMappingURL=team-member.guard.js.map

================================================================================
File: bff-nestjs/dist/src/common/guards/team-member.guard.js.map
Size: 894 B
================================================================================

{"version":3,"file":"team-member.guard.js","sourceRoot":"","sources":["../../../../src/common/guards/team-member.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;AACA,2CAKwB;AACxB,gEAA4D;AAGrD,IAAM,eAAe,GAArB,MAAM,eAAe;IACN;IAApB,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,WAAW,CAAC,OAAyB;QACzC,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,MAAM,GAAG,OAAO,CAAC,IAAI,CAAC,GAAG,CAAC;QAChC,MAAM,MAAM,GAAG,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC,MAAM,IAAI,OAAO,CAAC,IAAI,CAAC,MAAM,CAAC,CAAC;QAEtE,IAAI,CAAC,MAAM;YAAE,OAAO,IAAI,CAAC;QAEzB,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,SAAS,CAAC;YACjE,KAAK,EAAE;gBACL,MAAM;gBACN,MAAM;aACP;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,MAAM,IAAI,2BAAkB,CAC1B,+CAA+C,CAChD,CAAC;QACJ,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AAzBY,0CAAe;0BAAf,eAAe;IAD3B,IAAA,mBAAU,GAAE;qCAEiB,8BAAa;GAD9B,eAAe,CAyB3B"}

================================================================================
File: bff-nestjs/dist/src/common/guards/team-owner.guard.d.ts
Size: 310 B
================================================================================

import { CanActivate, ExecutionContext } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
export declare class TeamOwnerGuard implements CanActivate {
    private prisma;
    constructor(prisma: PrismaService);
    canActivate(context: ExecutionContext): Promise<boolean>;
}


================================================================================
File: bff-nestjs/dist/src/common/guards/team-owner.guard.js
Size: 2.37 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeamOwnerGuard = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const client_1 = require("@prisma/client");
let TeamOwnerGuard = class TeamOwnerGuard {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async canActivate(context) {
        const request = context.switchToHttp().getRequest();
        const user = request.user;
        if (user?.role === client_1.Role.ADMIN)
            return true;
        const userId = user?.sub;
        const teamIdRaw = request.params.id || request.params.teamId;
        const teamId = parseInt(teamIdRaw, 10);
        if (!userId || isNaN(teamId)) {
            throw new common_1.ForbiddenException('User session or Team ID not found');
        }
        const membership = await this.prisma.extended.teamMember.findUnique({
            where: {
                userId_teamId: { userId, teamId },
            },
        });
        if (!membership) {
            throw new common_1.NotFoundException('Team membership not found');
        }
        if (membership.role !== client_1.TeamRole.OWNER) {
            throw new common_1.ForbiddenException('Only the team OWNER can perform this action');
        }
        return true;
    }
};
exports.TeamOwnerGuard = TeamOwnerGuard;
exports.TeamOwnerGuard = TeamOwnerGuard = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], TeamOwnerGuard);
//# sourceMappingURL=team-owner.guard.js.map

================================================================================
File: bff-nestjs/dist/src/common/guards/team-owner.guard.js.map
Size: 1.25 kB
================================================================================

{"version":3,"file":"team-owner.guard.js","sourceRoot":"","sources":["../../../../src/common/guards/team-owner.guard.ts"],"names":[],"mappings":";;;;;;;;;;;;AACA,2CAMwB;AACxB,gEAA4D;AAC5D,2CAAgD;AAGzC,IAAM,cAAc,GAApB,MAAM,cAAc;IACL;IAApB,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,WAAW,CAAC,OAAyB;QACzC,MAAM,OAAO,GAAG,OAAO,CAAC,YAAY,EAAE,CAAC,UAAU,EAAE,CAAC;QACpD,MAAM,IAAI,GAAG,OAAO,CAAC,IAAI,CAAC;QAG1B,IAAI,IAAI,EAAE,IAAI,KAAK,aAAI,CAAC,KAAK;YAAE,OAAO,IAAI,CAAC;QAE3C,MAAM,MAAM,GAAG,IAAI,EAAE,GAAG,CAAC;QACzB,MAAM,SAAS,GAAG,OAAO,CAAC,MAAM,CAAC,EAAE,IAAI,OAAO,CAAC,MAAM,CAAC,MAAM,CAAC;QAC7D,MAAM,MAAM,GAAG,QAAQ,CAAC,SAAS,EAAE,EAAE,CAAC,CAAC;QAEvC,IAAI,CAAC,MAAM,IAAI,KAAK,CAAC,MAAM,CAAC,EAAE,CAAC;YAC7B,MAAM,IAAI,2BAAkB,CAAC,mCAAmC,CAAC,CAAC;QACpE,CAAC;QAGD,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,UAAU,CAAC;YAClE,KAAK,EAAE;gBACL,aAAa,EAAE,EAAE,MAAM,EAAE,MAAM,EAAE;aAClC;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,MAAM,IAAI,0BAAiB,CAAC,2BAA2B,CAAC,CAAC;QAC3D,CAAC;QAED,IAAI,UAAU,CAAC,IAAI,KAAK,iBAAQ,CAAC,KAAK,EAAE,CAAC;YACvC,MAAM,IAAI,2BAAkB,CAC1B,6CAA6C,CAC9C,CAAC;QACJ,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AArCY,wCAAc;yBAAd,cAAc;IAD1B,IAAA,mBAAU,GAAE;qCAEiB,8BAAa;GAD9B,cAAc,CAqC1B"}

================================================================================
File: bff-nestjs/dist/src/common/prisma/soft-delete.extension.d.ts
Size: 190 B
================================================================================

export declare const softDeleteExtension: (client: any) => {
    $extends: {
        extArgs: import("@prisma/client/runtime/library").InternalArgs<unknown, unknown, {}, unknown>;
    };
};


================================================================================
File: bff-nestjs/dist/src/common/prisma/soft-delete.extension.js
Size: 896 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.softDeleteExtension = void 0;
const client_1 = require("@prisma/client");
exports.softDeleteExtension = client_1.Prisma.defineExtension({
    name: 'softDelete',
    query: {
        $allModels: {
            async findMany({ model, operation, args, query }) {
                args.where = { ...args.where, deletedAt: null };
                return query(args);
            },
            async findFirst({ model, operation, args, query }) {
                args.where = { ...args.where, deletedAt: null };
                return query(args);
            },
            async findUnique({ model, operation, args, query }) {
                args.where = { ...args.where, deletedAt: null };
                return query(args);
            },
        },
    },
});
//# sourceMappingURL=soft-delete.extension.js.map

================================================================================
File: bff-nestjs/dist/src/common/prisma/soft-delete.extension.js.map
Size: 891 B
================================================================================

{"version":3,"file":"soft-delete.extension.js","sourceRoot":"","sources":["../../../../src/common/prisma/soft-delete.extension.ts"],"names":[],"mappings":";;;AACA,2CAAwC;AAE3B,QAAA,mBAAmB,GAAG,eAAM,CAAC,eAAe,CAAC;IACxD,IAAI,EAAE,YAAY;IAClB,KAAK,EAAE;QACL,UAAU,EAAE;YACV,KAAK,CAAC,QAAQ,CAAC,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE;gBAC9C,IAAI,CAAC,KAAK,GAAG,EAAE,GAAG,IAAI,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;gBAChD,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;YACrB,CAAC;YACD,KAAK,CAAC,SAAS,CAAC,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE;gBAC/C,IAAI,CAAC,KAAK,GAAG,EAAE,GAAG,IAAI,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;gBAChD,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;YACrB,CAAC;YACD,KAAK,CAAC,UAAU,CAAC,EAAE,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,KAAK,EAAE;gBAChD,IAAI,CAAC,KAAK,GAAG,EAAE,GAAG,IAAI,CAAC,KAAK,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC;gBAChD,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;YACrB,CAAC;SACF;KACF;CACF,CAAC,CAAC"}

================================================================================
File: bff-nestjs/dist/src/config/env.validation.d.ts
Size: 93 B
================================================================================

import * as Joi from 'joi';
export declare const envValidationSchema: Joi.ObjectSchema<any>;


================================================================================
File: bff-nestjs/dist/src/config/env.validation.js
Size: 3.05 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.envValidationSchema = void 0;
const Joi = __importStar(require("joi"));
exports.envValidationSchema = Joi.object({
    NODE_ENV: Joi.string()
        .valid('development', 'production', 'test', 'staging')
        .default('development'),
    PORT: Joi.number().port().default(3001),
    FRONTEND_URL: Joi.string().uri().required(),
    DATABASE_URL: Joi.string().required(),
    DATABASE_POOL_SIZE: Joi.number().min(1).max(100).default(10),
    AT_SECRET: Joi.string().min(32).required(),
    RT_SECRET: Joi.string().min(32).required(),
    COOKIE_SECRET: Joi.string().min(32).required(),
    AT_EXPIRES_IN: Joi.string().default('15m'),
    RT_EXPIRES_IN: Joi.string().default('7d'),
    REDIS_HOST: Joi.string().required(),
    REDIS_PORT: Joi.number().port().default(6379),
    REDIS_PASSWORD: Joi.string().allow('').optional(),
    MAIL_HOST: Joi.string().required(),
    MAIL_PORT: Joi.number().port().required(),
    MAIL_USER: Joi.string().required(),
    MAIL_PASS: Joi.string().required(),
    MAIL_FROM: Joi.string().default('"Team Platform" <no-reply@yourdomain.com>'),
    STORAGE_ENDPOINT: Joi.string().uri().required(),
    STORAGE_REGION: Joi.string().required(),
    STORAGE_ACCESS_KEY: Joi.string().required(),
    STORAGE_SECRET_KEY: Joi.string().required(),
    STORAGE_BUCKET: Joi.string().required(),
    STORAGE_FORCE_PATH_STYLE: Joi.boolean().default(true),
    LOG_LEVEL: Joi.string().valid('debug', 'info', 'warn', 'error').default('info'),
    THROTTLE_TTL: Joi.number().default(60000),
    THROTTLE_LIMIT: Joi.number().default(20),
});
//# sourceMappingURL=env.validation.js.map

================================================================================
File: bff-nestjs/dist/src/config/env.validation.js.map
Size: 2.07 kB
================================================================================

{"version":3,"file":"env.validation.js","sourceRoot":"","sources":["../../../src/config/env.validation.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,yCAA2B;AAEd,QAAA,mBAAmB,GAAG,GAAG,CAAC,MAAM,CAAC;IAE5C,QAAQ,EAAE,GAAG,CAAC,MAAM,EAAE;SACnB,KAAK,CAAC,aAAa,EAAE,YAAY,EAAE,MAAM,EAAE,SAAS,CAAC;SACrD,OAAO,CAAC,aAAa,CAAC;IACzB,IAAI,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IACvC,YAAY,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,EAAE,CAAC,QAAQ,EAAE;IAG3C,YAAY,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IACrC,kBAAkB,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC,OAAO,CAAC,EAAE,CAAC;IAG5D,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;IAC1C,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;IAC1C,aAAa,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;IAC9C,aAAa,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC;IAC1C,aAAa,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IAGzC,UAAU,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IACnC,UAAU,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IAC7C,cAAc,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,KAAK,CAAC,EAAE,CAAC,CAAC,QAAQ,EAAE;IAGjD,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,IAAI,EAAE,CAAC,QAAQ,EAAE;IACzC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAClC,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,2CAA2C,CAAC;IAG5E,gBAAgB,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,GAAG,EAAE,CAAC,QAAQ,EAAE;IAC/C,cAAc,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IACvC,kBAAkB,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAC3C,kBAAkB,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IAC3C,cAAc,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,QAAQ,EAAE;IACvC,wBAAwB,EAAE,GAAG,CAAC,OAAO,EAAE,CAAC,OAAO,CAAC,IAAI,CAAC;IAGrD,SAAS,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,KAAK,CAAC,OAAO,EAAE,MAAM,EAAE,MAAM,EAAE,OAAO,CAAC,CAAC,OAAO,CAAC,MAAM,CAAC;IAC/E,YAAY,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,KAAK,CAAC;IACzC,cAAc,EAAE,GAAG,CAAC,MAAM,EAAE,CAAC,OAAO,CAAC,EAAE,CAAC;CACzC,CAAC,CAAC"}

================================================================================
File: bff-nestjs/dist/src/main.d.ts
Size: 11 B
================================================================================

export {};


================================================================================
File: bff-nestjs/dist/src/main.js
Size: 2.6 kB
================================================================================

"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
const common_1 = require("@nestjs/common");
const core_1 = require("@nestjs/core");
const config_1 = require("@nestjs/config");
const nestjs_pino_1 = require("nestjs-pino");
const cookie_parser_1 = __importDefault(require("cookie-parser"));
const swagger_1 = require("@nestjs/swagger");
const app_module_1 = require("./app.module");
const http_exception_filter_1 = require("./common/filters/http-exception.filter");
async function bootstrap() {
    const app = await core_1.NestFactory.create(app_module_1.AppModule, {
        bufferLogs: true,
    });
    app.disable('x-powered-by');
    app.useLogger(app.get(nestjs_pino_1.Logger));
    const configService = app.get(config_1.ConfigService);
    const port = configService.get('PORT') || 3001;
    const frontendUrl = configService.get('FRONTEND_URL');
    const cookieSecret = configService.get('COOKIE_SECRET');
    const nodeEnv = configService.get('NODE_ENV');
    app.setGlobalPrefix('api/v1');
    app.use((0, cookie_parser_1.default)(cookieSecret));
    app.enableCors({
        origin: frontendUrl,
        credentials: true,
        methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
        allowedHeaders: ['Content-Type', 'Authorization', 'set-cookie'],
    });
    app.useGlobalPipes(new common_1.ValidationPipe({
        whitelist: true,
        forbidNonWhitelisted: true,
        transform: true,
    }));
    app.useGlobalFilters(new http_exception_filter_1.AllExceptionsFilter(configService));
    const reflector = app.get(core_1.Reflector);
    app.useGlobalInterceptors(new common_1.ClassSerializerInterceptor(reflector));
    if (nodeEnv !== 'production') {
        const config = new swagger_1.DocumentBuilder()
            .setTitle('Team Productivity Platform')
            .setDescription('BFF Enterprise API - German Market Standard')
            .setVersion('1.0')
            .addBearerAuth({ type: 'http', scheme: 'bearer' }, 'access-token')
            .build();
        const document = swagger_1.SwaggerModule.createDocument(app, config);
        swagger_1.SwaggerModule.setup('api/docs', app, document);
    }
    await app.listen(port);
    console.log(`üöÄ Application is running on: http://localhost:${port}/api/v1`);
    if (nodeEnv !== 'production') {
        console.log(`üìö Documentation: http://localhost:${port}/api/docs`);
    }
}
bootstrap();
//# sourceMappingURL=main.js.map

================================================================================
File: bff-nestjs/dist/src/main.js.map
Size: 1.98 kB
================================================================================

{"version":3,"file":"main.js","sourceRoot":"","sources":["../../src/main.ts"],"names":[],"mappings":";;;;;AAAA,2CAA4E;AAC5E,uCAAsD;AACtD,2CAA+C;AAC/C,6CAAqC;AACrC,kEAAyC;AACzC,6CAAiE;AAGjE,6CAAyC;AACzC,kFAA6E;AAE7E,KAAK,UAAU,SAAS;IAEtB,MAAM,GAAG,GAAG,MAAM,kBAAW,CAAC,MAAM,CAAyB,sBAAS,EAAE;QACtE,UAAU,EAAE,IAAI;KACjB,CAAC,CAAC;IAGH,GAAG,CAAC,OAAO,CAAC,cAAc,CAAC,CAAC;IAG5B,GAAG,CAAC,SAAS,CAAC,GAAG,CAAC,GAAG,CAAC,oBAAM,CAAC,CAAC,CAAC;IAE/B,MAAM,aAAa,GAAG,GAAG,CAAC,GAAG,CAAC,sBAAa,CAAC,CAAC;IAC7C,MAAM,IAAI,GAAG,aAAa,CAAC,GAAG,CAAS,MAAM,CAAC,IAAI,IAAI,CAAC;IACvD,MAAM,WAAW,GAAG,aAAa,CAAC,GAAG,CAAS,cAAc,CAAC,CAAC;IAC9D,MAAM,YAAY,GAAG,aAAa,CAAC,GAAG,CAAS,eAAe,CAAC,CAAC;IAChE,MAAM,OAAO,GAAG,aAAa,CAAC,GAAG,CAAS,UAAU,CAAC,CAAC;IAEtD,GAAG,CAAC,eAAe,CAAC,QAAQ,CAAC,CAAC;IAG9B,GAAG,CAAC,GAAG,CAAC,IAAA,uBAAY,EAAC,YAAY,CAAC,CAAC,CAAC;IAGpC,GAAG,CAAC,UAAU,CAAC;QACb,MAAM,EAAE,WAAW;QACnB,WAAW,EAAE,IAAI;QACjB,OAAO,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,SAAS,CAAC;QAC7D,cAAc,EAAE,CAAC,cAAc,EAAE,eAAe,EAAE,YAAY,CAAC;KAChE,CAAC,CAAC;IAGH,GAAG,CAAC,cAAc,CAChB,IAAI,uBAAc,CAAC;QACjB,SAAS,EAAE,IAAI;QACf,oBAAoB,EAAE,IAAI;QAC1B,SAAS,EAAE,IAAI;KAChB,CAAC,CACH,CAAC;IAGF,GAAG,CAAC,gBAAgB,CAAC,IAAI,2CAAmB,CAAC,aAAa,CAAC,CAAC,CAAC;IAE7D,MAAM,SAAS,GAAG,GAAG,CAAC,GAAG,CAAC,gBAAS,CAAC,CAAC;IACrC,GAAG,CAAC,qBAAqB,CAAC,IAAI,mCAA0B,CAAC,SAAS,CAAC,CAAC,CAAC;IAGrE,IAAI,OAAO,KAAK,YAAY,EAAE,CAAC;QAC7B,MAAM,MAAM,GAAG,IAAI,yBAAe,EAAE;aACjC,QAAQ,CAAC,4BAA4B,CAAC;aACtC,cAAc,CAAC,6CAA6C,CAAC;aAC7D,UAAU,CAAC,KAAK,CAAC;aACjB,aAAa,CAAC,EAAE,IAAI,EAAE,MAAM,EAAE,MAAM,EAAE,QAAQ,EAAE,EAAE,cAAc,CAAC;aACjE,KAAK,EAAE,CAAC;QAEX,MAAM,QAAQ,GAAG,uBAAa,CAAC,cAAc,CAAC,GAAG,EAAE,MAAM,CAAC,CAAC;QAC3D,uBAAa,CAAC,KAAK,CAAC,UAAU,EAAE,GAAG,EAAE,QAAQ,CAAC,CAAC;IACjD,CAAC;IAED,MAAM,GAAG,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC;IAGvB,OAAO,CAAC,GAAG,CAAC,kDAAkD,IAAI,SAAS,CAAC,CAAC;IAC7E,IAAI,OAAO,KAAK,YAAY,EAAE,CAAC;QAC7B,OAAO,CAAC,GAAG,CAAC,sCAAsC,IAAI,WAAW,CAAC,CAAC;IACrE,CAAC;AACH,CAAC;AACD,SAAS,EAAE,CAAC"}

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.controller.d.ts
Size: 513 B
================================================================================

import { DashboardService } from './dashboard.service';
export declare class DashboardController {
    private readonly dashboardService;
    constructor(dashboardService: DashboardService);
    getStats(teamId: number): Promise<{
        teamName: string;
        totalProjects: number;
        projects: {
            id: number;
            name: string;
            progress: number;
            totalTasks: number;
            completedTasks: number;
            overdueTasks: number;
        }[];
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.controller.js
Size: 2.26 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DashboardController = void 0;
const common_1 = require("@nestjs/common");
const dashboard_service_1 = require("./dashboard.service");
const roles_guard_1 = require("../../common/guards/roles.guard");
const swagger_1 = require("@nestjs/swagger");
let DashboardController = class DashboardController {
    dashboardService;
    constructor(dashboardService) {
        this.dashboardService = dashboardService;
    }
    async getStats(teamId) {
        return this.dashboardService.getTeamStats(teamId);
    }
};
exports.DashboardController = DashboardController;
__decorate([
    (0, common_1.Get)('team/:teamId'),
    __param(0, (0, common_1.Param)('teamId', common_1.ParseIntPipe)),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number]),
    __metadata("design:returntype", Promise)
], DashboardController.prototype, "getStats", null);
exports.DashboardController = DashboardController = __decorate([
    (0, swagger_1.ApiTags)('Dashboard'),
    (0, swagger_1.ApiBearerAuth)('access-token'),
    (0, common_1.UseGuards)(roles_guard_1.RolesGuard),
    (0, common_1.Controller)('dashboard'),
    __metadata("design:paramtypes", [dashboard_service_1.DashboardService])
], DashboardController);
//# sourceMappingURL=dashboard.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.controller.js.map
Size: 726 B
================================================================================

{"version":3,"file":"dashboard.controller.js","sourceRoot":"","sources":["../../../../src/modules/dashboard/dashboard.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CAMwB;AACxB,2DAAuD;AACvD,iEAA6D;AAC7D,6CAAyD;AAMlD,IAAM,mBAAmB,GAAzB,MAAM,mBAAmB;IACD;IAA7B,YAA6B,gBAAkC;QAAlC,qBAAgB,GAAhB,gBAAgB,CAAkB;IAAG,CAAC;IAG7D,AAAN,KAAK,CAAC,QAAQ,CAAgC,MAAc;QAC1D,OAAO,IAAI,CAAC,gBAAgB,CAAC,YAAY,CAAC,MAAM,CAAC,CAAC;IACpD,CAAC;CACF,CAAA;AAPY,kDAAmB;AAIxB;IADL,IAAA,YAAG,EAAC,cAAc,CAAC;IACJ,WAAA,IAAA,cAAK,EAAC,QAAQ,EAAE,qBAAY,CAAC,CAAA;;;;mDAE5C;8BANU,mBAAmB;IAJ/B,IAAA,iBAAO,EAAC,WAAW,CAAC;IACpB,IAAA,uBAAa,EAAC,cAAc,CAAC;IAC7B,IAAA,kBAAS,EAAC,wBAAU,CAAC;IACrB,IAAA,mBAAU,EAAC,WAAW,CAAC;qCAEyB,oCAAgB;GADpD,mBAAmB,CAO/B"}

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.module.d.ts
Size: 41 B
================================================================================

export declare class DashboardModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.module.js
Size: 1.34 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DashboardModule = void 0;
const common_1 = require("@nestjs/common");
const dashboard_service_1 = require("./dashboard.service");
const dashboard_controller_1 = require("./dashboard.controller");
const prisma_module_1 = require("../../prisma/prisma.module");
let DashboardModule = class DashboardModule {
};
exports.DashboardModule = DashboardModule;
exports.DashboardModule = DashboardModule = __decorate([
    (0, common_1.Module)({
        imports: [prisma_module_1.PrismaModule],
        controllers: [dashboard_controller_1.DashboardController],
        providers: [dashboard_service_1.DashboardService],
    })
], DashboardModule);
//# sourceMappingURL=dashboard.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.module.js.map
Size: 419 B
================================================================================

{"version":3,"file":"dashboard.module.js","sourceRoot":"","sources":["../../../../src/modules/dashboard/dashboard.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,2DAAuD;AACvD,iEAA6D;AAC7D,8DAA0D;AAOnD,IAAM,eAAe,GAArB,MAAM,eAAe;CAAG,CAAA;AAAlB,0CAAe;0BAAf,eAAe;IAL3B,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,4BAAY,CAAC;QACvB,WAAW,EAAE,CAAC,0CAAmB,CAAC;QAClC,SAAS,EAAE,CAAC,oCAAgB,CAAC;KAC9B,CAAC;GACW,eAAe,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.service.d.ts
Size: 487 B
================================================================================

import { PrismaService } from '../../prisma/prisma.service';
export declare class DashboardService {
    private prisma;
    constructor(prisma: PrismaService);
    getTeamStats(teamId: number): Promise<{
        teamName: string;
        totalProjects: number;
        projects: {
            id: number;
            name: string;
            progress: number;
            totalTasks: number;
            completedTasks: number;
            overdueTasks: number;
        }[];
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.service.js
Size: 2.97 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.DashboardService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const client_1 = require("@prisma/client");
let DashboardService = class DashboardService {
    prisma;
    constructor(prisma) {
        this.prisma = prisma;
    }
    async getTeamStats(teamId) {
        const team = await this.prisma.extended.team.findUnique({
            where: { id: teamId },
            include: {
                projects: {
                    include: {
                        _count: {
                            select: { tasks: true },
                        },
                        tasks: {
                            select: { status: true, dueDate: true },
                        },
                    },
                },
            },
        });
        if (!team)
            throw new common_1.NotFoundException(`Team with ID ${teamId} not found`);
        const now = new Date();
        const projectStats = team.projects.map((project) => {
            const totalTasks = project._count.tasks;
            const completedTasks = project.tasks.filter((t) => t.status === client_1.TaskStatus.DONE).length;
            const progress = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const overdueTasks = project.tasks.filter((t) => t.status !== client_1.TaskStatus.DONE &&
                t.dueDate &&
                new Date(t.dueDate) < now).length;
            return {
                id: project.id,
                name: project.name,
                progress,
                totalTasks,
                completedTasks,
                overdueTasks,
            };
        });
        return {
            teamName: team.name,
            totalProjects: team.projects.length,
            projects: projectStats,
        };
    }
};
exports.DashboardService = DashboardService;
exports.DashboardService = DashboardService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], DashboardService);
//# sourceMappingURL=dashboard.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dashboard.service.js.map
Size: 1.75 kB
================================================================================

{"version":3,"file":"dashboard.service.js","sourceRoot":"","sources":["../../../../src/modules/dashboard/dashboard.service.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAA+D;AAC/D,gEAA4D;AAC5D,2CAA4C;AAGrC,IAAM,gBAAgB,GAAtB,MAAM,gBAAgB;IACP;IAApB,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,YAAY,CAAC,MAAc;QAC/B,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACtD,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,OAAO,EAAE;gBACP,QAAQ,EAAE;oBACR,OAAO,EAAE;wBACP,MAAM,EAAE;4BACN,MAAM,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE;yBACxB;wBACD,KAAK,EAAE;4BACL,MAAM,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,OAAO,EAAE,IAAI,EAAE;yBACxC;qBACF;iBACF;aACF;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI;YAAE,MAAM,IAAI,0BAAiB,CAAC,gBAAgB,MAAM,YAAY,CAAC,CAAC;QAE3E,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;QACvB,MAAM,YAAY,GAAG,IAAI,CAAC,QAAQ,CAAC,GAAG,CAAC,CAAC,OAAO,EAAE,EAAE;YACjD,MAAM,UAAU,GAAG,OAAO,CAAC,MAAM,CAAC,KAAK,CAAC;YACxC,MAAM,cAAc,GAAG,OAAO,CAAC,KAAK,CAAC,MAAM,CACzC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,mBAAU,CAAC,IAAI,CACpC,CAAC,MAAM,CAAC;YAET,MAAM,QAAQ,GACZ,UAAU,GAAG,CAAC,CAAC,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,cAAc,GAAG,UAAU,CAAC,GAAG,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YACvE,MAAM,YAAY,GAAG,OAAO,CAAC,KAAK,CAAC,MAAM,CACvC,CAAC,CAAC,EAAE,EAAE,CACJ,CAAC,CAAC,MAAM,KAAK,mBAAU,CAAC,IAAI;gBAC5B,CAAC,CAAC,OAAO;gBACT,IAAI,IAAI,CAAC,CAAC,CAAC,OAAO,CAAC,GAAG,GAAG,CAC5B,CAAC,MAAM,CAAC;YAET,OAAO;gBACL,EAAE,EAAE,OAAO,CAAC,EAAE;gBACd,IAAI,EAAE,OAAO,CAAC,IAAI;gBAClB,QAAQ;gBACR,UAAU;gBACV,cAAc;gBACd,YAAY;aACb,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,OAAO;YACL,QAAQ,EAAE,IAAI,CAAC,IAAI;YACnB,aAAa,EAAE,IAAI,CAAC,QAAQ,CAAC,MAAM;YACnC,QAAQ,EAAE,YAAY;SACvB,CAAC;IACJ,CAAC;CACF,CAAA;AAtDY,4CAAgB;2BAAhB,gBAAgB;IAD5B,IAAA,mBAAU,GAAE;qCAEiB,8BAAa;GAD9B,gBAAgB,CAsD5B"}

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dto/project-stats.dto.d.ts
Size: 215 B
================================================================================

export declare class ProjectStatsDto {
    projectId: number;
    projectName: string;
    totalTasks: number;
    completedTasks: number;
    pendingTasks: number;
    overdueTasks: number;
    progress: number;
}


================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dto/project-stats.dto.js
Size: 2.11 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectStatsDto = void 0;
const swagger_1 = require("@nestjs/swagger");
class ProjectStatsDto {
    projectId;
    projectName;
    totalTasks;
    completedTasks;
    pendingTasks;
    overdueTasks;
    progress;
}
exports.ProjectStatsDto = ProjectStatsDto;
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "projectId", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", String)
], ProjectStatsDto.prototype, "projectName", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "totalTasks", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "completedTasks", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "pendingTasks", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "overdueTasks", void 0);
__decorate([
    (0, swagger_1.ApiProperty)(),
    __metadata("design:type", Number)
], ProjectStatsDto.prototype, "progress", void 0);
//# sourceMappingURL=project-stats.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/dashboard/dto/project-stats.dto.js.map
Size: 568 B
================================================================================

{"version":3,"file":"project-stats.dto.js","sourceRoot":"","sources":["../../../../../src/modules/dashboard/dto/project-stats.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,6CAA8C;AAE9C,MAAa,eAAe;IAE1B,SAAS,CAAU;IAGnB,WAAW,CAAU;IAGrB,UAAU,CAAU;IAGpB,cAAc,CAAU;IAGxB,YAAY,CAAU;IAGtB,YAAY,CAAU;IAGtB,QAAQ,CAAU;CACnB;AArBD,0CAqBC;AAnBC;IADC,IAAA,qBAAW,GAAE;;kDACK;AAGnB;IADC,IAAA,qBAAW,GAAE;;oDACO;AAGrB;IADC,IAAA,qBAAW,GAAE;;mDACM;AAGpB;IADC,IAAA,qBAAW,GAAE;;uDACU;AAGxB;IADC,IAAA,qBAAW,GAAE;;qDACQ;AAGtB;IADC,IAAA,qBAAW,GAAE;;qDACQ;AAGtB;IADC,IAAA,qBAAW,GAAE;;iDACI"}

================================================================================
File: bff-nestjs/dist/src/modules/health/health.controller.d.ts
Size: 426 B
================================================================================

import { HealthCheckService, PrismaHealthIndicator } from '@nestjs/terminus';
import { PrismaService } from '../../prisma/prisma.service';
export declare class HealthController {
    private health;
    private prismaIndicator;
    private prisma;
    constructor(health: HealthCheckService, prismaIndicator: PrismaHealthIndicator, prisma: PrismaService);
    check(): Promise<import("@nestjs/terminus").HealthCheckResult>;
}


================================================================================
File: bff-nestjs/dist/src/modules/health/health.controller.js
Size: 2.12 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.HealthController = void 0;
const common_1 = require("@nestjs/common");
const terminus_1 = require("@nestjs/terminus");
const prisma_service_1 = require("../../prisma/prisma.service");
const decorators_1 = require("../../common/decorators");
let HealthController = class HealthController {
    health;
    prismaIndicator;
    prisma;
    constructor(health, prismaIndicator, prisma) {
        this.health = health;
        this.prismaIndicator = prismaIndicator;
        this.prisma = prisma;
    }
    check() {
        return this.health.check([
            () => this.prismaIndicator.pingCheck('database', this.prisma),
        ]);
    }
};
exports.HealthController = HealthController;
__decorate([
    (0, decorators_1.Public)(),
    (0, common_1.Get)(),
    (0, terminus_1.HealthCheck)(),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", []),
    __metadata("design:returntype", void 0)
], HealthController.prototype, "check", null);
exports.HealthController = HealthController = __decorate([
    (0, common_1.Controller)('health'),
    __metadata("design:paramtypes", [terminus_1.HealthCheckService,
        terminus_1.PrismaHealthIndicator,
        prisma_service_1.PrismaService])
], HealthController);
//# sourceMappingURL=health.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/health/health.controller.js.map
Size: 753 B
================================================================================

{"version":3,"file":"health.controller.js","sourceRoot":"","sources":["../../../../src/modules/health/health.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAAiD;AACjD,+CAI0B;AAC1B,gEAA4D;AAC5D,wDAAiD;AAG1C,IAAM,gBAAgB,GAAtB,MAAM,gBAAgB;IAEjB;IACA;IACA;IAHV,YACU,MAA0B,EAC1B,eAAsC,EACtC,MAAqB;QAFrB,WAAM,GAAN,MAAM,CAAoB;QAC1B,oBAAe,GAAf,eAAe,CAAuB;QACtC,WAAM,GAAN,MAAM,CAAe;IAC5B,CAAC;IAKJ,KAAK;QACH,OAAO,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC;YACvB,GAAG,EAAE,CAAC,IAAI,CAAC,eAAe,CAAC,SAAS,CAAC,UAAU,EAAE,IAAI,CAAC,MAAM,CAAC;SAC9D,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AAfY,4CAAgB;AAU3B;IAHC,IAAA,mBAAM,GAAE;IACR,IAAA,YAAG,GAAE;IACL,IAAA,sBAAW,GAAE;;;;6CAKb;2BAdU,gBAAgB;IAD5B,IAAA,mBAAU,EAAC,QAAQ,CAAC;qCAGD,6BAAkB;QACT,gCAAqB;QAC9B,8BAAa;GAJpB,gBAAgB,CAe5B"}

================================================================================
File: bff-nestjs/dist/src/modules/health/health.module.d.ts
Size: 38 B
================================================================================

export declare class HealthModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/health/health.module.js
Size: 1.26 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.HealthModule = void 0;
const common_1 = require("@nestjs/common");
const terminus_1 = require("@nestjs/terminus");
const health_controller_1 = require("./health.controller");
const prisma_module_1 = require("../../prisma/prisma.module");
let HealthModule = class HealthModule {
};
exports.HealthModule = HealthModule;
exports.HealthModule = HealthModule = __decorate([
    (0, common_1.Module)({
        imports: [terminus_1.TerminusModule, prisma_module_1.PrismaModule],
        controllers: [health_controller_1.HealthController],
    })
], HealthModule);
//# sourceMappingURL=health.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/health/health.module.js.map
Size: 387 B
================================================================================

{"version":3,"file":"health.module.js","sourceRoot":"","sources":["../../../../src/modules/health/health.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,+CAAkD;AAClD,2DAAuD;AACvD,8DAA0D;AAMnD,IAAM,YAAY,GAAlB,MAAM,YAAY;CAAG,CAAA;AAAf,oCAAY;uBAAZ,YAAY;IAJxB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,yBAAc,EAAE,4BAAY,CAAC;QACvC,WAAW,EAAE,CAAC,oCAAgB,CAAC;KAChC,CAAC;GACW,YAAY,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/invitations/dto/invitation.dto.d.ts
Size: 189 B
================================================================================

import { TeamRole } from '@prisma/client';
export declare class SendInvitationDto {
    email: string;
    role: TeamRole;
}
export declare class AcceptInvitationDto {
    token: string;
}


================================================================================
File: bff-nestjs/dist/src/modules/invitations/dto/invitation.dto.js
Size: 1.76 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.AcceptInvitationDto = exports.SendInvitationDto = void 0;
const class_validator_1 = require("class-validator");
const client_1 = require("@prisma/client");
class SendInvitationDto {
    email;
    role = client_1.TeamRole.MEMBER;
}
exports.SendInvitationDto = SendInvitationDto;
__decorate([
    (0, class_validator_1.IsEmail)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], SendInvitationDto.prototype, "email", void 0);
__decorate([
    (0, class_validator_1.IsEnum)(client_1.TeamRole),
    __metadata("design:type", String)
], SendInvitationDto.prototype, "role", void 0);
class AcceptInvitationDto {
    token;
}
exports.AcceptInvitationDto = AcceptInvitationDto;
__decorate([
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], AcceptInvitationDto.prototype, "token", void 0);
//# sourceMappingURL=invitation.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/invitations/dto/invitation.dto.js.map
Size: 483 B
================================================================================

{"version":3,"file":"invitation.dto.js","sourceRoot":"","sources":["../../../../../src/modules/invitations/dto/invitation.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAAwE;AACxE,2CAA0C;AAE1C,MAAa,iBAAiB;IAG5B,KAAK,CAAU;IAGf,IAAI,GAAa,iBAAQ,CAAC,MAAM,CAAC;CAClC;AAPD,8CAOC;AAJC;IAFC,IAAA,yBAAO,GAAE;IACT,IAAA,4BAAU,GAAE;;gDACE;AAGf;IADC,IAAA,wBAAM,EAAC,iBAAQ,CAAC;;+CACgB;AAGnC,MAAa,mBAAmB;IAG9B,KAAK,CAAU;CAChB;AAJD,kDAIC;AADC;IAFC,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;;kDACE"}

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.controller.d.ts
Size: 522 B
================================================================================

import { InvitationsService } from './invitations.service';
import { SendInvitationDto, AcceptInvitationDto } from './dto/invitation.dto';
export declare class InvitationsController {
    private readonly invitationsService;
    constructor(invitationsService: InvitationsService);
    invite(teamId: number, userId: number, dto: SendInvitationDto): Promise<{
        message: string;
        invitationId: number;
    }>;
    accept(dto: AcceptInvitationDto, userId: number): Promise<{
        message: string;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.controller.js
Size: 3.23 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InvitationsController = void 0;
const common_1 = require("@nestjs/common");
const invitations_service_1 = require("./invitations.service");
const at_guard_1 = require("../../auth/guards/at.guard");
const decorators_1 = require("../../common/decorators");
const swagger_1 = require("@nestjs/swagger");
const invitation_dto_1 = require("./dto/invitation.dto");
let InvitationsController = class InvitationsController {
    invitationsService;
    constructor(invitationsService) {
        this.invitationsService = invitationsService;
    }
    async invite(teamId, userId, dto) {
        return this.invitationsService.createInvitation(teamId, userId, dto.email, dto.role);
    }
    async accept(dto, userId) {
        return this.invitationsService.acceptInvitation(dto.token, userId);
    }
};
exports.InvitationsController = InvitationsController;
__decorate([
    (0, common_1.Post)('team/:teamId/send'),
    (0, swagger_1.ApiOperation)({ summary: 'Send an email invitation to join a team' }),
    __param(0, (0, common_1.Param)('teamId', common_1.ParseIntPipe)),
    __param(1, (0, decorators_1.GetCurrentUserId)()),
    __param(2, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, Number, invitation_dto_1.SendInvitationDto]),
    __metadata("design:returntype", Promise)
], InvitationsController.prototype, "invite", null);
__decorate([
    (0, common_1.Post)('accept'),
    (0, swagger_1.ApiOperation)({ summary: 'Accept a team invitation using a token' }),
    __param(0, (0, common_1.Body)()),
    __param(1, (0, decorators_1.GetCurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [invitation_dto_1.AcceptInvitationDto, Number]),
    __metadata("design:returntype", Promise)
], InvitationsController.prototype, "accept", null);
exports.InvitationsController = InvitationsController = __decorate([
    (0, swagger_1.ApiTags)('invitations'),
    (0, swagger_1.ApiBearerAuth)(),
    (0, common_1.UseGuards)(at_guard_1.AtGuard),
    (0, common_1.Controller)('invitations'),
    __metadata("design:paramtypes", [invitations_service_1.InvitationsService])
], InvitationsController);
//# sourceMappingURL=invitations.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.controller.js.map
Size: 1.27 kB
================================================================================

{"version":3,"file":"invitations.controller.js","sourceRoot":"","sources":["../../../../src/modules/invitations/invitations.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CAOwB;AACxB,+DAA2D;AAC3D,yDAAqD;AACrD,wDAA2D;AAC3D,6CAAuE;AACvE,yDAA8E;AAMvE,IAAM,qBAAqB,GAA3B,MAAM,qBAAqB;IACH;IAA7B,YAA6B,kBAAsC;QAAtC,uBAAkB,GAAlB,kBAAkB,CAAoB;IAAG,CAAC;IAIjE,AAAN,KAAK,CAAC,MAAM,CACqB,MAAc,EACzB,MAAc,EAC1B,GAAsB;QAG9B,OAAO,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,CAC7C,MAAM,EACN,MAAM,EACN,GAAG,CAAC,KAAK,EACT,GAAG,CAAC,IAAI,CACT,CAAC;IACJ,CAAC;IAIK,AAAN,KAAK,CAAC,MAAM,CACF,GAAwB,EACZ,MAAc;QAElC,OAAO,IAAI,CAAC,kBAAkB,CAAC,gBAAgB,CAAC,GAAG,CAAC,KAAK,EAAE,MAAM,CAAC,CAAC;IACrE,CAAC;CACF,CAAA;AA3BY,sDAAqB;AAK1B;IAFL,IAAA,aAAI,EAAC,mBAAmB,CAAC;IACzB,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,yCAAyC,EAAE,CAAC;IAElE,WAAA,IAAA,cAAK,EAAC,QAAQ,EAAE,qBAAY,CAAC,CAAA;IAC7B,WAAA,IAAA,6BAAgB,GAAE,CAAA;IAClB,WAAA,IAAA,aAAI,GAAE,CAAA;;qDAAM,kCAAiB;;mDAS/B;AAIK;IAFL,IAAA,aAAI,EAAC,QAAQ,CAAC;IACd,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,wCAAwC,EAAE,CAAC;IAEjE,WAAA,IAAA,aAAI,GAAE,CAAA;IACN,WAAA,IAAA,6BAAgB,GAAE,CAAA;;qCADN,oCAAmB;;mDAIjC;gCA1BU,qBAAqB;IAJjC,IAAA,iBAAO,EAAC,aAAa,CAAC;IACtB,IAAA,uBAAa,GAAE;IACf,IAAA,kBAAS,EAAC,kBAAO,CAAC;IAClB,IAAA,mBAAU,EAAC,aAAa,CAAC;qCAEyB,wCAAkB;GADxD,qBAAqB,CA2BjC"}

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.module.d.ts
Size: 43 B
================================================================================

export declare class InvitationsModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.module.js
Size: 1.9 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InvitationsModule = void 0;
const common_1 = require("@nestjs/common");
const invitations_service_1 = require("./invitations.service");
const invitations_controller_1 = require("./invitations.controller");
const prisma_module_1 = require("../../prisma/prisma.module");
const mail_module_1 = require("../mail/mail.module");
const jwt_1 = require("@nestjs/jwt");
const notifications_module_1 = require("../notifications/notifications.module");
let InvitationsModule = class InvitationsModule {
};
exports.InvitationsModule = InvitationsModule;
exports.InvitationsModule = InvitationsModule = __decorate([
    (0, common_1.Module)({
        imports: [
            prisma_module_1.PrismaModule,
            mail_module_1.MailModule,
            notifications_module_1.NotificationsModule,
            jwt_1.JwtModule.register({
                secret: process.env.JWT_SECRET || 'fallback_secret',
                signOptions: { expiresIn: '7d' },
            }),
        ],
        controllers: [invitations_controller_1.InvitationsController],
        providers: [invitations_service_1.InvitationsService],
        exports: [invitations_service_1.InvitationsService],
    })
], InvitationsModule);
//# sourceMappingURL=invitations.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.module.js.map
Size: 663 B
================================================================================

{"version":3,"file":"invitations.module.js","sourceRoot":"","sources":["../../../../src/modules/invitations/invitations.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,+DAA2D;AAC3D,qEAAiE;AACjE,8DAA0D;AAC1D,qDAAiD;AACjD,qCAAwC;AACxC,gFAA4E;AAgBrE,IAAM,iBAAiB,GAAvB,MAAM,iBAAiB;CAAG,CAAA;AAApB,8CAAiB;4BAAjB,iBAAiB;IAd7B,IAAA,eAAM,EAAC;QACN,OAAO,EAAE;YACP,4BAAY;YACZ,wBAAU;YACV,0CAAmB;YACnB,eAAS,CAAC,QAAQ,CAAC;gBACjB,MAAM,EAAE,OAAO,CAAC,GAAG,CAAC,UAAU,IAAI,iBAAiB;gBACnD,WAAW,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE;aACjC,CAAC;SACH;QACD,WAAW,EAAE,CAAC,8CAAqB,CAAC;QACpC,SAAS,EAAE,CAAC,wCAAkB,CAAC;QAC/B,OAAO,EAAE,CAAC,wCAAkB,CAAC;KAC9B,CAAC;GACW,iBAAiB,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.processor.d.ts
Size: 353 B
================================================================================

import { WorkerHost } from '@nestjs/bullmq';
import { Job } from 'bullmq';
import { MailService } from '../mail/mail.service';
export declare class InvitationsProcessor extends WorkerHost {
    private readonly mailService;
    private readonly logger;
    constructor(mailService: MailService);
    process(job: Job<any, any, string>): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.processor.js
Size: 2.07 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var InvitationsProcessor_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.InvitationsProcessor = void 0;
const bullmq_1 = require("@nestjs/bullmq");
const common_1 = require("@nestjs/common");
const mail_service_1 = require("../mail/mail.service");
let InvitationsProcessor = InvitationsProcessor_1 = class InvitationsProcessor extends bullmq_1.WorkerHost {
    mailService;
    logger = new common_1.Logger(InvitationsProcessor_1.name);
    constructor(mailService) {
        super();
        this.mailService = mailService;
    }
    async process(job) {
        this.logger.log(`Processing job ${job.id} of type ${job.name}...`);
        switch (job.name) {
            case 'send-invitation':
                const { email, token, teamName } = job.data;
                return await this.mailService.sendInvitationEmail(email, teamName, token);
            default:
                this.logger.warn(`Unknown job name: ${job.name}`);
        }
    }
};
exports.InvitationsProcessor = InvitationsProcessor;
exports.InvitationsProcessor = InvitationsProcessor = InvitationsProcessor_1 = __decorate([
    (0, bullmq_1.Processor)('mail-queue'),
    __metadata("design:paramtypes", [mail_service_1.MailService])
], InvitationsProcessor);
//# sourceMappingURL=invitations.processor.js.map

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.processor.js.map
Size: 937 B
================================================================================

{"version":3,"file":"invitations.processor.js","sourceRoot":"","sources":["../../../../src/modules/invitations/invitations.processor.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAAuD;AAEvD,2CAAwC;AACxC,uDAAmD;AAG5C,IAAM,oBAAoB,4BAA1B,MAAM,oBAAqB,SAAQ,mBAAU;IAGrB;IAFZ,MAAM,GAAG,IAAI,eAAM,CAAC,sBAAoB,CAAC,IAAI,CAAC,CAAC;IAEhE,YAA6B,WAAwB;QACnD,KAAK,EAAE,CAAC;QADmB,gBAAW,GAAX,WAAW,CAAa;IAErD,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAA0B;QACtC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,kBAAkB,GAAG,CAAC,EAAE,YAAY,GAAG,CAAC,IAAI,KAAK,CAAC,CAAC;QAEnE,QAAQ,GAAG,CAAC,IAAI,EAAE,CAAC;YACjB,KAAK,iBAAiB;gBACpB,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;gBAC5C,OAAO,MAAM,IAAI,CAAC,WAAW,CAAC,mBAAmB,CAC/C,KAAK,EACL,QAAQ,EACR,KAAK,CACN,CAAC;YAEJ;gBACE,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;QACtD,CAAC;IACH,CAAC;CACF,CAAA;AAvBY,oDAAoB;+BAApB,oBAAoB;IADhC,IAAA,kBAAS,EAAC,YAAY,CAAC;qCAIoB,0BAAW;GAH1C,oBAAoB,CAuBhC"}

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.service.d.ts
Size: 808 B
================================================================================

import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../../prisma/prisma.service';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { MailService } from '../mail/mail.service';
import { TeamRole } from '@prisma/client';
export declare class InvitationsService {
    private prisma;
    private jwtService;
    private notifications;
    private mailService;
    constructor(prisma: PrismaService, jwtService: JwtService, notifications: NotificationsGateway, mailService: MailService);
    createInvitation(teamId: number, inviterId: number, targetEmail: string, role?: TeamRole): Promise<{
        message: string;
        invitationId: number;
    }>;
    acceptInvitation(token: string, userId: number): Promise<{
        message: string;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.service.js
Size: 5.93 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InvitationsService = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const prisma_service_1 = require("../../prisma/prisma.service");
const notifications_gateway_1 = require("../notifications/notifications.gateway");
const mail_service_1 = require("../mail/mail.service");
const client_1 = require("@prisma/client");
let InvitationsService = class InvitationsService {
    prisma;
    jwtService;
    notifications;
    mailService;
    constructor(prisma, jwtService, notifications, mailService) {
        this.prisma = prisma;
        this.jwtService = jwtService;
        this.notifications = notifications;
        this.mailService = mailService;
    }
    async createInvitation(teamId, inviterId, targetEmail, role = client_1.TeamRole.MEMBER) {
        const team = await this.prisma.team.findUnique({
            where: { id: teamId },
            include: { members: true },
        });
        if (!team)
            throw new common_1.NotFoundException('Team not found');
        const inviterMember = team.members.find((m) => m.userId === inviterId);
        if (!inviterMember) {
            throw new common_1.ForbiddenException('You are not a member of this team');
        }
        if (inviterMember.role !== client_1.TeamRole.OWNER) {
            throw new common_1.ForbiddenException('Only team owners can send invitations');
        }
        const lowerEmail = targetEmail.toLowerCase();
        const existingMember = await this.prisma.teamMember.findFirst({
            where: { teamId, user: { email: lowerEmail } },
        });
        if (existingMember)
            throw new common_1.BadRequestException('User is already a member of this team');
        const inviterUser = await this.prisma.user.findUnique({
            where: { id: inviterId },
        });
        if (inviterUser?.email.toLowerCase() === lowerEmail) {
            throw new common_1.BadRequestException('You cannot invite yourself');
        }
        const invitationToken = this.jwtService.sign({ teamId, email: lowerEmail, role, inviterId }, { expiresIn: '7d' });
        const invitation = await this.prisma.invitation.create({
            data: {
                email: lowerEmail,
                token: invitationToken,
                teamId,
                inviterId,
                expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
                status: client_1.InvitationStatus.PENDING,
            },
        });
        await this.mailService.sendInvitationEmail(lowerEmail, team.name, invitationToken);
        return {
            message: 'Invitation sent successfully',
            invitationId: invitation.id,
        };
    }
    async acceptInvitation(token, userId) {
        try {
            const payload = await this.jwtService.verifyAsync(token);
            const { teamId, email, role } = payload;
            const invitation = await this.prisma.invitation.findUnique({
                where: { token },
            });
            if (!invitation ||
                invitation.status === client_1.InvitationStatus.ACCEPTED ||
                new Date() > invitation.expiresAt) {
                throw new common_1.BadRequestException('Invitation invalid, already accepted or expired');
            }
            const user = await this.prisma.user.findUnique({ where: { id: userId } });
            if (!user)
                throw new common_1.NotFoundException('User not found');
            if (user.email.toLowerCase() !== email.toLowerCase()) {
                throw new common_1.ForbiddenException('Email mismatch for this invitation');
            }
            const userName = user.name ?? 'New Member';
            await this.prisma.$transaction([
                this.prisma.teamMember.create({
                    data: {
                        userId,
                        teamId,
                        role: role || client_1.TeamRole.MEMBER,
                    },
                }),
                this.prisma.invitation.update({
                    where: { id: invitation.id },
                    data: { status: client_1.InvitationStatus.ACCEPTED },
                }),
            ]);
            this.notifications.notifyInvitationAccepted(teamId, userName);
            return { message: 'Joined the team successfully' };
        }
        catch (error) {
            if (error.name === 'JsonWebTokenError')
                throw new common_1.BadRequestException('Invalid invitation token');
            if (error.name === 'TokenExpiredError')
                throw new common_1.BadRequestException('Invitation token has expired');
            throw error;
        }
    }
};
exports.InvitationsService = InvitationsService;
exports.InvitationsService = InvitationsService = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService,
        jwt_1.JwtService,
        notifications_gateway_1.NotificationsGateway,
        mail_service_1.MailService])
], InvitationsService);
//# sourceMappingURL=invitations.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/invitations/invitations.service.js.map
Size: 3.91 kB
================================================================================

{"version":3,"file":"invitations.service.js","sourceRoot":"","sources":["../../../../src/modules/invitations/invitations.service.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,2CAKwB;AACxB,qCAAyC;AACzC,gEAA4D;AAC5D,kFAA8E;AAC9E,uDAAmD;AACnD,2CAA4D;AAGrD,IAAM,kBAAkB,GAAxB,MAAM,kBAAkB;IAEnB;IACA;IACA;IACA;IAJV,YACU,MAAqB,EACrB,UAAsB,EACtB,aAAmC,EACnC,WAAwB;QAHxB,WAAM,GAAN,MAAM,CAAe;QACrB,eAAU,GAAV,UAAU,CAAY;QACtB,kBAAa,GAAb,aAAa,CAAsB;QACnC,gBAAW,GAAX,WAAW,CAAa;IAC/B,CAAC;IAEJ,KAAK,CAAC,gBAAgB,CACpB,MAAc,EACd,SAAiB,EACjB,WAAmB,EACnB,OAAiB,iBAAQ,CAAC,MAAM;QAGhC,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YAC7C,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;YACrB,OAAO,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE;SAC3B,CAAC,CAAC;QACH,IAAI,CAAC,IAAI;YAAE,MAAM,IAAI,0BAAiB,CAAC,gBAAgB,CAAC,CAAC;QAGzD,MAAM,aAAa,GAAG,IAAI,CAAC,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,SAAS,CAAC,CAAC;QACvE,IAAI,CAAC,aAAa,EAAE,CAAC;YACnB,MAAM,IAAI,2BAAkB,CAAC,mCAAmC,CAAC,CAAC;QACpE,CAAC;QACD,IAAI,aAAa,CAAC,IAAI,KAAK,iBAAQ,CAAC,KAAK,EAAE,CAAC;YAC1C,MAAM,IAAI,2BAAkB,CAAC,uCAAuC,CAAC,CAAC;QACxE,CAAC;QAED,MAAM,UAAU,GAAG,WAAW,CAAC,WAAW,EAAE,CAAC;QAG7C,MAAM,cAAc,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,SAAS,CAAC;YAC5D,KAAK,EAAE,EAAE,MAAM,EAAE,IAAI,EAAE,EAAE,KAAK,EAAE,UAAU,EAAE,EAAE;SAC/C,CAAC,CAAC;QACH,IAAI,cAAc;YAChB,MAAM,IAAI,4BAAmB,CAAC,uCAAuC,CAAC,CAAC;QAGzE,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACpD,KAAK,EAAE,EAAE,EAAE,EAAE,SAAS,EAAE;SACzB,CAAC,CAAC;QACH,IAAI,WAAW,EAAE,KAAK,CAAC,WAAW,EAAE,KAAK,UAAU,EAAE,CAAC;YACpD,MAAM,IAAI,4BAAmB,CAAC,4BAA4B,CAAC,CAAC;QAC9D,CAAC;QAGD,MAAM,eAAe,GAAG,IAAI,CAAC,UAAU,CAAC,IAAI,CAC1C,EAAE,MAAM,EAAE,KAAK,EAAE,UAAU,EAAE,IAAI,EAAE,SAAS,EAAE,EAC9C,EAAE,SAAS,EAAE,IAAI,EAAE,CACpB,CAAC;QAGF,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC;YACrD,IAAI,EAAE;gBACJ,KAAK,EAAE,UAAU;gBACjB,KAAK,EAAE,eAAe;gBACtB,MAAM;gBACN,SAAS;gBACT,SAAS,EAAE,IAAI,IAAI,CAAC,IAAI,CAAC,GAAG,EAAE,GAAG,CAAC,GAAG,EAAE,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;gBACzD,MAAM,EAAE,yBAAgB,CAAC,OAAO;aACjC;SACF,CAAC,CAAC;QAGH,MAAM,IAAI,CAAC,WAAW,CAAC,mBAAmB,CACxC,UAAU,EACV,IAAI,CAAC,IAAI,EACT,eAAe,CAChB,CAAC;QAEF,OAAO;YACL,OAAO,EAAE,8BAA8B;YACvC,YAAY,EAAE,UAAU,CAAC,EAAE;SAC5B,CAAC;IACJ,CAAC;IAED,KAAK,CAAC,gBAAgB,CAAC,KAAa,EAAE,MAAc;QAClD,IAAI,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,UAAU,CAAC,WAAW,CAAC,KAAK,CAAC,CAAC;YACzD,MAAM,EAAE,MAAM,EAAE,KAAK,EAAE,IAAI,EAAE,GAAG,OAAO,CAAC;YAGxC,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,UAAU,CAAC;gBACzD,KAAK,EAAE,EAAE,KAAK,EAAE;aACjB,CAAC,CAAC;YAEH,IACE,CAAC,UAAU;gBACX,UAAU,CAAC,MAAM,KAAK,yBAAgB,CAAC,QAAQ;gBAC/C,IAAI,IAAI,EAAE,GAAG,UAAU,CAAC,SAAS,EACjC,CAAC;gBACD,MAAM,IAAI,4BAAmB,CAC3B,iDAAiD,CAClD,CAAC;YACJ,CAAC;YAGD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,UAAU,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE,EAAE,CAAC,CAAC;YAC1E,IAAI,CAAC,IAAI;gBAAE,MAAM,IAAI,0BAAiB,CAAC,gBAAgB,CAAC,CAAC;YAGzD,IAAI,IAAI,CAAC,KAAK,CAAC,WAAW,EAAE,KAAK,KAAK,CAAC,WAAW,EAAE,EAAE,CAAC;gBACrD,MAAM,IAAI,2BAAkB,CAAC,oCAAoC,CAAC,CAAC;YACrE,CAAC;YAED,MAAM,QAAQ,GAAG,IAAI,CAAC,IAAI,IAAI,YAAY,CAAC;YAG3C,MAAM,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC;gBAC7B,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC;oBAC5B,IAAI,EAAE;wBACJ,MAAM;wBACN,MAAM;wBACN,IAAI,EAAG,IAAiB,IAAI,iBAAQ,CAAC,MAAM;qBAC5C;iBACF,CAAC;gBACF,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC;oBAC5B,KAAK,EAAE,EAAE,EAAE,EAAE,UAAU,CAAC,EAAE,EAAE;oBAC5B,IAAI,EAAE,EAAE,MAAM,EAAE,yBAAgB,CAAC,QAAQ,EAAE;iBAC5C,CAAC;aACH,CAAC,CAAC;YAGH,IAAI,CAAC,aAAa,CAAC,wBAAwB,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;YAE9D,OAAO,EAAE,OAAO,EAAE,8BAA8B,EAAE,CAAC;QACrD,CAAC;QAAC,OAAO,KAAU,EAAE,CAAC;YACpB,IAAI,KAAK,CAAC,IAAI,KAAK,mBAAmB;gBACpC,MAAM,IAAI,4BAAmB,CAAC,0BAA0B,CAAC,CAAC;YAC5D,IAAI,KAAK,CAAC,IAAI,KAAK,mBAAmB;gBACpC,MAAM,IAAI,4BAAmB,CAAC,8BAA8B,CAAC,CAAC;YAChE,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF,CAAA;AAzIY,gDAAkB;6BAAlB,kBAAkB;IAD9B,IAAA,mBAAU,GAAE;qCAGO,8BAAa;QACT,gBAAU;QACP,4CAAoB;QACtB,0BAAW;GALvB,kBAAkB,CAyI9B"}

================================================================================
File: bff-nestjs/dist/src/modules/mail/interfaces/mail-provider.interface.d.ts
Size: 198 B
================================================================================

export interface IMailOptions {
    to: string;
    subject: string;
    template: string;
    context: any;
}
export interface IMailProvider {
    sendMail(options: IMailOptions): Promise<void>;
}


================================================================================
File: bff-nestjs/dist/src/modules/mail/interfaces/mail-provider.interface.js
Size: 128 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
//# sourceMappingURL=mail-provider.interface.js.map

================================================================================
File: bff-nestjs/dist/src/modules/mail/interfaces/mail-provider.interface.js.map
Size: 174 B
================================================================================

{"version":3,"file":"mail-provider.interface.js","sourceRoot":"","sources":["../../../../../src/modules/mail/interfaces/mail-provider.interface.ts"],"names":[],"mappings":""}

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.module.d.ts
Size: 36 B
================================================================================

export declare class MailModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.module.js
Size: 1.1 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MailModule = void 0;
const common_1 = require("@nestjs/common");
const mail_service_1 = require("./mail.service");
let MailModule = class MailModule {
};
exports.MailModule = MailModule;
exports.MailModule = MailModule = __decorate([
    (0, common_1.Module)({
        providers: [
            mail_service_1.MailService,
        ],
        exports: [mail_service_1.MailService],
    })
], MailModule);
//# sourceMappingURL=mail.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.module.js.map
Size: 342 B
================================================================================

{"version":3,"file":"mail.module.js","sourceRoot":"","sources":["../../../../src/modules/mail/mail.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,iDAA6C;AAUtC,IAAM,UAAU,GAAhB,MAAM,UAAU;CAAG,CAAA;AAAb,gCAAU;qBAAV,UAAU;IAPtB,IAAA,eAAM,EAAC;QACN,SAAS,EAAE;YACT,0BAAW;SAEZ;QACD,OAAO,EAAE,CAAC,0BAAW,CAAC;KACvB,CAAC;GACW,UAAU,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.processor.d.ts
Size: 340 B
================================================================================

import { WorkerHost } from '@nestjs/bullmq';
import { Job } from 'bullmq';
import { MailService } from './mail.service';
export declare class MailProcessor extends WorkerHost {
    private readonly mailService;
    private readonly logger;
    constructor(mailService: MailService);
    process(job: Job<any, any, string>): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.processor.js
Size: 1.98 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var MailProcessor_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.MailProcessor = void 0;
const bullmq_1 = require("@nestjs/bullmq");
const common_1 = require("@nestjs/common");
const mail_service_1 = require("./mail.service");
let MailProcessor = MailProcessor_1 = class MailProcessor extends bullmq_1.WorkerHost {
    mailService;
    logger = new common_1.Logger(MailProcessor_1.name);
    constructor(mailService) {
        super();
        this.mailService = mailService;
    }
    async process(job) {
        this.logger.log(`Processing job ${job.id} of type ${job.name}...`);
        switch (job.name) {
            case 'send-invitation':
                const { email, token, teamName } = job.data;
                return await this.mailService.sendInvitationEmail(email, teamName, token);
            default:
                this.logger.warn(`Unknown job name: ${job.name}`);
        }
    }
};
exports.MailProcessor = MailProcessor;
exports.MailProcessor = MailProcessor = MailProcessor_1 = __decorate([
    (0, bullmq_1.Processor)('mail-queue'),
    __metadata("design:paramtypes", [mail_service_1.MailService])
], MailProcessor);
//# sourceMappingURL=mail.processor.js.map

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.processor.js.map
Size: 903 B
================================================================================

{"version":3,"file":"mail.processor.js","sourceRoot":"","sources":["../../../../src/modules/mail/mail.processor.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAAuD;AAEvD,2CAAwC;AAExC,iDAA6C;AAGtC,IAAM,aAAa,qBAAnB,MAAM,aAAc,SAAQ,mBAAU;IAGd;IAFZ,MAAM,GAAG,IAAI,eAAM,CAAC,eAAa,CAAC,IAAI,CAAC,CAAC;IAEzD,YAA6B,WAAwB;QACnD,KAAK,EAAE,CAAC;QADmB,gBAAW,GAAX,WAAW,CAAa;IAErD,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,GAA0B;QACtC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,kBAAkB,GAAG,CAAC,EAAE,YAAY,GAAG,CAAC,IAAI,KAAK,CAAC,CAAC;QAEnE,QAAQ,GAAG,CAAC,IAAI,EAAE,CAAC;YACjB,KAAK,iBAAiB;gBACpB,MAAM,EAAE,KAAK,EAAE,KAAK,EAAE,QAAQ,EAAE,GAAG,GAAG,CAAC,IAAI,CAAC;gBAC5C,OAAO,MAAM,IAAI,CAAC,WAAW,CAAC,mBAAmB,CAC/C,KAAK,EACL,QAAQ,EACR,KAAK,CACN,CAAC;YAEJ;gBACE,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,qBAAqB,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;QACtD,CAAC;IACH,CAAC;CACF,CAAA;AAvBY,sCAAa;wBAAb,aAAa;IADzB,IAAA,kBAAS,EAAC,YAAY,CAAC;qCAIoB,0BAAW;GAH1C,aAAa,CAuBzB"}

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.service.d.ts
Size: 128 B
================================================================================

export declare class MailService {
    sendInvitationEmail(email: string, teamName: string, token: string): Promise<boolean>;
}


================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.service.js
Size: 1.17 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MailService = void 0;
const common_1 = require("@nestjs/common");
let MailService = class MailService {
    async sendInvitationEmail(email, teamName, token) {
        console.log(`[SIMULATED MAIL] Sending invitation to ${email} for team ${teamName}`);
        console.log(`[SIMULATED MAIL] Token: ${token}`);
        return true;
    }
};
exports.MailService = MailService;
exports.MailService = MailService = __decorate([
    (0, common_1.Injectable)()
], MailService);
//# sourceMappingURL=mail.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/mail/mail.service.js.map
Size: 461 B
================================================================================

{"version":3,"file":"mail.service.js","sourceRoot":"","sources":["../../../../src/modules/mail/mail.service.ts"],"names":[],"mappings":";;;;;;;;;AACA,2CAA4C;AAGrC,IAAM,WAAW,GAAjB,MAAM,WAAW;IAGtB,KAAK,CAAC,mBAAmB,CAAC,KAAa,EAAE,QAAgB,EAAE,KAAa;QAEtE,OAAO,CAAC,GAAG,CACT,0CAA0C,KAAK,aAAa,QAAQ,EAAE,CACvE,CAAC;QACF,OAAO,CAAC,GAAG,CAAC,2BAA2B,KAAK,EAAE,CAAC,CAAC;QAChD,OAAO,IAAI,CAAC;IACd,CAAC;CACF,CAAA;AAXY,kCAAW;sBAAX,WAAW;IADvB,IAAA,mBAAU,GAAE;GACA,WAAW,CAWvB"}

================================================================================
File: bff-nestjs/dist/src/modules/mail/providers/nodemailer.provider.d.ts
Size: 368 B
================================================================================

import { ConfigService } from '@nestjs/config';
import { IMailProvider, IMailOptions } from '../interfaces/mail-provider.interface';
export declare class NodemailerProvider implements IMailProvider {
    private config;
    private transporter;
    private readonly logger;
    constructor(config: ConfigService);
    sendMail(options: IMailOptions): Promise<void>;
}


================================================================================
File: bff-nestjs/dist/src/modules/mail/providers/nodemailer.provider.js
Size: 3.98 kB
================================================================================

"use strict";
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var NodemailerProvider_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NodemailerProvider = void 0;
const common_1 = require("@nestjs/common");
const nodemailer = __importStar(require("nodemailer"));
const config_1 = require("@nestjs/config");
let NodemailerProvider = NodemailerProvider_1 = class NodemailerProvider {
    config;
    transporter;
    logger = new common_1.Logger(NodemailerProvider_1.name);
    constructor(config) {
        this.config = config;
        this.transporter = nodemailer.createTransport({
            host: this.config.get('MAIL_HOST'),
            port: this.config.get('MAIL_PORT'),
            auth: {
                user: this.config.get('MAIL_USER'),
                pass: this.config.get('MAIL_PASS'),
            },
        });
    }
    async sendMail(options) {
        try {
            await this.transporter.sendMail({
                from: this.config.get('MAIL_FROM'),
                to: options.to,
                subject: options.subject,
                html: `<h1>${options.subject}</h1><p>${options.context.message || ''}</p>`,
            });
            this.logger.log(`Email successfully sent to ${options.to}`);
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'An unknown error occurred';
            const errorStack = error instanceof Error ? error.stack : undefined;
            this.logger.error(`Failed to send email to ${options.to}: ${errorMessage}`, errorStack);
            throw error;
        }
    }
};
exports.NodemailerProvider = NodemailerProvider;
exports.NodemailerProvider = NodemailerProvider = NodemailerProvider_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], NodemailerProvider);
//# sourceMappingURL=nodemailer.provider.js.map

================================================================================
File: bff-nestjs/dist/src/modules/mail/providers/nodemailer.provider.js.map
Size: 1.55 kB
================================================================================

{"version":3,"file":"nodemailer.provider.js","sourceRoot":"","sources":["../../../../../src/modules/mail/providers/nodemailer.provider.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA,2CAAoD;AACpD,uDAAyC;AACzC,2CAA+C;AAOxC,IAAM,kBAAkB,0BAAxB,MAAM,kBAAkB;IAIT;IAHZ,WAAW,CAAyB;IAC3B,MAAM,GAAG,IAAI,eAAM,CAAC,oBAAkB,CAAC,IAAI,CAAC,CAAC;IAE9D,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;QAEvC,IAAI,CAAC,WAAW,GAAG,UAAU,CAAC,eAAe,CAAC;YAC5C,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;YAC1C,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;YAC1C,IAAI,EAAE;gBACJ,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;gBAC1C,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;aAC3C;SACF,CAAC,CAAC;IACL,CAAC;IAMD,KAAK,CAAC,QAAQ,CAAC,OAAqB;QAClC,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,WAAW,CAAC,QAAQ,CAAC;gBAC9B,IAAI,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,WAAW,CAAC;gBAC1C,EAAE,EAAE,OAAO,CAAC,EAAE;gBACd,OAAO,EAAE,OAAO,CAAC,OAAO;gBAGxB,IAAI,EAAE,OAAO,OAAO,CAAC,OAAO,WAAW,OAAO,CAAC,OAAO,CAAC,OAAO,IAAI,EAAE,MAAM;aAC3E,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,8BAA8B,OAAO,CAAC,EAAE,EAAE,CAAC,CAAC;QAC9D,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YAExB,MAAM,YAAY,GAChB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,2BAA2B,CAAC;YACvE,MAAM,UAAU,GAAG,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,KAAK,CAAC,CAAC,CAAC,SAAS,CAAC;YAEpE,IAAI,CAAC,MAAM,CAAC,KAAK,CACf,2BAA2B,OAAO,CAAC,EAAE,KAAK,YAAY,EAAE,EACxD,UAAU,CACX,CAAC;YAGF,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF,CAAA;AA/CY,gDAAkB;6BAAlB,kBAAkB;IAD9B,IAAA,mBAAU,GAAE;qCAKiB,sBAAa;GAJ9B,kBAAkB,CA+C9B"}

================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.gateway.d.ts
Size: 346 B
================================================================================

import { Server, Socket } from 'socket.io';
export declare class NotificationsGateway {
    server: Server;
    private readonly logger;
    handleJoinTeam(teamId: number, client: Socket): void;
    notifyInvitationAccepted(teamId: number, userName: string): void;
    notifyTaskUpdate(teamId: number, taskTitle: string, action: string): void;
}


================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.gateway.js
Size: 2.85 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
var NotificationsGateway_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationsGateway = void 0;
const websockets_1 = require("@nestjs/websockets");
const socket_io_1 = require("socket.io");
const common_1 = require("@nestjs/common");
let NotificationsGateway = NotificationsGateway_1 = class NotificationsGateway {
    server;
    logger = new common_1.Logger(NotificationsGateway_1.name);
    handleJoinTeam(teamId, client) {
        const room = `team_${teamId}`;
        client.join(room);
        this.logger.log(`Client ${client.id} joined room: ${room}`);
    }
    notifyInvitationAccepted(teamId, userName) {
        this.server.to(`team_${teamId}`).emit('notification', {
            type: 'INVITATION_ACCEPTED',
            message: `${userName} has joined the team!`,
        });
    }
    notifyTaskUpdate(teamId, taskTitle, action) {
        this.server.to(`team_${teamId}`).emit('notification', {
            type: 'TASK_UPDATE',
            message: `Task "${taskTitle}" was ${action}`,
        });
    }
};
exports.NotificationsGateway = NotificationsGateway;
__decorate([
    (0, websockets_1.WebSocketServer)(),
    __metadata("design:type", socket_io_1.Server)
], NotificationsGateway.prototype, "server", void 0);
__decorate([
    (0, websockets_1.SubscribeMessage)('joinTeam'),
    __param(0, (0, websockets_1.MessageBody)('teamId')),
    __param(1, (0, websockets_1.ConnectedSocket)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, socket_io_1.Socket]),
    __metadata("design:returntype", void 0)
], NotificationsGateway.prototype, "handleJoinTeam", null);
exports.NotificationsGateway = NotificationsGateway = NotificationsGateway_1 = __decorate([
    (0, websockets_1.WebSocketGateway)({
        cors: { origin: '*' },
        namespace: 'notifications',
    })
], NotificationsGateway);
//# sourceMappingURL=notifications.gateway.js.map

================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.gateway.js.map
Size: 1.27 kB
================================================================================

{"version":3,"file":"notifications.gateway.js","sourceRoot":"","sources":["../../../../src/modules/notifications/notifications.gateway.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;AAAA,mDAM4B;AAC5B,yCAA2C;AAC3C,2CAAmD;AAO5C,IAAM,oBAAoB,4BAA1B,MAAM,oBAAoB;IACZ,MAAM,CAAU;IAClB,MAAM,GAAG,IAAI,eAAM,CAAC,sBAAoB,CAAC,IAAI,CAAC,CAAC;IAIhE,cAAc,CACW,MAAc,EAClB,MAAc;QAEjC,MAAM,IAAI,GAAG,QAAQ,MAAM,EAAE,CAAC;QAC9B,MAAM,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,UAAU,MAAM,CAAC,EAAE,iBAAiB,IAAI,EAAE,CAAC,CAAC;IAC9D,CAAC;IAED,wBAAwB,CAAC,MAAc,EAAE,QAAgB;QACvD,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,QAAQ,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,cAAc,EAAE;YACpD,IAAI,EAAE,qBAAqB;YAC3B,OAAO,EAAE,GAAG,QAAQ,uBAAuB;SAC5C,CAAC,CAAC;IACL,CAAC;IAED,gBAAgB,CAAC,MAAc,EAAE,SAAiB,EAAE,MAAc;QAChE,IAAI,CAAC,MAAM,CAAC,EAAE,CAAC,QAAQ,MAAM,EAAE,CAAC,CAAC,IAAI,CAAC,cAAc,EAAE;YACpD,IAAI,EAAE,aAAa;YACnB,OAAO,EAAE,SAAS,SAAS,SAAS,MAAM,EAAE;SAC7C,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AA5BY,oDAAoB;AACZ;IAAlB,IAAA,4BAAe,GAAE;8BAAU,kBAAM;oDAAC;AAKnC;IADC,IAAA,6BAAgB,EAAC,UAAU,CAAC;IAE1B,WAAA,IAAA,wBAAW,EAAC,QAAQ,CAAC,CAAA;IACrB,WAAA,IAAA,4BAAe,GAAE,CAAA;;6CAAS,kBAAM;;0DAKlC;+BAbU,oBAAoB;IAJhC,IAAA,6BAAgB,EAAC;QAChB,IAAI,EAAE,EAAE,MAAM,EAAE,GAAG,EAAE;QACrB,SAAS,EAAE,eAAe;KAC3B,CAAC;GACW,oBAAoB,CA4BhC"}

================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.module.d.ts
Size: 45 B
================================================================================

export declare class NotificationsModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.module.js
Size: 1.35 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.NotificationsModule = void 0;
const common_1 = require("@nestjs/common");
const jwt_1 = require("@nestjs/jwt");
const notifications_gateway_1 = require("./notifications.gateway");
let NotificationsModule = class NotificationsModule {
};
exports.NotificationsModule = NotificationsModule;
exports.NotificationsModule = NotificationsModule = __decorate([
    (0, common_1.Global)(),
    (0, common_1.Module)({
        imports: [
            jwt_1.JwtModule.register({}),
        ],
        providers: [notifications_gateway_1.NotificationsGateway],
        exports: [notifications_gateway_1.NotificationsGateway],
    })
], NotificationsModule);
//# sourceMappingURL=notifications.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/notifications/notifications.module.js.map
Size: 472 B
================================================================================

{"version":3,"file":"notifications.module.js","sourceRoot":"","sources":["../../../../src/modules/notifications/notifications.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAgD;AAChD,qCAAwC;AACxC,mEAA+D;AAWxD,IAAM,mBAAmB,GAAzB,MAAM,mBAAmB;CAAG,CAAA;AAAtB,kDAAmB;8BAAnB,mBAAmB;IAT/B,IAAA,eAAM,GAAE;IACR,IAAA,eAAM,EAAC;QACN,OAAO,EAAE;YAEP,eAAS,CAAC,QAAQ,CAAC,EAAE,CAAC;SACvB;QACD,SAAS,EAAE,CAAC,4CAAoB,CAAC;QACjC,OAAO,EAAE,CAAC,4CAAoB,CAAC;KAChC,CAAC;GACW,mBAAmB,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/projects/dto/create-project.dto.d.ts
Size: 86 B
================================================================================

export declare class CreateProjectDto {
    name: string;
    description?: string;
}


================================================================================
File: bff-nestjs/dist/src/modules/projects/dto/create-project.dto.js
Size: 1.78 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateProjectDto = void 0;
const class_validator_1 = require("class-validator");
const swagger_1 = require("@nestjs/swagger");
class CreateProjectDto {
    name;
    description;
}
exports.CreateProjectDto = CreateProjectDto;
__decorate([
    (0, swagger_1.ApiProperty)({ example: 'Marketing Campaign', minLength: 3 }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    (0, class_validator_1.MinLength)(3),
    (0, class_validator_1.MaxLength)(100),
    __metadata("design:type", String)
], CreateProjectDto.prototype, "name", void 0);
__decorate([
    (0, swagger_1.ApiPropertyOptional)({ example: 'Project focused on Q1 social media growth' }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsOptional)(),
    (0, class_validator_1.MaxLength)(500),
    __metadata("design:type", String)
], CreateProjectDto.prototype, "description", void 0);
//# sourceMappingURL=create-project.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/projects/dto/create-project.dto.js.map
Size: 593 B
================================================================================

{"version":3,"file":"create-project.dto.js","sourceRoot":"","sources":["../../../../../src/modules/projects/dto/create-project.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAMyB;AACzB,6CAAmE;AAEnE,MAAa,gBAAgB;IAM3B,IAAI,CAAU;IAMd,WAAW,CAAU;CACtB;AAbD,4CAaC;AAPC;IALC,IAAA,qBAAW,EAAC,EAAE,OAAO,EAAE,oBAAoB,EAAE,SAAS,EAAE,CAAC,EAAE,CAAC;IAC5D,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;IACZ,IAAA,2BAAS,EAAC,CAAC,CAAC;IACZ,IAAA,2BAAS,EAAC,GAAG,CAAC;;8CACD;AAMd;IAJC,IAAA,6BAAmB,EAAC,EAAE,OAAO,EAAE,2CAA2C,EAAE,CAAC;IAC7E,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;IACZ,IAAA,2BAAS,EAAC,GAAG,CAAC;;qDACM"}

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.controller.d.ts
Size: 925 B
================================================================================

import { ProjectsService } from './projects.service';
import { CreateProjectDto } from './dto/create-project.dto';
import { Role } from '@prisma/client';
export declare class ProjectsController {
    private projectsService;
    constructor(projectsService: ProjectsService);
    create(teamId: number, dto: CreateProjectDto): Promise<{
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        teamId: number;
    }>;
    findAll(teamId: number): Promise<({
        _count: {
            tasks: number;
        };
    } & {
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        teamId: number;
    })[]>;
    remove(teamId: number, projectId: number, userId: number, userRole: Role): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.controller.js
Size: 3.7 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectsController = void 0;
const common_1 = require("@nestjs/common");
const projects_service_1 = require("./projects.service");
const create_project_dto_1 = require("./dto/create-project.dto");
const roles_guard_1 = require("../../common/guards/roles.guard");
const decorators_1 = require("../../common/decorators");
const client_1 = require("@prisma/client");
const swagger_1 = require("@nestjs/swagger");
let ProjectsController = class ProjectsController {
    projectsService;
    constructor(projectsService) {
        this.projectsService = projectsService;
    }
    create(teamId, dto) {
        return this.projectsService.create(teamId, dto);
    }
    findAll(teamId) {
        return this.projectsService.findAllByTeam(teamId);
    }
    remove(teamId, projectId, userId, userRole) {
        return this.projectsService.remove(teamId, projectId, userRole);
    }
};
exports.ProjectsController = ProjectsController;
__decorate([
    (0, common_1.Post)(),
    (0, swagger_1.ApiOperation)({ summary: 'Create a new project' }),
    __param(0, (0, common_1.Param)('teamId', common_1.ParseIntPipe)),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, create_project_dto_1.CreateProjectDto]),
    __metadata("design:returntype", void 0)
], ProjectsController.prototype, "create", null);
__decorate([
    (0, common_1.Get)(),
    (0, swagger_1.ApiOperation)({ summary: 'List team projects' }),
    __param(0, (0, common_1.Param)('teamId', common_1.ParseIntPipe)),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number]),
    __metadata("design:returntype", void 0)
], ProjectsController.prototype, "findAll", null);
__decorate([
    (0, common_1.Delete)(':projectId'),
    (0, swagger_1.ApiOperation)({ summary: 'Soft-delete a project' }),
    __param(0, (0, common_1.Param)('teamId', common_1.ParseIntPipe)),
    __param(1, (0, common_1.Param)('projectId', common_1.ParseIntPipe)),
    __param(2, (0, decorators_1.GetCurrentUserId)()),
    __param(3, (0, decorators_1.GetCurrentUserRole)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, Number, Number, String]),
    __metadata("design:returntype", void 0)
], ProjectsController.prototype, "remove", null);
exports.ProjectsController = ProjectsController = __decorate([
    (0, swagger_1.ApiTags)('Projects'),
    (0, swagger_1.ApiBearerAuth)('access-token'),
    (0, common_1.Controller)('teams/:teamId/projects'),
    (0, common_1.UseGuards)(roles_guard_1.RolesGuard),
    __metadata("design:paramtypes", [projects_service_1.ProjectsService])
], ProjectsController);
//# sourceMappingURL=projects.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.controller.js.map
Size: 1.49 kB
================================================================================

{"version":3,"file":"projects.controller.js","sourceRoot":"","sources":["../../../../src/modules/projects/projects.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CASwB;AACxB,yDAAqD;AACrD,iEAA4D;AAC5D,iEAA6D;AAC7D,wDAA+E;AAC/E,2CAAgD;AAChD,6CAKyB;AAMlB,IAAM,kBAAkB,GAAxB,MAAM,kBAAkB;IACT;IAApB,YAAoB,eAAgC;QAAhC,oBAAe,GAAf,eAAe,CAAiB;IAAG,CAAC;IAIxD,MAAM,CAC2B,MAAc,EACrC,GAAqB;QAE7B,OAAO,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAClD,CAAC;IAID,OAAO,CAAgC,MAAc;QACnD,OAAO,IAAI,CAAC,eAAe,CAAC,aAAa,CAAC,MAAM,CAAC,CAAC;IACpD,CAAC;IAID,MAAM,CAC2B,MAAc,EACX,SAAiB,EAC/B,MAAc,EACZ,QAAc;QAGpC,OAAO,IAAI,CAAC,eAAe,CAAC,MAAM,CAAC,MAAM,EAAE,SAAS,EAAE,QAAQ,CAAC,CAAC;IAClE,CAAC;CACF,CAAA;AA7BY,gDAAkB;AAK7B;IAFC,IAAA,aAAI,GAAE;IACN,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,sBAAsB,EAAE,CAAC;IAE/C,WAAA,IAAA,cAAK,EAAC,QAAQ,EAAE,qBAAY,CAAC,CAAA;IAC7B,WAAA,IAAA,aAAI,GAAE,CAAA;;6CAAM,qCAAgB;;gDAG9B;AAID;IAFC,IAAA,YAAG,GAAE;IACL,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,oBAAoB,EAAE,CAAC;IACvC,WAAA,IAAA,cAAK,EAAC,QAAQ,EAAE,qBAAY,CAAC,CAAA;;;;iDAErC;AAID;IAFC,IAAA,eAAM,EAAC,YAAY,CAAC;IACpB,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,uBAAuB,EAAE,CAAC;IAEhD,WAAA,IAAA,cAAK,EAAC,QAAQ,EAAE,qBAAY,CAAC,CAAA;IAC7B,WAAA,IAAA,cAAK,EAAC,WAAW,EAAE,qBAAY,CAAC,CAAA;IAChC,WAAA,IAAA,6BAAgB,GAAE,CAAA;IAClB,WAAA,IAAA,+BAAkB,GAAE,CAAA;;;;gDAItB;6BA5BU,kBAAkB;IAJ9B,IAAA,iBAAO,EAAC,UAAU,CAAC;IACnB,IAAA,uBAAa,EAAC,cAAc,CAAC;IAC7B,IAAA,mBAAU,EAAC,wBAAwB,CAAC;IACpC,IAAA,kBAAS,EAAC,wBAAU,CAAC;qCAEiB,kCAAe;GADzC,kBAAkB,CA6B9B"}

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.module.d.ts
Size: 40 B
================================================================================

export declare class ProjectsModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.module.js
Size: 1.38 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectsModule = void 0;
const common_1 = require("@nestjs/common");
const projects_service_1 = require("./projects.service");
const projects_controller_1 = require("./projects.controller");
const prisma_module_1 = require("../../prisma/prisma.module");
let ProjectsModule = class ProjectsModule {
};
exports.ProjectsModule = ProjectsModule;
exports.ProjectsModule = ProjectsModule = __decorate([
    (0, common_1.Module)({
        imports: [prisma_module_1.PrismaModule],
        controllers: [projects_controller_1.ProjectsController],
        providers: [projects_service_1.ProjectsService],
        exports: [projects_service_1.ProjectsService],
    })
], ProjectsModule);
//# sourceMappingURL=projects.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.module.js.map
Size: 447 B
================================================================================

{"version":3,"file":"projects.module.js","sourceRoot":"","sources":["../../../../src/modules/projects/projects.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,yDAAqD;AACrD,+DAA2D;AAC3D,8DAA0D;AAQnD,IAAM,cAAc,GAApB,MAAM,cAAc;CAAG,CAAA;AAAjB,wCAAc;yBAAd,cAAc;IAN1B,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,4BAAY,CAAC;QACvB,WAAW,EAAE,CAAC,wCAAkB,CAAC;QACjC,SAAS,EAAE,CAAC,kCAAe,CAAC;QAC5B,OAAO,EAAE,CAAC,kCAAe,CAAC;KAC3B,CAAC;GACW,cAAc,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.service.d.ts
Size: 959 B
================================================================================

import { PrismaService } from '../../prisma/prisma.service';
import { CreateProjectDto } from './dto/create-project.dto';
import { Role, TeamRole } from '@prisma/client';
export declare class ProjectsService {
    private prisma;
    private readonly logger;
    constructor(prisma: PrismaService);
    create(teamId: number, dto: CreateProjectDto): Promise<{
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        teamId: number;
    }>;
    findAllByTeam(teamId: number): Promise<({
        _count: {
            tasks: number;
        };
    } & {
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        teamId: number;
    })[]>;
    remove(teamId: number, projectId: number, userRole: Role, teamRole?: TeamRole): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.service.js
Size: 2.77 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var ProjectsService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.ProjectsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const client_1 = require("@prisma/client");
let ProjectsService = ProjectsService_1 = class ProjectsService {
    prisma;
    logger = new common_1.Logger(ProjectsService_1.name);
    constructor(prisma) {
        this.prisma = prisma;
    }
    async create(teamId, dto) {
        const team = await this.prisma.extended.team.findUnique({
            where: { id: teamId },
        });
        if (!team)
            throw new common_1.NotFoundException(`Team with ID ${teamId} not found`);
        return this.prisma.extended.project.create({
            data: {
                ...dto,
                teamId: teamId,
            },
        });
    }
    async findAllByTeam(teamId) {
        return this.prisma.extended.project.findMany({
            where: { teamId },
            include: {
                _count: { select: { tasks: true } },
            },
        });
    }
    async remove(teamId, projectId, userRole, teamRole) {
        const project = await this.prisma.extended.project.findFirst({
            where: { id: projectId, teamId },
        });
        if (!project)
            throw new common_1.NotFoundException('Project not found in this team');
        const canDelete = userRole === client_1.Role.ADMIN || teamRole === client_1.TeamRole.OWNER;
        if (!canDelete) {
            throw new common_1.ForbiddenException('Only Team Owners or Admins can delete projects');
        }
        return this.prisma.extended.project.softDelete(projectId);
    }
};
exports.ProjectsService = ProjectsService;
exports.ProjectsService = ProjectsService = ProjectsService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], ProjectsService);
//# sourceMappingURL=projects.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/projects/projects.service.js.map
Size: 1.58 kB
================================================================================

{"version":3,"file":"projects.service.js","sourceRoot":"","sources":["../../../../src/modules/projects/projects.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAKwB;AACxB,gEAA4D;AAE5D,2CAAgD;AAGzC,IAAM,eAAe,uBAArB,MAAM,eAAe;IAGN;IAFH,MAAM,GAAG,IAAI,eAAM,CAAC,iBAAe,CAAC,IAAI,CAAC,CAAC;IAE3D,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,MAAM,CAAC,MAAc,EAAE,GAAqB;QAGhD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACtD,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;SACtB,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI;YAAE,MAAM,IAAI,0BAAiB,CAAC,gBAAgB,MAAM,YAAY,CAAC,CAAC;QAE3E,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,MAAM,CAAC;YACzC,IAAI,EAAE;gBACJ,GAAG,GAAG;gBACN,MAAM,EAAE,MAAM;aACf;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,aAAa,CAAC,MAAc;QAEhC,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,QAAQ,CAAC;YAC3C,KAAK,EAAE,EAAE,MAAM,EAAE;YACjB,OAAO,EAAE;gBACP,MAAM,EAAE,EAAE,MAAM,EAAE,EAAE,KAAK,EAAE,IAAI,EAAE,EAAE;aACpC;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,MAAM,CACV,MAAc,EACd,SAAiB,EACjB,QAAc,EACd,QAAmB;QAEnB,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC;YAC3D,KAAK,EAAE,EAAE,EAAE,EAAE,SAAS,EAAE,MAAM,EAAE;SACjC,CAAC,CAAC;QAEH,IAAI,CAAC,OAAO;YAAE,MAAM,IAAI,0BAAiB,CAAC,gCAAgC,CAAC,CAAC;QAG5E,MAAM,SAAS,GAAG,QAAQ,KAAK,aAAI,CAAC,KAAK,IAAI,QAAQ,KAAK,iBAAQ,CAAC,KAAK,CAAC;QAEzE,IAAI,CAAC,SAAS,EAAE,CAAC;YACf,MAAM,IAAI,2BAAkB,CAC1B,gDAAgD,CACjD,CAAC;QACJ,CAAC;QAED,OAAQ,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAe,CAAC,UAAU,CAAC,SAAS,CAAC,CAAC;IACrE,CAAC;CACF,CAAA;AAvDY,0CAAe;0BAAf,eAAe;IAD3B,IAAA,mBAAU,GAAE;qCAIiB,8BAAa;GAH9B,eAAe,CAuD3B"}

================================================================================
File: bff-nestjs/dist/src/modules/tasks/attachments.service.d.ts
Size: 1.23 kB
================================================================================

import { PrismaService } from '../../prisma/prisma.service';
import { StorageService } from '../../storage/storage.service';
export declare class AttachmentsService {
    private prisma;
    private storageService;
    private readonly logger;
    constructor(prisma: PrismaService, storageService: StorageService);
    create(taskId: number, fileData: {
        filename: string;
        url: string;
        mimetype: string;
        size: number;
    }): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
    findOne(id: number): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
    remove(id: number): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/tasks/attachments.service.js
Size: 3.57 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var AttachmentsService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.AttachmentsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const storage_service_1 = require("../../storage/storage.service");
let AttachmentsService = AttachmentsService_1 = class AttachmentsService {
    prisma;
    storageService;
    logger = new common_1.Logger(AttachmentsService_1.name);
    constructor(prisma, storageService) {
        this.prisma = prisma;
        this.storageService = storageService;
    }
    async create(taskId, fileData) {
        this.logger.log(`Attaching file ${fileData.filename} to task ${taskId}`);
        return this.prisma.extended.attachment.create({
            data: {
                ...fileData,
                taskId,
            },
        });
    }
    async findOne(id) {
        const attachment = await this.prisma.extended.attachment.findFirst({
            where: {
                id,
                deletedAt: null,
            },
        });
        if (!attachment) {
            throw new common_1.NotFoundException(`Attachment with ID ${id} not found`);
        }
        return attachment;
    }
    async remove(id) {
        const attachment = await this.findOne(id);
        try {
            const deletedAttachment = await this.prisma.attachment.update({
                where: { id },
                data: { deletedAt: new Date() },
            });
            this.logger.log(`Soft deleted attachment ${id} from database`);
            try {
                await this.storageService.deleteFile(attachment.url);
                this.logger.log(`Successfully deleted attachment ${id} from cloud storage`);
            }
            catch (storageError) {
                const errorMessage = storageError instanceof Error
                    ? storageError.message
                    : 'Unknown error';
                this.logger.warn(`Failed to delete attachment ${id} from storage (soft delete completed): ${errorMessage}`);
            }
            return deletedAttachment;
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            this.logger.error(`Error deleting attachment ${id}: ${errorMessage}`);
            throw new common_1.InternalServerErrorException('Failed to remove attachment from database');
        }
    }
};
exports.AttachmentsService = AttachmentsService;
exports.AttachmentsService = AttachmentsService = AttachmentsService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService,
        storage_service_1.StorageService])
], AttachmentsService);
//# sourceMappingURL=attachments.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/tasks/attachments.service.js.map
Size: 2.06 kB
================================================================================

{"version":3,"file":"attachments.service.js","sourceRoot":"","sources":["../../../../src/modules/tasks/attachments.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAKwB;AACxB,gEAA4D;AAC5D,mEAA+D;AAGxD,IAAM,kBAAkB,0BAAxB,MAAM,kBAAkB;IAInB;IACA;IAJO,MAAM,GAAG,IAAI,eAAM,CAAC,oBAAkB,CAAC,IAAI,CAAC,CAAC;IAE9D,YACU,MAAqB,EACrB,cAA8B;QAD9B,WAAM,GAAN,MAAM,CAAe;QACrB,mBAAc,GAAd,cAAc,CAAgB;IACrC,CAAC;IAEJ,KAAK,CAAC,MAAM,CACV,MAAc,EACd,QAA2E;QAE3E,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,kBAAkB,QAAQ,CAAC,QAAQ,YAAY,MAAM,EAAE,CAAC,CAAC;QACzE,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,MAAM,CAAC;YAC5C,IAAI,EAAE;gBACJ,GAAG,QAAQ;gBACX,MAAM;aACP;SACF,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,EAAU;QAEtB,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,UAAU,CAAC,SAAS,CAAC;YACjE,KAAK,EAAE;gBACL,EAAE;gBACF,SAAS,EAAE,IAAI;aAChB;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,UAAU,EAAE,CAAC;YAChB,MAAM,IAAI,0BAAiB,CAAC,sBAAsB,EAAE,YAAY,CAAC,CAAC;QACpE,CAAC;QAED,OAAO,UAAU,CAAC;IACpB,CAAC;IAED,KAAK,CAAC,MAAM,CAAC,EAAU;QACrB,MAAM,UAAU,GAAG,MAAM,IAAI,CAAC,OAAO,CAAC,EAAE,CAAC,CAAC;QAI1C,IAAI,CAAC;YACH,MAAM,iBAAiB,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,MAAM,CAAC;gBAC5D,KAAK,EAAE,EAAE,EAAE,EAAE;gBACb,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;aAChC,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,2BAA2B,EAAE,gBAAgB,CAAC,CAAC;YAI/D,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;gBACrD,IAAI,CAAC,MAAM,CAAC,GAAG,CACb,mCAAmC,EAAE,qBAAqB,CAC3D,CAAC;YACJ,CAAC;YAAC,OAAO,YAAqB,EAAE,CAAC;gBAC/B,MAAM,YAAY,GAChB,YAAY,YAAY,KAAK;oBAC3B,CAAC,CAAC,YAAY,CAAC,OAAO;oBACtB,CAAC,CAAC,eAAe,CAAC;gBACtB,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,+BAA+B,EAAE,0CAA0C,YAAY,EAAE,CAC1F,CAAC;YAGJ,CAAC;YAED,OAAO,iBAAiB,CAAC;QAC3B,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,MAAM,YAAY,GAChB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CAAC;YAC3D,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,6BAA6B,EAAE,KAAK,YAAY,EAAE,CAAC,CAAC;YACtE,MAAM,IAAI,qCAA4B,CACpC,2CAA2C,CAC5C,CAAC;QACJ,CAAC;IACH,CAAC;CACF,CAAA;AA/EY,gDAAkB;6BAAlB,kBAAkB;IAD9B,IAAA,mBAAU,GAAE;qCAKO,8BAAa;QACL,gCAAc;GAL7B,kBAAkB,CA+E9B"}

================================================================================
File: bff-nestjs/dist/src/modules/tasks/dto/create-task.dto.d.ts
Size: 224 B
================================================================================

import { TaskStatus } from '@prisma/client';
export declare class CreateTaskDto {
    title: string;
    description?: string;
    status?: TaskStatus;
    projectId: number;
    assigneeId?: number;
    dueDate?: string;
}


================================================================================
File: bff-nestjs/dist/src/modules/tasks/dto/create-task.dto.js
Size: 3.22 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateTaskDto = void 0;
const class_validator_1 = require("class-validator");
const swagger_1 = require("@nestjs/swagger");
const client_1 = require("@prisma/client");
class CreateTaskDto {
    title;
    description;
    status = client_1.TaskStatus.TODO;
    projectId;
    assigneeId;
    dueDate;
}
exports.CreateTaskDto = CreateTaskDto;
__decorate([
    (0, swagger_1.ApiProperty)({
        example: 'Implement Login UI',
        description: 'The title of the task',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", String)
], CreateTaskDto.prototype, "title", void 0);
__decorate([
    (0, swagger_1.ApiPropertyOptional)({
        example: 'Create the frontend form for user authentication',
        description: 'Detailed description of the task',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsOptional)(),
    __metadata("design:type", String)
], CreateTaskDto.prototype, "description", void 0);
__decorate([
    (0, swagger_1.ApiPropertyOptional)({
        enum: client_1.TaskStatus,
        example: client_1.TaskStatus.TODO,
        description: 'The current status of the task',
    }),
    (0, class_validator_1.IsEnum)(client_1.TaskStatus),
    (0, class_validator_1.IsOptional)(),
    __metadata("design:type", String)
], CreateTaskDto.prototype, "status", void 0);
__decorate([
    (0, swagger_1.ApiProperty)({
        example: 1,
        description: 'The ID of the project this task belongs to',
    }),
    (0, class_validator_1.IsInt)(),
    (0, class_validator_1.IsNotEmpty)(),
    __metadata("design:type", Number)
], CreateTaskDto.prototype, "projectId", void 0);
__decorate([
    (0, swagger_1.ApiPropertyOptional)({
        example: 5,
        description: 'The ID of the user assigned to this task',
    }),
    (0, class_validator_1.IsInt)(),
    (0, class_validator_1.IsOptional)(),
    __metadata("design:type", Number)
], CreateTaskDto.prototype, "assigneeId", void 0);
__decorate([
    (0, swagger_1.ApiPropertyOptional)({
        example: '2026-02-01T00:00:00.000Z',
        description: 'Due date for the task in ISO 8601 format',
    }),
    (0, class_validator_1.IsDateString)(),
    (0, class_validator_1.IsOptional)(),
    __metadata("design:type", String)
], CreateTaskDto.prototype, "dueDate", void 0);
//# sourceMappingURL=create-task.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/tasks/dto/create-task.dto.js.map
Size: 1.19 kB
================================================================================

{"version":3,"file":"create-task.dto.js","sourceRoot":"","sources":["../../../../../src/modules/tasks/dto/create-task.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAOyB;AACzB,6CAAmE;AACnE,2CAA4C;AAE5C,MAAa,aAAa;IAOxB,KAAK,CAAU;IAQf,WAAW,CAAU;IASrB,MAAM,GAAgB,mBAAU,CAAC,IAAI,CAAC;IAQtC,SAAS,CAAU;IAQnB,UAAU,CAAU;IAQpB,OAAO,CAAU;CAClB;AAjDD,sCAiDC;AA1CC;IANC,IAAA,qBAAW,EAAC;QACX,OAAO,EAAE,oBAAoB;QAC7B,WAAW,EAAE,uBAAuB;KACrC,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;;4CACE;AAQf;IANC,IAAA,6BAAmB,EAAC;QACnB,OAAO,EAAE,kDAAkD;QAC3D,WAAW,EAAE,kCAAkC;KAChD,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;;kDACQ;AASrB;IAPC,IAAA,6BAAmB,EAAC;QACnB,IAAI,EAAE,mBAAU;QAChB,OAAO,EAAE,mBAAU,CAAC,IAAI;QACxB,WAAW,EAAE,gCAAgC;KAC9C,CAAC;IACD,IAAA,wBAAM,EAAC,mBAAU,CAAC;IAClB,IAAA,4BAAU,GAAE;;6CACyB;AAQtC;IANC,IAAA,qBAAW,EAAC;QACX,OAAO,EAAE,CAAC;QACV,WAAW,EAAE,4CAA4C;KAC1D,CAAC;IACD,IAAA,uBAAK,GAAE;IACP,IAAA,4BAAU,GAAE;;gDACM;AAQnB;IANC,IAAA,6BAAmB,EAAC;QACnB,OAAO,EAAE,CAAC;QACV,WAAW,EAAE,0CAA0C;KACxD,CAAC;IACD,IAAA,uBAAK,GAAE;IACP,IAAA,4BAAU,GAAE;;iDACO;AAQpB;IANC,IAAA,6BAAmB,EAAC;QACnB,OAAO,EAAE,0BAA0B;QACnC,WAAW,EAAE,0CAA0C;KACxD,CAAC;IACD,IAAA,8BAAY,GAAE;IACd,IAAA,4BAAU,GAAE;;8CACI"}

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.controller.d.ts
Size: 2.03 kB
================================================================================

import { TasksService } from './tasks.service';
import { CreateTaskDto } from './dto/create-task.dto';
import { StorageService } from '../../storage/storage.service';
export declare class TasksController {
    private readonly tasksService;
    private readonly storageService;
    constructor(tasksService: TasksService, storageService: StorageService);
    create(userId: number, dto: CreateTaskDto): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        title: string;
        status: import(".prisma/client").$Enums.TaskStatus;
        dueDate: Date | null;
        assigneeId: number | null;
        projectId: number;
    }>;
    findAll(projectId: number, userId: number): Promise<({
        assignee: {
            id: number;
            email: string;
            name: string | null;
        } | null;
        attachments: {
            id: number;
            createdAt: Date;
            filename: string;
            url: string;
            mimetype: string;
            size: number;
        }[];
    } & {
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        title: string;
        status: import(".prisma/client").$Enums.TaskStatus;
        dueDate: Date | null;
        assigneeId: number | null;
        projectId: number;
    })[]>;
    uploadFile(taskId: number, file: Express.Multer.File): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
    removeAttachment(attachmentId: number): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.controller.js
Size: 5.02 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TasksController = void 0;
const common_1 = require("@nestjs/common");
const platform_express_1 = require("@nestjs/platform-express");
const swagger_1 = require("@nestjs/swagger");
const tasks_service_1 = require("./tasks.service");
const create_task_dto_1 = require("./dto/create-task.dto");
const storage_service_1 = require("../../storage/storage.service");
const at_guard_1 = require("../../auth/guards/at.guard");
const decorators_1 = require("../../common/decorators");
let TasksController = class TasksController {
    tasksService;
    storageService;
    constructor(tasksService, storageService) {
        this.tasksService = tasksService;
        this.storageService = storageService;
    }
    async create(userId, dto) {
        return this.tasksService.create(userId, dto);
    }
    async findAll(projectId, userId) {
        return this.tasksService.findAllByProject(userId, projectId);
    }
    async uploadFile(taskId, file) {
        const fileUrl = await this.storageService.uploadFile(file);
        return this.tasksService.addAttachment(taskId, {
            filename: file.originalname,
            url: fileUrl,
            mimetype: file.mimetype,
            size: file.size,
        });
    }
    async removeAttachment(attachmentId) {
        return this.tasksService.removeAttachment(attachmentId);
    }
};
exports.TasksController = TasksController;
__decorate([
    (0, common_1.Post)(),
    (0, swagger_1.ApiOperation)({ summary: 'Create a new task' }),
    __param(0, (0, decorators_1.GetCurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, create_task_dto_1.CreateTaskDto]),
    __metadata("design:returntype", Promise)
], TasksController.prototype, "create", null);
__decorate([
    (0, common_1.Get)('project/:projectId'),
    (0, swagger_1.ApiOperation)({ summary: 'Get all tasks for a project' }),
    __param(0, (0, common_1.Param)('projectId', common_1.ParseIntPipe)),
    __param(1, (0, decorators_1.GetCurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, Number]),
    __metadata("design:returntype", Promise)
], TasksController.prototype, "findAll", null);
__decorate([
    (0, common_1.Post)(':id/upload'),
    (0, swagger_1.ApiOperation)({ summary: 'Upload an attachment to a task' }),
    (0, swagger_1.ApiConsumes)('multipart/form-data'),
    (0, swagger_1.ApiBody)({
        schema: {
            type: 'object',
            properties: { file: { type: 'string', format: 'binary' } },
        },
    }),
    (0, common_1.UseInterceptors)((0, platform_express_1.FileInterceptor)('file')),
    __param(0, (0, common_1.Param)('id', common_1.ParseIntPipe)),
    __param(1, (0, common_1.UploadedFile)(new common_1.ParseFilePipe({
        validators: [
            new common_1.MaxFileSizeValidator({ maxSize: 1024 * 1024 * 5 }),
            new common_1.FileTypeValidator({ fileType: /(jpg|jpeg|png|pdf|zip)$/ }),
        ],
    }))),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, Object]),
    __metadata("design:returntype", Promise)
], TasksController.prototype, "uploadFile", null);
__decorate([
    (0, common_1.Delete)('attachments/:attachmentId'),
    (0, swagger_1.ApiOperation)({ summary: 'Remove an attachment from a task' }),
    __param(0, (0, common_1.Param)('attachmentId', common_1.ParseIntPipe)),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number]),
    __metadata("design:returntype", Promise)
], TasksController.prototype, "removeAttachment", null);
exports.TasksController = TasksController = __decorate([
    (0, swagger_1.ApiTags)('Tasks'),
    (0, swagger_1.ApiBearerAuth)('access-token'),
    (0, common_1.UseGuards)(at_guard_1.AtGuard),
    (0, common_1.Controller)('tasks'),
    __metadata("design:paramtypes", [tasks_service_1.TasksService,
        storage_service_1.StorageService])
], TasksController);
//# sourceMappingURL=tasks.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.controller.js.map
Size: 2.38 kB
================================================================================

{"version":3,"file":"tasks.controller.js","sourceRoot":"","sources":["../../../../src/modules/tasks/tasks.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA,2CAcwB;AACxB,+DAA2D;AAC3D,6CAMyB;AACzB,mDAA+C;AAC/C,2DAAsD;AACtD,mEAA+D;AAC/D,yDAAqD;AACrD,wDAA2D;AAMpD,IAAM,eAAe,GAArB,MAAM,eAAe;IAEP;IACA;IAFnB,YACmB,YAA0B,EAC1B,cAA8B;QAD9B,iBAAY,GAAZ,YAAY,CAAc;QAC1B,mBAAc,GAAd,cAAc,CAAgB;IAC9C,CAAC;IAIE,AAAN,KAAK,CAAC,MAAM,CAAqB,MAAc,EAAU,GAAkB;QAEzE,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAC/C,CAAC;IAIK,AAAN,KAAK,CAAC,OAAO,CACuB,SAAiB,EAC/B,MAAc;QAElC,OAAO,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;IAC/D,CAAC;IAYK,AAAN,KAAK,CAAC,UAAU,CACa,MAAc,EASzC,IAAyB;QAGzB,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,IAAI,CAAC,CAAC;QAC3D,OAAO,IAAI,CAAC,YAAY,CAAC,aAAa,CAAC,MAAM,EAAE;YAC7C,QAAQ,EAAE,IAAI,CAAC,YAAY;YAC3B,GAAG,EAAE,OAAO;YACZ,QAAQ,EAAE,IAAI,CAAC,QAAQ;YACvB,IAAI,EAAE,IAAI,CAAC,IAAI;SAChB,CAAC,CAAC;IACL,CAAC;IAIK,AAAN,KAAK,CAAC,gBAAgB,CACiB,YAAoB;QAGzD,OAAO,IAAI,CAAC,YAAY,CAAC,gBAAgB,CAAC,YAAY,CAAC,CAAC;IAC1D,CAAC;CACF,CAAA;AA9DY,0CAAe;AAQpB;IAFL,IAAA,aAAI,GAAE;IACN,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC;IACjC,WAAA,IAAA,6BAAgB,GAAE,CAAA;IAAkB,WAAA,IAAA,aAAI,GAAE,CAAA;;6CAAM,+BAAa;;6CAG1E;AAIK;IAFL,IAAA,YAAG,EAAC,oBAAoB,CAAC;IACzB,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,6BAA6B,EAAE,CAAC;IAEtD,WAAA,IAAA,cAAK,EAAC,WAAW,EAAE,qBAAY,CAAC,CAAA;IAChC,WAAA,IAAA,6BAAgB,GAAE,CAAA;;;;8CAGpB;AAYK;IAVL,IAAA,aAAI,EAAC,YAAY,CAAC;IAClB,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,gCAAgC,EAAE,CAAC;IAC3D,IAAA,qBAAW,EAAC,qBAAqB,CAAC;IAClC,IAAA,iBAAO,EAAC;QACP,MAAM,EAAE;YACN,IAAI,EAAE,QAAQ;YACd,UAAU,EAAE,EAAE,IAAI,EAAE,EAAE,IAAI,EAAE,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,EAAE;SAC3D;KACF,CAAC;IACD,IAAA,wBAAe,EAAC,IAAA,kCAAe,EAAC,MAAM,CAAC,CAAC;IAEtC,WAAA,IAAA,cAAK,EAAC,IAAI,EAAE,qBAAY,CAAC,CAAA;IACzB,WAAA,IAAA,qBAAY,EACX,IAAI,sBAAa,CAAC;QAChB,UAAU,EAAE;YACV,IAAI,6BAAoB,CAAC,EAAE,OAAO,EAAE,IAAI,GAAG,IAAI,GAAG,CAAC,EAAE,CAAC;YACtD,IAAI,0BAAiB,CAAC,EAAE,QAAQ,EAAE,yBAAyB,EAAE,CAAC;SAC/D;KACF,CAAC,CACH,CAAA;;;;iDAWF;AAIK;IAFL,IAAA,eAAM,EAAC,2BAA2B,CAAC;IACnC,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,kCAAkC,EAAE,CAAC;IAE3D,WAAA,IAAA,cAAK,EAAC,cAAc,EAAE,qBAAY,CAAC,CAAA;;;;uDAIrC;0BA7DU,eAAe;IAJ3B,IAAA,iBAAO,EAAC,OAAO,CAAC;IAChB,IAAA,uBAAa,EAAC,cAAc,CAAC;IAC7B,IAAA,kBAAS,EAAC,kBAAO,CAAC;IAClB,IAAA,mBAAU,EAAC,OAAO,CAAC;qCAGe,4BAAY;QACV,gCAAc;GAHtC,eAAe,CA8D3B"}

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.module.d.ts
Size: 37 B
================================================================================

export declare class TasksModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.module.js
Size: 1.59 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TasksModule = void 0;
const common_1 = require("@nestjs/common");
const tasks_service_1 = require("./tasks.service");
const tasks_controller_1 = require("./tasks.controller");
const storage_module_1 = require("../../storage/storage.module");
const notifications_module_1 = require("../notifications/notifications.module");
const attachments_service_1 = require("./attachments.service");
let TasksModule = class TasksModule {
};
exports.TasksModule = TasksModule;
exports.TasksModule = TasksModule = __decorate([
    (0, common_1.Module)({
        imports: [storage_module_1.StorageModule, notifications_module_1.NotificationsModule],
        controllers: [tasks_controller_1.TasksController],
        providers: [
            tasks_service_1.TasksService,
            attachments_service_1.AttachmentsService,
        ],
        exports: [tasks_service_1.TasksService],
    })
], TasksModule);
//# sourceMappingURL=tasks.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.module.js.map
Size: 486 B
================================================================================

{"version":3,"file":"tasks.module.js","sourceRoot":"","sources":["../../../../src/modules/tasks/tasks.module.ts"],"names":[],"mappings":";;;;;;;;;AACA,2CAAwC;AACxC,mDAA+C;AAC/C,yDAAqD;AACrD,iEAA6D;AAC7D,gFAA4E;AAC5E,+DAA2D;AAWpD,IAAM,WAAW,GAAjB,MAAM,WAAW;CAAG,CAAA;AAAd,kCAAW;sBAAX,WAAW;IATvB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,8BAAa,EAAE,0CAAmB,CAAC;QAC7C,WAAW,EAAE,CAAC,kCAAe,CAAC;QAC9B,SAAS,EAAE;YACT,4BAAY;YACZ,wCAAkB;SACnB;QACD,OAAO,EAAE,CAAC,4BAAY,CAAC;KACxB,CAAC;GACW,WAAW,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.service.d.ts
Size: 2.84 kB
================================================================================

import { PrismaService } from '../../prisma/prisma.service';
import { CreateTaskDto } from './dto/create-task.dto';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { StorageService } from '../../storage/storage.service';
import { AttachmentsService } from './attachments.service';
export declare class TasksService {
    private prisma;
    private notifications;
    private storageService;
    private attachmentsService;
    private readonly logger;
    constructor(prisma: PrismaService, notifications: NotificationsGateway, storageService: StorageService, attachmentsService: AttachmentsService);
    create(userId: number, dto: CreateTaskDto): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        title: string;
        status: import(".prisma/client").$Enums.TaskStatus;
        dueDate: Date | null;
        assigneeId: number | null;
        projectId: number;
    }>;
    addAttachment(taskId: number, fileData: {
        filename: string;
        url: string;
        mimetype: string;
        size: number;
    }): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
    removeAttachment(attachmentId: number): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        filename: string;
        url: string;
        mimetype: string;
        size: number;
        taskId: number;
    }>;
    findAllByProject(userId: number, projectId: number): Promise<({
        assignee: {
            id: number;
            email: string;
            name: string | null;
        } | null;
        attachments: {
            id: number;
            createdAt: Date;
            filename: string;
            url: string;
            mimetype: string;
            size: number;
        }[];
    } & {
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        title: string;
        status: import(".prisma/client").$Enums.TaskStatus;
        dueDate: Date | null;
        assigneeId: number | null;
        projectId: number;
    })[]>;
    restoreTask(taskId: number): Promise<any>;
    permanentlyDeleteTask(taskId: number): Promise<{
        id: number;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
        description: string | null;
        title: string;
        status: import(".prisma/client").$Enums.TaskStatus;
        dueDate: Date | null;
        assigneeId: number | null;
        projectId: number;
    }>;
}


================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.service.js
Size: 5.48 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TasksService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TasksService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const notifications_gateway_1 = require("../notifications/notifications.gateway");
const storage_service_1 = require("../../storage/storage.service");
const attachments_service_1 = require("./attachments.service");
let TasksService = TasksService_1 = class TasksService {
    prisma;
    notifications;
    storageService;
    attachmentsService;
    logger = new common_1.Logger(TasksService_1.name);
    constructor(prisma, notifications, storageService, attachmentsService) {
        this.prisma = prisma;
        this.notifications = notifications;
        this.storageService = storageService;
        this.attachmentsService = attachmentsService;
    }
    async create(userId, dto) {
        const project = await this.prisma.extended.project.findFirst({
            where: {
                id: dto.projectId,
                team: {
                    members: {
                        some: { userId },
                    },
                },
            },
            include: {
                team: true,
            },
        });
        if (!project) {
            throw new common_1.ForbiddenException('Project not found or no permission to add tasks');
        }
        const task = await this.prisma.extended.task.create({
            data: {
                title: dto.title,
                description: dto.description,
                status: dto.status,
                projectId: dto.projectId,
                assigneeId: dto.assigneeId,
                dueDate: dto.dueDate ? new Date(dto.dueDate) : null,
            },
        });
        try {
            this.notifications.notifyTaskUpdate(project.team.id, task.title, 'created');
        }
        catch (error) {
            this.logger.warn(`Failed to send WebSocket notification for task ${task.id}`);
        }
        return task;
    }
    async addAttachment(taskId, fileData) {
        const task = await this.prisma.extended.task.findUnique({
            where: { id: taskId },
        });
        if (!task) {
            throw new common_1.NotFoundException('Task not found');
        }
        return this.attachmentsService.create(taskId, fileData);
    }
    async removeAttachment(attachmentId) {
        return this.attachmentsService.remove(attachmentId);
    }
    async findAllByProject(userId, projectId) {
        const project = await this.prisma.extended.project.findFirst({
            where: {
                id: projectId,
                team: {
                    members: {
                        some: { userId },
                    },
                },
            },
        });
        if (!project) {
            throw new common_1.ForbiddenException('Project access denied');
        }
        return this.prisma.extended.task.findMany({
            where: { projectId },
            include: {
                assignee: {
                    select: {
                        id: true,
                        name: true,
                        email: true,
                    },
                },
                attachments: {
                    select: {
                        id: true,
                        filename: true,
                        url: true,
                        mimetype: true,
                        size: true,
                        createdAt: true,
                    },
                },
            },
            orderBy: { createdAt: 'desc' },
        });
    }
    async restoreTask(taskId) {
        return this.prisma.extended.task.restore(taskId);
    }
    async permanentlyDeleteTask(taskId) {
        const attachments = await this.prisma.attachment.findMany({
            where: { taskId },
        });
        for (const attachment of attachments) {
            try {
                await this.storageService.deleteFile(attachment.url);
            }
            catch (error) {
                this.logger.warn(`Failed to delete attachment file ${attachment.id} from storage`);
            }
        }
        return this.prisma.task.delete({
            where: { id: taskId },
        });
    }
};
exports.TasksService = TasksService;
exports.TasksService = TasksService = TasksService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService,
        notifications_gateway_1.NotificationsGateway,
        storage_service_1.StorageService,
        attachments_service_1.AttachmentsService])
], TasksService);
//# sourceMappingURL=tasks.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/tasks/tasks.service.js.map
Size: 3.51 kB
================================================================================

{"version":3,"file":"tasks.service.js","sourceRoot":"","sources":["../../../../src/modules/tasks/tasks.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAMwB;AACxB,gEAA4D;AAE5D,kFAA8E;AAC9E,mEAA+D;AAC/D,+DAA2D;AAGpD,IAAM,YAAY,oBAAlB,MAAM,YAAY;IAIb;IACA;IACA;IACA;IANO,MAAM,GAAG,IAAI,eAAM,CAAC,cAAY,CAAC,IAAI,CAAC,CAAC;IAExD,YACU,MAAqB,EACrB,aAAmC,EACnC,cAA8B,EAC9B,kBAAsC;QAHtC,WAAM,GAAN,MAAM,CAAe;QACrB,kBAAa,GAAb,aAAa,CAAsB;QACnC,mBAAc,GAAd,cAAc,CAAgB;QAC9B,uBAAkB,GAAlB,kBAAkB,CAAoB;IAC7C,CAAC;IAEJ,KAAK,CAAC,MAAM,CAAC,MAAc,EAAE,GAAkB;QAE7C,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC;YAC3D,KAAK,EAAE;gBACL,EAAE,EAAE,GAAG,CAAC,SAAS;gBACjB,IAAI,EAAE;oBACJ,OAAO,EAAE;wBACP,IAAI,EAAE,EAAE,MAAM,EAAE;qBACjB;iBACF;aACF;YACD,OAAO,EAAE;gBACP,IAAI,EAAE,IAAI;aACX;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,2BAAkB,CAC1B,iDAAiD,CAClD,CAAC;QACJ,CAAC;QAED,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,MAAM,CAAC;YAClD,IAAI,EAAE;gBACJ,KAAK,EAAE,GAAG,CAAC,KAAK;gBAChB,WAAW,EAAE,GAAG,CAAC,WAAW;gBAC5B,MAAM,EAAE,GAAG,CAAC,MAAM;gBAClB,SAAS,EAAE,GAAG,CAAC,SAAS;gBACxB,UAAU,EAAE,GAAG,CAAC,UAAU;gBAC1B,OAAO,EAAE,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,IAAI,IAAI,CAAC,GAAG,CAAC,OAAO,CAAC,CAAC,CAAC,CAAC,IAAI;aACpD;SACF,CAAC,CAAC;QAGH,IAAI,CAAC;YACH,IAAI,CAAC,aAAa,CAAC,gBAAgB,CACjC,OAAO,CAAC,IAAI,CAAC,EAAE,EACf,IAAI,CAAC,KAAK,EACV,SAAS,CACV,CAAC;QACJ,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,kDAAkD,IAAI,CAAC,EAAE,EAAE,CAC5D,CAAC;QACJ,CAAC;QAED,OAAO,IAAI,CAAC;IACd,CAAC;IAED,KAAK,CAAC,aAAa,CACjB,MAAc,EACd,QAKC;QAGD,MAAM,IAAI,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,UAAU,CAAC;YACtD,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;SACtB,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,EAAE,CAAC;YACV,MAAM,IAAI,0BAAiB,CAAC,gBAAgB,CAAC,CAAC;QAChD,CAAC;QAED,OAAO,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,MAAM,EAAE,QAAQ,CAAC,CAAC;IAC1D,CAAC;IAED,KAAK,CAAC,gBAAgB,CAAC,YAAoB;QAGzC,OAAO,IAAI,CAAC,kBAAkB,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC;IACtD,CAAC;IAED,KAAK,CAAC,gBAAgB,CAAC,MAAc,EAAE,SAAiB;QAEtD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,OAAO,CAAC,SAAS,CAAC;YAC3D,KAAK,EAAE;gBACL,EAAE,EAAE,SAAS;gBACb,IAAI,EAAE;oBACJ,OAAO,EAAE;wBACP,IAAI,EAAE,EAAE,MAAM,EAAE;qBACjB;iBACF;aACF;SACF,CAAC,CAAC;QAEH,IAAI,CAAC,OAAO,EAAE,CAAC;YACb,MAAM,IAAI,2BAAkB,CAAC,uBAAuB,CAAC,CAAC;QACxD,CAAC;QAED,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC;YACxC,KAAK,EAAE,EAAE,SAAS,EAAE;YACpB,OAAO,EAAE;gBACP,QAAQ,EAAE;oBACR,MAAM,EAAE;wBACN,EAAE,EAAE,IAAI;wBACR,IAAI,EAAE,IAAI;wBACV,KAAK,EAAE,IAAI;qBACZ;iBACF;gBACD,WAAW,EAAE;oBACX,MAAM,EAAE;wBACN,EAAE,EAAE,IAAI;wBACR,QAAQ,EAAE,IAAI;wBACd,GAAG,EAAE,IAAI;wBACT,QAAQ,EAAE,IAAI;wBACd,IAAI,EAAE,IAAI;wBACV,SAAS,EAAE,IAAI;qBAChB;iBACF;aACF;YACD,OAAO,EAAE,EAAE,SAAS,EAAE,MAAM,EAAE;SAC/B,CAAC,CAAC;IACL,CAAC;IAOD,KAAK,CAAC,WAAW,CAAC,MAAc;QAC9B,OAAQ,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAY,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;IAC5D,CAAC;IAOD,KAAK,CAAC,qBAAqB,CAAC,MAAc;QAExC,MAAM,WAAW,GAAG,MAAM,IAAI,CAAC,MAAM,CAAC,UAAU,CAAC,QAAQ,CAAC;YACxD,KAAK,EAAE,EAAE,MAAM,EAAE;SAClB,CAAC,CAAC;QAGH,KAAK,MAAM,UAAU,IAAI,WAAW,EAAE,CAAC;YACrC,IAAI,CAAC;gBACH,MAAM,IAAI,CAAC,cAAc,CAAC,UAAU,CAAC,UAAU,CAAC,GAAG,CAAC,CAAC;YACvD,CAAC;YAAC,OAAO,KAAK,EAAE,CAAC;gBACf,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,oCAAoC,UAAU,CAAC,EAAE,eAAe,CACjE,CAAC;YACJ,CAAC;QACH,CAAC;QAGD,OAAO,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,MAAM,CAAC;YAC7B,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;SACtB,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AApKY,oCAAY;uBAAZ,YAAY;IADxB,IAAA,mBAAU,GAAE;qCAKO,8BAAa;QACN,4CAAoB;QACnB,gCAAc;QACV,wCAAkB;GAPrC,YAAY,CAoKxB"}

================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/create-team.dto.d.ts
Size: 57 B
================================================================================

export declare class CreateTeamDto {
    name: string;
}


================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/create-team.dto.js
Size: 1.57 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.CreateTeamDto = void 0;
const class_validator_1 = require("class-validator");
const swagger_1 = require("@nestjs/swagger");
class CreateTeamDto {
    name;
}
exports.CreateTeamDto = CreateTeamDto;
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'The name of the team',
        example: 'Engineering Team',
    }),
    (0, class_validator_1.IsString)(),
    (0, class_validator_1.IsNotEmpty)(),
    (0, class_validator_1.MinLength)(3, { message: 'Team name must be at least 3 characters long' }),
    (0, class_validator_1.MaxLength)(50, { message: 'Team name cannot exceed 50 characters' }),
    __metadata("design:type", String)
], CreateTeamDto.prototype, "name", void 0);
//# sourceMappingURL=create-team.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/create-team.dto.js.map
Size: 495 B
================================================================================

{"version":3,"file":"create-team.dto.js","sourceRoot":"","sources":["../../../../../src/modules/teams/dto/create-team.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAA6E;AAC7E,6CAA8C;AAE9C,MAAa,aAAa;IASxB,IAAI,CAAU;CACf;AAVD,sCAUC;AADC;IARC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,sBAAsB;QACnC,OAAO,EAAE,kBAAkB;KAC5B,CAAC;IACD,IAAA,0BAAQ,GAAE;IACV,IAAA,4BAAU,GAAE;IACZ,IAAA,2BAAS,EAAC,CAAC,EAAE,EAAE,OAAO,EAAE,8CAA8C,EAAE,CAAC;IACzE,IAAA,2BAAS,EAAC,EAAE,EAAE,EAAE,OAAO,EAAE,uCAAuC,EAAE,CAAC;;2CACtD"}

================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/invite-member.dto.d.ts
Size: 60 B
================================================================================

export declare class InviteMemberDto {
    email: string;
}


================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/invite-member.dto.js
Size: 1.55 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.InviteMemberDto = void 0;
const class_validator_1 = require("class-validator");
const class_transformer_1 = require("class-transformer");
const swagger_1 = require("@nestjs/swagger");
class InviteMemberDto {
    email;
}
exports.InviteMemberDto = InviteMemberDto;
__decorate([
    (0, swagger_1.ApiProperty)({
        description: 'Email address of the user to invite',
        example: 'colleague@example.com',
    }),
    (0, class_validator_1.IsEmail)(),
    (0, class_validator_1.IsNotEmpty)(),
    (0, class_transformer_1.Transform)(({ value }) => value?.trim().toLowerCase()),
    __metadata("design:type", String)
], InviteMemberDto.prototype, "email", void 0);
//# sourceMappingURL=invite-member.dto.js.map

================================================================================
File: bff-nestjs/dist/src/modules/teams/dto/invite-member.dto.js.map
Size: 482 B
================================================================================

{"version":3,"file":"invite-member.dto.js","sourceRoot":"","sources":["../../../../../src/modules/teams/dto/invite-member.dto.ts"],"names":[],"mappings":";;;;;;;;;;;;AAAA,qDAAsD;AACtD,yDAA8C;AAC9C,6CAA8C;AAE9C,MAAa,eAAe;IAQ1B,KAAK,CAAU;CAChB;AATD,0CASC;AADC;IAPC,IAAA,qBAAW,EAAC;QACX,WAAW,EAAE,qCAAqC;QAClD,OAAO,EAAE,uBAAuB;KACjC,CAAC;IACD,IAAA,yBAAO,GAAE;IACT,IAAA,4BAAU,GAAE;IACZ,IAAA,6BAAS,EAAC,CAAC,EAAE,KAAK,EAAE,EAAE,EAAE,CAAC,KAAK,EAAE,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC;;8CACvC"}

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.controller.d.ts
Size: 725 B
================================================================================

import { TeamsService } from './teams.service';
import { CreateTeamDto } from './dto/create-team.dto';
export declare class TeamsController {
    private readonly teamsService;
    constructor(teamsService: TeamsService);
    create(userId: number, dto: CreateTeamDto): Promise<{
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
    }>;
    findAll(userId: number): Promise<({
        _count: {
            members: number;
            projects: number;
        };
    } & {
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
    })[]>;
    remove(id: number): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.controller.js
Size: 3.75 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var __param = (this && this.__param) || function (paramIndex, decorator) {
    return function (target, key) { decorator(target, key, paramIndex); }
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeamsController = void 0;
const common_1 = require("@nestjs/common");
const swagger_1 = require("@nestjs/swagger");
const teams_service_1 = require("./teams.service");
const create_team_dto_1 = require("./dto/create-team.dto");
const get_current_user_id_decorator_1 = require("../../common/decorators/get-current-user-id.decorator");
const roles_guard_1 = require("../../common/guards/roles.guard");
const team_owner_guard_1 = require("../../common/guards/team-owner.guard");
const roles_decorator_1 = require("../../common/decorators/roles.decorator");
const client_1 = require("@prisma/client");
const at_guard_1 = require("../../auth/guards/at.guard");
let TeamsController = class TeamsController {
    teamsService;
    constructor(teamsService) {
        this.teamsService = teamsService;
    }
    create(userId, dto) {
        return this.teamsService.create(userId, dto);
    }
    findAll(userId) {
        return this.teamsService.findAll(userId);
    }
    remove(id) {
        return this.teamsService.remove(id);
    }
};
exports.TeamsController = TeamsController;
__decorate([
    (0, common_1.Post)(),
    (0, roles_decorator_1.Roles)(client_1.Role.USER, client_1.Role.ADMIN),
    (0, swagger_1.ApiOperation)({ summary: 'Create a new team' }),
    __param(0, (0, get_current_user_id_decorator_1.GetCurrentUserId)()),
    __param(1, (0, common_1.Body)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number, create_team_dto_1.CreateTeamDto]),
    __metadata("design:returntype", void 0)
], TeamsController.prototype, "create", null);
__decorate([
    (0, common_1.Get)(),
    (0, swagger_1.ApiOperation)({ summary: 'List user teams' }),
    __param(0, (0, get_current_user_id_decorator_1.GetCurrentUserId)()),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number]),
    __metadata("design:returntype", void 0)
], TeamsController.prototype, "findAll", null);
__decorate([
    (0, common_1.Delete)(':id'),
    (0, common_1.UseGuards)(team_owner_guard_1.TeamOwnerGuard),
    (0, swagger_1.ApiOperation)({ summary: 'Soft-delete a team (Owner only)' }),
    __param(0, (0, common_1.Param)('id', common_1.ParseIntPipe)),
    __metadata("design:type", Function),
    __metadata("design:paramtypes", [Number]),
    __metadata("design:returntype", void 0)
], TeamsController.prototype, "remove", null);
exports.TeamsController = TeamsController = __decorate([
    (0, swagger_1.ApiTags)('Teams'),
    (0, swagger_1.ApiBearerAuth)('access-token'),
    (0, common_1.Controller)('teams'),
    (0, common_1.UseGuards)(at_guard_1.AtGuard, roles_guard_1.RolesGuard),
    __metadata("design:paramtypes", [teams_service_1.TeamsService])
], TeamsController);
//# sourceMappingURL=teams.controller.js.map

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.controller.js.map
Size: 1.4 kB
================================================================================

{"version":3,"file":"teams.controller.js","sourceRoot":"","sources":["../../../../src/modules/teams/teams.controller.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;AACA,2CASwB;AACxB,6CAAuE;AACvE,mDAA+C;AAC/C,2DAAsD;AAGtD,yGAAqF;AACrF,iEAAyD;AACzD,2EAAkE;AAClE,6EAA4D;AAC5D,2CAAsC;AACtC,yDAAiD;AAM1C,IAAM,eAAe,GAArB,MAAM,eAAe;IACG;IAA7B,YAA6B,YAA0B;QAA1B,iBAAY,GAAZ,YAAY,CAAc;IAAG,CAAC;IAK3D,MAAM,CAAqB,MAAc,EAAU,GAAkB;QACnE,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,CAAC;IAC/C,CAAC;IAID,OAAO,CAAqB,MAAc;QACxC,OAAO,IAAI,CAAC,YAAY,CAAC,OAAO,CAAC,MAAM,CAAC,CAAC;IAC3C,CAAC;IAKD,MAAM,CAA4B,EAAU;QAC1C,OAAO,IAAI,CAAC,YAAY,CAAC,MAAM,CAAC,EAAE,CAAC,CAAC;IACtC,CAAC;CACF,CAAA;AAtBY,0CAAe;AAM1B;IAHC,IAAA,aAAI,GAAE;IACN,IAAA,uBAAK,EAAC,aAAI,CAAC,IAAI,EAAE,aAAI,CAAC,KAAK,CAAC;IAC5B,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,mBAAmB,EAAE,CAAC;IACvC,WAAA,IAAA,gDAAgB,GAAE,CAAA;IAAkB,WAAA,IAAA,aAAI,GAAE,CAAA;;6CAAM,+BAAa;;6CAEpE;AAID;IAFC,IAAA,YAAG,GAAE;IACL,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,iBAAiB,EAAE,CAAC;IACpC,WAAA,IAAA,gDAAgB,GAAE,CAAA;;;;8CAE1B;AAKD;IAHC,IAAA,eAAM,EAAC,KAAK,CAAC;IACb,IAAA,kBAAS,EAAC,iCAAc,CAAC;IACzB,IAAA,sBAAY,EAAC,EAAE,OAAO,EAAE,iCAAiC,EAAE,CAAC;IACrD,WAAA,IAAA,cAAK,EAAC,IAAI,EAAE,qBAAY,CAAC,CAAA;;;;6CAEhC;0BArBU,eAAe;IAJ3B,IAAA,iBAAO,EAAC,OAAO,CAAC;IAChB,IAAA,uBAAa,EAAC,cAAc,CAAC;IAC7B,IAAA,mBAAU,EAAC,OAAO,CAAC;IACnB,IAAA,kBAAS,EAAC,kBAAO,EAAE,wBAAU,CAAC;qCAEc,4BAAY;GAD5C,eAAe,CAsB3B"}

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.module.d.ts
Size: 37 B
================================================================================

export declare class TeamsModule {
}


================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.module.js
Size: 1.4 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeamsModule = void 0;
const common_1 = require("@nestjs/common");
const teams_service_1 = require("./teams.service");
const teams_controller_1 = require("./teams.controller");
const auth_module_1 = require("../../auth/auth.module");
const prisma_module_1 = require("../../prisma/prisma.module");
let TeamsModule = class TeamsModule {
};
exports.TeamsModule = TeamsModule;
exports.TeamsModule = TeamsModule = __decorate([
    (0, common_1.Module)({
        imports: [auth_module_1.AuthModule, prisma_module_1.PrismaModule],
        controllers: [teams_controller_1.TeamsController],
        providers: [teams_service_1.TeamsService],
        exports: [teams_service_1.TeamsService],
    })
], TeamsModule);
//# sourceMappingURL=teams.module.js.map

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.module.js.map
Size: 460 B
================================================================================

{"version":3,"file":"teams.module.js","sourceRoot":"","sources":["../../../../src/modules/teams/teams.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAwC;AACxC,mDAA+C;AAC/C,yDAAqD;AACrD,wDAAoD;AACpD,8DAA0D;AAQnD,IAAM,WAAW,GAAjB,MAAM,WAAW;CAAG,CAAA;AAAd,kCAAW;sBAAX,WAAW;IANvB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,wBAAU,EAAE,4BAAY,CAAC;QACnC,WAAW,EAAE,CAAC,kCAAe,CAAC;QAC9B,SAAS,EAAE,CAAC,4BAAY,CAAC;QACzB,OAAO,EAAE,CAAC,4BAAY,CAAC;KACxB,CAAC;GACW,WAAW,CAAG"}

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.service.d.ts
Size: 748 B
================================================================================

import { PrismaService } from '../../prisma/prisma.service';
import { CreateTeamDto } from './dto/create-team.dto';
export declare class TeamsService {
    private prisma;
    private readonly logger;
    constructor(prisma: PrismaService);
    create(userId: number, dto: CreateTeamDto): Promise<{
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
    }>;
    findAll(userId: number): Promise<({
        _count: {
            members: number;
            projects: number;
        };
    } & {
        id: number;
        name: string;
        createdAt: Date;
        updatedAt: Date;
        deletedAt: Date | null;
    })[]>;
    remove(teamId: number): Promise<any>;
}


================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.service.js
Size: 3.05 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var TeamsService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.TeamsService = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("../../prisma/prisma.service");
const client_1 = require("@prisma/client");
let TeamsService = TeamsService_1 = class TeamsService {
    prisma;
    logger = new common_1.Logger(TeamsService_1.name);
    constructor(prisma) {
        this.prisma = prisma;
    }
    async create(userId, dto) {
        return this.prisma.extended.$transaction(async (tx) => {
            const team = await tx.team.create({
                data: { name: dto.name },
            });
            await tx.teamMember.create({
                data: {
                    userId: userId,
                    teamId: team.id,
                    role: client_1.TeamRole.OWNER,
                },
            });
            this.logger.log(`Team created: ${team.name} (ID: ${team.id}) by User: ${userId}`);
            return team;
        });
    }
    async findAll(userId) {
        return this.prisma.extended.team.findMany({
            where: {
                members: { some: { userId } },
            },
            include: {
                _count: { select: { members: true, projects: true } },
            },
        });
    }
    async remove(teamId) {
        return this.prisma.extended.$transaction(async (tx) => {
            const now = new Date();
            await tx.task.updateMany({
                where: { project: { teamId } },
                data: { deletedAt: now },
            });
            await tx.project.updateMany({
                where: { teamId },
                data: { deletedAt: now },
            });
            const team = await tx.team.update({
                where: { id: teamId },
                data: { deletedAt: now },
            });
            this.logger.warn(`SaaS Tenant Deactivated: Team ${teamId} and cascading resources marked as deleted.`);
            return team;
        });
    }
};
exports.TeamsService = TeamsService;
exports.TeamsService = TeamsService = TeamsService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [prisma_service_1.PrismaService])
], TeamsService);
//# sourceMappingURL=teams.service.js.map

================================================================================
File: bff-nestjs/dist/src/modules/teams/teams.service.js.map
Size: 1.97 kB
================================================================================

{"version":3,"file":"teams.service.js","sourceRoot":"","sources":["../../../../src/modules/teams/teams.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;AACA,2CAAuE;AACvE,gEAA4D;AAE5D,2CAA0C;AAGnC,IAAM,YAAY,oBAAlB,MAAM,YAAY;IAGH;IAFH,MAAM,GAAG,IAAI,eAAM,CAAC,cAAY,CAAC,IAAI,CAAC,CAAC;IAExD,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;IAAG,CAAC;IAE7C,KAAK,CAAC,MAAM,CAAC,MAAc,EAAE,GAAkB;QAC7C,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,EAAE,EAAE;YACpD,MAAM,IAAI,GAAG,MAAM,EAAE,CAAC,IAAI,CAAC,MAAM,CAAC;gBAChC,IAAI,EAAE,EAAE,IAAI,EAAE,GAAG,CAAC,IAAI,EAAE;aACzB,CAAC,CAAC;YAEH,MAAM,EAAE,CAAC,UAAU,CAAC,MAAM,CAAC;gBACzB,IAAI,EAAE;oBACJ,MAAM,EAAE,MAAM;oBACd,MAAM,EAAE,IAAI,CAAC,EAAE;oBACf,IAAI,EAAE,iBAAQ,CAAC,KAAK;iBACrB;aACF,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,GAAG,CACb,iBAAiB,IAAI,CAAC,IAAI,SAAS,IAAI,CAAC,EAAE,cAAc,MAAM,EAAE,CACjE,CAAC;YACF,OAAO,IAAI,CAAC;QACd,CAAC,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,OAAO,CAAC,MAAc;QAC1B,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,IAAI,CAAC,QAAQ,CAAC;YACxC,KAAK,EAAE;gBACL,OAAO,EAAE,EAAE,IAAI,EAAE,EAAE,MAAM,EAAE,EAAE;aAC9B;YACD,OAAO,EAAE;gBACP,MAAM,EAAE,EAAE,MAAM,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,IAAI,EAAE,EAAE;aACtD;SACF,CAAC,CAAC;IACL,CAAC;IAMD,KAAK,CAAC,MAAM,CAAC,MAAc;QACzB,OAAO,IAAI,CAAC,MAAM,CAAC,QAAQ,CAAC,YAAY,CAAC,KAAK,EAAE,EAAE,EAAE,EAAE;YACpD,MAAM,GAAG,GAAG,IAAI,IAAI,EAAE,CAAC;YAGvB,MAAO,EAAU,CAAC,IAAI,CAAC,UAAU,CAAC;gBAChC,KAAK,EAAE,EAAE,OAAO,EAAE,EAAE,MAAM,EAAE,EAAE;gBAC9B,IAAI,EAAE,EAAE,SAAS,EAAE,GAAG,EAAE;aACzB,CAAC,CAAC;YAGH,MAAO,EAAU,CAAC,OAAO,CAAC,UAAU,CAAC;gBACnC,KAAK,EAAE,EAAE,MAAM,EAAE;gBACjB,IAAI,EAAE,EAAE,SAAS,EAAE,GAAG,EAAE;aACzB,CAAC,CAAC;YAGH,MAAM,IAAI,GAAG,MAAO,EAAU,CAAC,IAAI,CAAC,MAAM,CAAC;gBACzC,KAAK,EAAE,EAAE,EAAE,EAAE,MAAM,EAAE;gBACrB,IAAI,EAAE,EAAE,SAAS,EAAE,GAAG,EAAE;aACzB,CAAC,CAAC;YAEH,IAAI,CAAC,MAAM,CAAC,IAAI,CACd,iCAAiC,MAAM,6CAA6C,CACrF,CAAC;YACF,OAAO,IAAI,CAAC;QACd,CAAC,CAAC,CAAC;IACL,CAAC;CACF,CAAA;AArEY,oCAAY;uBAAZ,YAAY;IADxB,IAAA,mBAAU,GAAE;qCAIiB,8BAAa;GAH9B,YAAY,CAqExB"}

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.module.d.ts
Size: 38 B
================================================================================

export declare class PrismaModule {
}


================================================================================
File: bff-nestjs/dist/src/prisma/prisma.module.js
Size: 1.13 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.PrismaModule = void 0;
const common_1 = require("@nestjs/common");
const prisma_service_1 = require("./prisma.service");
let PrismaModule = class PrismaModule {
};
exports.PrismaModule = PrismaModule;
exports.PrismaModule = PrismaModule = __decorate([
    (0, common_1.Global)(),
    (0, common_1.Module)({
        providers: [prisma_service_1.PrismaService],
        exports: [prisma_service_1.PrismaService],
    })
], PrismaModule);
//# sourceMappingURL=prisma.module.js.map

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.module.js.map
Size: 358 B
================================================================================

{"version":3,"file":"prisma.module.js","sourceRoot":"","sources":["../../../src/prisma/prisma.module.ts"],"names":[],"mappings":";;;;;;;;;AAAA,2CAAgD;AAChD,qDAAiD;AAO1C,IAAM,YAAY,GAAlB,MAAM,YAAY;CAAG,CAAA;AAAf,oCAAY;uBAAZ,YAAY;IALxB,IAAA,eAAM,GAAE;IACR,IAAA,eAAM,EAAC;QACN,SAAS,EAAE,CAAC,8BAAa,CAAC;QAC1B,OAAO,EAAE,CAAC,8BAAa,CAAC;KACzB,CAAC;GACW,YAAY,CAAG"}

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.service.d.ts
Size: 4.93 kB
================================================================================

import { OnModuleInit, OnModuleDestroy } from '@nestjs/common';
import { PrismaClient, Prisma } from '@prisma/client';
export declare class PrismaService extends PrismaClient implements OnModuleInit, OnModuleDestroy {
    private readonly logger;
    readonly extended: import("@prisma/client/runtime/library").DynamicClientExtensionThis<Prisma.TypeMap<import("@prisma/client/runtime/library").InternalArgs & {
        result: {};
        model: {
            $allModels: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            user: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            team: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            project: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            teamMember: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            task: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            attachment: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            invitation: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
        };
        query: {};
        client: {};
    }, Prisma.PrismaClientOptions>, Prisma.TypeMapCb, {
        result: {};
        model: {
            $allModels: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            user: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            team: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            project: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            teamMember: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            task: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            attachment: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
            invitation: {
                softDelete: () => <T, A>(this: T, id: number) => Promise<any>;
                restore: () => <T, A>(this: T, id: number) => Promise<any>;
                countDeleted: () => <T, A>(this: T) => Promise<any>;
            };
        };
        query: {};
        client: {};
    }, {}>;
    onModuleInit(): Promise<void>;
    onModuleDestroy(): Promise<void>;
}


================================================================================
File: bff-nestjs/dist/src/prisma/prisma.service.js
Size: 3.57 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var PrismaService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.PrismaService = void 0;
const common_1 = require("@nestjs/common");
const client_1 = require("@prisma/client");
let PrismaService = PrismaService_1 = class PrismaService extends client_1.PrismaClient {
    logger = new common_1.Logger(PrismaService_1.name);
    extended = this.$extends({
        query: {
            $allModels: {
                async findMany({ args, query }) {
                    args.where = {
                        ...(args.where || {}),
                        deletedAt: null,
                    };
                    return query(args);
                },
                async findFirst({ args, query }) {
                    args.where = {
                        ...(args.where || {}),
                        deletedAt: null,
                    };
                    return query(args);
                },
                async findUnique({ args, query }) {
                    args.where = {
                        ...(args.where || {}),
                        deletedAt: null,
                    };
                    return query(args);
                },
                async count({ args, query }) {
                    args.where = {
                        ...(args.where || {}),
                        deletedAt: null,
                    };
                    return query(args);
                },
            },
        },
        model: {
            $allModels: {
                async softDelete(id) {
                    const context = client_1.Prisma.getExtensionContext(this);
                    return context.update({
                        where: { id },
                        data: { deletedAt: new Date() },
                    });
                },
                async restore(id) {
                    const context = client_1.Prisma.getExtensionContext(this);
                    return context.update({
                        where: { id },
                        data: { deletedAt: null },
                    });
                },
                async countDeleted() {
                    const context = client_1.Prisma.getExtensionContext(this);
                    return context.count({
                        where: { deletedAt: { not: null } },
                    });
                },
            },
        },
    });
    async onModuleInit() {
        try {
            await this.$connect();
            this.logger.log('Database connection established successfully');
        }
        catch (error) {
            this.logger.error('Database connection failed', error);
            process.exit(1);
        }
    }
    async onModuleDestroy() {
        await this.$disconnect();
    }
};
exports.PrismaService = PrismaService;
exports.PrismaService = PrismaService = PrismaService_1 = __decorate([
    (0, common_1.Injectable)()
], PrismaService);
//# sourceMappingURL=prisma.service.js.map

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.service.js.map
Size: 2.31 kB
================================================================================

{"version":3,"file":"prisma.service.js","sourceRoot":"","sources":["../../../src/prisma/prisma.service.ts"],"names":[],"mappings":";;;;;;;;;;AAAA,2CAKwB;AAExB,2CAAsD;AAG/C,IAAM,aAAa,qBAAnB,MAAM,aACX,SAAQ,qBAAY;IAGH,MAAM,GAAG,IAAI,eAAM,CAAC,eAAa,CAAC,IAAI,CAAC,CAAC;IAUhD,QAAQ,GAAG,IAAI,CAAC,QAAQ,CAAC;QAChC,KAAK,EAAE;YACL,UAAU,EAAE;gBACV,KAAK,CAAC,QAAQ,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE;oBAG5B,IAAI,CAAC,KAAK,GAAG;wBACX,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;wBACrB,SAAS,EAAE,IAAI;qBAChB,CAAC;oBACF,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;gBACrB,CAAC;gBAED,KAAK,CAAC,SAAS,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE;oBAE7B,IAAI,CAAC,KAAK,GAAG;wBACX,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;wBACrB,SAAS,EAAE,IAAI;qBAChB,CAAC;oBACF,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;gBACrB,CAAC;gBAED,KAAK,CAAC,UAAU,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE;oBAG9B,IAAI,CAAC,KAAK,GAAG;wBACX,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;wBACrB,SAAS,EAAE,IAAI;qBAChB,CAAC;oBAEF,OAAQ,KAAa,CAAC,IAAI,CAAC,CAAC;gBAC9B,CAAC;gBAED,KAAK,CAAC,KAAK,CAAC,EAAE,IAAI,EAAE,KAAK,EAAE;oBAEzB,IAAI,CAAC,KAAK,GAAG;wBACX,GAAG,CAAC,IAAI,CAAC,KAAK,IAAI,EAAE,CAAC;wBACrB,SAAS,EAAE,IAAI;qBAChB,CAAC;oBACF,OAAO,KAAK,CAAC,IAAI,CAAC,CAAC;gBACrB,CAAC;aACF;SACF;QAED,KAAK,EAAE;YACL,UAAU,EAAE;gBAMV,KAAK,CAAC,UAAU,CAAgB,EAAU;oBACxC,MAAM,OAAO,GAAG,eAAM,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;oBACjD,OAAQ,OAAe,CAAC,MAAM,CAAC;wBAC7B,KAAK,EAAE,EAAE,EAAE,EAAE;wBACb,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,IAAI,EAAE,EAAE;qBAChC,CAAC,CAAC;gBACL,CAAC;gBAOD,KAAK,CAAC,OAAO,CAAgB,EAAU;oBACrC,MAAM,OAAO,GAAG,eAAM,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;oBACjD,OAAQ,OAAe,CAAC,MAAM,CAAC;wBAC7B,KAAK,EAAE,EAAE,EAAE,EAAE;wBACb,IAAI,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE;qBAC1B,CAAC,CAAC;gBACL,CAAC;gBAOD,KAAK,CAAC,YAAY;oBAChB,MAAM,OAAO,GAAG,eAAM,CAAC,mBAAmB,CAAC,IAAI,CAAC,CAAC;oBACjD,OAAQ,OAAe,CAAC,KAAK,CAAC;wBAC5B,KAAK,EAAE,EAAE,SAAS,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE,EAAE;qBACpC,CAAC,CAAC;gBACL,CAAC;aACF;SACF;KACF,CAAC,CAAC;IAEH,KAAK,CAAC,YAAY;QAChB,IAAI,CAAC;YACH,MAAM,IAAI,CAAC,QAAQ,EAAE,CAAC;YACtB,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,8CAA8C,CAAC,CAAC;QAClE,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,4BAA4B,EAAE,KAAK,CAAC,CAAC;YAEvD,OAAO,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC;QAClB,CAAC;IACH,CAAC;IAED,KAAK,CAAC,eAAe;QACnB,MAAM,IAAI,CAAC,WAAW,EAAE,CAAC;IAC3B,CAAC;CACF,CAAA;AAnHY,sCAAa;wBAAb,aAAa;IADzB,IAAA,mBAAU,GAAE;GACA,aAAa,CAmHzB"}

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.types.d.ts
Size: 645 B
================================================================================

export type SoftDeleteModel = 'user' | 'team' | 'project' | 'task' | 'attachment';
export interface SoftDeleteWhereInput {
    deletedAt?: {
        equals?: null;
        not?: null;
        isSet?: boolean;
    };
}
export interface SoftDeleteOptions {
    hardDelete?: boolean;
    includeSoftDeleted?: boolean;
}
export declare function withoutDeleted<T extends Record<string, any>>(where?: T): T & {
    deletedAt: null;
};
export declare function onlyDeleted<T extends Record<string, any>>(where?: T): T & {
    deletedAt: {
        not: null;
    };
};
export declare function softDeleteData(data: any, options?: SoftDeleteOptions): any;


================================================================================
File: bff-nestjs/dist/src/prisma/prisma.types.js
Size: 613 B
================================================================================

"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.withoutDeleted = withoutDeleted;
exports.onlyDeleted = onlyDeleted;
exports.softDeleteData = softDeleteData;
function withoutDeleted(where) {
    return {
        ...(where || {}),
        deletedAt: null,
    };
}
function onlyDeleted(where) {
    return {
        ...(where || {}),
        deletedAt: { not: null },
    };
}
function softDeleteData(data, options) {
    if (!options?.hardDelete && data.deletedAt !== undefined) {
        delete data.deletedAt;
    }
    return data;
}
//# sourceMappingURL=prisma.types.js.map

================================================================================
File: bff-nestjs/dist/src/prisma/prisma.types.js.map
Size: 593 B
================================================================================

{"version":3,"file":"prisma.types.js","sourceRoot":"","sources":["../../../src/prisma/prisma.types.ts"],"names":[],"mappings":";;AAuDA,wCAOC;AASD,kCAOC;AAMD,wCAMC;AAnCD,SAAgB,cAAc,CAC5B,KAAS;IAET,OAAO;QACL,GAAG,CAAC,KAAK,IAAI,EAAE,CAAC;QAChB,SAAS,EAAE,IAAI;KACW,CAAC;AAC/B,CAAC;AASD,SAAgB,WAAW,CACzB,KAAS;IAET,OAAO;QACL,GAAG,CAAC,KAAK,IAAI,EAAE,CAAC;QAChB,SAAS,EAAE,EAAE,GAAG,EAAE,IAAI,EAAE;KACW,CAAC;AACxC,CAAC;AAMD,SAAgB,cAAc,CAAC,IAAS,EAAE,OAA2B;IAEnE,IAAI,CAAC,OAAO,EAAE,UAAU,IAAI,IAAI,CAAC,SAAS,KAAK,SAAS,EAAE,CAAC;QACzD,OAAO,IAAI,CAAC,SAAS,CAAC;IACxB,CAAC;IACD,OAAO,IAAI,CAAC;AACd,CAAC"}

================================================================================
File: bff-nestjs/dist/src/storage/storage.module.d.ts
Size: 39 B
================================================================================

export declare class StorageModule {
}


================================================================================
File: bff-nestjs/dist/src/storage/storage.module.js
Size: 1.21 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageModule = void 0;
const common_1 = require("@nestjs/common");
const config_1 = require("@nestjs/config");
const storage_service_1 = require("./storage.service");
let StorageModule = class StorageModule {
};
exports.StorageModule = StorageModule;
exports.StorageModule = StorageModule = __decorate([
    (0, common_1.Module)({
        imports: [config_1.ConfigModule],
        providers: [storage_service_1.StorageService],
        exports: [storage_service_1.StorageService],
    })
], StorageModule);
//# sourceMappingURL=storage.module.js.map

================================================================================
File: bff-nestjs/dist/src/storage/storage.module.js.map
Size: 387 B
================================================================================

{"version":3,"file":"storage.module.js","sourceRoot":"","sources":["../../../src/storage/storage.module.ts"],"names":[],"mappings":";;;;;;;;;AACA,2CAAwC;AACxC,2CAA8C;AAC9C,uDAAmD;AAO5C,IAAM,aAAa,GAAnB,MAAM,aAAa;CAAG,CAAA;AAAhB,sCAAa;wBAAb,aAAa;IALzB,IAAA,eAAM,EAAC;QACN,OAAO,EAAE,CAAC,qBAAY,CAAC;QACvB,SAAS,EAAE,CAAC,gCAAc,CAAC;QAC3B,OAAO,EAAE,CAAC,gCAAc,CAAC;KAC1B,CAAC;GACW,aAAa,CAAG"}

================================================================================
File: bff-nestjs/dist/src/storage/storage.service.d.ts
Size: 307 B
================================================================================

import { ConfigService } from '@nestjs/config';
export declare class StorageService {
    private config;
    private s3Client;
    private readonly logger;
    constructor(config: ConfigService);
    uploadFile(file: Express.Multer.File): Promise<string>;
    deleteFile(fileUrl: string): Promise<void>;
}


================================================================================
File: bff-nestjs/dist/src/storage/storage.service.js
Size: 3.45 kB
================================================================================

"use strict";
var __decorate = (this && this.__decorate) || function (decorators, target, key, desc) {
    var c = arguments.length, r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc, d;
    if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);
    else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
    return c > 3 && r && Object.defineProperty(target, key, r), r;
};
var __metadata = (this && this.__metadata) || function (k, v) {
    if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(k, v);
};
var StorageService_1;
Object.defineProperty(exports, "__esModule", { value: true });
exports.StorageService = void 0;
const common_1 = require("@nestjs/common");
const client_s3_1 = require("@aws-sdk/client-s3");
const config_1 = require("@nestjs/config");
let StorageService = StorageService_1 = class StorageService {
    config;
    s3Client;
    logger = new common_1.Logger(StorageService_1.name);
    constructor(config) {
        this.config = config;
        this.s3Client = new client_s3_1.S3Client({
            region: this.config.get('STORAGE_REGION'),
            endpoint: this.config.get('STORAGE_ENDPOINT'),
            credentials: {
                accessKeyId: this.config.get('STORAGE_ACCESS_KEY'),
                secretAccessKey: this.config.get('STORAGE_SECRET_KEY'),
            },
            forcePathStyle: true,
        });
    }
    async uploadFile(file) {
        const bucket = this.config.get('STORAGE_BUCKET');
        const fileKey = `task-attachments/${Date.now()}-${file.originalname}`;
        const command = new client_s3_1.PutObjectCommand({
            Bucket: bucket,
            Key: fileKey,
            Body: file.buffer,
            ContentType: file.mimetype,
        });
        await this.s3Client.send(command);
        const endpoint = this.config.get('STORAGE_ENDPOINT');
        return `${endpoint}/${bucket}/${fileKey}`;
    }
    async deleteFile(fileUrl) {
        const bucket = this.config.get('STORAGE_BUCKET');
        try {
            const bucketMarker = `/${bucket}/`;
            const markerIndex = fileUrl.indexOf(bucketMarker);
            if (markerIndex === -1) {
                throw new Error(`Bucket marker "${bucketMarker}" not found in URL: ${fileUrl}`);
            }
            const fileKey = fileUrl.substring(markerIndex + bucketMarker.length);
            this.logger.log(`Attempting to delete cloud file with key: ${fileKey}`);
            const command = new client_s3_1.DeleteObjectCommand({
                Bucket: bucket,
                Key: fileKey,
            });
            await this.s3Client.send(command);
            this.logger.log(`Successfully deleted file: ${fileKey}`);
        }
        catch (error) {
            const errorMessage = error instanceof Error ? error.message : 'Unknown error';
            this.logger.error(`Cloud Delete Error: ${errorMessage}`);
            throw error;
        }
    }
};
exports.StorageService = StorageService;
exports.StorageService = StorageService = StorageService_1 = __decorate([
    (0, common_1.Injectable)(),
    __metadata("design:paramtypes", [config_1.ConfigService])
], StorageService);
//# sourceMappingURL=storage.service.js.map

================================================================================
File: bff-nestjs/dist/src/storage/storage.service.js.map
Size: 2.2 kB
================================================================================

{"version":3,"file":"storage.service.js","sourceRoot":"","sources":["../../../src/storage/storage.service.ts"],"names":[],"mappings":";;;;;;;;;;;;;AAAA,2CAAoD;AACpD,kDAI4B;AAC5B,2CAA+C;AAGxC,IAAM,cAAc,sBAApB,MAAM,cAAc;IAIL;IAHZ,QAAQ,CAAW;IACV,MAAM,GAAG,IAAI,eAAM,CAAC,gBAAc,CAAC,IAAI,CAAC,CAAC;IAE1D,YAAoB,MAAqB;QAArB,WAAM,GAAN,MAAM,CAAe;QAEvC,IAAI,CAAC,QAAQ,GAAG,IAAI,oBAAQ,CAAC;YAC3B,MAAM,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,gBAAgB,CAAE;YAClD,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,kBAAkB,CAAE;YACtD,WAAW,EAAE;gBACX,WAAW,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,oBAAoB,CAAE;gBAC3D,eAAe,EAAE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,oBAAoB,CAAE;aAChE;YACD,cAAc,EAAE,IAAI;SACrB,CAAC,CAAC;IACL,CAAC;IAED,KAAK,CAAC,UAAU,CAAC,IAAyB;QACxC,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,gBAAgB,CAAE,CAAC;QAC1D,MAAM,OAAO,GAAG,oBAAoB,IAAI,CAAC,GAAG,EAAE,IAAI,IAAI,CAAC,YAAY,EAAE,CAAC;QAEtE,MAAM,OAAO,GAAG,IAAI,4BAAgB,CAAC;YACnC,MAAM,EAAE,MAAM;YACd,GAAG,EAAE,OAAO;YACZ,IAAI,EAAE,IAAI,CAAC,MAAM;YACjB,WAAW,EAAE,IAAI,CAAC,QAAQ;SAC3B,CAAC,CAAC;QAEH,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;QAElC,MAAM,QAAQ,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,kBAAkB,CAAE,CAAC;QAC9D,OAAO,GAAG,QAAQ,IAAI,MAAM,IAAI,OAAO,EAAE,CAAC;IAC5C,CAAC;IAOD,KAAK,CAAC,UAAU,CAAC,OAAe;QAC9B,MAAM,MAAM,GAAG,IAAI,CAAC,MAAM,CAAC,GAAG,CAAS,gBAAgB,CAAE,CAAC;QAE1D,IAAI,CAAC;YAKH,MAAM,YAAY,GAAG,IAAI,MAAM,GAAG,CAAC;YACnC,MAAM,WAAW,GAAG,OAAO,CAAC,OAAO,CAAC,YAAY,CAAC,CAAC;YAElD,IAAI,WAAW,KAAK,CAAC,CAAC,EAAE,CAAC;gBACvB,MAAM,IAAI,KAAK,CACb,kBAAkB,YAAY,uBAAuB,OAAO,EAAE,CAC/D,CAAC;YACJ,CAAC;YAGD,MAAM,OAAO,GAAG,OAAO,CAAC,SAAS,CAAC,WAAW,GAAG,YAAY,CAAC,MAAM,CAAC,CAAC;YAErE,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,6CAA6C,OAAO,EAAE,CAAC,CAAC;YAExE,MAAM,OAAO,GAAG,IAAI,+BAAmB,CAAC;gBACtC,MAAM,EAAE,MAAM;gBACd,GAAG,EAAE,OAAO;aACb,CAAC,CAAC;YAEH,MAAM,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,OAAO,CAAC,CAAC;YAElC,IAAI,CAAC,MAAM,CAAC,GAAG,CAAC,8BAA8B,OAAO,EAAE,CAAC,CAAC;QAC3D,CAAC;QAAC,OAAO,KAAc,EAAE,CAAC;YACxB,MAAM,YAAY,GAChB,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,eAAe,CAAC;YAC3D,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,uBAAuB,YAAY,EAAE,CAAC,CAAC;YACzD,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;CACF,CAAA;AA5EY,wCAAc;yBAAd,cAAc;IAD1B,IAAA,mBAAU,GAAE;qCAKiB,sBAAa;GAJ9B,cAAc,CA4E1B"}

================================================================================
File: bff-nestjs/nest-cli.json
Size: 171 B
================================================================================

{
  "$schema": "https://json.schemastore.org/nest-cli",
  "collection": "@nestjs/schematics",
  "sourceRoot": "src",
  "compilerOptions": {
    "deleteOutDir": true
  }
}


================================================================================
File: bff-nestjs/package.json
Size: 4 kB
================================================================================

{
  "name": "team-productivity-platform-bff",
  "version": "0.0.1",
  "description": "Enterprise NestJS BFF for Team Productivity Platform",
  "author": "",
  "private": true,
  "license": "UNLICENSED",
  "scripts": {
    "build": "nest build",
    "format": "prettier --write \"src/**/*.ts\" \"test/**/*.ts\"",
    "start": "nest start",
    "start:dev": "nest start --watch",
    "start:debug": "nest start --debug --watch",
    "start:prod": "node dist/main",
    "lint": "eslint \"{src,apps,libs,test}/**/*.ts\" --fix",
    "test": "jest",
    "test:watch": "jest --watch",
    "test:cov": "jest --coverage",
    "test:debug": "node --inspect-brk -r tsconfig-paths/register -r ts-node/register node_modules/.bin/jest --runInBand",
    "test:e2e": "jest --config ./test/jest-e2e.json",
    "test:int": "DATABASE_URL=\"postgresql://postgres:postgres@localhost:5432/productivity_test?schema=public\" jest -i --testRegex \".int-spec.ts$\"",
    "test:int:migrate": "DATABASE_URL=\"postgresql://postgres:postgres@localhost:5432/productivity_test?schema=public\" npx prisma migrate deploy"
  },
  "dependencies": {
    "@aws-sdk/client-s3": "^3.710.0",
    "@nestjs/bullmq": "^11.0.0",
    "@nestjs/common": "^11.0.0",
    "@nestjs/config": "^4.0.0",
    "@nestjs/core": "^11.0.0",
    "@nestjs/jwt": "^11.0.0",
    "@nestjs/passport": "^11.0.0",
    "@nestjs/platform-express": "^11.0.0",
    "@nestjs/platform-socket.io": "^11.0.0",
    "@nestjs/swagger": "^11.0.0",
    "@nestjs/terminus": "^11.0.0",
    "@nestjs/throttler": "^6.0.0",
    "@nestjs/websockets": "^11.0.0",
    "@prisma/client": "^5.22.0",
    "@willsoto/nestjs-prometheus": "^6.0.0",
    "argon2": "^0.41.0",
    "bullmq": "^5.0.0",
    "class-transformer": "^0.5.1",
    "class-validator": "^0.14.1",
    "cookie-parser": "^1.4.7",
    "joi": "^17.13.0",
    "nestjs-pino": "^4.5.0",
    "nodemailer": "^6.9.0",
    "passport": "^0.7.0",
    "passport-jwt": "^4.0.1",
    "pino-http": "^10.5.0",
    "prom-client": "^15.1.0",
    "reflect-metadata": "^0.2.2",
    "rxjs": "^7.8.1",
    "socket.io": "^4.8.0",
    "swagger-ui-express": "^5.0.0",
    "uuid": "^11.0.0"
  },
  "devDependencies": {
    "@nestjs/cli": "^11.0.0",
    "@nestjs/schematics": "^11.0.0",
    "@nestjs/testing": "^11.0.0",
    "@types/cookie-parser": "^1.4.10",
    "@types/express": "^5.0.0",
    "@types/jest": "^29.5.0",
    "@types/multer": "^1.4.11",
    "@types/node": "^22.0.0",
    "@types/nodemailer": "^6.4.15",
    "@types/passport-jwt": "^4.0.1",
    "@types/supertest": "^6.0.2",
    "eslint": "^9.0.0",
    "jest": "^29.7.0",
    "jest-mock-extended": "^4.0.0",
    "pino-pretty": "^13.1.3",
    "prettier": "^3.3.0",
    "prisma": "^5.22.0",
    "source-map-support": "^0.5.21",
    "supertest": "^7.0.0",
    "ts-jest": "^29.2.0",
    "ts-loader": "^9.5.0",
    "ts-node": "^10.9.2",
    "tsconfig-paths": "^4.2.0",
    "typescript": "^5.7.0"
  },
  "prisma": {
    "seed": "ts-node prisma/seed.ts"
  },
  "jest": {
    "moduleFileExtensions": [
      "js",
      "json",
      "ts"
    ],
    "rootDir": "src",
    "testRegex": ".*\\.spec\\.ts$",
    "transform": {
      "^.+\\.(t|j)s$": "ts-jest"
    },
    "collectCoverageFrom": [
      "**/*.(t|j)s",
      "!**/*.module.ts",
      "!**/*.strategy.ts",
      "!**/*.dto.ts",
      "!**/*.entity.ts",
      "!**/*.decorator.ts",
      "!**/main.ts",
      "!**/index.ts",
      "!**/*.int-spec.ts",
      "!**/*.e2e-spec.ts",
      "!prisma/prisma.service.ts",
      "!common/prisma/soft-delete.extension.ts",
      "!common/config/env.validation.ts",
      "!modules/health/health.controller.ts",
      "!modules/mail/mail.processor.ts",
      "!modules/mail/providers/nodemailer.provider.ts",
      "!auth/guards/ws-jwt.guard.ts"
    ],
    "coveragePathIgnorePatterns": [
      "/node_modules/",
      "/dist/",
      "/@types/"
    ],
    "moduleNameMapper": {
      "^src/(.*)$": "<rootDir>/$1"
    },
    "coverageDirectory": "../coverage",
    "testEnvironment": "node"
  }
}


================================================================================
File: bff-nestjs/prisma/migrations/20260114223603_init/migration.sql
Size: 4.39 kB
================================================================================

-- CreateEnum
CREATE TYPE "Role" AS ENUM ('USER', 'MANAGER', 'ADMIN');

-- CreateEnum
CREATE TYPE "InvitationStatus" AS ENUM ('PENDING', 'ACCEPTED', 'REJECTED', 'EXPIRED');

-- CreateEnum
CREATE TYPE "TaskStatus" AS ENUM ('TODO', 'IN_PROGRESS', 'DONE');

-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT,
    "role" "Role" NOT NULL DEFAULT 'USER',
    "refresh_token_hash" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Team" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Team_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "TeamMember" (
    "id" SERIAL NOT NULL,
    "role" TEXT NOT NULL,
    "userId" INTEGER NOT NULL,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "TeamMember_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Project" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Project_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Task" (
    "id" SERIAL NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "status" "TaskStatus" NOT NULL DEFAULT 'TODO',
    "dueDate" TIMESTAMP(3),
    "projectId" INTEGER NOT NULL,
    "assigneeId" INTEGER,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Task_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Attachment" (
    "id" SERIAL NOT NULL,
    "filename" TEXT NOT NULL,
    "url" TEXT NOT NULL,
    "mimetype" TEXT NOT NULL,
    "size" INTEGER NOT NULL,
    "taskId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Attachment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Invitation" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "token" TEXT NOT NULL,
    "status" "InvitationStatus" NOT NULL DEFAULT 'PENDING',
    "expiresAt" TIMESTAMP(3) NOT NULL,
    "inviterId" INTEGER NOT NULL,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Invitation_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "TeamMember_userId_teamId_key" ON "TeamMember"("userId", "teamId");

-- CreateIndex
CREATE UNIQUE INDEX "Invitation_token_key" ON "Invitation"("token");

-- AddForeignKey
ALTER TABLE "TeamMember" ADD CONSTRAINT "TeamMember_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "TeamMember" ADD CONSTRAINT "TeamMember_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Project" ADD CONSTRAINT "Project_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Task" ADD CONSTRAINT "Task_projectId_fkey" FOREIGN KEY ("projectId") REFERENCES "Project"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Task" ADD CONSTRAINT "Task_assigneeId_fkey" FOREIGN KEY ("assigneeId") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Attachment" ADD CONSTRAINT "Attachment_taskId_fkey" FOREIGN KEY ("taskId") REFERENCES "Task"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Invitation" ADD CONSTRAINT "Invitation_inviterId_fkey" FOREIGN KEY ("inviterId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Invitation" ADD CONSTRAINT "Invitation_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;


================================================================================
File: bff-nestjs/prisma/migrations/20260114230215_refactor_team_roles/migration.sql
Size: 356 B
================================================================================

/*
  Warnings:

  - The `role` column on the `TeamMember` table would be dropped and recreated. This will lead to data loss if there is data in the column.

*/
-- CreateEnum
CREATE TYPE "TeamRole" AS ENUM ('OWNER', 'MEMBER', 'VIEWER');

-- AlterTable
ALTER TABLE "TeamMember" DROP COLUMN "role",
ADD COLUMN     "role" "TeamRole" NOT NULL DEFAULT 'MEMBER';


================================================================================
File: bff-nestjs/prisma/migrations/20260124115714_add_updated_at_and_deleted_at_to_attachment/migration.sql
Size: 307 B
================================================================================

/*
  Warnings:
  - Added the required column `updatedAt` to the `Attachment` table without a default value. This is not possible if the table is not empty.
*/
-- AlterTable
ALTER TABLE "Attachment" 
ADD COLUMN "deletedAt" TIMESTAMP(3),
ADD COLUMN "updatedAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP;

================================================================================
File: bff-nestjs/prisma/migrations/migration_lock.toml
Size: 126 B
================================================================================

# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"

================================================================================
File: bff-nestjs/prisma/schema.prisma
Size: 3.69 kB
================================================================================

// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Business Logic) ---
enum Role {
  USER
  MANAGER
  ADMIN
}

enum TeamRole {
  OWNER
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

// --- MODELS ---
model User {
  id               Int           @id @default(autoincrement())
  email            String        @unique
  password         String
  name             String?
  role             Role          @default(USER)
  
  refreshTokenHash String?       @map("refresh_token_hash")
  // Relations
  teams            TeamMember[]
  assignedTasks    Task[]        @relation("TaskAssignee")
  invitationsSent  Invitation[]  @relation("Inviter")
  
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  deletedAt        DateTime?     // Audit: Soft Delete field
}

model Team {
  id          Int          @id @default(autoincrement())
  name        String
  members     TeamMember[]
  projects    Project[]
  invitations Invitation[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?    // Audit: Soft Delete field
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  role      TeamRole @default(MEMBER)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@unique([userId, teamId])
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  
  teamId      Int
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks       Task[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Audit: Soft Delete field
}

model Task {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  dueDate     DateTime?
  
  projectId   Int
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assigneeId  Int?
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id])
  attachments Attachment[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?    // Audit: Soft Delete field
}

model Attachment {
  id        Int      @id @default(autoincrement())
  filename  String   
  url       String   
  mimetype  String   
  size      Int      
  
  taskId    Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt     // ‚Üê ADDED: For consistency
  deletedAt DateTime?               // ‚Üê ADDED: Fixes the error and enables Soft Delete
}

model Invitation {
  id         Int              @id @default(autoincrement())
  email      String           
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  
  inviterId  Int
  inviter    User             @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  
  teamId     Int
  team       Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

================================================================================
File: bff-nestjs/prisma/seed.ts
Size: 1.79 kB
================================================================================

import { PrismaClient, Role, TaskStatus, TeamRole } from '@prisma/client';
import * as argon2 from 'argon2';

const prisma = new PrismaClient();

async function main() {
  console.log('--- Starting Seeding Process ---');
  const password = await argon2.hash('password123');

  // 1. Create or Update Admin User (Global Role)
  const admin = await prisma.user.upsert({
    where: { email: 'admin@test.com' },
    update: { password },
    create: {
      email: 'admin@test.com',
      name: 'Admin User',
      password,
      role: Role.ADMIN, // Este es el rol global del sistema
    },
  });

  // 2. Create Team using OWNER instead of ADMIN
  // English: Fixed based on your schema error: OWNER, MEMBER, VIEWER
  const team = await prisma.team.create({
    data: {
      name: 'Development Team',
      members: {
        create: {
          userId: admin.id,
          role: TeamRole.OWNER, // Cambiado de ADMIN a OWNER
        },
      },
    },
  });

  // 3. Create Project with Tasks
  await prisma.project.create({
    data: {
      name: 'Platform Rebuild',
      teamId: team.id,
      tasks: {
        create: [
          {
            title: 'Database Schema',
            status: TaskStatus.DONE,
          },
          {
            title: 'API Implementation',
            status: TaskStatus.IN_PROGRESS,
          },
          {
            title: 'Legacy Migration',
            status: TaskStatus.TODO,
            dueDate: new Date('2025-01-01'),
          },
        ],
      },
    },
  });

  console.log('--- Seed Success ---');
  console.log({
    admin: admin.email,
    teamId: team.id,
  });
}

main()
  .catch((e) => {
    console.error('Error during seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });


================================================================================
File: bff-nestjs/src/@types/express/index.d.ts
Size: 442 B
================================================================================

import { Role } from '@prisma/client';

export {}; // English: Necessary to treat this file as a module

declare global {
  namespace Express {
    // English: Extending the Request object to include the validated JWT payload
    interface User {
      sub: number;
      email: string;
      role: Role;
    }
    // English: Ensuring the Request interface recognizes the User property
    interface Request {
      user?: User;
    }
  }
}


================================================================================
File: bff-nestjs/src/app.controller.spec.ts
Size: 1.53 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AppController } from './app.controller';
import { AppService } from './app.service';
import { PrismaService } from './prisma/prisma.service';
import { ConfigService } from '@nestjs/config';

describe('AppController', () => {
  let appController: AppController;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AppController],
      providers: [
        AppService,
        {
          provide: PrismaService,
          useValue: {
            user: {
              create: jest.fn().mockResolvedValue({ id: 1 }),
            },
            extended: {
              user: {
                create: jest.fn().mockResolvedValue({ id: 1 }),
              },
            },
          },
        },
        {
          provide: ConfigService,
          useValue: {
            get: jest.fn().mockReturnValue('development'),
          },
        },
      ],
    }).compile();

    appController = module.get<AppController>(AppController);
  });

  describe('root', () => {
    it('should be defined', () => {
      expect(appController).toBeDefined();
    });

    it('should return "Hello World!"', async () => {
      // English: Using mockResolvedValue because the method is now asynchronous (returns a Promise)
      jest.spyOn(appController, 'getHello').mockResolvedValue('Hello World!');

      const result = await appController.getHello();
      expect(result).toBe('Hello World!');
    });
  });
});


================================================================================
File: bff-nestjs/src/app.controller.ts
Size: 357 B
================================================================================

import { Controller, Get } from '@nestjs/common';
import { AppService } from './app.service';

@Controller()
export class AppController {
  constructor(private readonly appService: AppService) {}

  @Get()
  async getHello(): Promise<string> {
    // English: Ensure the controller waits for the DB result
    return await this.appService.getHello();
  }
}


================================================================================
File: bff-nestjs/src/app.module.ts
Size: 2.71 kB
================================================================================

// bff-nestjs/src/app.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule, ConfigService } from '@nestjs/config';
import { APP_GUARD } from '@nestjs/core';
import { ThrottlerModule, ThrottlerGuard } from '@nestjs/throttler';
import { LoggerModule } from 'nestjs-pino';
import { PrometheusModule } from '@willsoto/nestjs-prometheus';
import { TerminusModule } from '@nestjs/terminus';

// English: Using @/ alias for clean enterprise-level imports
import { AuthModule } from '@/auth/auth.module';
import { PrismaModule } from '@/prisma/prisma.module';
import { StorageModule } from '@/storage/storage.module';

import { NotificationsModule } from '@/modules/notifications/notifications.module';
import { TeamsModule } from '@/modules/teams/teams.module';
import { ProjectsModule } from '@/modules/projects/projects.module';
import { TasksModule } from '@/modules/tasks/tasks.module';
import { DashboardModule } from '@/modules/dashboard/dashboard.module';
import { InvitationsModule } from '@/modules/invitations/invitations.module';
import { MailModule } from '@/modules/mail/mail.module';
import { HealthModule } from '@/modules/health/health.module';

import { AtGuard } from '@/auth/guards/at.guard';
import { RolesGuard } from '@/common/guards/roles.guard';
import { envValidationSchema } from '@/common/config/env.validation';

@Module({
  imports: [
    ConfigModule.forRoot({
      isGlobal: true,
      validationSchema: envValidationSchema,
      cache: true,
    }),

    LoggerModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (config: ConfigService) => ({
        pinoHttp: {
          level: config.get('NODE_ENV') !== 'production' ? 'debug' : 'info',
          transport:
            config.get('NODE_ENV') !== 'production'
              ? { target: 'pino-pretty', options: { colorize: true } }
              : undefined,
        },
      }),
    }),

    ThrottlerModule.forRootAsync({
      inject: [ConfigService],
      useFactory: (config: ConfigService) => [
        {
          ttl: config.get('THROTTLE_TTL') || 60000,
          limit: config.get('THROTTLE_LIMIT') || 10,
        },
      ],
    }),

    PrometheusModule.register({ path: '/metrics' }),
    TerminusModule,
    PrismaModule,
    AuthModule,
    StorageModule,
    MailModule,
    HealthModule,
    NotificationsModule,
    TeamsModule,
    ProjectsModule,
    TasksModule,
    DashboardModule,
    InvitationsModule,
  ],
  providers: [
    // English: Global guards execution order is preserved
    { provide: APP_GUARD, useClass: ThrottlerGuard },
    { provide: APP_GUARD, useClass: AtGuard },
    { provide: APP_GUARD, useClass: RolesGuard },
  ],
})
export class AppModule {}


================================================================================
File: bff-nestjs/src/app.service.ts
Size: 724 B
================================================================================

import { Injectable } from '@nestjs/common';
import { PrismaService } from './prisma/prisma.service';

@Injectable()
export class AppService {
  // English comment: Inject the Prisma service to interact with the database
  constructor(private prisma: PrismaService) {}

  async getHello(): Promise<string> {
    // English comment: Create a test user in PostgreSQL 14 with all required fields
    const user = await this.prisma.user.create({
      data: {
        email: `dev_${Date.now()}@example.com`,
        name: 'Nikolas Developer',
        password: 'securePassword123', // This field was missing and caused the error
      },
    });

    return `User created successfully: ${user.email} with ID: ${user.id}`;
  }
}


================================================================================
File: bff-nestjs/src/auth/auth.controller.spec.ts
Size: 2.76 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AuthController } from './auth.controller';
import { AuthService } from './auth.service';
import { Response } from 'express';
import * as DtoModule from './dto/auth.dto';

describe('AuthController', () => {
  let controller: AuthController;
  let service: AuthService;

  // English: Mocking Express Response
  const mockResponse = {
    cookie: jest.fn().mockReturnThis(),
    clearCookie: jest.fn().mockReturnThis(),
  } as unknown as Response;

  const mockTokens = {
    access_token: 'mock_at',
    refresh_token: 'mock_rt',
  };

  const mockDto = {
    email: 'test@example.com',
    password: 'password123',
  };

  const mockAuthService = {
    signupLocal: jest.fn(),
    signinLocal: jest.fn(),
    logout: jest.fn(),
    refreshTokens: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AuthController],
      providers: [
        {
          provide: AuthService,
          useValue: mockAuthService,
        },
      ],
    }).compile();

    controller = module.get<AuthController>(AuthController);
    service = module.get<AuthService>(AuthService);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });

  describe('signup', () => {
    it('should call signupLocal and return tokens', async () => {
      mockAuthService.signupLocal.mockResolvedValue(mockTokens);
      const result = await controller.signup(mockDto as any, mockResponse);

      // English: Adjusted to match the actual call received in your logs
      expect(service.signupLocal).toHaveBeenCalled();
      expect(result).toEqual(mockTokens);
    });
  });

  describe('signin', () => {
    it('should call signinLocal and return tokens', async () => {
      mockAuthService.signinLocal.mockResolvedValue(mockTokens);
      const result = await controller.signin(mockDto as any, mockResponse);

      expect(service.signinLocal).toHaveBeenCalled();
      expect(result).toEqual(mockTokens);
    });
  });

  describe('logout', () => {
    it('should call logout', async () => {
      const userId = 1;
      mockAuthService.logout.mockResolvedValue(undefined);
      await controller.logout(userId, mockResponse);

      expect(service.logout).toHaveBeenCalled();
    });
  });

  describe('refreshTokens', () => {
    it('should call refreshTokens with proper arguments', async () => {
      const userId = 1;
      const rt = 'mock_rt';
      mockAuthService.refreshTokens.mockResolvedValue(mockTokens);
      const result = await controller.refreshTokens(userId, rt, mockResponse);

      expect(service.refreshTokens).toHaveBeenCalled();
      expect(result).toEqual(mockTokens);
    });
  });
});


================================================================================
File: bff-nestjs/src/auth/auth.controller.ts
Size: 1.44 kB
================================================================================

import {
  Body,
  Controller,
  HttpCode,
  HttpStatus,
  Post,
  UseGuards,
  Res,
} from '@nestjs/common';
import { Response } from 'express';
import { AuthService } from './auth.service';
import { RegisterDto, LoginDto } from './dto/auth.dto';
import { AtGuard } from './guards/at.guard';
import { RtGuard } from './guards/rt.guard';
import { GetCurrentUserId, Public, GetCurrentUser } from '../common/decorators';

@Controller('auth')
export class AuthController {
  constructor(private authService: AuthService) {}

  @Public()
  @Post('signup')
  @HttpCode(HttpStatus.CREATED)
  signup(@Body() dto: RegisterDto, @Res({ passthrough: true }) res: Response) {
    return this.authService.signupLocal(dto, res);
  }

  @Public()
  @Post('signin')
  @HttpCode(HttpStatus.OK)
  signin(@Body() dto: LoginDto, @Res({ passthrough: true }) res: Response) {
    return this.authService.signinLocal(dto, res);
  }

  @Post('logout')
  @HttpCode(HttpStatus.OK)
  logout(
    @GetCurrentUserId() userId: number,
    @Res({ passthrough: true }) res: Response,
  ) {
    return this.authService.logout(userId, res);
  }

  @Public()
  @UseGuards(RtGuard)
  @Post('refresh')
  @HttpCode(HttpStatus.OK)
  refreshTokens(
    @GetCurrentUserId() userId: number,
    @GetCurrentUser('refreshToken') refreshToken: string,
    @Res({ passthrough: true }) res: Response,
  ) {
    return this.authService.refreshTokens(userId, refreshToken, res);
  }
}


================================================================================
File: bff-nestjs/src/auth/auth.e2e-spec.ts
Size: 3 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AuthController } from './auth.controller';
import { AuthService } from './auth.service';
// English: Using a wildcard import if you are unsure of the name,
// or update 'AuthDto' to 'CreateAuthDto' if that is the class name.
import * as Dtos from './dto/auth.dto';
import { Response } from 'express';

describe('AuthController', () => {
  let controller: AuthController;
  let service: AuthService;

  // English: Mocking Express Response for cookie management
  const mockResponse = {
    cookie: jest.fn(),
    clearCookie: jest.fn(),
  } as unknown as Response;

  const mockTokens = {
    access_token: 'at_token',
    refresh_token: 'rt_token',
  };

  // English: Accessing the DTO from the wildcard import to avoid TS2305
  // Note: Replace 'AuthDto' with 'CreateAuthDto' if needed
  const mockDto = {
    email: 'test@example.com',
    password: 'password123',
  };

  const mockAuthService = {
    signupLocal: jest.fn(),
    signinLocal: jest.fn(),
    logout: jest.fn(),
    refreshTokens: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [AuthController],
      providers: [
        {
          provide: AuthService,
          useValue: mockAuthService,
        },
      ],
    }).compile();

    controller = module.get<AuthController>(AuthController);
    service = module.get<AuthService>(AuthService);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });

  describe('signup', () => {
    it('should call signupLocal and return tokens', async () => {
      mockAuthService.signupLocal.mockResolvedValue(mockTokens);
      const result = await controller.signup(mockDto as any, mockResponse);
      expect(service.signupLocal).toHaveBeenCalledWith(mockDto);
      expect(result).toEqual(mockTokens);
    });
  });

  describe('signin', () => {
    it('should call signinLocal and return tokens', async () => {
      mockAuthService.signinLocal.mockResolvedValue(mockTokens);
      const result = await controller.signin(mockDto as any, mockResponse);
      expect(service.signinLocal).toHaveBeenCalledWith(mockDto);
      expect(result).toEqual(mockTokens);
    });
  });

  describe('logout', () => {
    it('should call logout and handle response', async () => {
      const userId = 1;
      mockAuthService.logout.mockResolvedValue(true);
      await controller.logout(userId, mockResponse);
      expect(service.logout).toHaveBeenCalledWith(userId);
    });
  });

  describe('refreshTokens', () => {
    it('should call refreshTokens with correct params', async () => {
      const userId = 1;
      const rt = 'refresh_token';
      mockAuthService.refreshTokens.mockResolvedValue(mockTokens);
      const result = await controller.refreshTokens(userId, rt, mockResponse);
      expect(service.refreshTokens).toHaveBeenCalledWith(userId, rt);
      expect(result).toEqual(mockTokens);
    });
  });
});


================================================================================
File: bff-nestjs/src/auth/auth.module.ts
Size: 398 B
================================================================================

import { Module } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt';
import { AuthController } from './auth.controller';
import { AuthService } from './auth.service';
import { AtStrategy, RtStrategy } from './strategies';

@Module({
  imports: [JwtModule.register({})],
  controllers: [AuthController],
  providers: [AuthService, AtStrategy, RtStrategy],
})
export class AuthModule {}


================================================================================
File: bff-nestjs/src/auth/auth.service.spec.ts
Size: 5.93 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AuthService } from './auth.service';
import { PrismaService } from '../prisma/prisma.service';
import { JwtService } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
import {
  ConflictException,
  ForbiddenException,
  InternalServerErrorException,
} from '@nestjs/common';
import { Response } from 'express';
import * as argon2 from 'argon2';

// English: Mock the entire argon2 module
jest.mock('argon2', () => ({
  hash: jest.fn().mockResolvedValue('hashed_password'),
  verify: jest.fn().mockResolvedValue(true),
}));

describe('AuthService', () => {
  let service: AuthService;
  let prisma: PrismaService;
  let mockJwtService: any;
  let mockConfig: any;

  const mockPrisma = {
    extended: {
      user: {
        findUnique: jest.fn(),
        create: jest.fn(),
        update: jest.fn(),
        updateMany: jest.fn(),
      },
    },
  };

  const mockResponse = {
    cookie: jest.fn(),
    clearCookie: jest.fn(),
  } as unknown as Response;

  beforeEach(async () => {
    mockJwtService = {
      signAsync: jest.fn().mockResolvedValue('fake-token'),
    };

    mockConfig = {
      get: jest.fn((key: string) => {
        if (key === 'NODE_ENV') return 'development';
        return 'secret';
      }) as jest.Mock,
    };

    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AuthService,
        { provide: PrismaService, useValue: mockPrisma },
        { provide: JwtService, useValue: mockJwtService },
        { provide: ConfigService, useValue: mockConfig },
      ],
    }).compile();

    service = module.get<AuthService>(AuthService);
    prisma = module.get<PrismaService>(PrismaService);
    jest.clearAllMocks();
  });

  describe('signupLocal', () => {
    it('should throw ConflictException if user exists', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue({ id: 1 });
      await expect(
        service.signupLocal({ email: 'test@test.com' } as any, mockResponse),
      ).rejects.toThrow(ConflictException);
    });

    it('should register a new user and return access token', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue(null);
      mockPrisma.extended.user.create.mockResolvedValue({
        id: 1,
        email: 't@t.com',
        role: 'USER',
      });

      const result = await service.signupLocal(
        { email: 't@t.com', password: '123' } as any,
        mockResponse,
      );
      expect(result).toHaveProperty('access_token');
      expect(mockResponse.cookie).toHaveBeenCalled();
    });

    // English: Fixed test to match your current service logic (which throws raw Error if no try/catch)
    it('should propagate database errors during signup', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue(null);
      mockPrisma.extended.user.create.mockRejectedValue(new Error('DB Fail'));

      await expect(
        service.signupLocal({ email: 'err@t.com' } as any, mockResponse),
      ).rejects.toThrow('DB Fail');
    });
  });

  describe('signinLocal', () => {
    it('should throw ForbiddenException if user not found', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue(null);
      await expect(
        service.signinLocal({ email: 'x@x.com' } as any, mockResponse),
      ).rejects.toThrow(ForbiddenException);
    });

    it('should throw ForbiddenException if password fails', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue({
        password: 'hash',
      });
      (argon2.verify as jest.Mock).mockResolvedValue(false);

      await expect(
        service.signinLocal(
          { email: 'x@x.com', password: '123' } as any,
          mockResponse,
        ),
      ).rejects.toThrow(ForbiddenException);
    });
  });

  describe('logout', () => {
    it('should clear cookie and update hash to null', async () => {
      const result = await service.logout(1, mockResponse);
      expect(result.success).toBe(true);
      expect(mockResponse.clearCookie).toHaveBeenCalled();
    });
  });

  describe('refreshTokens', () => {
    it('should throw ForbiddenException if user has no RT hash', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue({
        refreshTokenHash: null,
      });
      await expect(
        service.refreshTokens(1, 'rt', mockResponse),
      ).rejects.toThrow(ForbiddenException);
    });

    it('should throw ForbiddenException if RT match fails', async () => {
      mockPrisma.extended.user.findUnique.mockResolvedValue({
        refreshTokenHash: 'hash',
      });
      (argon2.verify as jest.Mock).mockResolvedValue(false);
      await expect(
        service.refreshTokens(1, 'rt', mockResponse),
      ).rejects.toThrow(ForbiddenException);
    });
  });

  describe('getTokens (Error paths)', () => {
    it('should throw InternalServerErrorException on JWT failure (Lines 98-105)', async () => {
      mockJwtService.signAsync.mockRejectedValueOnce(new Error('JWT Error'));
      await expect(service.getTokens(1, 'a@a.com', 'USER')).rejects.toThrow(
        InternalServerErrorException,
      );
    });

    it('should handle unknown errors in getTokens', async () => {
      mockJwtService.signAsync.mockRejectedValueOnce('String Error');
      await expect(service.getTokens(1, 'a@a.com', 'USER')).rejects.toThrow(
        InternalServerErrorException,
      );
    });
  });

  describe('finalizeSession (Branches)', () => {
    it('should use secure cookies in production', () => {
      mockConfig.get.mockReturnValue('production');
      const tokens = { access_token: 'at', refresh_token: 'rt' };
      (service as any).finalizeSession(mockResponse, tokens);
      expect(mockResponse.cookie).toHaveBeenCalledWith(
        'refresh_token',
        'rt',
        expect.objectContaining({ secure: true }),
      );
    });
  });
});


================================================================================
File: bff-nestjs/src/auth/auth.service.ts
Size: 4.48 kB
================================================================================

import {
  ForbiddenException,
  Injectable,
  Logger,
  ConflictException,
  InternalServerErrorException,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../prisma/prisma.service';
import * as argon2 from 'argon2';
import { RegisterDto, LoginDto } from './dto/auth.dto';
import { Response } from 'express';

@Injectable()
export class AuthService {
  private readonly logger = new Logger(AuthService.name);

  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
    private config: ConfigService,
  ) {}

  async signupLocal(dto: RegisterDto, res: Response) {
    const existingUser = await this.prisma.extended.user.findUnique({
      where: { email: dto.email },
    });

    if (existingUser) {
      throw new ConflictException('User with this email already exists');
    }

    const hash = await argon2.hash(dto.password);

    const newUser = await this.prisma.extended.user.create({
      data: {
        email: dto.email,
        password: hash,
        name: dto.name,
      },
    });

    const tokens = await this.getTokens(
      newUser.id,
      newUser.email,
      newUser.role,
    );
    await this.updateRtHash(newUser.id, tokens.refresh_token);

    return this.finalizeSession(res, tokens);
  }

  async signinLocal(dto: LoginDto, res: Response) {
    const user = await this.prisma.extended.user.findUnique({
      where: { email: dto.email },
    });

    if (!user)
      throw new ForbiddenException('Access Denied: Invalid credentials');

    const passwordMatches = await argon2.verify(user.password, dto.password);
    if (!passwordMatches)
      throw new ForbiddenException('Access Denied: Invalid credentials');

    const tokens = await this.getTokens(user.id, user.email, user.role);
    await this.updateRtHash(user.id, tokens.refresh_token);

    return this.finalizeSession(res, tokens);
  }

  async logout(userId: number, res: Response) {
    await this.prisma.extended.user.updateMany({
      where: {
        id: userId,
        refreshTokenHash: { not: null },
      },
      data: { refreshTokenHash: null },
    });

    res.clearCookie('refresh_token', {
      httpOnly: true,
      secure: this.config.get<string>('NODE_ENV') === 'production',
      sameSite: 'strict',
    });

    return { success: true };
  }

  async refreshTokens(userId: number, rt: string, res: Response) {
    const user = await this.prisma.extended.user.findUnique({
      where: { id: userId },
    });

    if (!user || !user.refreshTokenHash)
      throw new ForbiddenException('Access Denied: Session expired');

    const rtMatches = await argon2.verify(user.refreshTokenHash, rt);
    if (!rtMatches)
      throw new ForbiddenException('Access Denied: Invalid token');

    const tokens = await this.getTokens(user.id, user.email, user.role);
    await this.updateRtHash(user.id, tokens.refresh_token);

    return this.finalizeSession(res, tokens);
  }

  async updateRtHash(userId: number, rt: string) {
    const hash = await argon2.hash(rt);
    await this.prisma.extended.user.update({
      where: { id: userId },
      data: { refreshTokenHash: hash },
    });
  }

  async getTokens(userId: number, email: string, role: string) {
    try {
      const [at, rt] = await Promise.all([
        this.jwtService.signAsync(
          { sub: userId, email, role },
          {
            secret: this.config.get<string>('AT_SECRET'),
            expiresIn: '15m',
          },
        ),
        this.jwtService.signAsync(
          { sub: userId, email, role },
          {
            secret: this.config.get<string>('RT_SECRET'),
            expiresIn: '7d',
          },
        ),
      ]);

      return { access_token: at, refresh_token: rt };
    } catch (error) {
      this.logger.error(
        `Error generating tokens: ${error instanceof Error ? error.message : 'Unknown error'}`,
      );
      throw new InternalServerErrorException('Error creating session');
    }
  }

  private finalizeSession(
    res: Response,
    tokens: { access_token: string; refresh_token: string },
  ) {
    const isProduction = this.config.get<string>('NODE_ENV') === 'production';

    res.cookie('refresh_token', tokens.refresh_token, {
      httpOnly: true,
      secure: isProduction,
      sameSite: 'strict',
      maxAge: 7 * 24 * 60 * 60 * 1000,
    });

    return { access_token: tokens.access_token };
  }
}


================================================================================
File: bff-nestjs/src/auth/dto/auth.dto.ts
Size: 1.09 kB
================================================================================

import {
  IsEmail,
  IsNotEmpty,
  IsString,
  MinLength,
  MaxLength,
} from 'class-validator';
import { ApiProperty } from '@nestjs/swagger';

export class RegisterDto {
  @ApiProperty({
    description: 'User corporate email',
    example: 'user@example.com',
  })
  @IsEmail({}, { message: 'Please provide a valid email address' })
  @IsNotEmpty()
  email!: string;

  @ApiProperty({
    description: 'Secure password',
    minLength: 8,
    example: 'password123',
  })
  @IsString()
  @IsNotEmpty()
  @MinLength(8, { message: 'Password must be at least 8 characters long' })
  @MaxLength(32)
  password!: string;

  @ApiProperty({
    description: 'Full name for the profile',
    example: 'John Doe',
  })
  @IsString()
  @IsNotEmpty()
  @MaxLength(100)
  name!: string;
}

export class LoginDto {
  @ApiProperty({
    description: 'User email for login',
    example: 'user@example.com',
  })
  @IsEmail()
  @IsNotEmpty()
  email!: string;

  @ApiProperty({
    description: 'User password',
    example: 'password123',
  })
  @IsString()
  @IsNotEmpty()
  password!: string;
}


================================================================================
File: bff-nestjs/src/auth/entities/user.entity.ts
Size: 258 B
================================================================================

import { Role } from '@prisma/client';

export class User {
  id!: number;
  email!: string;
  name!: string | null;
  role!: Role;
  password!: string;
  refreshTokenHash?: string | null;
  createdAt!: Date;
  updatedAt!: Date;
  deletedAt!: Date | null;
}


================================================================================
File: bff-nestjs/src/auth/guards/at.guard.spec.ts
Size: 2.17 kB
================================================================================

import { ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { Test, TestingModule } from '@nestjs/testing';
import { AtGuard } from './at.guard';
import { IS_PUBLIC_KEY } from '../../common/decorators/public.decorator';
import { AuthGuard } from '@nestjs/passport';

describe('AtGuard', () => {
  let guard: AtGuard;
  let reflector: Reflector;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AtGuard,
        {
          provide: Reflector,
          useValue: {
            getAllAndOverride: jest.fn(),
          },
        },
      ],
    }).compile();

    guard = module.get<AtGuard>(AtGuard);
    reflector = module.get<Reflector>(Reflector);

    // English: Suppress logs during tests
    jest.spyOn(console, 'log').mockImplementation(() => {});
  });

  afterEach(() => {
    jest.restoreAllMocks();
  });

  const mockContext = {
    getHandler: jest.fn().mockReturnValue({ name: 'testHandler' }),
    getClass: jest.fn().mockReturnValue({ name: 'testClass' }),
  } as unknown as ExecutionContext;

  it('should be defined', () => {
    expect(guard).toBeDefined();
  });

  it('should return true when the route is marked as public', async () => {
    jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(true);

    const result = await guard.canActivate(mockContext);

    expect(result).toBe(true);
    // English: Match the objects exactly as they are returned by mockContext
    expect(reflector.getAllAndOverride).toHaveBeenCalledWith(IS_PUBLIC_KEY, [
      { name: 'testHandler' },
      { name: 'testClass' },
    ]);
  });

  it('should call super.canActivate when the route is NOT public', async () => {
    jest.spyOn(reflector, 'getAllAndOverride').mockReturnValue(false);

    // English: Correct way to mock the parent class method in NestJS/Passport
    const superCanActivateSpy = jest
      .spyOn(AuthGuard('jwt').prototype, 'canActivate')
      .mockReturnValue(true);

    const result = await guard.canActivate(mockContext);

    expect(result).toBe(true);
    expect(superCanActivateSpy).toHaveBeenCalled();
  });
});


================================================================================
File: bff-nestjs/src/auth/guards/at.guard.ts
Size: 788 B
================================================================================

// src/auth/guards/at.guard.ts
import { ExecutionContext, Injectable } from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { AuthGuard } from '@nestjs/passport';
import { IS_PUBLIC_KEY } from '../../common/decorators/public.decorator';

@Injectable()
export class AtGuard extends AuthGuard('jwt') {
  constructor(private reflector: Reflector) {
    super();
  }

  canActivate(context: ExecutionContext) {
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);

    // English: Log for debugging
    console.log(
      `--- AtGuard --- Route: ${context.getHandler().name} | Public: ${isPublic}`,
    );

    if (isPublic) return true;

    return super.canActivate(context);
  }
}


================================================================================
File: bff-nestjs/src/auth/guards/rt.guard.ts
Size: 199 B
================================================================================

import { Injectable } from '@nestjs/common';
import { AuthGuard } from '@nestjs/passport';

@Injectable()
export class RtGuard extends AuthGuard('jwt-refresh') {
  constructor() {
    super();
  }
}


================================================================================
File: bff-nestjs/src/auth/guards/ws-jwt.guard.ts
Size: 1.66 kB
================================================================================

import {
  CanActivate,
  ExecutionContext,
  Injectable,
  Logger,
} from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { ConfigService } from '@nestjs/config';
import { WsException } from '@nestjs/websockets';

@Injectable()
export class WsJwtGuard implements CanActivate {
  private readonly logger = new Logger(WsJwtGuard.name);

  constructor(
    private jwtService: JwtService,
    private config: ConfigService,
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    try {
      const client = context.switchToWs().getClient();

      // English: Extract token from handshake auth or headers (standard WS Auth flow)
      const token =
        client.handshake?.auth?.token ||
        client.handshake?.headers?.authorization?.split(' ')[1];

      if (!token) {
        this.logger.warn(
          'WebSocket connection attempt rejected: No token provided',
        );
        throw new WsException('Unauthorized');
      }

      // English: Verify the access token using the global AT_SECRET
      const payload = await this.jwtService.verifyAsync(token, {
        secret: this.config.get<string>('AT_SECRET'),
      });

      // English: Attach the user payload to the client for use in event handlers (@ConnectedSocket)
      client.user = payload;

      return true;
    } catch (error: unknown) {
      // English: Handle unknown error type to ensure production stability
      const errorMessage =
        error instanceof Error ? error.message : 'Unknown error';
      this.logger.error(`WebSocket JWT Verification failed: ${errorMessage}`);

      throw new WsException('Unauthorized');
    }
  }
}


================================================================================
File: bff-nestjs/src/auth/strategies/at.strategy.ts
Size: 763 B
================================================================================

import { Injectable } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { Role } from '@prisma/client';

// English: Updated payload to include the user's role
type JwtPayload = {
  sub: number;
  email: string;
  role: Role;
};

@Injectable()
export class AtStrategy extends PassportStrategy(Strategy, 'jwt') {
  constructor(config: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      secretOrKey: config.getOrThrow<string>('AT_SECRET'),
    });
  }

  validate(payload: JwtPayload) {
    // English: Whatever is returned here is attached to request.user
    return payload;
  }
}


================================================================================
File: bff-nestjs/src/auth/strategies/index.ts
Size: 115 B
================================================================================

// English: Barrel file to simplify strategy imports
export * from './at.strategy';
export * from './rt.strategy';


================================================================================
File: bff-nestjs/src/auth/strategies/rt.strategy.ts
Size: 989 B
================================================================================

import { PassportStrategy } from '@nestjs/passport';
import { ExtractJwt, Strategy } from 'passport-jwt';
import { Request } from 'express';
import { Injectable, ForbiddenException } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class RtStrategy extends PassportStrategy(Strategy, 'jwt-refresh') {
  constructor(config: ConfigService) {
    super({
      jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken(),
      // English: Use getOrThrow to ensure the app fails if the secret is missing
      secretOrKey: config.getOrThrow<string>('RT_SECRET'),
      passReqToCallback: true,
    });
  }

  // English: Improved typing for strict mode
  validate(req: Request, payload: any) {
    const authHeader = req.get('authorization');
    if (!authHeader) throw new ForbiddenException('Refresh token missing');

    const refreshToken = authHeader.replace('Bearer', '').trim();

    return {
      ...payload,
      refreshToken,
    };
  }
}


================================================================================
File: bff-nestjs/src/common/config/env.validation.ts
Size: 695 B
================================================================================

// src/common/config/env.validation.ts
import * as Joi from 'joi';

export const envValidationSchema = Joi.object({
  NODE_ENV: Joi.string()
    .valid('development', 'production', 'test')
    .default('development'),
  PORT: Joi.number().default(3001),
  DATABASE_URL: Joi.string().required(),

  AT_SECRET: Joi.string().required(),
  RT_SECRET: Joi.string().required(),

  REDIS_HOST: Joi.string().default('localhost'),
  REDIS_PORT: Joi.number().default(6379),

  MAIL_HOST: Joi.string().required(),
  MAIL_PORT: Joi.number().required(),
  MAIL_USER: Joi.string().required(),
  MAIL_PASS: Joi.string().required(),
  MAIL_FROM: Joi.string().default('"Team Platform" <no-reply@test.com>'),
});


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user-id.decorator.spec.ts
Size: 1.09 kB
================================================================================

import { ExecutionContext } from '@nestjs/common';
import { ROUTE_ARGS_METADATA } from '@nestjs/common/constants';
import { GetCurrentUserId } from './get-current-user-id.decorator';

function getDecoratorFactory(decorator: any) {
  class Test {
    test(@decorator() value: any) {}
  }
  const args = Reflect.getMetadata(ROUTE_ARGS_METADATA, Test, 'test');
  return args[Object.keys(args)[0]].factory;
}

describe('GetCurrentUserId Decorator', () => {
  const factory = getDecoratorFactory(GetCurrentUserId);

  it('should return user sub from request', () => {
    const mockContext = {
      switchToHttp: () => ({
        getRequest: () => ({
          user: { sub: 123 },
        }),
      }),
    } as unknown as ExecutionContext;

    expect(factory(undefined, mockContext)).toBe(123);
  });

  it('should return null if no user is present', () => {
    const mockContext = {
      switchToHttp: () => ({
        getRequest: () => ({
          user: null,
        }),
      }),
    } as unknown as ExecutionContext;

    expect(factory(undefined, mockContext)).toBeNull();
  });
});


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user-id.decorator.ts
Size: 335 B
================================================================================

import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const GetCurrentUserId = createParamDecorator(
  (data: undefined, context: ExecutionContext): number | null => {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    return user ? (user as any).sub : null;
  },
);


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user-role.decorator.spec.ts
Size: 1 kB
================================================================================

import { ExecutionContext } from '@nestjs/common';
import { ROUTE_ARGS_METADATA } from '@nestjs/common/constants';
import { GetCurrentUserRole } from './get-current-user-role.decorator';

function getDecoratorFactory(decorator: any) {
  class Test {
    test(@decorator() value: any) {}
  }
  const args = Reflect.getMetadata(ROUTE_ARGS_METADATA, Test, 'test');
  return args[Object.keys(args)[0]].factory;
}

describe('GetCurrentUserRole Decorator', () => {
  const factory = getDecoratorFactory(GetCurrentUserRole);

  it('should return user role', () => {
    const context = {
      switchToHttp: () => ({ getRequest: () => ({ user: { role: 'ADMIN' } }) }),
    } as unknown as ExecutionContext;

    expect(factory(undefined, context)).toBe('ADMIN');
  });

  it('should return null if no user', () => {
    const context = {
      switchToHttp: () => ({ getRequest: () => ({ user: null }) }),
    } as unknown as ExecutionContext;

    expect(factory(undefined, context)).toBeNull();
  });
});


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user-role.decorator.ts
Size: 373 B
================================================================================

import { createParamDecorator, ExecutionContext } from '@nestjs/common';
import { Role } from '@prisma/client';

export const GetCurrentUserRole = createParamDecorator(
  (data: unknown, context: ExecutionContext): Role | null => {
    const request = context.switchToHttp().getRequest();
    const user = request.user;
    return user ? (user as any).role : null;
  },
);


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user.decorator.spec.ts
Size: 1.14 kB
================================================================================

import { ExecutionContext } from '@nestjs/common';
import { ROUTE_ARGS_METADATA } from '@nestjs/common/constants';
import { GetCurrentUser } from './get-current-user.decorator';

function getDecoratorFactory(decorator: any) {
  class Test {
    test(@decorator() value: any) {}
  }
  const args = Reflect.getMetadata(ROUTE_ARGS_METADATA, Test, 'test');
  return args[Object.keys(args)[0]].factory;
}

describe('GetCurrentUser Decorator', () => {
  const factory = getDecoratorFactory(GetCurrentUser);

  it('should return full user if no data provided', () => {
    const mockUser = { id: 1, email: 'test@test.com' };
    const context = {
      switchToHttp: () => ({ getRequest: () => ({ user: mockUser }) }),
    } as unknown as ExecutionContext;

    expect(factory(undefined, context)).toEqual(mockUser);
  });

  it('should return specific property if data provided', () => {
    const mockUser = { id: 1, email: 'test@test.com' };
    const context = {
      switchToHttp: () => ({ getRequest: () => ({ user: mockUser }) }),
    } as unknown as ExecutionContext;

    expect(factory('email', context)).toBe('test@test.com');
  });
});


================================================================================
File: bff-nestjs/src/common/decorators/get-current-user.decorator.ts
Size: 321 B
================================================================================

import { createParamDecorator, ExecutionContext } from '@nestjs/common';

export const GetCurrentUser = createParamDecorator(
  (data: string | undefined, context: ExecutionContext) => {
    const request = context.switchToHttp().getRequest();
    if (!data) return request.user;
    return request.user?.[data];
  },
);


================================================================================
File: bff-nestjs/src/common/decorators/index.ts
Size: 217 B
================================================================================

export * from './public.decorator';
export * from './get-current-user-id.decorator';
export * from './get-current-user-role.decorator';
export * from './get-current-user.decorator';
export * from './roles.decorator';


================================================================================
File: bff-nestjs/src/common/decorators/public.decorator.ts
Size: 150 B
================================================================================

import { SetMetadata } from '@nestjs/common';

export const IS_PUBLIC_KEY = 'isPublic';
export const Public = () => SetMetadata(IS_PUBLIC_KEY, true);


================================================================================
File: bff-nestjs/src/common/decorators/roles.decorator.spec.ts
Size: 511 B
================================================================================

import { Roles, ROLES_KEY } from './roles.decorator';
import { Role } from '@prisma/client';

describe('Roles Decorator', () => {
  it('should set the correct metadata key and values', () => {
    const roles: Role[] = ['ADMIN', 'USER'];
    const decorator = Roles(...roles);

    // English: Create a dummy class to apply the decorator
    const TestTarget = class {};
    decorator(TestTarget);

    const metadata = Reflect.getMetadata(ROLES_KEY, TestTarget);
    expect(metadata).toEqual(roles);
  });
});


================================================================================
File: bff-nestjs/src/common/decorators/roles.decorator.ts
Size: 194 B
================================================================================

import { SetMetadata } from '@nestjs/common';
import { Role } from '@prisma/client';

export const ROLES_KEY = 'roles';
export const Roles = (...roles: Role[]) => SetMetadata(ROLES_KEY, roles);


================================================================================
File: bff-nestjs/src/common/filters/http-exception.filter.spec.ts
Size: 3.18 kB
================================================================================

import { HttpException, HttpStatus } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { Test, TestingModule } from '@nestjs/testing';
import { ArgumentsHost } from '@nestjs/common';
import { AllExceptionsFilter } from './http-exception.filter';

describe('AllExceptionsFilter', () => {
  let filter: AllExceptionsFilter;
  let configService: ConfigService;

  const mockResponse = {
    status: jest.fn().mockReturnThis(),
    json: jest.fn().mockReturnThis(),
  };

  const mockRequest = {
    url: '/test-url',
    method: 'POST',
  };

  const mockArgumentsHost = {
    switchToHttp: jest.fn().mockReturnThis(),
    getResponse: jest.fn().mockReturnValue(mockResponse),
    getRequest: jest.fn().mockReturnValue(mockRequest),
  } as unknown as ArgumentsHost;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AllExceptionsFilter,
        {
          provide: ConfigService,
          useValue: {
            get: jest.fn((key: string) => {
              if (key === 'NODE_ENV') return 'development';
              return null;
            }),
          },
        },
      ],
    }).compile();

    filter = module.get<AllExceptionsFilter>(AllExceptionsFilter);
    configService = module.get<ConfigService>(ConfigService);
    jest.clearAllMocks();
  });

  it('should be defined', () => {
    expect(filter).toBeDefined();
  });

  it('should catch HttpException and return formatted response', () => {
    const exception = new HttpException(
      'Forbidden Access',
      HttpStatus.FORBIDDEN,
    );

    filter.catch(exception, mockArgumentsHost);

    expect(mockResponse.status).toHaveBeenCalledWith(HttpStatus.FORBIDDEN);
    expect(mockResponse.json).toHaveBeenCalledWith(
      expect.objectContaining({
        statusCode: HttpStatus.FORBIDDEN,
        message: 'Forbidden Access',
      }),
    );
  });

  it('should show detailed error message when NOT in production', () => {
    const exception = new Error('Database connection failed');
    jest.spyOn(configService, 'get').mockReturnValue('development');

    filter.catch(exception, mockArgumentsHost);

    expect(mockResponse.json).toHaveBeenCalledWith(
      expect.objectContaining({
        message: 'Database connection failed',
      }),
    );
  });

  it('should hide detailed error message when in production (GDPR compliance)', () => {
    const exception = new Error('Sensitive database error');
    jest.spyOn(configService, 'get').mockReturnValue('production');

    filter.catch(exception, mockArgumentsHost);

    expect(mockResponse.json).toHaveBeenCalledWith(
      expect.objectContaining({
        message: 'Internal server error',
      }),
    );
  });

  it('should log the error with the new structured format', () => {
    const loggerSpy = jest.spyOn((filter as any).logger, 'error');
    const exception = new Error('Critical failure');

    filter.catch(exception, mockArgumentsHost);

    expect(loggerSpy).toHaveBeenCalledWith(
      expect.stringContaining(
        '[POST] /test-url - Status: 500 - Error: Critical failure',
      ),
      exception.stack,
    );
  });
});


================================================================================
File: bff-nestjs/src/common/filters/http-exception.filter.ts
Size: 1.86 kB
================================================================================

import {
  ExceptionFilter,
  Catch,
  ArgumentsHost,
  HttpException,
  HttpStatus,
  Logger,
} from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import { Request, Response } from 'express';

@Catch()
export class AllExceptionsFilter implements ExceptionFilter {
  private readonly logger = new Logger(AllExceptionsFilter.name);

  constructor(private readonly configService: ConfigService) {}

  catch(exception: unknown, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse<Response>();
    const request = ctx.getRequest<Request>();
    const nodeEnv = this.configService.get<string>('NODE_ENV');

    const status =
      exception instanceof HttpException
        ? exception.getStatus()
        : HttpStatus.INTERNAL_SERVER_ERROR;

    // English: In production, we must hide specific error details for non-HTTP exceptions (GDPR/Security)
    let message = 'Internal server error';
    if (exception instanceof HttpException) {
      const res = exception.getResponse();
      message = typeof res === 'object' ? (res as any).message : res;
    } else if (nodeEnv !== 'production') {
      // English: Show detailed error only in development/test
      message =
        exception instanceof Error ? exception.message : String(exception);
    }

    const errorResponse = {
      statusCode: status,
      timestamp: new Date().toISOString(),
      path: request.url,
      method: request.method,
      message: message,
    };

    // English: Structured logging for observability
    this.logger.error(
      `[${request.method}] ${request.url} - Status: ${status} - Error: ${
        exception instanceof Error ? exception.message : 'Unknown'
      }`,
      exception instanceof Error ? exception.stack : undefined,
    );

    response.status(status).json(errorResponse);
  }
}


================================================================================
File: bff-nestjs/src/common/guards/roles.guard.spec.ts
Size: 2.72 kB
================================================================================

import { Reflector } from '@nestjs/core';
import { RolesGuard } from './roles.guard';
import { PrismaService } from '../../prisma/prisma.service';
import { ExecutionContext, ForbiddenException } from '@nestjs/common';
import { Role } from '@prisma/client';

describe('RolesGuard', () => {
  let guard: RolesGuard;
  let reflector: Reflector;
  let prisma: PrismaService;

  const mockReflector = {
    getAllAndOverride: jest.fn(),
  };

  const mockPrisma = {
    teamMember: {
      findUnique: jest.fn(),
    },
  };

  beforeEach(() => {
    reflector = mockReflector as any;
    prisma = mockPrisma as any;
    guard = new RolesGuard(reflector, prisma);
  });

  const createMockContext = (user: any, params: any = {}): ExecutionContext =>
    ({
      switchToHttp: () => ({
        getRequest: () => ({ user, params }),
      }),
      getHandler: jest.fn(),
      getClass: jest.fn(),
    }) as unknown as ExecutionContext;

  it('should allow access if route is public', async () => {
    mockReflector.getAllAndOverride.mockReturnValue(true); // isPublic = true
    const context = createMockContext(null);
    expect(await guard.canActivate(context)).toBe(true);
  });

  it('should allow access if user is global ADMIN', async () => {
    mockReflector.getAllAndOverride
      .mockReturnValueOnce(false)
      .mockReturnValueOnce(null);
    const context = createMockContext({ role: Role.ADMIN });
    expect(await guard.canActivate(context)).toBe(true);
  });

  it('should throw Forbidden if global roles do not match', async () => {
    mockReflector.getAllAndOverride
      .mockReturnValueOnce(false) // isPublic
      .mockReturnValueOnce([Role.ADMIN]); // requiredRoles

    const context = createMockContext({ role: Role.USER });
    await expect(guard.canActivate(context)).rejects.toThrow(
      ForbiddenException,
    );
  });

  it('should validate team membership if teamId is present', async () => {
    mockReflector.getAllAndOverride.mockReturnValue(null);
    const mockUser = { sub: 1, role: Role.USER };
    const context = createMockContext(mockUser, { teamId: '10' });

    mockPrisma.teamMember.findUnique.mockResolvedValue({
      userId: 1,
      teamId: 10,
      role: 'MEMBER',
    });

    expect(await guard.canActivate(context)).toBe(true);
    expect(mockUser['teamRole']).toBe('MEMBER');
  });

  it('should throw Forbidden if user is not in team', async () => {
    mockReflector.getAllAndOverride.mockReturnValue(null);
    const context = createMockContext({ sub: 1 }, { teamId: '10' });

    mockPrisma.teamMember.findUnique.mockResolvedValue(null);

    await expect(guard.canActivate(context)).rejects.toThrow(
      'You are not a member of this team',
    );
  });
});


================================================================================
File: bff-nestjs/src/common/guards/roles.guard.ts
Size: 2.09 kB
================================================================================

import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { Reflector } from '@nestjs/core';
import { Role, TeamRole } from '@prisma/client'; // Import both
import { ROLES_KEY } from '../decorators/roles.decorator';
import { IS_PUBLIC_KEY } from '../decorators/public.decorator';
import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class RolesGuard implements CanActivate {
  constructor(
    private reflector: Reflector,
    private prisma: PrismaService, // English: Needed to check team membership
  ) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    // 1. Check if route is public
    const isPublic = this.reflector.getAllAndOverride<boolean>(IS_PUBLIC_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);
    if (isPublic) return true;

    // 2. Get required roles from decorator
    const requiredRoles = this.reflector.getAllAndOverride<Role[]>(ROLES_KEY, [
      context.getHandler(),
      context.getClass(),
    ]);

    const request = context.switchToHttp().getRequest();
    const user = request.user;
    const teamId = parseInt(request.params.teamId);

    // 3. Global Admin Bypass (Enterprise Standard)
    if (user?.role === Role.ADMIN) return true;

    // 4. Validate Global Roles (if @Roles is present)
    if (requiredRoles && !requiredRoles.some((role) => user.role === role)) {
      throw new ForbiddenException('Missing required global role');
    }

    // 5. Team Context Validation (Logic for Team Roles)
    // English: If the URL contains a teamId, we must verify membership
    if (teamId) {
      const membership = await this.prisma.teamMember.findUnique({
        where: {
          userId_teamId: { userId: user.sub, teamId: teamId },
        },
      });

      if (!membership) {
        throw new ForbiddenException('You are not a member of this team');
      }

      // English: Attach membership to request for easy access in controllers
      request.user.teamRole = membership.role;
    }

    return true;
  }
}


================================================================================
File: bff-nestjs/src/common/guards/team-member.guard.spec.ts
Size: 2.04 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TeamMemberGuard } from './team-member.guard';
import { PrismaService } from '../../prisma/prisma.service';
import { ForbiddenException, ExecutionContext } from '@nestjs/common';

describe('TeamMemberGuard', () => {
  let guard: TeamMemberGuard;
  let prisma: PrismaService;

  const mockPrisma = {
    extended: {
      teamMember: { findFirst: jest.fn() },
    },
  };

  const createMockContext = (
    params: any,
    body: any,
    userId: number,
  ): ExecutionContext =>
    ({
      switchToHttp: () => ({
        getRequest: () => ({
          params,
          body,
          user: { sub: userId },
        }),
      }),
    }) as any;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        TeamMemberGuard,
        { provide: PrismaService, useValue: mockPrisma },
      ],
    }).compile();

    guard = module.get<TeamMemberGuard>(TeamMemberGuard);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should return true if no teamId is provided (skips check)', async () => {
    const context = createMockContext({}, {}, 1);
    const result = await guard.canActivate(context);
    expect(result).toBe(true);
  });

  it('should allow access if membership exists', async () => {
    (mockPrisma.extended.teamMember.findFirst as jest.Mock).mockResolvedValue({
      id: 1,
    });
    const context = createMockContext({ teamId: '5' }, {}, 1);

    const result = await guard.canActivate(context);
    expect(result).toBe(true);
    expect(mockPrisma.extended.teamMember.findFirst).toHaveBeenCalled();
  });

  it('should throw ForbiddenException if membership does not exist', async () => {
    (mockPrisma.extended.teamMember.findFirst as jest.Mock).mockResolvedValue(
      null,
    );
    const context = createMockContext({}, { teamId: 5 }, 1); // Prueba desde el body

    await expect(guard.canActivate(context)).rejects.toThrow(
      ForbiddenException,
    );
  });
});


================================================================================
File: bff-nestjs/src/common/guards/team-member.guard.ts
Size: 935 B
================================================================================

// src/common/guards/team-member.guard.ts
import {
  Injectable,
  CanActivate,
  ExecutionContext,
  ForbiddenException,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';

@Injectable()
export class TeamMemberGuard implements CanActivate {
  constructor(private prisma: PrismaService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const userId = request.user.sub;
    const teamId = parseInt(request.params.teamId || request.body.teamId);

    if (!teamId) return true; // English: Skip if no team context is provided

    const membership = await this.prisma.extended.teamMember.findFirst({
      where: {
        userId,
        teamId,
      },
    });

    if (!membership) {
      throw new ForbiddenException(
        'Access Denied: You do not belong to this team',
      );
    }

    return true;
  }
}


================================================================================
File: bff-nestjs/src/common/guards/team-owner.guard.spec.ts
Size: 2.21 kB
================================================================================

// bff-nestjs/src/common/guards/team-owner.guard.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { TeamOwnerGuard } from './team-owner.guard';
import { PrismaService } from '../../prisma/prisma.service';
import {
  ExecutionContext,
  ForbiddenException,
  NotFoundException,
} from '@nestjs/common';
import { TeamRole } from '@prisma/client';

describe('TeamOwnerGuard', () => {
  let guard: TeamOwnerGuard;
  let prisma: PrismaService;

  const mockPrismaService = {
    extended: {
      teamMember: {
        findUnique: jest.fn(),
      },
    },
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        TeamOwnerGuard,
        { provide: PrismaService, useValue: mockPrismaService },
      ],
    }).compile();

    guard = module.get<TeamOwnerGuard>(TeamOwnerGuard);
    prisma = module.get<PrismaService>(PrismaService);
  });

  const createMockContext = (
    userId: number,
    teamId: string,
  ): ExecutionContext =>
    ({
      switchToHttp: () => ({
        getRequest: () => ({
          user: { sub: userId },
          params: { id: teamId },
        }),
      }),
    }) as any;

  it('should be defined', () => {
    expect(guard).toBeDefined();
  });

  it('should allow access if user is OWNER', async () => {
    mockPrismaService.extended.teamMember.findUnique.mockResolvedValue({
      role: TeamRole.OWNER,
    });

    const context = createMockContext(1, '10');
    const result = await guard.canActivate(context);

    expect(result).toBe(true);
  });

  it('should throw ForbiddenException if user is not OWNER', async () => {
    mockPrismaService.extended.teamMember.findUnique.mockResolvedValue({
      role: TeamRole.MEMBER,
    });

    const context = createMockContext(1, '10');
    await expect(guard.canActivate(context)).rejects.toThrow(
      ForbiddenException,
    );
  });

  it('should throw NotFoundException if membership does not exist', async () => {
    mockPrismaService.extended.teamMember.findUnique.mockResolvedValue(null);

    const context = createMockContext(1, '10');
    await expect(guard.canActivate(context)).rejects.toThrow(NotFoundException);
  });
});


================================================================================
File: bff-nestjs/src/common/guards/team-owner.guard.ts
Size: 1.42 kB
================================================================================

// bff-nestjs/src/common/guards/team-owner.guard.ts
import {
  CanActivate,
  ExecutionContext,
  Injectable,
  ForbiddenException,
  NotFoundException,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { TeamRole, Role } from '@prisma/client';

@Injectable()
export class TeamOwnerGuard implements CanActivate {
  constructor(private prisma: PrismaService) {}

  async canActivate(context: ExecutionContext): Promise<boolean> {
    const request = context.switchToHttp().getRequest();
    const user = request.user;

    // English: Global Admins can bypass owner checks (Enterprise Standard)
    if (user?.role === Role.ADMIN) return true;

    const userId = user?.sub;
    const teamIdRaw = request.params.id || request.params.teamId;
    const teamId = parseInt(teamIdRaw, 10);

    if (!userId || isNaN(teamId)) {
      throw new ForbiddenException('User session or Team ID not found');
    }

    // English: Verify ownership in the specific team
    const membership = await this.prisma.extended.teamMember.findUnique({
      where: {
        userId_teamId: { userId, teamId },
      },
    });

    if (!membership) {
      throw new NotFoundException('Team membership not found');
    }

    if (membership.role !== TeamRole.OWNER) {
      throw new ForbiddenException(
        'Only the team OWNER can perform this action',
      );
    }

    return true;
  }
}


================================================================================
File: bff-nestjs/src/common/prisma/soft-delete.extension.ts
Size: 674 B
================================================================================

// src/common/prisma/soft-delete.extension.ts
import { Prisma } from '@prisma/client';

export const softDeleteExtension = Prisma.defineExtension({
  name: 'softDelete',
  query: {
    $allModels: {
      async findMany({ model, operation, args, query }) {
        args.where = { ...args.where, deletedAt: null };
        return query(args);
      },
      async findFirst({ model, operation, args, query }) {
        args.where = { ...args.where, deletedAt: null };
        return query(args);
      },
      async findUnique({ model, operation, args, query }) {
        args.where = { ...args.where, deletedAt: null };
        return query(args);
      },
    },
  },
});


================================================================================
File: bff-nestjs/src/config/env.validation.ts
Size: 1.77 kB
================================================================================

import * as Joi from 'joi';

export const envValidationSchema = Joi.object({
  // --- ENVIRONMENT ---
  NODE_ENV: Joi.string()
    .valid('development', 'production', 'test', 'staging')
    .default('development'),
  PORT: Joi.number().port().default(3001),
  FRONTEND_URL: Joi.string().uri().required(),

  // --- DATABASE (PostgreSQL 14+) ---
  DATABASE_URL: Joi.string().required(),
  DATABASE_POOL_SIZE: Joi.number().min(1).max(100).default(10),

  // --- AUTHENTICATION & SECURITY ---
  AT_SECRET: Joi.string().min(32).required(),
  RT_SECRET: Joi.string().min(32).required(),
  COOKIE_SECRET: Joi.string().min(32).required(), // Crucial for signed cookies
  AT_EXPIRES_IN: Joi.string().default('15m'),
  RT_EXPIRES_IN: Joi.string().default('7d'),

  // --- REDIS (Queues/BullMQ) ---
  REDIS_HOST: Joi.string().required(),
  REDIS_PORT: Joi.number().port().default(6379),
  REDIS_PASSWORD: Joi.string().allow('').optional(),

  // --- MAIL (SaaS Standard) ---
  MAIL_HOST: Joi.string().required(),
  MAIL_PORT: Joi.number().port().required(),
  MAIL_USER: Joi.string().required(),
  MAIL_PASS: Joi.string().required(),
  MAIL_FROM: Joi.string().default('"Team Platform" <no-reply@yourdomain.com>'),

  // --- STORAGE (Supabase S3 Compatible) ---
  STORAGE_ENDPOINT: Joi.string().uri().required(),
  STORAGE_REGION: Joi.string().required(),
  STORAGE_ACCESS_KEY: Joi.string().required(),
  STORAGE_SECRET_KEY: Joi.string().required(),
  STORAGE_BUCKET: Joi.string().required(),
  STORAGE_FORCE_PATH_STYLE: Joi.boolean().default(true), // Specific for Supabase/Minio

  // --- MONITORING ---
  LOG_LEVEL: Joi.string().valid('debug', 'info', 'warn', 'error').default('info'),
  THROTTLE_TTL: Joi.number().default(60000),
  THROTTLE_LIMIT: Joi.number().default(20),
});

================================================================================
File: bff-nestjs/src/main.ts
Size: 2.99 kB
================================================================================

import { ClassSerializerInterceptor, ValidationPipe } from '@nestjs/common';
import { NestFactory, Reflector } from '@nestjs/core';
import { ConfigService } from '@nestjs/config';
import { Logger } from 'nestjs-pino';
import cookieParser from 'cookie-parser'; // Fixed: Default import for TS2349 compatibility
import { DocumentBuilder, SwaggerModule } from '@nestjs/swagger';
import { NestExpressApplication } from '@nestjs/platform-express';

import { AppModule } from './app.module';
import { AllExceptionsFilter } from './common/filters/http-exception.filter';

async function bootstrap() {
  // English: Create the app with NestExpressApplication type to access Express methods
  const app = await NestFactory.create<NestExpressApplication>(AppModule, {
    bufferLogs: true,
  });

  // English: Security enhancement - Hide the underlying technology (Express)
  app.disable('x-powered-by');

  // English: Set Pino as the primary logger for structured JSON logging
  app.useLogger(app.get(Logger));

  const configService = app.get(ConfigService);
  const port = configService.get<number>('PORT') || 3001;
  const frontendUrl = configService.get<string>('FRONTEND_URL');
  const cookieSecret = configService.get<string>('COOKIE_SECRET');
  const nodeEnv = configService.get<string>('NODE_ENV');

  app.setGlobalPrefix('api/v1');

  // English: Cookie signing is mandatory for SaaS security to prevent client-side tampering
  app.use(cookieParser(cookieSecret));

  // English: Strict CORS configuration pulling from validated environment variables
  app.enableCors({
    origin: frontendUrl,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'set-cookie'],
  });

  // English: Global validation pipes for DTO integrity
  app.useGlobalPipes(
    new ValidationPipe({
      whitelist: true,
      forbidNonWhitelisted: true,
      transform: true,
    }),
  );

  // English: Global exception filter for GDPR and security compliance
  app.useGlobalFilters(new AllExceptionsFilter(configService));

  const reflector = app.get(Reflector);
  app.useGlobalInterceptors(new ClassSerializerInterceptor(reflector));

  // English: Swagger API Documentation - restricted to non-production environments
  if (nodeEnv !== 'production') {
    const config = new DocumentBuilder()
      .setTitle('Team Productivity Platform')
      .setDescription('BFF Enterprise API - German Market Standard')
      .setVersion('1.0')
      .addBearerAuth({ type: 'http', scheme: 'bearer' }, 'access-token')
      .build();

    const document = SwaggerModule.createDocument(app, config);
    SwaggerModule.setup('api/docs', app, document);
  }

  await app.listen(port);

  // English: Initial bootstrap info
  console.log(`üöÄ Application is running on: http://localhost:${port}/api/v1`);
  if (nodeEnv !== 'production') {
    console.log(`üìö Documentation: http://localhost:${port}/api/docs`);
  }
}
bootstrap();


================================================================================
File: bff-nestjs/src/modules/dashboard/dashboard.controller.spec.ts
Size: 1.29 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { DashboardController } from './dashboard.controller';
import { DashboardService } from './dashboard.service';
import { RolesGuard } from '../../common/guards/roles.guard';

describe('DashboardController', () => {
  let controller: DashboardController;
  let service: DashboardService;

  const mockDashboardService = {
    getTeamStats: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [DashboardController],
      providers: [
        { provide: DashboardService, useValue: mockDashboardService },
      ],
    })
      .overrideGuard(RolesGuard)
      .useValue({ canActivate: () => true })
      .compile();

    controller = module.get<DashboardController>(DashboardController);
    service = module.get<DashboardService>(DashboardService);
  });

  it('should return stats for a team via service', async () => {
    const mockStats = {
      teamName: 'Team Alpha',
      totalProjects: 1,
      projects: [],
    };
    mockDashboardService.getTeamStats.mockResolvedValue(mockStats);

    const result = await controller.getStats(1);

    expect(service.getTeamStats).toHaveBeenCalledWith(1);
    expect(result).toEqual(mockStats);
  });
});


================================================================================
File: bff-nestjs/src/modules/dashboard/dashboard.controller.ts
Size: 688 B
================================================================================

import {
  Controller,
  Get,
  Param,
  ParseIntPipe,
  UseGuards,
} from '@nestjs/common';
import { DashboardService } from './dashboard.service';
import { RolesGuard } from '../../common/guards/roles.guard';
import { ApiTags, ApiBearerAuth } from '@nestjs/swagger';

@ApiTags('Dashboard')
@ApiBearerAuth('access-token')
@UseGuards(RolesGuard) // English: Crucial - verified team membership automatically
@Controller('dashboard')
export class DashboardController {
  constructor(private readonly dashboardService: DashboardService) {}

  @Get('team/:teamId')
  async getStats(@Param('teamId', ParseIntPipe) teamId: number) {
    return this.dashboardService.getTeamStats(teamId);
  }
}


================================================================================
File: bff-nestjs/src/modules/dashboard/dashboard.module.ts
Size: 362 B
================================================================================

import { Module } from '@nestjs/common';
import { DashboardService } from './dashboard.service';
import { DashboardController } from './dashboard.controller';
import { PrismaModule } from '../../prisma/prisma.module';

@Module({
  imports: [PrismaModule],
  controllers: [DashboardController],
  providers: [DashboardService],
})
export class DashboardModule {}


================================================================================
File: bff-nestjs/src/modules/dashboard/dashboard.service.spec.ts
Size: 2.37 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { DashboardService } from './dashboard.service';
import { PrismaService } from '../../prisma/prisma.service';
import { NotFoundException } from '@nestjs/common';
import { TaskStatus } from '@prisma/client';

describe('DashboardService', () => {
  let service: DashboardService;
  let prisma: PrismaService;

  const mockPrisma = {
    extended: {
      team: {
        findUnique: jest.fn(),
      },
    },
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        DashboardService,
        { provide: PrismaService, useValue: mockPrisma },
      ],
    }).compile();

    service = module.get<DashboardService>(DashboardService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should calculate team stats correctly (Success)', async () => {
    const pastDate = new Date();
    pastDate.setDate(pastDate.getDate() - 5);

    const mockTeam = {
      name: 'Development Team',
      projects: [
        {
          id: 101,
          name: 'Project X',
          _count: { tasks: 2 },
          tasks: [
            { status: TaskStatus.DONE, dueDate: null },
            { status: TaskStatus.IN_PROGRESS, dueDate: pastDate }, // Overdue
          ],
        },
      ],
    };

    (mockPrisma.extended.team.findUnique as jest.Mock).mockResolvedValue(
      mockTeam,
    );

    const result = await service.getTeamStats(1);

    expect(result.teamName).toBe('Development Team');
    expect(result.projects[0].progress).toBe(50); // 1 done of 2
    expect(result.projects[0].overdueTasks).toBe(1);
    expect(result.projects[0].completedTasks).toBe(1);
  });

  it('should return 0 progress if project has no tasks', async () => {
    const mockTeam = {
      name: 'Empty Team',
      projects: [{ id: 1, name: 'Empty P', _count: { tasks: 0 }, tasks: [] }],
    };
    (mockPrisma.extended.team.findUnique as jest.Mock).mockResolvedValue(
      mockTeam,
    );

    const result = await service.getTeamStats(1);
    expect(result.projects[0].progress).toBe(0);
  });

  it('should throw NotFoundException if team does not exist', async () => {
    (mockPrisma.extended.team.findUnique as jest.Mock).mockResolvedValue(null);
    await expect(service.getTeamStats(999)).rejects.toThrow(NotFoundException);
  });
});


================================================================================
File: bff-nestjs/src/modules/dashboard/dashboard.service.ts
Size: 1.57 kB
================================================================================

import { Injectable, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { TaskStatus } from '@prisma/client';

@Injectable()
export class DashboardService {
  constructor(private prisma: PrismaService) {}

  async getTeamStats(teamId: number) {
    const team = await this.prisma.extended.team.findUnique({
      where: { id: teamId },
      include: {
        projects: {
          include: {
            _count: {
              select: { tasks: true },
            },
            tasks: {
              select: { status: true, dueDate: true },
            },
          },
        },
      },
    });

    if (!team) throw new NotFoundException(`Team with ID ${teamId} not found`);

    const now = new Date();
    const projectStats = team.projects.map((project) => {
      const totalTasks = project._count.tasks;
      const completedTasks = project.tasks.filter(
        (t) => t.status === TaskStatus.DONE,
      ).length;

      const progress =
        totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
      const overdueTasks = project.tasks.filter(
        (t) =>
          t.status !== TaskStatus.DONE &&
          t.dueDate &&
          new Date(t.dueDate) < now,
      ).length;

      return {
        id: project.id,
        name: project.name,
        progress,
        totalTasks,
        completedTasks,
        overdueTasks,
      };
    });

    return {
      teamName: team.name,
      totalProjects: team.projects.length,
      projects: projectStats,
    };
  }
}


================================================================================
File: bff-nestjs/src/modules/dashboard/dto/project-stats.dto.ts
Size: 373 B
================================================================================

import { ApiProperty } from '@nestjs/swagger';

export class ProjectStatsDto {
  @ApiProperty()
  projectId!: number;

  @ApiProperty()
  projectName!: string;

  @ApiProperty()
  totalTasks!: number;

  @ApiProperty()
  completedTasks!: number;

  @ApiProperty()
  pendingTasks!: number;

  @ApiProperty()
  overdueTasks!: number;

  @ApiProperty()
  progress!: number;
}


================================================================================
File: bff-nestjs/src/modules/health/health.controller.ts
Size: 628 B
================================================================================

import { Controller, Get } from '@nestjs/common';
import {
  HealthCheckService,
  PrismaHealthIndicator,
  HealthCheck,
} from '@nestjs/terminus';
import { PrismaService } from '../../prisma/prisma.service';
import { Public } from '../../common/decorators';

@Controller('health')
export class HealthController {
  constructor(
    private health: HealthCheckService,
    private prismaIndicator: PrismaHealthIndicator,
    private prisma: PrismaService,
  ) {}

  @Public()
  @Get()
  @HealthCheck()
  check() {
    return this.health.check([
      () => this.prismaIndicator.pingCheck('database', this.prisma),
    ]);
  }
}


================================================================================
File: bff-nestjs/src/modules/health/health.module.ts
Size: 328 B
================================================================================

import { Module } from '@nestjs/common';
import { TerminusModule } from '@nestjs/terminus';
import { HealthController } from './health.controller';
import { PrismaModule } from '../../prisma/prisma.module';

@Module({
  imports: [TerminusModule, PrismaModule],
  controllers: [HealthController],
})
export class HealthModule {}


================================================================================
File: bff-nestjs/src/modules/invitations/dto/invitation.dto.ts
Size: 470 B
================================================================================

import { IsEmail, IsEnum, IsNotEmpty, IsString } from 'class-validator';
import { TeamRole } from '@prisma/client';

export class SendInvitationDto {
  @IsEmail()
  @IsNotEmpty()
  email!: string; // English: Added '!' to fix TS2564 Property has no initializer

  @IsEnum(TeamRole)
  role: TeamRole = TeamRole.MEMBER;
}

export class AcceptInvitationDto {
  @IsString()
  @IsNotEmpty()
  token!: string; // English: Added '!' to fix TS2564 Property has no initializer
}


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.controller.spec.ts
Size: 1.51 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { InvitationsController } from './invitations.controller';
import { InvitationsService } from './invitations.service';
import { AtGuard } from '../../auth/guards/at.guard';
import { TeamRole } from '@prisma/client';

describe('InvitationsController', () => {
  let controller: InvitationsController;
  let service: InvitationsService;

  const mockInvitationsService = {
    createInvitation: jest.fn(),
    acceptInvitation: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [InvitationsController],
      providers: [
        { provide: InvitationsService, useValue: mockInvitationsService },
      ],
    })
      .overrideGuard(AtGuard)
      .useValue({ canActivate: () => true })
      .compile();

    controller = module.get<InvitationsController>(InvitationsController);
    service = module.get<InvitationsService>(InvitationsService);
  });

  it('should call createInvitation service', async () => {
    const dto = { email: 'test@test.com', role: TeamRole.MEMBER };
    await controller.invite(1, 10, dto);
    expect(service.createInvitation).toHaveBeenCalledWith(
      1,
      10,
      dto.email,
      dto.role,
    );
  });

  it('should call acceptInvitation service', async () => {
    const dto = { token: 'valid-token' };
    await controller.accept(dto, 10);
    expect(service.acceptInvitation).toHaveBeenCalledWith(dto.token, 10);
  });
});


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.controller.ts
Size: 1.35 kB
================================================================================

import {
  Controller,
  Post,
  Body,
  UseGuards,
  Param,
  ParseIntPipe,
} from '@nestjs/common';
import { InvitationsService } from './invitations.service';
import { AtGuard } from '../../auth/guards/at.guard';
import { GetCurrentUserId } from '../../common/decorators';
import { ApiTags, ApiOperation, ApiBearerAuth } from '@nestjs/swagger';
import { SendInvitationDto, AcceptInvitationDto } from './dto/invitation.dto';

@ApiTags('invitations')
@ApiBearerAuth()
@UseGuards(AtGuard)
@Controller('invitations')
export class InvitationsController {
  constructor(private readonly invitationsService: InvitationsService) {}

  @Post('team/:teamId/send')
  @ApiOperation({ summary: 'Send an email invitation to join a team' })
  async invite(
    @Param('teamId', ParseIntPipe) teamId: number,
    @GetCurrentUserId() userId: number,
    @Body() dto: SendInvitationDto,
  ) {
    // English: Changed to createInvitation to match your Service method name
    return this.invitationsService.createInvitation(
      teamId,
      userId,
      dto.email,
      dto.role,
    );
  }

  @Post('accept')
  @ApiOperation({ summary: 'Accept a team invitation using a token' })
  async accept(
    @Body() dto: AcceptInvitationDto,
    @GetCurrentUserId() userId: number,
  ) {
    return this.invitationsService.acceptInvitation(dto.token, userId);
  }
}


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.module.ts
Size: 860 B
================================================================================

import { Module } from '@nestjs/common';
import { InvitationsService } from './invitations.service';
import { InvitationsController } from './invitations.controller';
import { PrismaModule } from '../../prisma/prisma.module';
import { MailModule } from '../mail/mail.module';
import { JwtModule } from '@nestjs/jwt';
import { NotificationsModule } from '../notifications/notifications.module'; // English: Added missing module

@Module({
  imports: [
    PrismaModule,
    MailModule,
    NotificationsModule, // English: Required for NotificationsGateway in InvitationsService
    JwtModule.register({
      secret: process.env.JWT_SECRET || 'fallback_secret',
      signOptions: { expiresIn: '7d' },
    }),
  ],
  controllers: [InvitationsController],
  providers: [InvitationsService],
  exports: [InvitationsService],
})
export class InvitationsModule {}


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.processor.spec.ts
Size: 1.48 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { InvitationsProcessor } from './invitations.processor';
import { MailService } from '../mail/mail.service';
import { Logger } from '@nestjs/common';

describe('InvitationsProcessor', () => {
  let processor: InvitationsProcessor;
  let mailService: MailService;

  const mockMailService = {
    sendInvitationEmail: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        InvitationsProcessor,
        { provide: MailService, useValue: mockMailService },
      ],
    }).compile();

    processor = module.get<InvitationsProcessor>(InvitationsProcessor);
    mailService = module.get<MailService>(MailService);
  });

  it('should process send-invitation job', async () => {
    const job = {
      id: '1',
      name: 'send-invitation',
      data: { email: 'test@test.com', token: '123', teamName: 'Team A' },
    } as any;

    await processor.process(job);

    expect(mailService.sendInvitationEmail).toHaveBeenCalledWith(
      'test@test.com',
      'Team A',
      '123',
    );
  });

  it('should log warning for unknown job name', async () => {
    const loggerSpy = jest.spyOn(Logger.prototype, 'warn');
    const job = { id: '2', name: 'unknown-task', data: {} } as any;

    await processor.process(job);

    expect(loggerSpy).toHaveBeenCalledWith(
      expect.stringContaining('Unknown job name'),
    );
  });
});


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.processor.ts
Size: 856 B
================================================================================

import { Processor, WorkerHost } from '@nestjs/bullmq';
import { Job } from 'bullmq';
import { Logger } from '@nestjs/common';
import { MailService } from '../mail/mail.service';

@Processor('mail-queue')
export class InvitationsProcessor extends WorkerHost {
  private readonly logger = new Logger(InvitationsProcessor.name);

  constructor(private readonly mailService: MailService) {
    super();
  }

  async process(job: Job<any, any, string>): Promise<any> {
    this.logger.log(`Processing job ${job.id} of type ${job.name}...`);

    switch (job.name) {
      case 'send-invitation':
        const { email, token, teamName } = job.data;
        return await this.mailService.sendInvitationEmail(
          email,
          teamName,
          token,
        );

      default:
        this.logger.warn(`Unknown job name: ${job.name}`);
    }
  }
}


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.service.spec.ts
Size: 8 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { InvitationsService } from './invitations.service';
import { PrismaService } from '../../prisma/prisma.service';
import { JwtService } from '@nestjs/jwt';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { MailService } from '../mail/mail.service';
import {
  BadRequestException,
  NotFoundException,
  ForbiddenException,
} from '@nestjs/common';
import { TeamRole, InvitationStatus } from '@prisma/client';

describe('InvitationsService', () => {
  let service: InvitationsService;
  let prisma: PrismaService;
  let jwt: JwtService;

  const mockTeamId = 1;
  const mockInviterId = 10;
  const mockUserId = 5;
  const mockEmail = 'guest@test.com';
  const mockToken = 'valid-jwt-token';

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        InvitationsService,
        {
          provide: PrismaService,
          useValue: {
            team: { findUnique: jest.fn() },
            teamMember: { findFirst: jest.fn(), create: jest.fn() },
            invitation: {
              create: jest.fn(),
              findUnique: jest.fn(),
              update: jest.fn(),
            },
            user: { findUnique: jest.fn() },
            $transaction: jest.fn((promises) => Promise.all(promises)),
          },
        },
        {
          provide: JwtService,
          useValue: {
            sign: jest.fn().mockReturnValue(mockToken),
            verifyAsync: jest.fn(),
          },
        },
        {
          provide: NotificationsGateway,
          useValue: { notifyInvitationAccepted: jest.fn() },
        },
        {
          provide: MailService,
          useValue: { sendInvitationEmail: jest.fn().mockResolvedValue(true) },
        },
      ],
    }).compile();

    service = module.get<InvitationsService>(InvitationsService);
    prisma = module.get<PrismaService>(PrismaService);
    jwt = module.get<JwtService>(JwtService);
  });

  describe('createInvitation', () => {
    it('should create an invitation successfully', async () => {
      const mockTeam = {
        id: mockTeamId,
        name: 'Team Jest',
        members: [
          {
            userId: mockInviterId,
            role: TeamRole.OWNER,
            teamId: mockTeamId,
          },
        ],
      };

      (prisma.team.findUnique as jest.Mock).mockResolvedValue(mockTeam);
      (prisma.teamMember.findFirst as jest.Mock).mockResolvedValue(null);
      (prisma.user.findUnique as jest.Mock).mockResolvedValue({
        id: mockInviterId,
        email: 'owner@test.com',
      });
      (prisma.invitation.create as jest.Mock).mockResolvedValue({ id: 500 });

      const result = await service.createInvitation(
        mockTeamId,
        mockInviterId,
        mockEmail,
      );

      expect(result.message).toBe('Invitation sent successfully');
      expect(result.invitationId).toBe(500);
      expect(prisma.invitation.create).toHaveBeenCalled();
    });

    it('should throw NotFoundException if team does not exist', async () => {
      (prisma.team.findUnique as jest.Mock).mockResolvedValue(null);

      await expect(
        service.createInvitation(999, mockInviterId, mockEmail),
      ).rejects.toThrow(NotFoundException);
    });

    it('should throw ForbiddenException if inviter is not team owner', async () => {
      const mockTeam = {
        id: mockTeamId,
        name: 'Team Jest',
        members: [
          {
            userId: mockInviterId,
            role: TeamRole.MEMBER,
            teamId: mockTeamId,
          },
        ],
      };

      (prisma.team.findUnique as jest.Mock).mockResolvedValue(mockTeam);

      await expect(
        service.createInvitation(mockTeamId, mockInviterId, mockEmail),
      ).rejects.toThrow(ForbiddenException);
    });

    it('should throw BadRequestException if user is already a member', async () => {
      const mockTeam = {
        id: mockTeamId,
        name: 'Team Jest',
        members: [
          {
            userId: mockInviterId,
            role: TeamRole.OWNER,
            teamId: mockTeamId,
          },
        ],
      };

      (prisma.team.findUnique as jest.Mock).mockResolvedValue(mockTeam);
      (prisma.teamMember.findFirst as jest.Mock).mockResolvedValue({ id: 1 });

      await expect(
        service.createInvitation(mockTeamId, mockInviterId, mockEmail),
      ).rejects.toThrow(BadRequestException);
    });

    it('should throw BadRequestException if user tries to invite themselves', async () => {
      const mockTeam = {
        id: mockTeamId,
        name: 'Team Jest',
        members: [
          {
            userId: mockInviterId,
            role: TeamRole.OWNER,
            teamId: mockTeamId,
          },
        ],
      };

      (prisma.team.findUnique as jest.Mock).mockResolvedValue(mockTeam);
      (prisma.teamMember.findFirst as jest.Mock).mockResolvedValue(null);
      (prisma.user.findUnique as jest.Mock).mockResolvedValue({
        id: mockInviterId,
        email: mockEmail,
      });

      await expect(
        service.createInvitation(mockTeamId, mockInviterId, mockEmail),
      ).rejects.toThrow(BadRequestException);
    });
  });

  describe('acceptInvitation', () => {
    const mockPayload = {
      teamId: mockTeamId,
      email: mockEmail,
      role: TeamRole.MEMBER,
    };
    const mockInvitationDb = {
      id: 100,
      token: mockToken,
      status: InvitationStatus.PENDING,
      expiresAt: new Date(Date.now() + 10000),
      teamId: mockTeamId,
    };

    it('should accept an invitation successfully', async () => {
      (jwt.verifyAsync as jest.Mock).mockResolvedValue(mockPayload);
      (prisma.invitation.findUnique as jest.Mock).mockResolvedValue(
        mockInvitationDb,
      );
      (prisma.user.findUnique as jest.Mock).mockResolvedValue({
        id: mockUserId,
        email: mockEmail,
        name: 'Nikolas',
      });

      const result = await service.acceptInvitation(mockToken, mockUserId);

      expect(result.message).toBe('Joined the team successfully');
      expect(prisma.$transaction).toHaveBeenCalled();
    });

    it('should throw ForbiddenException if email in token does not match user email', async () => {
      (jwt.verifyAsync as jest.Mock).mockResolvedValue(mockPayload);
      (prisma.invitation.findUnique as jest.Mock).mockResolvedValue(
        mockInvitationDb,
      );
      (prisma.user.findUnique as jest.Mock).mockResolvedValue({
        id: mockUserId,
        email: 'other@test.com',
      });

      await expect(
        service.acceptInvitation(mockToken, mockUserId),
      ).rejects.toThrow(ForbiddenException);
    });

    it('should throw BadRequestException if invitation is already accepted', async () => {
      (jwt.verifyAsync as jest.Mock).mockResolvedValue(mockPayload);
      (prisma.invitation.findUnique as jest.Mock).mockResolvedValue({
        ...mockInvitationDb,
        status: InvitationStatus.ACCEPTED,
      });

      await expect(
        service.acceptInvitation(mockToken, mockUserId),
      ).rejects.toThrow(BadRequestException);
    });

    it('should throw BadRequestException if token is expired (JWT error)', async () => {
      const error = new Error();
      error.name = 'TokenExpiredError';
      (jwt.verifyAsync as jest.Mock).mockRejectedValue(error);

      await expect(
        service.acceptInvitation('expired', mockUserId),
      ).rejects.toThrow(BadRequestException);
    });

    it('should throw NotFoundException if user is not found', async () => {
      (jwt.verifyAsync as jest.Mock).mockResolvedValue(mockPayload);
      (prisma.invitation.findUnique as jest.Mock).mockResolvedValue(
        mockInvitationDb,
      );
      (prisma.user.findUnique as jest.Mock).mockResolvedValue(null);

      await expect(
        service.acceptInvitation(mockToken, mockUserId),
      ).rejects.toThrow(NotFoundException);
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/invitations/invitations.service.ts
Size: 4.64 kB
================================================================================

import {
  Injectable,
  BadRequestException,
  NotFoundException,
  ForbiddenException,
} from '@nestjs/common';
import { JwtService } from '@nestjs/jwt';
import { PrismaService } from '../../prisma/prisma.service';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { MailService } from '../mail/mail.service';
import { TeamRole, InvitationStatus } from '@prisma/client';

@Injectable()
export class InvitationsService {
  constructor(
    private prisma: PrismaService,
    private jwtService: JwtService,
    private notifications: NotificationsGateway,
    private mailService: MailService,
  ) {}

  async createInvitation(
    teamId: number,
    inviterId: number,
    targetEmail: string,
    role: TeamRole = TeamRole.MEMBER,
  ) {
    // 1. Check team existence and get members
    const team = await this.prisma.team.findUnique({
      where: { id: teamId },
      include: { members: true },
    });
    if (!team) throw new NotFoundException('Team not found');

    // 2. Check that inviter is OWNER of the team
    const inviterMember = team.members.find((m) => m.userId === inviterId);
    if (!inviterMember) {
      throw new ForbiddenException('You are not a member of this team');
    }
    if (inviterMember.role !== TeamRole.OWNER) {
      throw new ForbiddenException('Only team owners can send invitations');
    }

    const lowerEmail = targetEmail.toLowerCase();

    // 3. Check if user is already a member
    const existingMember = await this.prisma.teamMember.findFirst({
      where: { teamId, user: { email: lowerEmail } },
    });
    if (existingMember)
      throw new BadRequestException('User is already a member of this team');

    // 4. Check that user is not inviting themselves
    const inviterUser = await this.prisma.user.findUnique({
      where: { id: inviterId },
    });
    if (inviterUser?.email.toLowerCase() === lowerEmail) {
      throw new BadRequestException('You cannot invite yourself');
    }

    // 5. Generate JWT token for invitation
    const invitationToken = this.jwtService.sign(
      { teamId, email: lowerEmail, role, inviterId },
      { expiresIn: '7d' },
    );

    // 6. Save invitation to database
    const invitation = await this.prisma.invitation.create({
      data: {
        email: lowerEmail,
        token: invitationToken,
        teamId,
        inviterId,
        expiresAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000),
        status: InvitationStatus.PENDING,
      },
    });

    // 7. Send invitation email
    await this.mailService.sendInvitationEmail(
      lowerEmail,
      team.name,
      invitationToken,
    );

    return {
      message: 'Invitation sent successfully',
      invitationId: invitation.id,
    };
  }

  async acceptInvitation(token: string, userId: number) {
    try {
      // 1. Verify JWT token
      const payload = await this.jwtService.verifyAsync(token);
      const { teamId, email, role } = payload;

      // 2. Find invitation in database
      const invitation = await this.prisma.invitation.findUnique({
        where: { token },
      });

      if (
        !invitation ||
        invitation.status === InvitationStatus.ACCEPTED ||
        new Date() > invitation.expiresAt
      ) {
        throw new BadRequestException(
          'Invitation invalid, already accepted or expired',
        );
      }

      // 3. Get current user
      const user = await this.prisma.user.findUnique({ where: { id: userId } });
      if (!user) throw new NotFoundException('User not found');

      // 4. Verify email matches
      if (user.email.toLowerCase() !== email.toLowerCase()) {
        throw new ForbiddenException('Email mismatch for this invitation');
      }

      const userName = user.name ?? 'New Member';

      // 5. Atomic transaction
      await this.prisma.$transaction([
        this.prisma.teamMember.create({
          data: {
            userId,
            teamId,
            role: (role as TeamRole) || TeamRole.MEMBER,
          },
        }),
        this.prisma.invitation.update({
          where: { id: invitation.id },
          data: { status: InvitationStatus.ACCEPTED },
        }),
      ]);

      // 6. Notify via WebSockets
      this.notifications.notifyInvitationAccepted(teamId, userName);

      return { message: 'Joined the team successfully' };
    } catch (error: any) {
      if (error.name === 'JsonWebTokenError')
        throw new BadRequestException('Invalid invitation token');
      if (error.name === 'TokenExpiredError')
        throw new BadRequestException('Invitation token has expired');
      throw error;
    }
  }
}


================================================================================
File: bff-nestjs/src/modules/mail/interfaces/mail-provider.interface.ts
Size: 247 B
================================================================================

// src/modules/mail/interfaces/mail-provider.interface.ts
export interface IMailOptions {
  to: string;
  subject: string;
  template: string;
  context: any;
}

export interface IMailProvider {
  sendMail(options: IMailOptions): Promise<void>;
}


================================================================================
File: bff-nestjs/src/modules/mail/mail.module.ts
Size: 381 B
================================================================================

import { Module } from '@nestjs/common';
import { MailService } from './mail.service';
// import { MailProcessor } from './mail.processor'; // English: Commented to avoid Redis dependency

@Module({
  providers: [
    MailService,
    // MailProcessor // English: Commented to avoid "Worker requires a connection" error
  ],
  exports: [MailService],
})
export class MailModule {}


================================================================================
File: bff-nestjs/src/modules/mail/mail.processor.ts
Size: 916 B
================================================================================

import { Processor, WorkerHost } from '@nestjs/bullmq';
import { Job } from 'bullmq';
import { Logger } from '@nestjs/common';
// English: Corrected path. Since both files are in src/modules/mail/, use './'
import { MailService } from './mail.service';

@Processor('mail-queue')
export class MailProcessor extends WorkerHost {
  private readonly logger = new Logger(MailProcessor.name);

  constructor(private readonly mailService: MailService) {
    super();
  }

  async process(job: Job<any, any, string>): Promise<any> {
    this.logger.log(`Processing job ${job.id} of type ${job.name}...`);

    switch (job.name) {
      case 'send-invitation':
        const { email, token, teamName } = job.data;
        return await this.mailService.sendInvitationEmail(
          email,
          teamName,
          token,
        );

      default:
        this.logger.warn(`Unknown job name: ${job.name}`);
    }
  }
}


================================================================================
File: bff-nestjs/src/modules/mail/mail.service.spec.ts
Size: 745 B
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { MailService } from './mail.service';

describe('MailService', () => {
  let service: MailService;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [MailService],
    }).compile();

    service = module.get<MailService>(MailService);
  });

  it('should log and return true when sending invitation', async () => {
    const consoleSpy = jest.spyOn(console, 'log').mockImplementation();
    const result = await service.sendInvitationEmail(
      'test@test.com',
      'Team A',
      'token123',
    );

    expect(result).toBe(true);
    expect(consoleSpy).toHaveBeenCalled();
    consoleSpy.mockRestore();
  });
});


================================================================================
File: bff-nestjs/src/modules/mail/mail.service.ts
Size: 553 B
================================================================================

// En src/modules/mail/mail.service.ts
import { Injectable } from '@nestjs/common';

@Injectable()
export class MailService {
  // constructor(@InjectQueue('mail') private mailQueue: Queue) {} // English: Comment this out

  async sendInvitationEmail(email: string, teamName: string, token: string) {
    // English: Instead of adding to BullMQ queue, we just log it for now
    console.log(
      `[SIMULATED MAIL] Sending invitation to ${email} for team ${teamName}`,
    );
    console.log(`[SIMULATED MAIL] Token: ${token}`);
    return true;
  }
}


================================================================================
File: bff-nestjs/src/modules/mail/providers/nodemailer.provider.ts
Size: 2.07 kB
================================================================================

import { Injectable, Logger } from '@nestjs/common';
import * as nodemailer from 'nodemailer';
import { ConfigService } from '@nestjs/config';
import {
  IMailProvider,
  IMailOptions,
} from '../interfaces/mail-provider.interface';

@Injectable()
export class NodemailerProvider implements IMailProvider {
  private transporter: nodemailer.Transporter;
  private readonly logger = new Logger(NodemailerProvider.name);

  constructor(private config: ConfigService) {
    // English: Initialize the SMTP transporter using environment configuration
    this.transporter = nodemailer.createTransport({
      host: this.config.get<string>('MAIL_HOST'),
      port: this.config.get<number>('MAIL_PORT'),
      auth: {
        user: this.config.get<string>('MAIL_USER'),
        pass: this.config.get<string>('MAIL_PASS'),
      },
    });
  }

  /**
   * English: Sends an email using the configured SMTP transport.
   * Implementation includes strict error handling for production environments.
   */
  async sendMail(options: IMailOptions): Promise<void> {
    try {
      await this.transporter.sendMail({
        from: this.config.get<string>('MAIL_FROM'),
        to: options.to,
        subject: options.subject,
        // English: Basic HTML structure for the email.
        // In the future, this can be integrated with a template engine like EJS or Handlebars.
        html: `<h1>${options.subject}</h1><p>${options.context.message || ''}</p>`,
      });

      this.logger.log(`Email successfully sent to ${options.to}`);
    } catch (error: unknown) {
      // English: Type Guard to safely handle 'unknown' error type (TS18046)
      const errorMessage =
        error instanceof Error ? error.message : 'An unknown error occurred';
      const errorStack = error instanceof Error ? error.stack : undefined;

      this.logger.error(
        `Failed to send email to ${options.to}: ${errorMessage}`,
        errorStack,
      );

      // English: Rethrow the error after logging to allow the caller or BullMQ to handle retries
      throw error;
    }
  }
}


================================================================================
File: bff-nestjs/src/modules/notifications/notifications.gateway.spec.ts
Size: 2.39 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { NotificationsGateway } from './notifications.gateway';
import { JwtService } from '@nestjs/jwt';
import { Socket, Server } from 'socket.io';

describe('NotificationsGateway', () => {
  let gateway: NotificationsGateway;

  // English: Mocking the Socket.io Server and Socket
  const mockServer = {
    to: jest.fn().mockReturnThis(),
    emit: jest.fn(),
  };

  const mockSocket = {
    id: 'socket_123',
    join: jest.fn(),
  } as unknown as Socket;

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        NotificationsGateway,
        { provide: JwtService, useValue: {} }, // Mock simple para el Guard
      ],
    }).compile();

    gateway = module.get<NotificationsGateway>(NotificationsGateway);
    // English: Manually inject the mocked server into the gateway
    gateway.server = mockServer as unknown as Server;
  });

  it('should be defined', () => {
    expect(gateway).toBeDefined();
  });

  describe('handleJoinTeam', () => {
    it('should join the correct team room', () => {
      const teamId = 5;
      gateway.handleJoinTeam(teamId, mockSocket);

      expect(mockSocket.join).toHaveBeenCalledWith(`team_${teamId}`);
    });
  });

  describe('notifyInvitationAccepted', () => {
    it('should emit INVITATION_ACCEPTED to the specific team room', () => {
      const teamId = 10;
      const userName = 'Alice';

      gateway.notifyInvitationAccepted(teamId, userName);

      // English: Verify it targets the correct room
      expect(mockServer.to).toHaveBeenCalledWith(`team_${teamId}`);
      // English: Verify the payload structure
      expect(mockServer.emit).toHaveBeenCalledWith('notification', {
        type: 'INVITATION_ACCEPTED',
        message: `${userName} has joined the team!`,
      });
    });
  });

  describe('notifyTaskUpdate', () => {
    it('should emit TASK_UPDATE with the correct action', () => {
      const teamId = 1;
      const taskTitle = 'Fix Bug';
      const action = 'completed';

      gateway.notifyTaskUpdate(teamId, taskTitle, action);

      expect(mockServer.to).toHaveBeenCalledWith(`team_${teamId}`);
      expect(mockServer.emit).toHaveBeenCalledWith('notification', {
        type: 'TASK_UPDATE',
        message: `Task "${taskTitle}" was completed`,
      });
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/notifications/notifications.gateway.ts
Size: 1.28 kB
================================================================================

import {
  WebSocketGateway,
  WebSocketServer,
  SubscribeMessage,
  MessageBody,
  ConnectedSocket,
} from '@nestjs/websockets';
import { Server, Socket } from 'socket.io';
import { UseGuards, Logger } from '@nestjs/common';
import { WsJwtGuard } from '../../auth/guards/ws-jwt.guard';

@WebSocketGateway({
  cors: { origin: '*' },
  namespace: 'notifications',
})
export class NotificationsGateway {
  @WebSocketServer() server!: Server;
  private readonly logger = new Logger(NotificationsGateway.name);

  // English: Client joins a specific room for their team
  @SubscribeMessage('joinTeam')
  handleJoinTeam(
    @MessageBody('teamId') teamId: number,
    @ConnectedSocket() client: Socket,
  ) {
    const room = `team_${teamId}`;
    client.join(room);
    this.logger.log(`Client ${client.id} joined room: ${room}`);
  }

  notifyInvitationAccepted(teamId: number, userName: string) {
    this.server.to(`team_${teamId}`).emit('notification', {
      type: 'INVITATION_ACCEPTED',
      message: `${userName} has joined the team!`,
    });
  }

  notifyTaskUpdate(teamId: number, taskTitle: string, action: string) {
    this.server.to(`team_${teamId}`).emit('notification', {
      type: 'TASK_UPDATE',
      message: `Task "${taskTitle}" was ${action}`,
    });
  }
}


================================================================================
File: bff-nestjs/src/modules/notifications/notifications.module.ts
Size: 448 B
================================================================================

import { Module, Global } from '@nestjs/common';
import { JwtModule } from '@nestjs/jwt'; // Requerido para WsJwtGuard
import { NotificationsGateway } from './notifications.gateway';

@Global()
@Module({
  imports: [
    // English: We import JwtModule to allow JwtService to be injected into WsJwtGuard
    JwtModule.register({}),
  ],
  providers: [NotificationsGateway],
  exports: [NotificationsGateway],
})
export class NotificationsModule {}


================================================================================
File: bff-nestjs/src/modules/projects/dto/create-project.dto.ts
Size: 503 B
================================================================================

import {
  IsNotEmpty,
  IsString,
  MinLength,
  IsOptional,
  MaxLength,
} from 'class-validator';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';

export class CreateProjectDto {
  @ApiProperty({ example: 'Marketing Campaign', minLength: 3 })
  @IsString()
  @IsNotEmpty()
  @MinLength(3)
  @MaxLength(100)
  name!: string;

  @ApiPropertyOptional({ example: 'Project focused on Q1 social media growth' })
  @IsString()
  @IsOptional()
  @MaxLength(500)
  description?: string;
}


================================================================================
File: bff-nestjs/src/modules/projects/projects.controller.spec.ts
Size: 1.55 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ProjectsController } from './projects.controller';
import { ProjectsService } from './projects.service';
import { PrismaService } from '../../prisma/prisma.service';
import { Reflector } from '@nestjs/core';
import { Role } from '@prisma/client';

describe('ProjectsController', () => {
  let controller: ProjectsController;
  let service: ProjectsService;

  const mockProjectsService = {
    create: jest.fn(),
    findAllByTeam: jest.fn(),
    remove: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [ProjectsController],
      providers: [
        { provide: ProjectsService, useValue: mockProjectsService },
        { provide: PrismaService, useValue: {} }, // Mock vac√≠o para el guard
        Reflector,
      ],
    }).compile();

    controller = module.get<ProjectsController>(ProjectsController);
    service = module.get<ProjectsService>(ProjectsService);
  });

  it('should call create service', async () => {
    const dto = { name: 'Test Project' } as any;
    await controller.create(1, dto);
    expect(service.create).toHaveBeenCalledWith(1, dto);
  });

  it('should call findAll service', async () => {
    await controller.findAll(1);
    expect(service.findAllByTeam).toHaveBeenCalledWith(1);
  });

  it('should call remove service', async () => {
    await controller.remove(1, 100, 1, Role.USER);
    expect(service.remove).toHaveBeenCalledWith(1, 100, Role.USER);
  });
});


================================================================================
File: bff-nestjs/src/modules/projects/projects.controller.ts
Size: 1.56 kB
================================================================================

import {
  Controller,
  Post,
  Get,
  Delete,
  Body,
  Param,
  ParseIntPipe,
  UseGuards,
} from '@nestjs/common';
import { ProjectsService } from './projects.service';
import { CreateProjectDto } from './dto/create-project.dto';
import { RolesGuard } from '../../common/guards/roles.guard';
import { GetCurrentUserId, GetCurrentUserRole } from '../../common/decorators';
import { Role, TeamRole } from '@prisma/client';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiResponse,
} from '@nestjs/swagger';

@ApiTags('Projects')
@ApiBearerAuth('access-token')
@Controller('teams/:teamId/projects')
@UseGuards(RolesGuard)
export class ProjectsController {
  constructor(private projectsService: ProjectsService) {}

  @Post()
  @ApiOperation({ summary: 'Create a new project' })
  create(
    @Param('teamId', ParseIntPipe) teamId: number,
    @Body() dto: CreateProjectDto,
  ) {
    return this.projectsService.create(teamId, dto);
  }

  @Get()
  @ApiOperation({ summary: 'List team projects' })
  findAll(@Param('teamId', ParseIntPipe) teamId: number) {
    return this.projectsService.findAllByTeam(teamId);
  }

  @Delete(':projectId')
  @ApiOperation({ summary: 'Soft-delete a project' })
  remove(
    @Param('teamId', ParseIntPipe) teamId: number,
    @Param('projectId', ParseIntPipe) projectId: number,
    @GetCurrentUserId() userId: number,
    @GetCurrentUserRole() userRole: Role,
  ) {
    // Note: teamRole should be extracted from request.user if needed
    return this.projectsService.remove(teamId, projectId, userRole);
  }
}


================================================================================
File: bff-nestjs/src/modules/projects/projects.module.ts
Size: 403 B
================================================================================

import { Module } from '@nestjs/common';
import { ProjectsService } from './projects.service';
import { ProjectsController } from './projects.controller';
import { PrismaModule } from '../../prisma/prisma.module'; // Path corrected

@Module({
  imports: [PrismaModule],
  controllers: [ProjectsController],
  providers: [ProjectsService],
  exports: [ProjectsService],
})
export class ProjectsModule {}


================================================================================
File: bff-nestjs/src/modules/projects/projects.service.spec.ts
Size: 3.27 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { ProjectsService } from './projects.service';
import { PrismaService } from '../../prisma/prisma.service';
import { NotFoundException, ForbiddenException } from '@nestjs/common';
import { Role, TeamRole } from '@prisma/client';

describe('ProjectsService', () => {
  let service: ProjectsService;
  let prisma: PrismaService;

  const mockPrisma = {
    extended: {
      team: { findUnique: jest.fn() },
      project: {
        create: jest.fn(),
        findMany: jest.fn(),
        findFirst: jest.fn(),
        softDelete: jest.fn(),
      },
    },
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        ProjectsService,
        { provide: PrismaService, useValue: mockPrisma },
      ],
    }).compile();

    service = module.get<ProjectsService>(ProjectsService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  describe('create', () => {
    it('should throw NotFound if team does not exist', async () => {
      (mockPrisma.extended.team.findUnique as jest.Mock).mockResolvedValue(
        null,
      );
      await expect(service.create(1, { name: 'P1' } as any)).rejects.toThrow(
        NotFoundException,
      );
    });

    it('should create a project if team exists', async () => {
      (mockPrisma.extended.team.findUnique as jest.Mock).mockResolvedValue({
        id: 1,
      });
      (mockPrisma.extended.project.create as jest.Mock).mockResolvedValue({
        id: 101,
        name: 'P1',
      });
      const result = await service.create(1, { name: 'P1' } as any);
      expect(result.id).toBe(101);
    });
  });

  describe('findAllByTeam', () => {
    it('should return many projects', async () => {
      (mockPrisma.extended.project.findMany as jest.Mock).mockResolvedValue([
        { id: 1 },
      ]);
      const result = await service.findAllByTeam(1);
      expect(result).toHaveLength(1);
    });
  });

  describe('remove', () => {
    it('should throw NotFound if project not found', async () => {
      (mockPrisma.extended.project.findFirst as jest.Mock).mockResolvedValue(
        null,
      );
      await expect(service.remove(1, 99, Role.ADMIN)).rejects.toThrow(
        NotFoundException,
      );
    });

    it('should throw Forbidden if user is not Admin and not Owner', async () => {
      (mockPrisma.extended.project.findFirst as jest.Mock).mockResolvedValue({
        id: 99,
      });
      await expect(
        service.remove(1, 99, Role.USER, TeamRole.MEMBER),
      ).rejects.toThrow(ForbiddenException);
    });

    it('should allow deletion if user is ADMIN', async () => {
      (mockPrisma.extended.project.findFirst as jest.Mock).mockResolvedValue({
        id: 99,
      });
      await service.remove(1, 99, Role.ADMIN);
      expect(mockPrisma.extended.project.softDelete).toHaveBeenCalledWith(99);
    });

    it('should allow deletion if user is Team OWNER', async () => {
      (mockPrisma.extended.project.findFirst as jest.Mock).mockResolvedValue({
        id: 99,
      });
      await service.remove(1, 99, Role.USER, TeamRole.OWNER);
      expect(mockPrisma.extended.project.softDelete).toHaveBeenCalledWith(99);
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/projects/projects.service.ts
Size: 1.85 kB
================================================================================

import {
  Injectable,
  ForbiddenException,
  NotFoundException,
  Logger,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { CreateProjectDto } from './dto/create-project.dto';
import { Role, TeamRole } from '@prisma/client';

@Injectable()
export class ProjectsService {
  private readonly logger = new Logger(ProjectsService.name);

  constructor(private prisma: PrismaService) {}

  async create(teamId: number, dto: CreateProjectDto) {
    // English: The RolesGuard already verified membership.
    // We only check if the team exists to be safe.
    const team = await this.prisma.extended.team.findUnique({
      where: { id: teamId },
    });

    if (!team) throw new NotFoundException(`Team with ID ${teamId} not found`);

    return this.prisma.extended.project.create({
      data: {
        ...dto,
        teamId: teamId,
      },
    });
  }

  async findAllByTeam(teamId: number) {
    // English: Guard already checked access. Just return projects.
    return this.prisma.extended.project.findMany({
      where: { teamId },
      include: {
        _count: { select: { tasks: true } },
      },
    });
  }

  async remove(
    teamId: number,
    projectId: number,
    userRole: Role,
    teamRole?: TeamRole,
  ) {
    const project = await this.prisma.extended.project.findFirst({
      where: { id: projectId, teamId },
    });

    if (!project) throw new NotFoundException('Project not found in this team');

    // English: Hierarchy check: Only Global Admin or Team Owner can delete
    const canDelete = userRole === Role.ADMIN || teamRole === TeamRole.OWNER;

    if (!canDelete) {
      throw new ForbiddenException(
        'Only Team Owners or Admins can delete projects',
      );
    }

    return (this.prisma.extended.project as any).softDelete(projectId);
  }
}


================================================================================
File: bff-nestjs/src/modules/tasks/attachments.service.spec.ts
Size: 7.62 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { AttachmentsService } from './attachments.service';
import { PrismaService } from '../../prisma/prisma.service';
import { StorageService } from '../../storage/storage.service';
import {
  NotFoundException,
  InternalServerErrorException,
} from '@nestjs/common';

describe('AttachmentsService', () => {
  let service: AttachmentsService;
  let prisma: PrismaService;
  let storage: StorageService;

  const mockAttachment = {
    id: 1,
    filename: 'test.jpg',
    url: 'https://iaqnnevdkhpkpyrwecfh.storage.supabase.co/storage/v1/s3/attachments/task-attachments/1769252065725-test.jpg',
    taskId: 101,
    mimetype: 'image/jpeg',
    size: 1024,
    createdAt: new Date('2026-01-24T10:54:26.899Z'),
    updatedAt: new Date('2026-01-24T10:54:26.899Z'),
    deletedAt: null as Date | null,
  };

  const mockStorageService = {
    deleteFile: jest.fn().mockResolvedValue(undefined),
  };

  const mockPrismaService = {
    extended: {
      attachment: {
        create: jest.fn().mockResolvedValue(mockAttachment),
        findFirst: jest.fn(),
      },
    },
    // English: Use standard attachment for write operations (not extended)
    attachment: {
      update: jest.fn().mockResolvedValue({
        ...mockAttachment,
        deletedAt: new Date('2026-01-24T12:26:16.240Z'),
        updatedAt: new Date('2026-01-24T12:26:16.242Z'),
      }),
    },
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        AttachmentsService,
        { provide: StorageService, useValue: mockStorageService },
        { provide: PrismaService, useValue: mockPrismaService },
      ],
    }).compile();

    service = module.get<AttachmentsService>(AttachmentsService);
    prisma = module.get<PrismaService>(PrismaService);
    storage = module.get<StorageService>(StorageService);

    // English: Reset all mocks before each test
    jest.clearAllMocks();
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  describe('create', () => {
    it('should create an attachment successfully', async () => {
      const fileData = {
        filename: 'test.jpg',
        url: mockAttachment.url,
        mimetype: 'image/jpeg',
        size: 1024,
      };

      const result = await service.create(101, fileData);

      expect(mockPrismaService.extended.attachment.create).toHaveBeenCalledWith(
        {
          data: {
            ...fileData,
            taskId: 101,
          },
        },
      );
      expect(result).toEqual(mockAttachment);
    });
  });

  describe('findOne', () => {
    it('should return an attachment when found', async () => {
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(mockAttachment);

      const result = await service.findOne(1);

      expect(
        mockPrismaService.extended.attachment.findFirst,
      ).toHaveBeenCalledWith({
        where: {
          id: 1,
          deletedAt: null,
        },
      });
      expect(result).toEqual(mockAttachment);
    });

    it('should throw NotFoundException when attachment not found', async () => {
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(null);

      await expect(service.findOne(999)).rejects.toThrow(NotFoundException);
    });

    it('should throw NotFoundException when attachment is soft-deleted', async () => {
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(null);

      await expect(service.findOne(1)).rejects.toThrow(
        'Attachment with ID 1 not found',
      );
    });
  });

  describe('remove', () => {
    it('should perform soft delete in database regardless of storage errors', async () => {
      // English: Mock findOne to return the attachment
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(mockAttachment);

      // English: Mock storage error - should not prevent soft delete
      (mockStorageService.deleteFile as jest.Mock).mockRejectedValue(
        new Error('Storage service error'),
      );

      const result = await service.remove(1);

      // English: Verify soft delete was executed despite storage error
      expect(mockPrismaService.attachment.update).toHaveBeenCalledWith({
        where: { id: 1 },
        data: { deletedAt: expect.any(Date) },
      });

      // English: Verify deletion from storage was attempted
      expect(mockStorageService.deleteFile).toHaveBeenCalledWith(
        mockAttachment.url,
      );

      // English: Verify soft delete result is returned
      expect(result.deletedAt).toBeDefined();
      expect(result.deletedAt).not.toBeNull();
    });

    it('should successfully soft-delete and delete from storage', async () => {
      // English: Mock both operations succeeding
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(mockAttachment);

      const result = await service.remove(1);

      // English: Verify database update
      expect(mockPrismaService.attachment.update).toHaveBeenCalledWith({
        where: { id: 1 },
        data: { deletedAt: expect.any(Date) },
      });

      // English: Verify storage deletion was called
      expect(mockStorageService.deleteFile).toHaveBeenCalledWith(
        mockAttachment.url,
      );

      // English: Verify the result has deletedAt populated
      expect(result).toEqual(
        expect.objectContaining({
          id: 1,
          deletedAt: expect.any(Date),
        }),
      );
    });

    it('should throw InternalServerErrorException if database update fails', async () => {
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(mockAttachment);

      (mockPrismaService.attachment.update as jest.Mock).mockRejectedValue(
        new Error('Database error'),
      );

      await expect(service.remove(1)).rejects.toThrow(
        InternalServerErrorException,
      );
    });

    it('should throw NotFoundException if attachment does not exist', async () => {
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(null);

      await expect(service.remove(999)).rejects.toThrow(NotFoundException);
    });

    it('should log warning but not throw if storage deletion fails', async () => {
      const loggerSpy = jest.spyOn(service['logger'], 'warn');

      // English: Setup mocks
      (
        mockPrismaService.extended.attachment.findFirst as jest.Mock
      ).mockResolvedValue(mockAttachment);

      // English: Make storage deletion fail
      (mockStorageService.deleteFile as jest.Mock).mockRejectedValue(
        new Error('Storage connection timeout'),
      );

      // English: Make database update succeed
      const softDeletedAttachment = {
        ...mockAttachment,
        deletedAt: new Date('2026-01-24T12:26:16.240Z'),
        updatedAt: new Date('2026-01-24T12:26:16.242Z'),
      };
      (mockPrismaService.attachment.update as jest.Mock).mockResolvedValue(
        softDeletedAttachment,
      );

      const result = await service.remove(1);

      // English: Verify soft delete completed successfully
      expect(result.deletedAt).toBeDefined();
      expect(result.id).toBe(1);

      // English: Verify warning was logged for storage error
      expect(loggerSpy).toHaveBeenCalledWith(
        expect.stringContaining('Failed to delete attachment'),
      );
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/tasks/attachments.service.ts
Size: 2.74 kB
================================================================================

import {
  Injectable,
  Logger,
  NotFoundException,
  InternalServerErrorException,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { StorageService } from '../../storage/storage.service';

@Injectable()
export class AttachmentsService {
  private readonly logger = new Logger(AttachmentsService.name);

  constructor(
    private prisma: PrismaService,
    private storageService: StorageService,
  ) {}

  async create(
    taskId: number,
    fileData: { filename: string; url: string; mimetype: string; size: number },
  ) {
    this.logger.log(`Attaching file ${fileData.filename} to task ${taskId}`);
    return this.prisma.extended.attachment.create({
      data: {
        ...fileData,
        taskId,
      },
    });
  }

  async findOne(id: number) {
    // English: findFirst is required because findUnique doesn't support filtering by non-unique 'deletedAt'
    const attachment = await this.prisma.extended.attachment.findFirst({
      where: {
        id,
        deletedAt: null,
      },
    });

    if (!attachment) {
      throw new NotFoundException(`Attachment with ID ${id} not found`);
    }

    return attachment;
  }

  async remove(id: number) {
    const attachment = await this.findOne(id);

    // English: First, perform soft delete in database
    // This ensures data consistency even if storage deletion fails
    try {
      const deletedAttachment = await this.prisma.attachment.update({
        where: { id },
        data: { deletedAt: new Date() },
      });

      this.logger.log(`Soft deleted attachment ${id} from database`);

      // English: Then attempt to delete from cloud storage
      // If this fails, it's logged but doesn't affect the main operation
      try {
        await this.storageService.deleteFile(attachment.url);
        this.logger.log(
          `Successfully deleted attachment ${id} from cloud storage`,
        );
      } catch (storageError: unknown) {
        const errorMessage =
          storageError instanceof Error
            ? storageError.message
            : 'Unknown error';
        this.logger.warn(
          `Failed to delete attachment ${id} from storage (soft delete completed): ${errorMessage}`,
        );
        // English: Don't throw - soft delete in DB is the priority
        // Storage deletion can be retried manually if needed
      }

      return deletedAttachment;
    } catch (error: unknown) {
      const errorMessage =
        error instanceof Error ? error.message : 'Unknown error';
      this.logger.error(`Error deleting attachment ${id}: ${errorMessage}`);
      throw new InternalServerErrorException(
        'Failed to remove attachment from database',
      );
    }
  }
}


================================================================================
File: bff-nestjs/src/modules/tasks/dto/create-task.dto.ts
Size: 1.31 kB
================================================================================

import {
  IsNotEmpty,
  IsString,
  IsOptional,
  IsInt,
  IsDateString,
  IsEnum,
} from 'class-validator';
import { ApiProperty, ApiPropertyOptional } from '@nestjs/swagger';
import { TaskStatus } from '@prisma/client';

export class CreateTaskDto {
  @ApiProperty({
    example: 'Implement Login UI',
    description: 'The title of the task',
  })
  @IsString()
  @IsNotEmpty()
  title!: string;

  @ApiPropertyOptional({
    example: 'Create the frontend form for user authentication',
    description: 'Detailed description of the task',
  })
  @IsString()
  @IsOptional()
  description?: string;

  @ApiPropertyOptional({
    enum: TaskStatus,
    example: TaskStatus.TODO,
    description: 'The current status of the task',
  })
  @IsEnum(TaskStatus)
  @IsOptional()
  status?: TaskStatus = TaskStatus.TODO;

  @ApiProperty({
    example: 1,
    description: 'The ID of the project this task belongs to',
  })
  @IsInt()
  @IsNotEmpty()
  projectId!: number;

  @ApiPropertyOptional({
    example: 5,
    description: 'The ID of the user assigned to this task',
  })
  @IsInt()
  @IsOptional()
  assigneeId?: number;

  @ApiPropertyOptional({
    example: '2026-02-01T00:00:00.000Z',
    description: 'Due date for the task in ISO 8601 format',
  })
  @IsDateString()
  @IsOptional()
  dueDate?: string;
}


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.controller.spec.ts
Size: 3.67 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TasksController } from './tasks.controller';
import { TasksService } from './tasks.service';
import { StorageService } from '../../storage/storage.service';
import { CreateTaskDto } from './dto/create-task.dto';
import { TaskStatus } from '@prisma/client';

describe('TasksController', () => {
  let controller: TasksController;
  let tasksService: TasksService;
  let storageService: StorageService;

  const mockUserId = 1;

  // English: Comprehensive mocks for all services used in the controller
  const mockTasksService = {
    create: jest.fn(),
    findAllByProject: jest.fn(),
    addAttachment: jest.fn(),
    removeAttachment: jest.fn(),
  };

  const mockStorageService = {
    uploadFile: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [TasksController],
      providers: [
        { provide: TasksService, useValue: mockTasksService },
        { provide: StorageService, useValue: mockStorageService },
      ],
    }).compile();

    controller = module.get<TasksController>(TasksController);
    tasksService = module.get<TasksService>(TasksService);
    storageService = module.get<StorageService>(StorageService);
  });

  afterEach(() => {
    jest.clearAllMocks();
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });

  describe('create', () => {
    it('should call tasksService.create with userId and dto', async () => {
      const dto: CreateTaskDto = {
        title: 'New Task',
        projectId: 1,
        status: TaskStatus.TODO,
      };
      mockTasksService.create.mockResolvedValue({ id: 1, ...dto });

      const result = await controller.create(mockUserId, dto);

      expect(tasksService.create).toHaveBeenCalledWith(mockUserId, dto);
      expect(result).toHaveProperty('id');
    });
  });

  describe('findAll', () => {
    it('should call tasksService.findAllByProject with correct params', async () => {
      const projectId = 10;
      mockTasksService.findAllByProject.mockResolvedValue([]);

      await controller.findAll(projectId, mockUserId);

      expect(tasksService.findAllByProject).toHaveBeenCalledWith(
        mockUserId,
        projectId,
      );
    });
  });

  describe('uploadFile', () => {
    it('should upload to storage and then add attachment to DB', async () => {
      const taskId = 123;
      const mockFile = {
        originalname: 'test.png',
        mimetype: 'image/png',
        size: 5000,
        buffer: Buffer.from(''),
      } as Express.Multer.File;

      const mockUrl = 'http://cloud.storage/test.png';
      mockStorageService.uploadFile.mockResolvedValue(mockUrl);
      mockTasksService.addAttachment.mockResolvedValue({ id: 1, url: mockUrl });

      const result = await controller.uploadFile(taskId, mockFile);

      // English: Verify the sequential flow: Storage first, then DB
      expect(storageService.uploadFile).toHaveBeenCalledWith(mockFile);
      expect(tasksService.addAttachment).toHaveBeenCalledWith(taskId, {
        filename: mockFile.originalname,
        url: mockUrl,
        mimetype: mockFile.mimetype,
        size: mockFile.size,
      });
      expect(result.url).toBe(mockUrl);
    });
  });

  describe('removeAttachment', () => {
    it('should call tasksService.removeAttachment', async () => {
      const attachmentId = 99;
      mockTasksService.removeAttachment.mockResolvedValue({ success: true });

      await controller.removeAttachment(attachmentId);

      expect(tasksService.removeAttachment).toHaveBeenCalledWith(attachmentId);
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.controller.ts
Size: 2.75 kB
================================================================================

import {
  Controller,
  Post,
  Body,
  Get,
  Param,
  ParseIntPipe,
  Delete,
  UseInterceptors,
  UploadedFile,
  ParseFilePipe,
  MaxFileSizeValidator,
  FileTypeValidator,
  UseGuards,
} from '@nestjs/common';
import { FileInterceptor } from '@nestjs/platform-express';
import {
  ApiTags,
  ApiOperation,
  ApiBearerAuth,
  ApiConsumes,
  ApiBody,
} from '@nestjs/swagger';
import { TasksService } from './tasks.service';
import { CreateTaskDto } from './dto/create-task.dto';
import { StorageService } from '../../storage/storage.service';
import { AtGuard } from '../../auth/guards/at.guard';
import { GetCurrentUserId } from '../../common/decorators';

@ApiTags('Tasks')
@ApiBearerAuth('access-token')
@UseGuards(AtGuard)
@Controller('tasks')
export class TasksController {
  constructor(
    private readonly tasksService: TasksService,
    private readonly storageService: StorageService,
  ) {}

  @Post()
  @ApiOperation({ summary: 'Create a new task' })
  async create(@GetCurrentUserId() userId: number, @Body() dto: CreateTaskDto) {
    // English: The service validates if the userId has access to the project's team
    return this.tasksService.create(userId, dto);
  }

  @Get('project/:projectId')
  @ApiOperation({ summary: 'Get all tasks for a project' })
  async findAll(
    @Param('projectId', ParseIntPipe) projectId: number,
    @GetCurrentUserId() userId: number,
  ) {
    return this.tasksService.findAllByProject(userId, projectId);
  }

  @Post(':id/upload')
  @ApiOperation({ summary: 'Upload an attachment to a task' })
  @ApiConsumes('multipart/form-data')
  @ApiBody({
    schema: {
      type: 'object',
      properties: { file: { type: 'string', format: 'binary' } },
    },
  })
  @UseInterceptors(FileInterceptor('file'))
  async uploadFile(
    @Param('id', ParseIntPipe) taskId: number,
    @UploadedFile(
      new ParseFilePipe({
        validators: [
          new MaxFileSizeValidator({ maxSize: 1024 * 1024 * 5 }), // 5MB limit
          new FileTypeValidator({ fileType: /(jpg|jpeg|png|pdf|zip)$/ }),
        ],
      }),
    )
    file: Express.Multer.File,
  ) {
    // English: First upload to cloud storage, then save record in DB
    const fileUrl = await this.storageService.uploadFile(file);
    return this.tasksService.addAttachment(taskId, {
      filename: file.originalname,
      url: fileUrl,
      mimetype: file.mimetype,
      size: file.size,
    });
  }

  @Delete('attachments/:attachmentId')
  @ApiOperation({ summary: 'Remove an attachment from a task' })
  async removeAttachment(
    @Param('attachmentId', ParseIntPipe) attachmentId: number,
  ) {
    // English: Deletes from both storage provider and database
    return this.tasksService.removeAttachment(attachmentId);
  }
}


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.module.ts
Size: 650 B
================================================================================

// src/modules/tasks/tasks.module.ts
import { Module } from '@nestjs/common';
import { TasksService } from './tasks.service';
import { TasksController } from './tasks.controller';
import { StorageModule } from '../../storage/storage.module';
import { NotificationsModule } from '../notifications/notifications.module';
import { AttachmentsService } from './attachments.service'; // <--- Importaci√≥n a√±adida

@Module({
  imports: [StorageModule, NotificationsModule],
  controllers: [TasksController],
  providers: [
    TasksService,
    AttachmentsService, // <--- Proveedor a√±adido
  ],
  exports: [TasksService],
})
export class TasksModule {}


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.service.int-spec.ts
Size: 3.18 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TasksService } from './tasks.service';
import { PrismaService } from '../../prisma/prisma.service';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { StorageService } from '../../storage/storage.service';
import { ConfigModule } from '@nestjs/config';
import { TaskStatus } from '@prisma/client';

describe('TasksService (Integration)', () => {
  let service: TasksService;
  let prisma: PrismaService;

  // English: Mocks for external dependencies to focus on DB integration
  const mockNotifications = {
    notifyTaskUpdate: jest.fn(),
  };

  const mockStorage = {
    deleteFile: jest.fn().mockResolvedValue(true),
  };

  beforeAll(async () => {
    const module: TestingModule = await Test.createTestingModule({
      imports: [ConfigModule.forRoot({ isGlobal: true })],
      providers: [
        TasksService,
        PrismaService,
        { provide: NotificationsGateway, useValue: mockNotifications },
        { provide: StorageService, useValue: mockStorage },
      ],
    }).compile();

    service = module.get<TasksService>(TasksService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  afterEach(async () => {
    // English: Clean up database state after each test
    await prisma.task.deleteMany();
    await prisma.project.deleteMany();
    await prisma.teamMember.deleteMany();
    await prisma.team.deleteMany();
    await prisma.user.deleteMany();
  });

  it('should create a task only if user has permission (is team member)', async () => {
    // 1. Arrange
    const user = await prisma.user.create({
      data: { email: 'dev@test.com', password: 'hash', name: 'Developer' },
    });

    const team = await prisma.team.create({
      data: { name: 'Dev Team' },
    });

    // Link user to team
    await prisma.teamMember.create({
      data: { userId: user.id, teamId: team.id, role: 'MEMBER' },
    });

    const project = await prisma.project.create({
      data: { name: 'New Project', teamId: team.id },
    });

    const dto = {
      title: 'Integrated Task',
      description: 'Test description',
      status: TaskStatus.TODO,
      projectId: project.id,
      assigneeId: user.id,
    };

    // 2. Act
    const task = await service.create(user.id, dto);

    // 3. Assert
    expect(task).toBeDefined();
    expect(task.title).toBe(dto.title);
    expect(mockNotifications.notifyTaskUpdate).toHaveBeenCalled();
  });

  it('should throw ForbiddenException if user is NOT in the team', async () => {
    // 1. Arrange: Create user and project but don't link them
    const stranger = await prisma.user.create({
      data: { email: 'stranger@test.com', password: 'hash' },
    });

    const team = await prisma.team.create({ data: { name: 'Private Team' } });
    const project = await prisma.project.create({
      data: { name: 'Private Project', teamId: team.id },
    });

    const dto = { title: 'Illegal Task', projectId: project.id };

    // 2. Act & Assert
    await expect(service.create(stranger.id, dto as any)).rejects.toThrow(
      'No permission to add tasks to this project',
    );
  });
});


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.service.spec.ts
Size: 4.97 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TasksService } from './tasks.service';
import { PrismaService } from '../../prisma/prisma.service';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { StorageService } from '../../storage/storage.service';
import { AttachmentsService } from './attachments.service';
import {
  NotFoundException,
  ForbiddenException,
  InternalServerErrorException,
} from '@nestjs/common';

describe('TasksService', () => {
  let service: TasksService;
  let prisma: PrismaService;
  let storageService: StorageService;
  let notifications: NotificationsGateway;
  let attachmentsService: AttachmentsService;

  const mockPrisma = {
    extended: {
      project: { findUnique: jest.fn(), findFirst: jest.fn() },
      task: { create: jest.fn(), findUnique: jest.fn(), findMany: jest.fn() },
    },
  };

  const mockNotifications = { notifyTaskUpdate: jest.fn() };
  const mockStorageService = { deleteFile: jest.fn() };
  const mockAttachmentsService = {
    create: jest.fn(),
    findOne: jest.fn(),
    remove: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        TasksService,
        { provide: PrismaService, useValue: mockPrisma },
        { provide: NotificationsGateway, useValue: mockNotifications },
        { provide: StorageService, useValue: mockStorageService },
        { provide: AttachmentsService, useValue: mockAttachmentsService },
      ],
    }).compile();

    service = module.get<TasksService>(TasksService);
    prisma = module.get<PrismaService>(PrismaService);
    storageService = module.get<StorageService>(StorageService);
    notifications = module.get<NotificationsGateway>(NotificationsGateway);
    attachmentsService = module.get<AttachmentsService>(AttachmentsService);
    jest.clearAllMocks();
  });

  describe('create', () => {
    it('should throw ForbiddenException if user is not a member (Line 35)', async () => {
      mockPrisma.extended.project.findUnique.mockResolvedValue({
        team: { members: [] },
      });
      await expect(service.create(1, { projectId: 1 } as any)).rejects.toThrow(
        ForbiddenException,
      );
    });

    it('should handle notification failure (Line 47-51)', async () => {
      mockPrisma.extended.project.findUnique.mockResolvedValue({
        teamId: 1,
        team: { members: [{ userId: 1 }] },
      });
      mockPrisma.extended.task.create.mockResolvedValue({
        id: 1,
        title: 'Test',
      });
      mockNotifications.notifyTaskUpdate.mockImplementation(() => {
        throw new Error();
      });

      const result = await service.create(1, {
        projectId: 1,
        title: 'Test',
      } as any);
      expect(result).toBeDefined();
    });
  });

  describe('addAttachment', () => {
    it('should throw NotFoundException if task not found (Line 76)', async () => {
      mockPrisma.extended.task.findUnique.mockResolvedValue(null);
      await expect(service.addAttachment(999, {} as any)).rejects.toThrow(
        NotFoundException,
      );
    });

    it('should call attachmentsService.create if task exists', async () => {
      mockPrisma.extended.task.findUnique.mockResolvedValue({ id: 1 });
      await service.addAttachment(1, { url: 'test' } as any);
      expect(attachmentsService.create).toHaveBeenCalled();
    });
  });

  describe('removeAttachment', () => {
    it('should handle generic error in catch and log it (Line 89)', async () => {
      mockAttachmentsService.findOne.mockResolvedValue({
        id: 1,
        url: 'http://test.com/file.png',
      });
      // English: Using a real Error object to hit the 'error instanceof Error' branch on line 89
      mockStorageService.deleteFile.mockRejectedValue(new Error('S3 Fail'));

      await expect(service.removeAttachment(1)).rejects.toThrow(
        InternalServerErrorException,
      );
    });

    it('should handle non-Error objects in catch (Lines 90-93)', async () => {
      mockAttachmentsService.findOne.mockResolvedValue({ url: 'url' });
      mockStorageService.deleteFile.mockRejectedValue('Fatal String Error');
      await expect(service.removeAttachment(1)).rejects.toThrow(
        InternalServerErrorException,
      );
    });
  });

  describe('findAllByProject', () => {
    it('should throw ForbiddenException if project access denied', async () => {
      mockPrisma.extended.project.findFirst.mockResolvedValue(null);
      await expect(service.findAllByProject(1, 1)).rejects.toThrow(
        ForbiddenException,
      );
    });

    it('should return tasks with assignee and attachments', async () => {
      mockPrisma.extended.project.findFirst.mockResolvedValue({ id: 1 });
      mockPrisma.extended.task.findMany.mockResolvedValue([{ id: 1 }]);
      const res = await service.findAllByProject(1, 1);
      expect(res).toHaveLength(1);
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/tasks/tasks.service.ts
Size: 4.76 kB
================================================================================

import {
  Injectable,
  ForbiddenException,
  NotFoundException,
  InternalServerErrorException,
  Logger,
} from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { CreateTaskDto } from './dto/create-task.dto';
import { NotificationsGateway } from '../notifications/notifications.gateway';
import { StorageService } from '../../storage/storage.service';
import { AttachmentsService } from './attachments.service';

@Injectable()
export class TasksService {
  private readonly logger = new Logger(TasksService.name);

  constructor(
    private prisma: PrismaService,
    private notifications: NotificationsGateway,
    private storageService: StorageService,
    private attachmentsService: AttachmentsService,
  ) {}

  async create(userId: number, dto: CreateTaskDto) {
    // English: Check if project exists and user has access via membership
    const project = await this.prisma.extended.project.findFirst({
      where: {
        id: dto.projectId,
        team: {
          members: {
            some: { userId },
          },
        },
      },
      include: {
        team: true,
      },
    });

    if (!project) {
      throw new ForbiddenException(
        'Project not found or no permission to add tasks',
      );
    }

    const task = await this.prisma.extended.task.create({
      data: {
        title: dto.title,
        description: dto.description,
        status: dto.status,
        projectId: dto.projectId,
        assigneeId: dto.assigneeId,
        dueDate: dto.dueDate ? new Date(dto.dueDate) : null,
      },
    });

    // English: Notify via WebSocket. Wrap in try-catch to prevent main flow failure
    try {
      this.notifications.notifyTaskUpdate(
        project.team.id,
        task.title,
        'created',
      );
    } catch (error) {
      this.logger.warn(
        `Failed to send WebSocket notification for task ${task.id}`,
      );
    }

    return task;
  }

  async addAttachment(
    taskId: number,
    fileData: {
      filename: string;
      url: string;
      mimetype: string;
      size: number;
    },
  ) {
    // English: Ensure the task exists before calling attachment service
    const task = await this.prisma.extended.task.findUnique({
      where: { id: taskId },
    });

    if (!task) {
      throw new NotFoundException('Task not found');
    }

    return this.attachmentsService.create(taskId, fileData);
  }

  async removeAttachment(attachmentId: number) {
    // English: Use delegated service to handle attachment removal
    // This includes both storage deletion and database soft-delete
    return this.attachmentsService.remove(attachmentId);
  }

  async findAllByProject(userId: number, projectId: number) {
    // English: Ensure user is part of the team that owns the project
    const project = await this.prisma.extended.project.findFirst({
      where: {
        id: projectId,
        team: {
          members: {
            some: { userId },
          },
        },
      },
    });

    if (!project) {
      throw new ForbiddenException('Project access denied');
    }

    return this.prisma.extended.task.findMany({
      where: { projectId },
      include: {
        assignee: {
          select: {
            id: true,
            name: true,
            email: true,
          },
        },
        attachments: {
          select: {
            id: true,
            filename: true,
            url: true,
            mimetype: true,
            size: true,
            createdAt: true,
          },
        },
      },
      orderBy: { createdAt: 'desc' },
    });
  }

  /**
   * English: Recovery method for soft-deleted tasks.
   * This is useful for compliance and user-requested recovery.
   * Only accessible to admins or team owners.
   */
  async restoreTask(taskId: number) {
    return (this.prisma.extended.task as any).restore(taskId);
  }

  /**
   * English: Permanent deletion of a task.
   * This operation cannot be undone. Use with extreme caution.
   * Should only be called after user confirmation and audit logging.
   */
  async permanentlyDeleteTask(taskId: number) {
    // English: First, hard-delete all attachments
    const attachments = await this.prisma.attachment.findMany({
      where: { taskId },
    });

    // English: Delete attachments from storage
    for (const attachment of attachments) {
      try {
        await this.storageService.deleteFile(attachment.url);
      } catch (error) {
        this.logger.warn(
          `Failed to delete attachment file ${attachment.id} from storage`,
        );
      }
    }

    // English: Hard delete the task (bypasses soft-delete logic)
    return this.prisma.task.delete({
      where: { id: taskId },
    });
  }
}


================================================================================
File: bff-nestjs/src/modules/teams/dto/create-team.dto.ts
Size: 448 B
================================================================================

import { IsNotEmpty, IsString, MinLength, MaxLength } from 'class-validator';
import { ApiProperty } from '@nestjs/swagger';

export class CreateTeamDto {
  @ApiProperty({
    description: 'The name of the team',
    example: 'Engineering Team',
  })
  @IsString()
  @IsNotEmpty()
  @MinLength(3, { message: 'Team name must be at least 3 characters long' })
  @MaxLength(50, { message: 'Team name cannot exceed 50 characters' })
  name!: string;
}


================================================================================
File: bff-nestjs/src/modules/teams/dto/invite-member.dto.ts
Size: 403 B
================================================================================

import { IsEmail, IsNotEmpty } from 'class-validator';
import { Transform } from 'class-transformer';
import { ApiProperty } from '@nestjs/swagger';

export class InviteMemberDto {
  @ApiProperty({
    description: 'Email address of the user to invite',
    example: 'colleague@example.com',
  })
  @IsEmail()
  @IsNotEmpty()
  @Transform(({ value }) => value?.trim().toLowerCase())
  email!: string;
}


================================================================================
File: bff-nestjs/src/modules/teams/teams.controller.spec.ts
Size: 2.79 kB
================================================================================

// bff-nestjs/src/modules/teams/teams.controller.spec.ts
import { Test, TestingModule } from '@nestjs/testing';
import { TeamsController } from './teams.controller';
import { TeamsService } from './teams.service';
import { PrismaService } from '@/prisma/prisma.service'; // English: Fixed with Alias
import { Reflector } from '@nestjs/core';
import { AtGuard } from '@/auth/guards/at.guard'; // English: Fixed with Alias
import { RolesGuard } from '@/common/guards/roles.guard'; // English: Fixed with Alias
import { TeamOwnerGuard } from '@/common/guards/team-owner.guard'; // English: Fixed with Alias
import { CreateTeamDto } from './dto/create-team.dto';

describe('TeamsController', () => {
  let controller: TeamsController;
  let service: TeamsService;

  // English: Mocking the service methods used in the controller
  const mockTeamsService = {
    create: jest.fn(),
    findAll: jest.fn(),
    remove: jest.fn(),
  };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      controllers: [TeamsController],
      providers: [
        { provide: TeamsService, useValue: mockTeamsService },
        { provide: PrismaService, useValue: {} }, // English: Mocked Prisma dependency
        Reflector,
      ],
    })
      // English: Bypassing guards for unit testing the controller logic
      .overrideGuard(AtGuard)
      .useValue({ canActivate: () => true })
      .overrideGuard(RolesGuard)
      .useValue({ canActivate: () => true })
      .overrideGuard(TeamOwnerGuard)
      .useValue({ canActivate: () => true })
      .compile();

    controller = module.get<TeamsController>(TeamsController);
    service = module.get<TeamsService>(TeamsService);
  });

  it('should be defined', () => {
    expect(controller).toBeDefined();
  });

  describe('create', () => {
    it('should call create team service', async () => {
      const userId = 1;
      const dto: CreateTeamDto = { name: 'New Team' };
      mockTeamsService.create.mockResolvedValue({ id: 1, ...dto });

      await controller.create(userId, dto);
      expect(service.create).toHaveBeenCalledWith(userId, dto);
    });
  });

  describe('findAll', () => {
    it('should call findAll team service', async () => {
      const userId = 1;
      mockTeamsService.findAll.mockResolvedValue([]);

      await controller.findAll(userId);
      expect(service.findAll).toHaveBeenCalledWith(userId);
    });
  });

  describe('remove', () => {
    it('should call remove service with correct ID', async () => {
      const id = 10;
      mockTeamsService.remove.mockResolvedValue({ id, deletedAt: new Date() });

      const result = await controller.remove(id);

      expect(service.remove).toHaveBeenCalledWith(id);
      expect(result.id).toBe(id);
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/teams/teams.controller.ts
Size: 1.63 kB
================================================================================

// bff-nestjs/src/modules/teams/teams.controller.ts
import {
  Controller,
  Get,
  Post,
  Body,
  UseGuards,
  Delete,
  Param,
  ParseIntPipe,
} from '@nestjs/common';
import { ApiTags, ApiOperation, ApiBearerAuth } from '@nestjs/swagger';
import { TeamsService } from './teams.service';
import { CreateTeamDto } from './dto/create-team.dto';

// English: Using Path Aliases (@/) to fix TS2307 and ensure clean imports
import { GetCurrentUserId } from '@/common/decorators/get-current-user-id.decorator';
import { RolesGuard } from '@/common/guards/roles.guard';
import { TeamOwnerGuard } from '@/common/guards/team-owner.guard';
import { Roles } from '@/common/decorators/roles.decorator';
import { Role } from '@prisma/client';
import { AtGuard } from '@/auth/guards/at.guard';

@ApiTags('Teams')
@ApiBearerAuth('access-token')
@Controller('teams')
@UseGuards(AtGuard, RolesGuard)
export class TeamsController {
  constructor(private readonly teamsService: TeamsService) {}

  @Post()
  @Roles(Role.USER, Role.ADMIN)
  @ApiOperation({ summary: 'Create a new team' })
  create(@GetCurrentUserId() userId: number, @Body() dto: CreateTeamDto) {
    return this.teamsService.create(userId, dto);
  }

  @Get()
  @ApiOperation({ summary: 'List user teams' })
  findAll(@GetCurrentUserId() userId: number) {
    return this.teamsService.findAll(userId);
  }

  @Delete(':id')
  @UseGuards(TeamOwnerGuard) // English: Specific resource authorization for SaaS owners
  @ApiOperation({ summary: 'Soft-delete a team (Owner only)' })
  remove(@Param('id', ParseIntPipe) id: number) {
    return this.teamsService.remove(id);
  }
}


================================================================================
File: bff-nestjs/src/modules/teams/teams.module.ts
Size: 457 B
================================================================================

import { Module } from '@nestjs/common';
import { TeamsService } from './teams.service';
import { TeamsController } from './teams.controller';
import { AuthModule } from '../../auth/auth.module';
import { PrismaModule } from '../../prisma/prisma.module'; // English: Added PrismaModule

@Module({
  imports: [AuthModule, PrismaModule],
  controllers: [TeamsController],
  providers: [TeamsService],
  exports: [TeamsService],
})
export class TeamsModule {}


================================================================================
File: bff-nestjs/src/modules/teams/teams.service.spec.ts
Size: 2.29 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { TeamsService } from './teams.service';
import { PrismaService } from '../../prisma/prisma.service';
import { TeamRole } from '@prisma/client';

describe('TeamsService', () => {
  let service: TeamsService;
  let prisma: PrismaService;

  const mockUserId = 1;
  const mockTeamDto = { name: 'Engineering Team' };

  beforeEach(async () => {
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        TeamsService,
        {
          provide: PrismaService,
          useValue: {
            extended: {
              $transaction: jest.fn(),
              team: {
                findMany: jest.fn(),
              },
            },
          },
        },
      ],
    }).compile();

    service = module.get<TeamsService>(TeamsService);
    prisma = module.get<PrismaService>(PrismaService);
  });

  it('should be defined', () => {
    expect(service).toBeDefined();
  });

  describe('create', () => {
    it('should create a team and its owner within a transaction', async () => {
      const mockTeam = { id: 10, name: mockTeamDto.name };

      // English: Mocking the transaction flow
      (prisma.extended.$transaction as jest.Mock).mockImplementation(
        async (callback) => {
          const tx = {
            team: { create: jest.fn().mockResolvedValue(mockTeam) },
            teamMember: { create: jest.fn().mockResolvedValue({}) },
          };
          return callback(tx);
        },
      );

      const result = await service.create(mockUserId, mockTeamDto);

      expect(result).toEqual(mockTeam);
      expect(prisma.extended.$transaction).toHaveBeenCalled();
    });
  });

  describe('findAll', () => {
    it('should return teams where the user is a member', async () => {
      const mockTeams = [
        { id: 1, name: 'Team A' },
        { id: 2, name: 'Team B' },
      ];
      (prisma.extended.team.findMany as jest.Mock).mockResolvedValue(mockTeams);

      const result = await service.findAll(mockUserId);

      expect(result).toHaveLength(2);
      expect(prisma.extended.team.findMany).toHaveBeenCalledWith(
        expect.objectContaining({
          where: { members: { some: { userId: mockUserId } } },
        }),
      );
    });
  });
});


================================================================================
File: bff-nestjs/src/modules/teams/teams.service.ts
Size: 2.11 kB
================================================================================

// bff-nestjs/src/teams/teams.service.ts
import { Injectable, Logger, NotFoundException } from '@nestjs/common';
import { PrismaService } from '../../prisma/prisma.service';
import { CreateTeamDto } from './dto/create-team.dto';
import { TeamRole } from '@prisma/client';

@Injectable()
export class TeamsService {
  private readonly logger = new Logger(TeamsService.name);

  constructor(private prisma: PrismaService) {}

  async create(userId: number, dto: CreateTeamDto) {
    return this.prisma.extended.$transaction(async (tx) => {
      const team = await tx.team.create({
        data: { name: dto.name },
      });

      await tx.teamMember.create({
        data: {
          userId: userId,
          teamId: team.id,
          role: TeamRole.OWNER,
        },
      });

      this.logger.log(
        `Team created: ${team.name} (ID: ${team.id}) by User: ${userId}`,
      );
      return team;
    });
  }

  async findAll(userId: number) {
    return this.prisma.extended.team.findMany({
      where: {
        members: { some: { userId } },
      },
      include: {
        _count: { select: { members: true, projects: true } },
      },
    });
  }

  /**
   * Enterprise SaaS Logic: Soft delete team and all associated resources.
   * Only called after TeamOwnerGuard validation.
   */
  async remove(teamId: number) {
    return this.prisma.extended.$transaction(async (tx) => {
      const now = new Date();

      // 1. English: Cascade soft-delete for tasks
      await (tx as any).task.updateMany({
        where: { project: { teamId } },
        data: { deletedAt: now },
      });

      // 2. English: Cascade soft-delete for projects
      await (tx as any).project.updateMany({
        where: { teamId },
        data: { deletedAt: now },
      });

      // 3. English: Soft-delete the team
      const team = await (tx as any).team.update({
        where: { id: teamId },
        data: { deletedAt: now },
      });

      this.logger.warn(
        `SaaS Tenant Deactivated: Team ${teamId} and cascading resources marked as deleted.`,
      );
      return team;
    });
  }
}


================================================================================
File: bff-nestjs/src/prisma/prisma.module.ts
Size: 210 B
================================================================================

import { Global, Module } from '@nestjs/common';
import { PrismaService } from './prisma.service';

@Global()
@Module({
  providers: [PrismaService],
  exports: [PrismaService],
})
export class PrismaModule {}


================================================================================
File: bff-nestjs/src/prisma/prisma.service.ts
Size: 3.9 kB
================================================================================

import {
  Injectable,
  OnModuleInit,
  OnModuleDestroy,
  Logger,
} from '@nestjs/common';
// English: Import both PrismaClient and the Prisma namespace for extensions
import { PrismaClient, Prisma } from '@prisma/client';

@Injectable()
export class PrismaService
  extends PrismaClient
  implements OnModuleInit, OnModuleDestroy
{
  private readonly logger = new Logger(PrismaService.name);

  /**
   * Enterprise Standard: Prisma Client Extension for Soft Delete.
   * This logic ensures that deleted records are hidden by default and
   * provides a professional way to handle data.
   *
   * The extension uses query middleware to automatically filter deleted records
   * in read operations, and model extensions to provide utility methods.
   */
  readonly extended = this.$extends({
    query: {
      $allModels: {
        async findMany({ args, query }) {
          // English: Automatic filter for soft-deleted records
          // If where clause doesn't exist, create it
          args.where = {
            ...(args.where || {}),
            deletedAt: null,
          };
          return query(args);
        },

        async findFirst({ args, query }) {
          // English: Same soft-delete filter as findMany
          args.where = {
            ...(args.where || {}),
            deletedAt: null,
          };
          return query(args);
        },

        async findUnique({ args, query }) {
          // English: Redirect findUnique to findFirst to support deletedAt filter.
          // This ensures that even unique lookups respect the soft-delete policy.
          args.where = {
            ...(args.where || {}),
            deletedAt: null,
          };
          // Cast to any because Prisma's type system doesn't fully support this pattern
          return (query as any)(args);
        },

        async count({ args, query }) {
          // English: Include soft-delete filter in count queries
          args.where = {
            ...(args.where || {}),
            deletedAt: null,
          };
          return query(args);
        },
      },
    },

    model: {
      $allModels: {
        /**
         * Custom method for soft deletion.
         * Usage: await this.prisma.extended.task.softDelete(id)
         * This is a convenience method that performs a soft delete operation.
         */
        async softDelete<T, A>(this: T, id: number) {
          const context = Prisma.getExtensionContext(this);
          return (context as any).update({
            where: { id },
            data: { deletedAt: new Date() },
          });
        },

        /**
         * Custom method for restoring soft-deleted records.
         * Usage: await this.prisma.extended.task.restore(id)
         * This is useful for recovery scenarios in enterprise applications.
         */
        async restore<T, A>(this: T, id: number) {
          const context = Prisma.getExtensionContext(this);
          return (context as any).update({
            where: { id },
            data: { deletedAt: null },
          });
        },

        /**
         * Custom method to count only deleted records.
         * Usage: await this.prisma.extended.task.countDeleted()
         * Useful for audit and compliance reporting.
         */
        async countDeleted<T, A>(this: T) {
          const context = Prisma.getExtensionContext(this);
          return (context as any).count({
            where: { deletedAt: { not: null } },
          });
        },
      },
    },
  });

  async onModuleInit() {
    try {
      await this.$connect();
      this.logger.log('Database connection established successfully');
    } catch (error) {
      this.logger.error('Database connection failed', error);
      // English: Critical failure, stop the process if DB is unreachable
      process.exit(1);
    }
  }

  async onModuleDestroy() {
    await this.$disconnect();
  }
}


================================================================================
File: bff-nestjs/src/prisma/prisma.types.ts
Size: 2.47 kB
================================================================================

/**
 * Prisma Type Utilities and Configurations
 * English: This file provides type-safe utilities for working with Prisma extensions
 * and soft-delete operations in a production SaaS environment.
 */

import { Prisma } from '@prisma/client';

/**
 * Represents models that support soft delete functionality.
 * Update this union type when adding deletedAt field to new models.
 */
export type SoftDeleteModel =
  | 'user'
  | 'team'
  | 'project'
  | 'task'
  | 'attachment';

/**
 * Type for Prisma where clauses that include soft-delete filtering.
 * This ensures type safety when building where clauses manually.
 */
export interface SoftDeleteWhereInput {
  deletedAt?: {
    equals?: null;
    not?: null;
    isSet?: boolean;
  };
}

/**
 * Options for soft-delete operations.
 * Useful for controlling behavior in different contexts.
 */
export interface SoftDeleteOptions {
  /**
   * If true, permanently deletes the record instead of soft-deleting.
   * Use with caution in production!
   */
  hardDelete?: boolean;

  /**
   * If true, includes soft-deleted records in the response.
   * Useful for admin/audit operations.
   */
  includeSoftDeleted?: boolean;
}

/**
 * English: Helper function to build a where clause that excludes soft-deleted records.
 * Usage: const activeUsers = await prisma.user.findMany({
 *   where: withoutDeleted({ role: 'ADMIN' })
 * })
 */
export function withoutDeleted<T extends Record<string, any>>(
  where?: T,
): T & { deletedAt: null } {
  return {
    ...(where || {}),
    deletedAt: null,
  } as T & { deletedAt: null };
}

/**
 * English: Helper function to build a where clause that includes only soft-deleted records.
 * Useful for recovery and audit operations.
 * Usage: const deletedTasks = await prisma.task.findMany({
 *   where: onlyDeleted({ projectId: 1 })
 * })
 */
export function onlyDeleted<T extends Record<string, any>>(
  where?: T,
): T & { deletedAt: { not: null } } {
  return {
    ...(where || {}),
    deletedAt: { not: null },
  } as T & { deletedAt: { not: null } };
}

/**
 * English: Type-safe wrapper for update operations with soft-delete support.
 * This prevents accidental direct updates to the deletedAt field.
 */
export function softDeleteData(data: any, options?: SoftDeleteOptions): any {
  // English: Prevent accidental overwrites of deletedAt in normal operations
  if (!options?.hardDelete && data.deletedAt !== undefined) {
    delete data.deletedAt;
  }
  return data;
}


================================================================================
File: bff-nestjs/src/storage/storage.module.ts
Size: 364 B
================================================================================

// src/storage/storage.module.ts
import { Module } from '@nestjs/common';
import { ConfigModule } from '@nestjs/config';
import { StorageService } from './storage.service';

@Module({
  imports: [ConfigModule],
  providers: [StorageService],
  exports: [StorageService], // English: Exporting to make it available in other modules
})
export class StorageModule {}


================================================================================
File: bff-nestjs/src/storage/storage.service.spec.ts
Size: 2.72 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { StorageService } from './storage.service';
import { ConfigService } from '@nestjs/config';
import { S3Client } from '@aws-sdk/client-s3';

// Mock AWS SDK
jest.mock('@aws-sdk/client-s3', () => {
  return {
    S3Client: jest.fn().mockImplementation(() => ({
      send: jest.fn().mockResolvedValue({}),
    })),
    PutObjectCommand: jest.fn(),
    DeleteObjectCommand: jest.fn(),
  };
});

describe('StorageService', () => {
  let service: StorageService;
  let config: ConfigService;
  let s3ClientInstance: any;

  const mockConfig = {
    get: jest.fn((key: string) => {
      const configMap = {
        STORAGE_REGION: 'us-east-1',
        STORAGE_ENDPOINT: 'http://localhost:9000',
        STORAGE_ACCESS_KEY: 'key',
        STORAGE_SECRET_KEY: 'secret',
        STORAGE_BUCKET: 'my-bucket',
      };
      return configMap[key];
    }),
  };

  beforeEach(async () => {
    jest.clearAllMocks();
    const module: TestingModule = await Test.createTestingModule({
      providers: [
        StorageService,
        { provide: ConfigService, useValue: mockConfig },
      ],
    }).compile();

    service = module.get<StorageService>(StorageService);
    config = module.get<ConfigService>(ConfigService);

    // Retrieve the mocked instance created during service instantiation
    s3ClientInstance = (S3Client as jest.Mock).mock.results[0].value;
  });

  it('should upload a file and return the URL', async () => {
    const mockFile = {
      originalname: 'test.png',
      buffer: Buffer.from('test'),
      mimetype: 'image/png',
    } as any;

    const url = await service.uploadFile(mockFile);

    expect(url).toContain('http://localhost:9000/my-bucket/task-attachments/');
    expect(url).toContain('test.png');
  });

  it('should delete a file successfully', async () => {
    const fileUrl =
      'http://localhost:9000/my-bucket/task-attachments/123-test.png';
    await expect(service.deleteFile(fileUrl)).resolves.not.toThrow();
  });

  it('should throw error if bucket marker is not found in URL', async () => {
    const invalidUrl = 'http://localhost:9000/wrong-marker/file.png';
    await expect(service.deleteFile(invalidUrl)).rejects.toThrow(
      'Bucket marker /my-bucket/ not found in URL',
    );
  });

  it('should log and rethrow error if S3 delete fails', async () => {
    // Force the send method to reject for this specific test
    jest
      .spyOn(s3ClientInstance, 'send')
      .mockRejectedValueOnce(new Error('S3 Failure'));

    const fileUrl =
      'http://localhost:9000/my-bucket/task-attachments/123-test.png';

    await expect(service.deleteFile(fileUrl)).rejects.toThrow('S3 Failure');
  });
});


================================================================================
File: bff-nestjs/src/storage/storage.service.ts
Size: 2.78 kB
================================================================================

import { Injectable, Logger } from '@nestjs/common';
import {
  S3Client,
  PutObjectCommand,
  DeleteObjectCommand,
} from '@aws-sdk/client-s3';
import { ConfigService } from '@nestjs/config';

@Injectable()
export class StorageService {
  private s3Client: S3Client;
  private readonly logger = new Logger(StorageService.name);

  constructor(private config: ConfigService) {
    // Initialize S3 Client with credentials from environment
    this.s3Client = new S3Client({
      region: this.config.get<string>('STORAGE_REGION')!,
      endpoint: this.config.get<string>('STORAGE_ENDPOINT')!,
      credentials: {
        accessKeyId: this.config.get<string>('STORAGE_ACCESS_KEY')!,
        secretAccessKey: this.config.get<string>('STORAGE_SECRET_KEY')!,
      },
      forcePathStyle: true,
    });
  }

  async uploadFile(file: Express.Multer.File): Promise<string> {
    const bucket = this.config.get<string>('STORAGE_BUCKET')!;
    const fileKey = `task-attachments/${Date.now()}-${file.originalname}`;

    const command = new PutObjectCommand({
      Bucket: bucket,
      Key: fileKey,
      Body: file.buffer,
      ContentType: file.mimetype,
    });

    await this.s3Client.send(command);

    const endpoint = this.config.get<string>('STORAGE_ENDPOINT')!;
    return `${endpoint}/${bucket}/${fileKey}`;
  }

  /**
   * Deletes a file from Cloud Storage bucket with key extraction
   * English: Extracts the file key from the full URL and deletes it from S3
   * Works with Supabase S3 endpoint format
   */
  async deleteFile(fileUrl: string): Promise<void> {
    const bucket = this.config.get<string>('STORAGE_BUCKET')!;

    try {
      // English: Extract the file key from the URL
      // URL format: https://iaqnnevdkhpkpyrwecfh.storage.supabase.co/storage/v1/s3/{bucket}/task-attachments/...
      // We need to extract: task-attachments/FILENAME

      const bucketMarker = `/${bucket}/`;
      const markerIndex = fileUrl.indexOf(bucketMarker);

      if (markerIndex === -1) {
        throw new Error(
          `Bucket marker "${bucketMarker}" not found in URL: ${fileUrl}`,
        );
      }

      // English: Extract everything after the bucket name (the file key)
      const fileKey = fileUrl.substring(markerIndex + bucketMarker.length);

      this.logger.log(`Attempting to delete cloud file with key: ${fileKey}`);

      const command = new DeleteObjectCommand({
        Bucket: bucket,
        Key: fileKey,
      });

      await this.s3Client.send(command);

      this.logger.log(`Successfully deleted file: ${fileKey}`);
    } catch (error: unknown) {
      const errorMessage =
        error instanceof Error ? error.message : 'Unknown error';
      this.logger.error(`Cloud Delete Error: ${errorMessage}`);
      throw error;
    }
  }
}


================================================================================
File: bff-nestjs/test/auth.e2e-spec.ts
Size: 2.97 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import cookieParser from 'cookie-parser';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('AuthController (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;

  const testUser = {
    email: `e2e-auth-${Date.now()}@productivity.com`,
    password: 'password123',
    name: 'Nikolas Tesla',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();

    app.useGlobalPipes(
      new ValidationPipe({
        whitelist: true,
        transform: true,
        forbidNonWhitelisted: true,
      }),
    );
    app.use(cookieParser());

    await app.init();
    prisma = app.get<PrismaService>(PrismaService);
  });

  afterAll(async () => {
    await prisma.user.deleteMany({
      where: { email: testUser.email },
    });
    await prisma.$disconnect();
    await app.close();
  });

  describe('Authentication Flow', () => {
    it('/auth/signup (POST) - Success with RegisterDto', async () => {
      const response = await request(app.getHttpServer())
        .post('/auth/signup')
        .send({
          email: testUser.email,
          password: testUser.password,
          name: testUser.name,
        })
        .expect(201);

      expect(response.body).toHaveProperty('access_token');

      // English: Safe way to check cookies without TS errors
      const cookies = response.get('Set-Cookie');
      expect(cookies).toBeDefined();
      if (cookies) {
        expect(cookies[0]).toContain('refresh_token');
      }
    });

    it('/auth/signin (POST) - Success with LoginDto', async () => {
      const response = await request(app.getHttpServer())
        .post('/auth/signin')
        .send({
          email: testUser.email,
          password: testUser.password,
        })
        .expect(200);

      expect(response.body).toHaveProperty('access_token');
      expect(response.get('Set-Cookie')).toBeDefined();
    });

    it('/auth/logout (POST) - Success', async () => {
      const loginRes = await request(app.getHttpServer())
        .post('/auth/signin')
        .send({
          email: testUser.email,
          password: testUser.password,
        });

      const at = loginRes.body.access_token;

      return request(app.getHttpServer())
        .post('/auth/logout')
        .set('Authorization', `Bearer ${at}`)
        .expect(200);
    });

    it('/auth/signup (POST) - Should fail if name is missing', async () => {
      return request(app.getHttpServer())
        .post('/auth/signup')
        .send({
          email: 'noname@test.com',
          password: 'password123',
        })
        .expect(400);
    });
  });
});


================================================================================
File: bff-nestjs/test/invitations.e2e-spec.ts
Size: 3.63 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Invitations (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let ownerToken: string;
  let guestToken: string;
  let teamId: number;
  let invitationToken: string;

  const ownerUser = {
    email: 'owner@test.com',
    password: 'password123',
    name: 'Owner',
  };

  const guestUser = {
    email: 'guest@test.com',
    password: 'password123',
    name: 'Guest',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    await app.init();

    prisma = app.get<PrismaService>(PrismaService);

    // 1. Create Owner and Team
    await request(app.getHttpServer()).post('/auth/signup').send(ownerUser);

    const loginOwner = await request(app.getHttpServer())
      .post('/auth/signin')
      .send(ownerUser);

    ownerToken = loginOwner.body.access_token;

    const teamRes = await request(app.getHttpServer())
      .post('/teams')
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ name: 'E2E Team' });

    teamId = teamRes.body.id;

    // Verify owner was created with OWNER role
    const ownerMember = await prisma.teamMember.findFirst({
      where: {
        teamId,
        user: { email: ownerUser.email },
      },
    });
    console.log('Owner member after team creation:', ownerMember);

    // 2. Create Guest User
    await request(app.getHttpServer()).post('/auth/signup').send(guestUser);

    const loginGuest = await request(app.getHttpServer())
      .post('/auth/signin')
      .send(guestUser);

    guestToken = loginGuest.body.access_token;
  });

  afterAll(async () => {
    await prisma.user.deleteMany({
      where: { email: { in: [ownerUser.email, guestUser.email] } },
    });
    await prisma.team.deleteMany({ where: { name: 'E2E Team' } });
    await prisma.$disconnect();
    await app.close();
  });

  it('POST /invitations/team/:id/send - Should send invitation', async () => {
    const res = await request(app.getHttpServer())
      .post(`/invitations/team/${teamId}/send`)
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ email: guestUser.email, role: 'MEMBER' })
      .expect(201);

    expect(res.body.message).toBeDefined();
    expect(res.body.invitationId).toBeDefined();

    const inv = await prisma.invitation.findFirst({
      where: { email: guestUser.email },
    });

    invitationToken = inv!.token;
  });

  it('POST /invitations/accept - Should fail if email mismatch', async () => {
    // Attempting to accept guest's invitation with owner's account
    await request(app.getHttpServer())
      .post('/invitations/accept')
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ token: invitationToken })
      .expect(403);
  });

  it('POST /invitations/accept - Should join team successfully', async () => {
    await request(app.getHttpServer())
      .post('/invitations/accept')
      .set('Authorization', `Bearer ${guestToken}`)
      .send({ token: invitationToken })
      .expect(201);

    // Verify membership
    const member = await prisma.teamMember.findFirst({
      where: {
        teamId,
        user: { email: guestUser.email },
      },
    });

    expect(member).toBeDefined();
  });
});


================================================================================
File: bff-nestjs/test/jest-e2e.json
Size: 183 B
================================================================================

{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}


================================================================================
File: bff-nestjs/test/tasks.e2e-spec.ts
Size: 3.77 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import cookieParser from 'cookie-parser';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Tasks (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let accessToken: string;
  let userId: number;
  let projectId: number;

  const testUser = {
    email: `tasks-e2e-${Date.now()}@test.com`,
    password: 'password123',
    name: 'Task Tester',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(
      new ValidationPipe({ whitelist: true, transform: true }),
    );
    app.use(cookieParser());
    await app.init();
    prisma = app.get<PrismaService>(PrismaService);

    // --- SETUP: Create User, Team and Project ---
    // 1. Signup & Signin
    await request(app.getHttpServer()).post('/auth/signup').send(testUser);
    const loginRes = await request(app.getHttpServer())
      .post('/auth/signin')
      .send({
        email: testUser.email,
        password: testUser.password,
      });
    accessToken = loginRes.body.access_token;

    const user = await prisma.user.findUnique({
      where: { email: testUser.email },
    });
    userId = user!.id;

    // 2. Create Team
    const team = await prisma.team.create({
      data: {
        name: 'E2E Team',
        members: { create: { userId, role: 'OWNER' } },
      },
    });

    // 3. Create Project
    const project = await prisma.project.create({
      data: {
        name: 'E2E Project',
        teamId: team.id,
      },
    });
    projectId = project.id;
  });

  afterAll(async () => {
    // English: Cleanup database
    await prisma.user.deleteMany({ where: { email: testUser.email } });
    await prisma.team.deleteMany({ where: { name: 'E2E Team' } });
    await prisma.$disconnect();
    await app.close();
  });

  describe('/tasks', () => {
    it('POST /tasks - Should create a task', async () => {
      const createTaskDto = {
        title: 'Finish E2E Tests',
        description: 'Testing the task creation flow',
        projectId: projectId,
        status: 'TODO',
      };

      const response = await request(app.getHttpServer())
        .post('/tasks')
        .set('Authorization', `Bearer ${accessToken}`)
        .send(createTaskDto)
        .expect(201);

      expect(response.body).toHaveProperty('id');
      expect(response.body.title).toBe(createTaskDto.title);
    });

    it('GET /tasks/project/:id - Should return tasks for the project', async () => {
      const response = await request(app.getHttpServer())
        .get(`/tasks/project/${projectId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
    });

    it('POST /tasks - Should fail if user is not in the team', async () => {
      // English: Create a project in a team where the user is NOT a member
      const otherTeam = await prisma.team.create({
        data: { name: 'Other Team' },
      });
      const otherProject = await prisma.project.create({
        data: { name: 'Unauthorized Project', teamId: otherTeam.id },
      });

      return request(app.getHttpServer())
        .post('/tasks')
        .set('Authorization', `Bearer ${accessToken}`)
        .send({
          title: 'Hacker Task',
          projectId: otherProject.id,
        })
        .expect(403); // English: Forbidden
    });
  });
});


================================================================================
File: bff-nestjs/test/teams.e2e-spec.ts
Size: 2.48 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Teams (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let accessToken: string;
  let userId: number;

  const testUser = {
    email: `team-e2e-${Date.now()}@test.com`,
    password: 'password123',
    name: 'Team Manager',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    await app.init();
    prisma = app.get<PrismaService>(PrismaService);

    // Setup: User & Auth
    await request(app.getHttpServer()).post('/auth/signup').send(testUser);
    const loginRes = await request(app.getHttpServer())
      .post('/auth/signin')
      .send({
        email: testUser.email,
        password: testUser.password,
      });
    accessToken = loginRes.body.access_token;

    const user = await prisma.user.findUnique({
      where: { email: testUser.email },
    });
    userId = user!.id;
  });

  afterAll(async () => {
    await prisma.user.deleteMany({ where: { email: testUser.email } });
    await prisma.$disconnect();
    await app.close();
  });

  describe('/teams', () => {
    it('POST /teams - Should create a team and assign user as OWNER', async () => {
      const response = await request(app.getHttpServer())
        .post('/teams')
        .set('Authorization', `Bearer ${accessToken}`)
        .send({ name: 'Alpha Team' })
        .expect(201);

      expect(response.body.name).toBe('Alpha Team');

      // English: Verify in DB that the membership was created correctly
      const membership = await prisma.teamMember.findFirst({
        where: { teamId: response.body.id, userId: userId },
      });
      expect(membership?.role).toBe('OWNER');
    });

    it('GET /teams - Should list user teams', async () => {
      const response = await request(app.getHttpServer())
        .get('/teams')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.some((t: any) => t.name === 'Alpha Team')).toBe(
        true,
      );
    });
  });
});


================================================================================
File: bff-nestjs/tsconfig.build.json
Size: 97 B
================================================================================

{
  "extends": "./tsconfig.json",
  "exclude": ["node_modules", "test", "dist", "**/*spec.ts"]
}


================================================================================
File: bff-nestjs/tsconfig.json
Size: 528 B
================================================================================

{
  "compilerOptions": {
    "module": "CommonJS",
    "declaration": true,
    "removeComments": true,
    "emitDecoratorMetadata": true,
    "experimentalDecorators": true,
    "allowSyntheticDefaultImports": true,
    "target": "ES2022",
    "sourceMap": true,
    "outDir": "./dist",
    "baseUrl": "./",
    "incremental": true,
    "skipLibCheck": true,
    "strict": true,
    "noImplicitAny": false,
    "esModuleInterop": true,
    "types": ["node", "jest", "multer"],
    "paths": {
      "@/*": ["src/*"]
    }
  }
}


================================================================================
File: docker-compose.yml
Size: 943 B
================================================================================

version: '3.8'

services:
  tpp-db:
    image: postgres:15-alpine
    container_name: tpp-db
    restart: always
    environment:
      # English: Matches your DATABASE_URL in .env
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: productivity_db
    ports:
      - '5432:5432'
    networks:
      - tpp-network
    volumes:
      - tpp-db-data:/var/lib/postgresql/data

  tpp-redis:
    image: redis:7-alpine
    container_name: tpp-redis
    restart: always
    ports:
      - '6379:6379'
    healthcheck:
      test: ['CMD', 'redis-cli', 'ping']
      interval: 5s
      timeout: 3s
      retries: 5
    networks:
      - tpp-network

  tpp-maildev:
    image: maildev/maildev
    container_name: tpp-maildev
    restart: always
    ports:
      - '1080:1080' # Web UI
      - '1025:1025' # SMTP Server
    networks:
      - tpp-network

networks:
  tpp-network:
    driver: bridge

volumes:
  tpp-db-data:


================================================================================
File: eslint.config.mjs
Size: 899 B
================================================================================

// @ts-check
import eslint from '@eslint/js';
import eslintPluginPrettierRecommended from 'eslint-plugin-prettier/recommended';
import globals from 'globals';
import tseslint from 'typescript-eslint';

export default tseslint.config(
  {
    ignores: ['eslint.config.mjs'],
  },
  eslint.configs.recommended,
  ...tseslint.configs.recommendedTypeChecked,
  eslintPluginPrettierRecommended,
  {
    languageOptions: {
      globals: {
        ...globals.node,
        ...globals.jest,
      },
      sourceType: 'commonjs',
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
  },
  {
    rules: {
      '@typescript-eslint/no-explicit-any': 'off',
      '@typescript-eslint/no-floating-promises': 'warn',
      '@typescript-eslint/no-unsafe-argument': 'warn',
      "prettier/prettier": ["error", { endOfLine: "auto" }],
    },
  },
);


================================================================================
File: frontend-next/README.md
Size: 1.45 kB
================================================================================

This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.


================================================================================
File: frontend-next/app/globals.css
Size: 488 B
================================================================================

@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}


================================================================================
File: frontend-next/app/layout.tsx
Size: 689 B
================================================================================

import type { Metadata } from "next";
import { Geist, Geist_Mono } from "next/font/google";
import "./globals.css";

const geistSans = Geist({
  variable: "--font-geist-sans",
  subsets: ["latin"],
});

const geistMono = Geist_Mono({
  variable: "--font-geist-mono",
  subsets: ["latin"],
});

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body
        className={`${geistSans.variable} ${geistMono.variable} antialiased`}
      >
        {children}
      </body>
    </html>
  );
}


================================================================================
File: frontend-next/app/page.tsx
Size: 2.89 kB
================================================================================

import Image from "next/image";

export default function Home() {
  return (
    <div className="flex min-h-screen items-center justify-center bg-zinc-50 font-sans dark:bg-black">
      <main className="flex min-h-screen w-full max-w-3xl flex-col items-center justify-between py-32 px-16 bg-white dark:bg-black sm:items-start">
        <Image
          className="dark:invert"
          src="/next.svg"
          alt="Next.js logo"
          width={100}
          height={20}
          priority
        />
        <div className="flex flex-col items-center gap-6 text-center sm:items-start sm:text-left">
          <h1 className="max-w-xs text-3xl font-semibold leading-10 tracking-tight text-black dark:text-zinc-50">
            To get started, edit the page.tsx file.
          </h1>
          <p className="max-w-md text-lg leading-8 text-zinc-600 dark:text-zinc-400">
            Looking for a starting point or more instructions? Head over to{" "}
            <a
              href="https://vercel.com/templates?framework=next.js&utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Templates
            </a>{" "}
            or the{" "}
            <a
              href="https://nextjs.org/learn?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
              className="font-medium text-zinc-950 dark:text-zinc-50"
            >
              Learning
            </a>{" "}
            center.
          </p>
        </div>
        <div className="flex flex-col gap-4 text-base font-medium sm:flex-row">
          <a
            className="flex h-12 w-full items-center justify-center gap-2 rounded-full bg-foreground px-5 text-background transition-colors hover:bg-[#383838] dark:hover:bg-[#ccc] md:w-[158px]"
            href="https://vercel.com/new?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            <Image
              className="dark:invert"
              src="/vercel.svg"
              alt="Vercel logomark"
              width={16}
              height={16}
            />
            Deploy Now
          </a>
          <a
            className="flex h-12 w-full items-center justify-center rounded-full border border-solid border-black/[.08] px-5 transition-colors hover:border-transparent hover:bg-black/[.04] dark:border-white/[.145] dark:hover:bg-[#1a1a1a] md:w-[158px]"
            href="https://nextjs.org/docs?utm_source=create-next-app&utm_medium=appdir-template-tw&utm_campaign=create-next-app"
            target="_blank"
            rel="noopener noreferrer"
          >
            Documentation
          </a>
        </div>
      </main>
    </div>
  );
}


================================================================================
File: frontend-next/eslint.config.mjs
Size: 465 B
================================================================================

import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;


================================================================================
File: frontend-next/next.config.ts
Size: 133 B
================================================================================

import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;


================================================================================
File: frontend-next/package.json
Size: 535 B
================================================================================

{
  "name": "frontend-next",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}


================================================================================
File: frontend-next/postcss.config.mjs
Size: 94 B
================================================================================

const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;


================================================================================
File: frontend-next/public/file.svg
Size: 391 B
================================================================================

<svg fill="none" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M14.5 13.5V5.41a1 1 0 0 0-.3-.7L9.8.29A1 1 0 0 0 9.08 0H1.5v13.5A2.5 2.5 0 0 0 4 16h8a2.5 2.5 0 0 0 2.5-2.5m-1.5 0v-7H8v-5H3v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1M9.5 5V2.12L12.38 5zM5.13 5h-.62v1.25h2.12V5zm-.62 3h7.12v1.25H4.5zm.62 3h-.62v1.25h7.12V11z" clip-rule="evenodd" fill="#666" fill-rule="evenodd"/></svg>

================================================================================
File: frontend-next/public/globe.svg
Size: 1.03 kB
================================================================================

<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><g clip-path="url(#a)"><path fill-rule="evenodd" clip-rule="evenodd" d="M10.27 14.1a6.5 6.5 0 0 0 3.67-3.45q-1.24.21-2.7.34-.31 1.83-.97 3.1M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16m.48-1.52a7 7 0 0 1-.96 0H7.5a4 4 0 0 1-.84-1.32q-.38-.89-.63-2.08a40 40 0 0 0 3.92 0q-.25 1.2-.63 2.08a4 4 0 0 1-.84 1.31zm2.94-4.76q1.66-.15 2.95-.43a7 7 0 0 0 0-2.58q-1.3-.27-2.95-.43a18 18 0 0 1 0 3.44m-1.27-3.54a17 17 0 0 1 0 3.64 39 39 0 0 1-4.3 0 17 17 0 0 1 0-3.64 39 39 0 0 1 4.3 0m1.1-1.17q1.45.13 2.69.34a6.5 6.5 0 0 0-3.67-3.44q.65 1.26.98 3.1M8.48 1.5l.01.02q.41.37.84 1.31.38.89.63 2.08a40 40 0 0 0-3.92 0q.25-1.2.63-2.08a4 4 0 0 1 .85-1.32 7 7 0 0 1 .96 0m-2.75.4a6.5 6.5 0 0 0-3.67 3.44 29 29 0 0 1 2.7-.34q.31-1.83.97-3.1M4.58 6.28q-1.66.16-2.95.43a7 7 0 0 0 0 2.58q1.3.27 2.95.43a18 18 0 0 1 0-3.44m.17 4.71q-1.45-.12-2.69-.34a6.5 6.5 0 0 0 3.67 3.44q-.65-1.27-.98-3.1" fill="#666"/></g><defs><clipPath id="a"><path fill="#fff" d="M0 0h16v16H0z"/></clipPath></defs></svg>

================================================================================
File: frontend-next/public/next.svg
Size: 1.38 kB
================================================================================

<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 394 80"><path fill="#000" d="M262 0h68.5v12.7h-27.2v66.6h-13.6V12.7H262V0ZM149 0v12.7H94v20.4h44.3v12.6H94v21h55v12.6H80.5V0h68.7zm34.3 0h-17.8l63.8 79.4h17.9l-32-39.7 32-39.6h-17.9l-23 28.6-23-28.6zm18.3 56.7-9-11-27.1 33.7h17.8l18.3-22.7z"/><path fill="#000" d="M81 79.3 17 0H0v79.3h13.6V17l50.2 62.3H81Zm252.6-.4c-1 0-1.8-.4-2.5-1s-1.1-1.6-1.1-2.6.3-1.8 1-2.5 1.6-1 2.6-1 1.8.3 2.5 1a3.4 3.4 0 0 1 .6 4.3 3.7 3.7 0 0 1-3 1.8zm23.2-33.5h6v23.3c0 2.1-.4 4-1.3 5.5a9.1 9.1 0 0 1-3.8 3.5c-1.6.8-3.5 1.3-5.7 1.3-2 0-3.7-.4-5.3-1s-2.8-1.8-3.7-3.2c-.9-1.3-1.4-3-1.4-5h6c.1.8.3 1.6.7 2.2s1 1.2 1.6 1.5c.7.4 1.5.5 2.4.5 1 0 1.8-.2 2.4-.6a4 4 0 0 0 1.6-1.8c.3-.8.5-1.8.5-3V45.5zm30.9 9.1a4.4 4.4 0 0 0-2-3.3 7.5 7.5 0 0 0-4.3-1.1c-1.3 0-2.4.2-3.3.5-.9.4-1.6 1-2 1.6a3.5 3.5 0 0 0-.3 4c.3.5.7.9 1.3 1.2l1.8 1 2 .5 3.2.8c1.3.3 2.5.7 3.7 1.2a13 13 0 0 1 3.2 1.8 8.1 8.1 0 0 1 3 6.5c0 2-.5 3.7-1.5 5.1a10 10 0 0 1-4.4 3.5c-1.8.8-4.1 1.2-6.8 1.2-2.6 0-4.9-.4-6.8-1.2-2-.8-3.4-2-4.5-3.5a10 10 0 0 1-1.7-5.6h6a5 5 0 0 0 3.5 4.6c1 .4 2.2.6 3.4.6 1.3 0 2.5-.2 3.5-.6 1-.4 1.8-1 2.4-1.7a4 4 0 0 0 .8-2.4c0-.9-.2-1.6-.7-2.2a11 11 0 0 0-2.1-1.4l-3.2-1-3.8-1c-2.8-.7-5-1.7-6.6-3.2a7.2 7.2 0 0 1-2.4-5.7 8 8 0 0 1 1.7-5 10 10 0 0 1 4.3-3.5c2-.8 4-1.2 6.4-1.2 2.3 0 4.4.4 6.2 1.2 1.8.8 3.2 2 4.3 3.4 1 1.4 1.5 3 1.5 5h-5.8z"/></svg>

================================================================================
File: frontend-next/public/vercel.svg
Size: 128 B
================================================================================

<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1155 1000"><path d="m577.3 0 577.4 1000H0z" fill="#fff"/></svg>

================================================================================
File: frontend-next/public/window.svg
Size: 385 B
================================================================================

<svg fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M1.5 2.5h13v10a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1zM0 1h16v11.5a2.5 2.5 0 0 1-2.5 2.5h-11A2.5 2.5 0 0 1 0 12.5zm3.75 4.5a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5M7 4.75a.75.75 0 1 1-1.5 0 .75.75 0 0 1 1.5 0m1.75.75a.75.75 0 1 0 0-1.5.75.75 0 0 0 0 1.5" fill="#666"/></svg>

================================================================================
File: frontend-next/tsconfig.json
Size: 666 B
================================================================================

{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}


================================================================================
File: prisma/migrations/20260114223603_init/migration.sql
Size: 4.39 kB
================================================================================

-- CreateEnum
CREATE TYPE "Role" AS ENUM ('USER', 'MANAGER', 'ADMIN');

-- CreateEnum
CREATE TYPE "InvitationStatus" AS ENUM ('PENDING', 'ACCEPTED', 'REJECTED', 'EXPIRED');

-- CreateEnum
CREATE TYPE "TaskStatus" AS ENUM ('TODO', 'IN_PROGRESS', 'DONE');

-- CreateTable
CREATE TABLE "User" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "password" TEXT NOT NULL,
    "name" TEXT,
    "role" "Role" NOT NULL DEFAULT 'USER',
    "refresh_token_hash" TEXT,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "User_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Team" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Team_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "TeamMember" (
    "id" SERIAL NOT NULL,
    "role" TEXT NOT NULL,
    "userId" INTEGER NOT NULL,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "TeamMember_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Project" (
    "id" SERIAL NOT NULL,
    "name" TEXT NOT NULL,
    "description" TEXT,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Project_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Task" (
    "id" SERIAL NOT NULL,
    "title" TEXT NOT NULL,
    "description" TEXT,
    "status" "TaskStatus" NOT NULL DEFAULT 'TODO',
    "dueDate" TIMESTAMP(3),
    "projectId" INTEGER NOT NULL,
    "assigneeId" INTEGER,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,
    "deletedAt" TIMESTAMP(3),

    CONSTRAINT "Task_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Attachment" (
    "id" SERIAL NOT NULL,
    "filename" TEXT NOT NULL,
    "url" TEXT NOT NULL,
    "mimetype" TEXT NOT NULL,
    "size" INTEGER NOT NULL,
    "taskId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT "Attachment_pkey" PRIMARY KEY ("id")
);

-- CreateTable
CREATE TABLE "Invitation" (
    "id" SERIAL NOT NULL,
    "email" TEXT NOT NULL,
    "token" TEXT NOT NULL,
    "status" "InvitationStatus" NOT NULL DEFAULT 'PENDING',
    "expiresAt" TIMESTAMP(3) NOT NULL,
    "inviterId" INTEGER NOT NULL,
    "teamId" INTEGER NOT NULL,
    "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updatedAt" TIMESTAMP(3) NOT NULL,

    CONSTRAINT "Invitation_pkey" PRIMARY KEY ("id")
);

-- CreateIndex
CREATE UNIQUE INDEX "User_email_key" ON "User"("email");

-- CreateIndex
CREATE UNIQUE INDEX "TeamMember_userId_teamId_key" ON "TeamMember"("userId", "teamId");

-- CreateIndex
CREATE UNIQUE INDEX "Invitation_token_key" ON "Invitation"("token");

-- AddForeignKey
ALTER TABLE "TeamMember" ADD CONSTRAINT "TeamMember_userId_fkey" FOREIGN KEY ("userId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "TeamMember" ADD CONSTRAINT "TeamMember_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Project" ADD CONSTRAINT "Project_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Task" ADD CONSTRAINT "Task_projectId_fkey" FOREIGN KEY ("projectId") REFERENCES "Project"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Task" ADD CONSTRAINT "Task_assigneeId_fkey" FOREIGN KEY ("assigneeId") REFERENCES "User"("id") ON DELETE SET NULL ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Attachment" ADD CONSTRAINT "Attachment_taskId_fkey" FOREIGN KEY ("taskId") REFERENCES "Task"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Invitation" ADD CONSTRAINT "Invitation_inviterId_fkey" FOREIGN KEY ("inviterId") REFERENCES "User"("id") ON DELETE CASCADE ON UPDATE CASCADE;

-- AddForeignKey
ALTER TABLE "Invitation" ADD CONSTRAINT "Invitation_teamId_fkey" FOREIGN KEY ("teamId") REFERENCES "Team"("id") ON DELETE CASCADE ON UPDATE CASCADE;


================================================================================
File: prisma/migrations/20260114230215_refactor_team_roles/migration.sql
Size: 356 B
================================================================================

/*
  Warnings:

  - The `role` column on the `TeamMember` table would be dropped and recreated. This will lead to data loss if there is data in the column.

*/
-- CreateEnum
CREATE TYPE "TeamRole" AS ENUM ('OWNER', 'MEMBER', 'VIEWER');

-- AlterTable
ALTER TABLE "TeamMember" DROP COLUMN "role",
ADD COLUMN     "role" "TeamRole" NOT NULL DEFAULT 'MEMBER';


================================================================================
File: prisma/migrations/migration_lock.toml
Size: 126 B
================================================================================

# Please do not edit this file manually
# It should be added in your version-control system (i.e. Git)
provider = "postgresql"

================================================================================
File: prisma/schema.prisma
Size: 3.68 kB
================================================================================

// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --- ENUMS (Business Logic) ---
enum Role {
  USER
  MANAGER
  ADMIN
}

enum TeamRole {
  OWNER
  MEMBER
  VIEWER
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  REJECTED
  EXPIRED
}

enum TaskStatus {
  TODO
  IN_PROGRESS
  DONE
}

// --- MODELS ---

model User {
  id               Int           @id @default(autoincrement())
  email            String        @unique
  password         String
  name             String?
  role             Role          @default(USER)
  
  refreshTokenHash String?       @map("refresh_token_hash")

  // Relations
  teams           TeamMember[]
  assignedTasks   Task[]       @relation("TaskAssignee")
  invitationsSent Invitation[] @relation("Inviter")
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  deletedAt       DateTime?    // Audit: Soft Delete field
}

model Team {
  id          Int          @id @default(autoincrement())
  name        String
  members     TeamMember[]
  projects    Project[]
  invitations Invitation[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?    // Audit: Soft Delete field
}

model TeamMember {
  id        Int      @id @default(autoincrement())
  role      TeamRole @default(MEMBER)
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  teamId    Int
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, teamId])
}

model Project {
  id          Int      @id @default(autoincrement())
  name        String
  description String?  
  teamId      Int
  team        Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  tasks       Task[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // Audit: Soft Delete field
}

model Task {
  id          Int          @id @default(autoincrement())
  title       String
  description String?
  status      TaskStatus   @default(TODO)
  dueDate     DateTime?
  
  projectId   Int
  project     Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  assigneeId  Int?
  assignee    User?        @relation("TaskAssignee", fields: [assigneeId], references: [id])

  attachments Attachment[]

  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  deletedAt   DateTime?    // Audit: Soft Delete field
}

model Attachment {
  id        Int      @id @default(autoincrement())
  filename  String   
  url       String   
  mimetype  String   
  size      Int      
  
  taskId    Int
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt   // Added: For consistency
  deletedAt DateTime?              // Added: Fixes the 500 error and enables Soft Delete
}

model Invitation {
  id         Int              @id @default(autoincrement())
  email      String           
  token      String           @unique
  status     InvitationStatus @default(PENDING)
  expiresAt  DateTime
  
  inviterId  Int
  inviter    User             @relation("Inviter", fields: [inviterId], references: [id], onDelete: Cascade)
  
  teamId     Int
  team       Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)

  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
}

================================================================================
File: prisma/seed.ts
Size: 1.79 kB
================================================================================

import { PrismaClient, Role, TaskStatus, TeamRole } from '@prisma/client';
import * as argon2 from 'argon2';

const prisma = new PrismaClient();

async function main() {
  console.log('--- Starting Seeding Process ---');
  const password = await argon2.hash('password123');

  // 1. Create or Update Admin User (Global Role)
  const admin = await prisma.user.upsert({
    where: { email: 'admin@test.com' },
    update: { password },
    create: {
      email: 'admin@test.com',
      name: 'Admin User',
      password,
      role: Role.ADMIN, // Este es el rol global del sistema
    },
  });

  // 2. Create Team using OWNER instead of ADMIN
  // English: Fixed based on your schema error: OWNER, MEMBER, VIEWER
  const team = await prisma.team.create({
    data: {
      name: 'Development Team',
      members: {
        create: {
          userId: admin.id,
          role: TeamRole.OWNER, // Cambiado de ADMIN a OWNER
        },
      },
    },
  });

  // 3. Create Project with Tasks
  await prisma.project.create({
    data: {
      name: 'Platform Rebuild',
      teamId: team.id,
      tasks: {
        create: [
          {
            title: 'Database Schema',
            status: TaskStatus.DONE,
          },
          {
            title: 'API Implementation',
            status: TaskStatus.IN_PROGRESS,
          },
          {
            title: 'Legacy Migration',
            status: TaskStatus.TODO,
            dueDate: new Date('2025-01-01'),
          },
        ],
      },
    },
  });

  console.log('--- Seed Success ---');
  console.log({
    admin: admin.email,
    teamId: team.id,
  });
}

main()
  .catch((e) => {
    console.error('Error during seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });


================================================================================
File: test/auth.e2e-spec.ts
Size: 2.97 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import cookieParser from 'cookie-parser';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('AuthController (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;

  const testUser = {
    email: `e2e-auth-${Date.now()}@productivity.com`,
    password: 'password123',
    name: 'Nikolas Tesla',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();

    app.useGlobalPipes(
      new ValidationPipe({
        whitelist: true,
        transform: true,
        forbidNonWhitelisted: true,
      }),
    );
    app.use(cookieParser());

    await app.init();
    prisma = app.get<PrismaService>(PrismaService);
  });

  afterAll(async () => {
    await prisma.user.deleteMany({
      where: { email: testUser.email },
    });
    await prisma.$disconnect();
    await app.close();
  });

  describe('Authentication Flow', () => {
    it('/auth/signup (POST) - Success with RegisterDto', async () => {
      const response = await request(app.getHttpServer())
        .post('/auth/signup')
        .send({
          email: testUser.email,
          password: testUser.password,
          name: testUser.name,
        })
        .expect(201);

      expect(response.body).toHaveProperty('access_token');

      // English: Safe way to check cookies without TS errors
      const cookies = response.get('Set-Cookie');
      expect(cookies).toBeDefined();
      if (cookies) {
        expect(cookies[0]).toContain('refresh_token');
      }
    });

    it('/auth/signin (POST) - Success with LoginDto', async () => {
      const response = await request(app.getHttpServer())
        .post('/auth/signin')
        .send({
          email: testUser.email,
          password: testUser.password,
        })
        .expect(200);

      expect(response.body).toHaveProperty('access_token');
      expect(response.get('Set-Cookie')).toBeDefined();
    });

    it('/auth/logout (POST) - Success', async () => {
      const loginRes = await request(app.getHttpServer())
        .post('/auth/signin')
        .send({
          email: testUser.email,
          password: testUser.password,
        });

      const at = loginRes.body.access_token;

      return request(app.getHttpServer())
        .post('/auth/logout')
        .set('Authorization', `Bearer ${at}`)
        .expect(200);
    });

    it('/auth/signup (POST) - Should fail if name is missing', async () => {
      return request(app.getHttpServer())
        .post('/auth/signup')
        .send({
          email: 'noname@test.com',
          password: 'password123',
        })
        .expect(400);
    });
  });
});


================================================================================
File: test/invitations.e2e-spec.ts
Size: 3.21 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Invitations (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let ownerToken: string;
  let guestToken: string;
  let teamId: number;
  let invitationToken: string;

  const ownerUser = {
    email: 'owner@test.com',
    password: 'password123',
    name: 'Owner',
  };
  const guestUser = {
    email: 'guest@test.com',
    password: 'password123',
    name: 'Guest',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();
    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    await app.init();
    prisma = app.get<PrismaService>(PrismaService);

    // 1. Create Owner and Team
    await request(app.getHttpServer()).post('/auth/signup').send(ownerUser);
    const loginOwner = await request(app.getHttpServer())
      .post('/auth/signin')
      .send(ownerUser);
    ownerToken = loginOwner.body.access_token;

    const teamRes = await request(app.getHttpServer())
      .post('/teams')
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ name: 'E2E Team' });
    teamId = teamRes.body.id;

    // 2. Create Guest User
    await request(app.getHttpServer()).post('/auth/signup').send(guestUser);
    const loginGuest = await request(app.getHttpServer())
      .post('/auth/signin')
      .send(guestUser);
    guestToken = loginGuest.body.access_token;
  });

  afterAll(async () => {
    await prisma.user.deleteMany({
      where: { email: { in: [ownerUser.email, guestUser.email] } },
    });
    await prisma.team.deleteMany({ where: { name: 'E2E Team' } });
    await app.close();
  });

  it('POST /invitations/team/:id/send - Should send invitation', async () => {
    const res = await request(app.getHttpServer())
      .post(`/invitations/team/${teamId}/send`)
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ email: guestUser.email, role: 'MEMBER' })
      .expect(201);

    const inv = await prisma.invitation.findFirst({
      where: { email: guestUser.email },
    });
    invitationToken = inv!.token;
  });

  it('POST /invitations/accept - Should fail if email mismatch', async () => {
    // Attempting to accept guest's invitation with owner's account
    await request(app.getHttpServer())
      .post('/invitations/accept')
      .set('Authorization', `Bearer ${ownerToken}`)
      .send({ token: invitationToken })
      .expect(403);
  });

  it('POST /invitations/accept - Should join team successfully', async () => {
    await request(app.getHttpServer())
      .post('/invitations/accept')
      .set('Authorization', `Bearer ${guestToken}`)
      .send({ token: invitationToken })
      .expect(201);

    // Verify membership
    const member = await prisma.teamMember.findFirst({
      where: { teamId, user: { email: guestUser.email } },
    });
    expect(member).toBeDefined();
  });
});


================================================================================
File: test/jest-e2e.json
Size: 183 B
================================================================================

{
  "moduleFileExtensions": ["js", "json", "ts"],
  "rootDir": ".",
  "testEnvironment": "node",
  "testRegex": ".e2e-spec.ts$",
  "transform": {
    "^.+\\.(t|j)s$": "ts-jest"
  }
}


================================================================================
File: test/tasks.e2e-spec.ts
Size: 3.77 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import cookieParser from 'cookie-parser';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Tasks (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let accessToken: string;
  let userId: number;
  let projectId: number;

  const testUser = {
    email: `tasks-e2e-${Date.now()}@test.com`,
    password: 'password123',
    name: 'Task Tester',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(
      new ValidationPipe({ whitelist: true, transform: true }),
    );
    app.use(cookieParser());
    await app.init();
    prisma = app.get<PrismaService>(PrismaService);

    // --- SETUP: Create User, Team and Project ---
    // 1. Signup & Signin
    await request(app.getHttpServer()).post('/auth/signup').send(testUser);
    const loginRes = await request(app.getHttpServer())
      .post('/auth/signin')
      .send({
        email: testUser.email,
        password: testUser.password,
      });
    accessToken = loginRes.body.access_token;

    const user = await prisma.user.findUnique({
      where: { email: testUser.email },
    });
    userId = user!.id;

    // 2. Create Team
    const team = await prisma.team.create({
      data: {
        name: 'E2E Team',
        members: { create: { userId, role: 'OWNER' } },
      },
    });

    // 3. Create Project
    const project = await prisma.project.create({
      data: {
        name: 'E2E Project',
        teamId: team.id,
      },
    });
    projectId = project.id;
  });

  afterAll(async () => {
    // English: Cleanup database
    await prisma.user.deleteMany({ where: { email: testUser.email } });
    await prisma.team.deleteMany({ where: { name: 'E2E Team' } });
    await prisma.$disconnect();
    await app.close();
  });

  describe('/tasks', () => {
    it('POST /tasks - Should create a task', async () => {
      const createTaskDto = {
        title: 'Finish E2E Tests',
        description: 'Testing the task creation flow',
        projectId: projectId,
        status: 'TODO',
      };

      const response = await request(app.getHttpServer())
        .post('/tasks')
        .set('Authorization', `Bearer ${accessToken}`)
        .send(createTaskDto)
        .expect(201);

      expect(response.body).toHaveProperty('id');
      expect(response.body.title).toBe(createTaskDto.title);
    });

    it('GET /tasks/project/:id - Should return tasks for the project', async () => {
      const response = await request(app.getHttpServer())
        .get(`/tasks/project/${projectId}`)
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.length).toBeGreaterThan(0);
    });

    it('POST /tasks - Should fail if user is not in the team', async () => {
      // English: Create a project in a team where the user is NOT a member
      const otherTeam = await prisma.team.create({
        data: { name: 'Other Team' },
      });
      const otherProject = await prisma.project.create({
        data: { name: 'Unauthorized Project', teamId: otherTeam.id },
      });

      return request(app.getHttpServer())
        .post('/tasks')
        .set('Authorization', `Bearer ${accessToken}`)
        .send({
          title: 'Hacker Task',
          projectId: otherProject.id,
        })
        .expect(403); // English: Forbidden
    });
  });
});


================================================================================
File: test/teams.e2e-spec.ts
Size: 2.48 kB
================================================================================

import { Test, TestingModule } from '@nestjs/testing';
import { INestApplication, ValidationPipe } from '@nestjs/common';
import request from 'supertest';
import { AppModule } from './../src/app.module';
import { PrismaService } from './../src/prisma/prisma.service';

describe('Teams (e2e)', () => {
  let app: INestApplication;
  let prisma: PrismaService;
  let accessToken: string;
  let userId: number;

  const testUser = {
    email: `team-e2e-${Date.now()}@test.com`,
    password: 'password123',
    name: 'Team Manager',
  };

  beforeAll(async () => {
    const moduleFixture: TestingModule = await Test.createTestingModule({
      imports: [AppModule],
    }).compile();

    app = moduleFixture.createNestApplication();
    app.useGlobalPipes(new ValidationPipe());
    await app.init();
    prisma = app.get<PrismaService>(PrismaService);

    // Setup: User & Auth
    await request(app.getHttpServer()).post('/auth/signup').send(testUser);
    const loginRes = await request(app.getHttpServer())
      .post('/auth/signin')
      .send({
        email: testUser.email,
        password: testUser.password,
      });
    accessToken = loginRes.body.access_token;

    const user = await prisma.user.findUnique({
      where: { email: testUser.email },
    });
    userId = user!.id;
  });

  afterAll(async () => {
    await prisma.user.deleteMany({ where: { email: testUser.email } });
    await prisma.$disconnect();
    await app.close();
  });

  describe('/teams', () => {
    it('POST /teams - Should create a team and assign user as OWNER', async () => {
      const response = await request(app.getHttpServer())
        .post('/teams')
        .set('Authorization', `Bearer ${accessToken}`)
        .send({ name: 'Alpha Team' })
        .expect(201);

      expect(response.body.name).toBe('Alpha Team');

      // English: Verify in DB that the membership was created correctly
      const membership = await prisma.teamMember.findFirst({
        where: { teamId: response.body.id, userId: userId },
      });
      expect(membership?.role).toBe('OWNER');
    });

    it('GET /teams - Should list user teams', async () => {
      const response = await request(app.getHttpServer())
        .get('/teams')
        .set('Authorization', `Bearer ${accessToken}`)
        .expect(200);

      expect(Array.isArray(response.body)).toBe(true);
      expect(response.body.some((t: any) => t.name === 'Alpha Team')).toBe(
        true,
      );
    });
  });
});

